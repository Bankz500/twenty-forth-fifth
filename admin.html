<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Manage Testimonials | Beal Offshore Ltd</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="logo new.png">
    <link rel="icon" href="logo new.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .success-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 3px solid #60a5fa;
        }
        .nav-item.active:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }
        .sidebar {
            display: flex;
            flex-direction: column;
        }
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
        }
        .sidebar-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            margin-top: auto;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar fixed md:static inset-y-0 left-0 z-50 w-64 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white shadow-2xl">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-700/50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-lg">
                        <i class="fas fa-shield-alt text-white text-lg"></i>
                    </div>
                <div>
                        <h1 class="text-lg font-bold text-white">Admin Panel</h1>
                        <p class="text-xs text-slate-400">Beal Offshore</p>
                </div>
                </div>
                <button id="closeSidebar" class="md:hidden text-slate-400 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav p-4 space-y-1">
                <a href="#testimonials" onclick="showSection('testimonials'); return false;" 
                   class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-star text-yellow-400 group-hover:scale-110 transition-transform"></i>
        </div>
                    <span class="font-medium text-sm">Testimonials</span>
                </a>
                <a href="#chat" onclick="showSection('chat'); return false;" 
                   class="nav-item relative flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-comments text-slate-300 group-hover:text-white transition-colors"></i>
                    </div>
                    <span class="font-medium text-sm">Live Chat</span>
                    <span id="adminChatBadge" class="ml-auto bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5 hidden shadow-lg">0</span>
                </a>
            </nav>

            <!-- Sidebar Footer with Logout -->
            <div class="sidebar-footer">
                <button onclick="signOut()" 
                   class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-red-600/20 hover:border-red-500/50 border border-transparent cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-sign-out-alt text-slate-400 group-hover:text-red-400 transition-colors"></i>
                    </div>
                    <span class="font-medium text-sm text-slate-300 group-hover:text-red-400 transition-colors">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button id="openSidebar" class="md:hidden text-gray-600 hover:text-gray-900">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <h2 id="pageTitle" class="text-2xl font-bold text-gray-900">Testimonials</h2>
            </div>
        </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-6">
                <div class="max-w-7xl mx-auto">

        <!-- Success Message -->
        <div id="successMessage" class="hidden success-message bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-4">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successText"></span>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorText"></span>
        </div>

        <!-- Testimonials Section -->
        <div id="testimonialsSection">
        <!-- Add Testimonial Form -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-plus-circle text-blue-500 mr-2"></i>
                Add New Testimonial
            </h2>
            <form id="testimonialForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Author Name *</label>
                        <input type="text" id="authorName" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="John Smith">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company *</label>
                        <input type="text" id="company" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="ABC Corporation">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Country *</label>
                        <input type="text" id="country" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="United States">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rating *</label>
                        <select id="rating" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select rating</option>
                            <option value="5">5 ⭐⭐⭐⭐⭐</option>
                            <option value="4">4 ⭐⭐⭐⭐</option>
                            <option value="3">3 ⭐⭐⭐</option>
                            <option value="2">2 ⭐⭐</option>
                            <option value="1">1 ⭐</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Like Count (75–300)</label>
                    <input type="number" id="likeCount" min="0"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Leave empty to auto-generate">
                    <p class="text-xs text-gray-500 mt-1">If empty: new testimonials get a random value (75–300). When editing, leaving empty keeps the current value.</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Review Text *</label>
                    <textarea id="reviewText" required rows="4"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter the testimonial text here..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Author Image (Optional)</label>
                    <div class="flex items-center gap-4">
                        <input type="file" id="authorImage" accept="image/*"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <div id="imagePreview" class="hidden">
                            <img id="previewImg" src="" alt="Preview" class="w-20 h-20 object-cover rounded-lg border border-gray-300">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Upload a profile image for the testimonial author (max 2MB)</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Published Date (Optional)</label>
                    <input type="date" id="publishedDate"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Leave empty to use current date</p>
                </div>

                <div class="flex items-center gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="verified" checked
                            class="mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="text-sm text-gray-700">Verified</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="published" checked
                            class="mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="text-sm text-gray-700">Published (visible on testimonials page)</span>
                    </label>
                </div>

                <div class="flex gap-2">
                <button type="submit" id="submitBtn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i><span id="submitBtnText">Add Testimonial</span>
                    </button>
                    <button type="button" id="cancelEditBtn" onclick="cancelEdit()" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-times mr-2"></i>Cancel
                </button>
                </div>
            </form>
        </div>

        <!-- Add Sample Testimonials -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-magic text-purple-500 mr-2"></i>
                Quick Setup
            </h2>
            <p class="text-gray-600 text-sm mb-4">Add realistic sample testimonials to get started quickly.</p>
            <div class="flex flex-col sm:flex-row gap-2">
            <button id="addSamplesBtn"
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                <i class="fas fa-sparkles mr-2"></i>Add Sample Testimonials
            </button>
                <button id="backfillLikesBtn"
                    class="bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-thumbs-up mr-2"></i>Assign Random Like Counts
            </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Assigns a random like count (75–300) to every testimonial (overwrites existing values).</p>
        </div>

        <!-- Existing Testimonials List -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-list text-gray-700 mr-2"></i>
                Existing Testimonials
            </h2>
            <div id="testimonialsList" class="space-y-4">
                <p class="text-gray-500 text-center py-8">Loading testimonials...</p>
                </div>
            </div>
        </div>

        <!-- Live Chat Management Section -->
        <div id="chatSection" class="hidden bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-comments text-blue-500 mr-2"></i>
                Live Chat Management
            </h2>
            <div id="chatsList" class="space-y-4">
                <p class="text-gray-500 text-center py-8">Loading chats...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, getDoc, serverTimestamp, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyABYV12B7RM2ZCD2G1lFTLpgJwflJFwEXY",
            authDomain: "beal-offshore.firebaseapp.com",
            projectId: "beal-offshore",
            storageBucket: "beal-offshore.firebasestorage.app",
            messagingSenderId: "1091834410162",
            appId: "1:1091834410162:web:56285433b5751e681745ab",
            measurementId: "G-CT463F3T6J"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Sign out function
        window.signOut = async function() {
            const { signOut: firebaseSignOut } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
            try {
                await firebaseSignOut(auth);
                window.location.href = 'admin-login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            }
        };

        // Check authentication
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'admin-login.html';
                return;
            }
            // Load once auth is ready; avoids a false "0 testimonials" before Firebase restores the session.
            loadTestimonials();
        });

        // Image preview functionality
        document.getElementById('authorImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (file) {
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('Image size must be less than 2MB');
                    e.target.value = '';
                    preview.classList.add('hidden');
                    return;
                }
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select a valid image file');
                    e.target.value = '';
                    preview.classList.add('hidden');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
            }
        });

        // Upload image to Cloudinary
        async function uploadImageToCloudinary(file) {
            const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dmgcagkqa/image/upload';
            const CLOUDINARY_UPLOAD_PRESET = 'ASHB_profile';
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                const response = await fetch(CLOUDINARY_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Image upload failed');
                }

                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Sample testimonials data - Authentic and detailed reviews
        const sampleTestimonials = [
            {
                authorName: "Michael Chen",
                company: "Global Trade Solutions Inc.",
                country: "Singapore",
                rating: 5,
                reviewText: "Beal Offshore Ltd has been instrumental in our international expansion across Southeast Asia. Their expertise in offshore banking solutions and regulatory compliance has saved us significant time and resources. The team is professional, responsive, and truly understands the complexities of cross-border transactions. We've processed over $2M in international transfers through their platform with zero issues. Their compliance team ensured we met all regulatory requirements for our operations in multiple jurisdictions. Highly recommended for any business looking to expand internationally.",
                verified: true,
                published: true
            },
            {
                authorName: "Sarah Williams",
                company: "Williams Financial Group",
                country: "United Kingdom",
                rating: 5,
                reviewText: "Outstanding service from Beal Offshore. They helped us set up our offshore account structure efficiently when we were establishing our presence in the European market. Their attention to detail and commitment to compliance is impressive - they walked us through every step of the KYC process and made it seamless. The online dashboard is intuitive, and their customer support team responds within hours, not days. We've been with them for 18 months now and couldn't be happier. Highly recommended for anyone looking for reliable offshore banking services with a personal touch.",
                verified: true,
                published: true
            },
            {
                authorName: "James Rodriguez",
                company: "Rodriguez Holdings",
                country: "United States",
                rating: 5,
                reviewText: "We've been working with Beal Offshore Ltd for over two years now, and they've consistently exceeded our expectations. As a family office managing assets across multiple countries, we needed a bank that understood international wealth management. Their team is knowledgeable, professional, and always available when we need assistance - even during off-hours. The platform is user-friendly and the transaction processing is seamless. What impressed us most was their proactive approach to compliance - they keep us informed about regulatory changes that might affect our accounts. This level of service is rare in offshore banking.",
                verified: true,
                published: true
            },
            {
                authorName: "Emma Thompson",
                company: "Thompson Enterprises",
                country: "Canada",
                rating: 5,
                reviewText: "Beal Offshore has transformed how we manage our international finances. The offshore account setup was straightforward, and their compliance team ensured everything was done correctly from day one. We were initially concerned about the complexity of offshore banking, but their team made the entire process transparent and easy to understand. Their customer support is top-notch - they've helped us navigate currency conversions, international wire transfers, and even provided advice on tax-efficient structures. We appreciate their transparency throughout the process. After 3 years, we still feel like valued clients, not just account numbers.",
                verified: true,
                published: true
            },
            {
                authorName: "David Kim",
                company: "Kim Capital Management",
                country: "South Korea",
                rating: 5,
                reviewText: "Excellent offshore banking services. Beal Offshore Ltd understands the needs of international businesses and provides tailored solutions. Their platform is secure, reliable, and their team is always ready to help. We've processed millions in transactions through their system without a single security concern. The multi-currency accounts have been particularly useful for our operations across Asia-Pacific. Their compliance documentation is thorough, which gives us confidence when dealing with auditors. We've had a great experience working with them and plan to expand our relationship.",
                verified: true,
                published: true
            },
            {
                authorName: "Robert Anderson",
                company: "Anderson & Associates",
                country: "Australia",
                rating: 5,
                reviewText: "I've worked with several offshore banks over the past decade, and Beal Offshore Ltd stands out for their professionalism and reliability. Their online banking platform is modern and secure - I can manage all my accounts from anywhere in the world. The transaction fees are competitive, and more importantly, they're transparent about all costs upfront. Their support team has helped me with everything from setting up beneficiary accounts to understanding tax implications. The fact that they're fully licensed and regulated gives me peace of mind. I've recommended them to several colleagues in the financial services industry.",
                verified: true,
                published: true
            },
            {
                authorName: "Maria Garcia",
                company: "Garcia International Trading",
                country: "Spain",
                rating: 5,
                reviewText: "Beal Offshore Ltd has been our banking partner for our import-export business for the past 3 years. Their multi-currency accounts have been essential for our operations across Europe and Latin America. The wire transfer process is fast and reliable - we've never experienced delays or issues. Their compliance team is thorough but efficient, which is exactly what we need. The online platform allows us to track all transactions in real-time, and the reporting features help us with our accounting. Their customer service is exceptional - they speak multiple languages and understand international business needs. We couldn't operate our business as efficiently without them.",
                verified: true,
                published: true
            },
            {
                authorName: "Thomas Müller",
                company: "Müller Tech Solutions",
                country: "Germany",
                rating: 5,
                reviewText: "As a technology company expanding globally, we needed a banking partner that could keep up with our fast-paced growth. Beal Offshore Ltd has been exactly that. They set up our corporate accounts quickly and have supported us through multiple funding rounds. Their platform integrates well with our accounting software, saving us hours of manual work. The team understands the unique needs of tech companies - they've helped us with everything from investor relations to payroll for our international team. Their security measures are top-tier, which is crucial for a tech company. Highly professional and reliable.",
                verified: true,
                published: true
            },
            {
                authorName: "Jennifer Lee",
                company: "Lee Investment Partners",
                country: "Hong Kong",
                rating: 5,
                reviewText: "Beal Offshore Ltd has been our preferred banking partner for managing our clients' offshore investments. Their expertise in wealth management and their understanding of different regulatory environments is impressive. The platform is sophisticated yet user-friendly, and their reporting capabilities are excellent for our compliance requirements. They've helped us structure accounts for clients across multiple jurisdictions while ensuring full regulatory compliance. Their team is responsive and always willing to go the extra mile. We've been with them for 4 years and have never had a reason to look elsewhere. They truly understand the needs of investment professionals.",
                verified: true,
                published: true
            },
            {
                authorName: "Ahmed Hassan",
                company: "Hassan Trading Group",
                country: "United Arab Emirates",
                rating: 5,
                reviewText: "Beal Offshore Ltd has been instrumental in our business expansion across the Middle East and Africa. Their understanding of regional banking requirements and their ability to facilitate transactions across different currencies has been invaluable. The account setup process was smooth, and their compliance team ensured we met all regulatory requirements. Their online platform works perfectly even with slower internet connections, which is important for our operations in remote areas. The customer support team is available 24/7 and has helped us resolve issues quickly. Their commitment to security and compliance gives us confidence in every transaction. Excellent service overall.",
                verified: true,
                published: true
            },
            {
                authorName: "Sophie Martin",
                company: "Martin Real Estate Holdings",
                country: "France",
                rating: 5,
                reviewText: "We've been using Beal Offshore Ltd for our international real estate investments for over 5 years. Their expertise in handling large transactions and their understanding of property investment structures is outstanding. They've facilitated transactions in multiple countries and currencies without any issues. The platform is secure and user-friendly, and their reporting features help us track all our investments. Their compliance team has been particularly helpful in ensuring we meet all regulatory requirements across different jurisdictions. The level of service we receive is exceptional - they treat us like partners, not just clients. We've recommended them to many colleagues in the real estate industry.",
                verified: true,
                published: true
            },
            {
                authorName: "Carlos Silva",
                company: "Silva Manufacturing Corp",
                country: "Brazil",
                rating: 5,
                reviewText: "Beal Offshore Ltd has transformed our international operations. As a manufacturing company with suppliers and customers across multiple continents, we needed a banking partner that could handle complex international transactions. They've exceeded our expectations in every way. Their multi-currency accounts have saved us significant money on currency conversions, and their wire transfer service is fast and reliable. The online platform is excellent - we can manage all our accounts and transactions from our office in São Paulo. Their customer support team speaks Portuguese, which makes communication much easier. They've been our banking partner for 2 years, and we plan to continue working with them as we expand further.",
                verified: true,
                published: true
            }
        ];

        // Random createdAt between 2019-01-01 and 2025-12-31 (avoid "today" dates like 2026)
        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function randomLikeCount() {
            return randomInt(75, 300);
        }

        function randomSampleCreatedAt() {
            const year = randomInt(2019, 2025);
            const month = randomInt(0, 11); // 0-11
            // Days in month:
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const day = randomInt(1, daysInMonth);
            const hour = randomInt(10, 16); // daytime hours to reduce timezone date shifting
            const minute = randomInt(0, 59);
            const second = randomInt(0, 59);
            return new Date(year, month, day, hour, minute, second);
        }

        function normalizeKeyPart(value) {
            return String(value || '')
                .toLowerCase()
                .replace(/\s+/g, ' ')
                .trim();
        }

        function createdAtKey(value) {
            if (!value) return '';
            if (value instanceof Date) return String(value.getTime());
            if (typeof value.toDate === 'function') return String(value.toDate().getTime()); // Firestore Timestamp
            if (typeof value === 'number') return String(value);
            if (typeof value === 'string') {
                const ms = Date.parse(value);
                return Number.isFinite(ms) ? String(ms) : value;
            }
            if (typeof value === 'object' && typeof value.seconds === 'number') {
                const ns = typeof value.nanoseconds === 'number' ? value.nanoseconds : 0;
                return String(value.seconds * 1000 + Math.floor(ns / 1e6));
            }
            try {
                const ms = new Date(value).getTime();
                return Number.isFinite(ms) ? String(ms) : '';
            } catch {
                return '';
            }
        }

        function testimonialSignature(t) {
            // Signature used to prevent duplicates across multiple "Add Sample" clicks.
            // Uniqueness is based on name + review text + timestamp (date/time).
            return [
                normalizeKeyPart(t.authorName),
                normalizeKeyPart(t.reviewText),
                createdAtKey(t.createdAt)
            ].join('||');
        }

        function hashStringToUint32(input) {
            // FNV-1a-ish hash (stable across sessions)
            let h = 2166136261;
            const s = String(input || '');
            for (let i = 0; i < s.length; i++) {
                h ^= s.charCodeAt(i);
                h = Math.imul(h, 16777619);
            }
            return h >>> 0;
        }

        const FEMALE_FIRST_NAMES = new Set([
            'heather','nicole','ashley','lauren','jessica','kayla','stephanie','megan','danielle','courtney',
            'alicia','kimberly','samantha','rachel','christina','erica','natalie','tiffany','vanessa','emily',
            'monica','allison','paige','brielle','haley','jenna','victoria','faith','marissa','kelsey',
            'hannah','olivia','alexis','desiree','michelle','brooke','carly','naomi','chelsea','madeline',
            'rachael','autumn','kristen','savannah','bianca','lillian','kayleen',
            'sarah','emma','maria','jennifer','sophie'
        ]);

        const MALE_FIRST_NAMES = new Set([
            'michael','daniel','anthony','brian','kevin','jason','andrew','matthew','jonathan','justin','brandon',
            'eric','nicholas','ryan','steven','joseph','tyler','adam','sean','robert','zachary','carlos','patrick',
            'aaron','dylan','marcus','paul','trevor','joshua','nathan','corey','luke','omar','isaiah','miguel',
            'julian','frank','victor','evan','caleb','jordan','devin','austin','raymond','blake','terrence','noah',
            'samuel','david','ahmed','james','thomas'
        ]);

        function inferGenderFromName(authorName) {
            const first = String(authorName || '')
                .trim()
                .split(/\s+/)[0]
                .replace(/[^a-zA-Z']/g, '')
                .toLowerCase();

            if (!first) return null;
            if (FEMALE_FIRST_NAMES.has(first)) return 'female';
            if (MALE_FIRST_NAMES.has(first)) return 'male';
            return null;
        }

        function pickSampleAuthorImage(authorName, usedUrls = null) {
            // Goal:
            // - Avoid repeats (best-effort within a single click)
            // - Prefer male/female human photos when we can infer it
            // - Otherwise fall back to deterministic avatars/objects
            const baseSeed = encodeURIComponent(String(authorName || 'beal-offshore'));
            const baseHash = hashStringToUint32(baseSeed);
            const gender = inferGenderFromName(authorName);

            // deterministic roll in [0,1)
            const baseRoll = (baseHash % 1000) / 1000;

            for (let attempt = 0; attempt < 12; attempt++) {
                const salt = attempt ? `-${attempt}` : '';
                const seed = `${baseSeed}${salt}`;

                const roll = ((baseHash + attempt * 997) % 1000) / 1000;
                const portraitIdx = (baseHash + attempt * 101) % 100; // randomuser supports 0-99

                let url = '';
                if (roll < 0.55) {
                    const folder = gender === 'female'
                        ? 'women'
                        : gender === 'male'
                            ? 'men'
                            : ((baseHash + attempt) % 2 ? 'men' : 'women');
                    url = `https://randomuser.me/api/portraits/${folder}/${portraitIdx}.jpg`;
                } else if (roll < 0.9) {
                    url = `https://api.dicebear.com/8.x/avataaars/svg?seed=${seed}`;
                } else {
                    url = `https://api.dicebear.com/8.x/shapes/svg?seed=${seed}`;
                }

                if (!usedUrls || !usedUrls.has(url)) {
                    return url;
                }
            }

            // worst-case fallback
            if (baseRoll < 0.5) return `https://api.dicebear.com/8.x/avataaars/svg?seed=${baseSeed}`;
            return `https://api.dicebear.com/8.x/shapes/svg?seed=${baseSeed}`;
        }

        function generateExtraSamples({ count, existingKeys, existingNames }) {
            const fullNames = [
                'Daniel Thompson', 'Anthony Rodriguez', 'Brian Anderson', 'Kevin Moore', 'Jason Taylor', 'Andrew White',
                'Matthew Harris', 'Jonathan Clark', 'Justin Lewis', 'Brandon Walker', 'Eric Hall', 'Nicholas Young',
                'Ryan Allen', 'Steven King', 'Joseph Wright', 'Tyler Lopez', 'Adam Scott', 'Sean Ramirez',
                'Robert Campbell', 'Zachary Mitchell', 'Carlos Hernandez', 'Patrick O\'Neill', 'Aaron Brooks', 'Dylan Foster',
                'Marcus Green', 'Paul Simmons', 'Trevor Price', 'Joshua Bennett', 'Nathan Coleman', 'Corey Evans',
                'Luke Patterson', 'Omar Washington', 'Isaiah Turner', 'Miguel Flores', 'Julian Rivera', 'Frank Delgado',
                'Victor Morales', 'Evan Porter', 'Caleb Reed', 'Jordan Nichols', 'Devin Watson', 'Austin Grant',
                'Raymond Cruz', 'Blake Henderson', 'Terrence Powell', 'Noah Kim', 'Samuel Baker',
                'Heather Johnson', 'Nicole Ramirez', 'Ashley Thompson', 'Lauren Mitchell', 'Jessica Anderson',
                'Kayla Peterson', 'Stephanie Brown', 'Megan O\'Connor', 'Danielle White', 'Courtney Lewis',
                'Alicia Martinez', 'Kimberly Scott', 'Samantha Young', 'Rachel Turner', 'Christina Hall',
                'Erica Moore', 'Natalie Brooks', 'Tiffany Adams', 'Vanessa Flores', 'Emily Richardson',
                'Monica Rivera', 'Allison Grant', 'Paige Reynolds', 'Brielle Jackson', 'Haley Stewart',
                'Jenna Sullivan', 'Victoria Lopez', 'Faith Robinson', 'Marissa Clark', 'Kelsey Bennett',
                'Hannah Phillips', 'Jordan Evans', 'Olivia Carter', 'Alexis Green', 'Desiree Torres',
                'Michelle Ward', 'Brooke Simmons', 'Carly Foster', 'Naomi Price', 'Chelsea Nguyen',
                'Madeline Howard', 'Rachael King', 'Autumn Diaz', 'Kristen Powell', 'Savannah Morris',
                'Bianca Cruz', 'Lillian Baker', 'Kayleen Murphy'
            ];
            const companyPrefixes = [
                'Northbridge','Blue Harbor','Atlas','Summit','Cedarstone','Silverline','Evergreen','Prime','Vertex','Keystone','Oakridge','Brightwater'
            ];
            const companySuffixes = [
                'Capital','Holdings','Partners','Advisory','Trading','Logistics','Ventures','Group','Enterprises','Management','Solutions','Industries'
            ];
            const countries = [
                'United States','United Kingdom','Canada','Australia','Germany','France','Spain','Italy','Singapore','Hong Kong','United Arab Emirates',
                'South Africa','Netherlands','Switzerland','Sweden','Norway','Ireland','Brazil','Mexico','Japan'
            ];
            // Short 2-line testimonials
            const shortTestimonials = [
                'Beal Offshore Ltd has been excellent for our international banking needs. Highly professional and reliable service.',
                'Great experience with Beal Offshore Ltd. Their platform is user-friendly and customer support is responsive.',
                'We\'ve been using Beal Offshore Ltd for offshore banking and are very satisfied. Fast transactions and excellent service.',
                'Beal Offshore Ltd made our offshore account setup seamless. The team is knowledgeable and always available to help.',
                'Outstanding service from Beal Offshore Ltd. Their compliance guidance and international transfer capabilities are top-notch.',
                'We chose Beal Offshore Ltd for our global operations and couldn\'t be happier. Professional, secure, and efficient.',
                'Beal Offshore Ltd provides excellent offshore banking solutions. The platform is intuitive and transactions are processed quickly.',
                'Highly recommend Beal Offshore Ltd for international banking. Their customer service is exceptional and the process is transparent.',
                'Our experience with Beal Offshore Ltd has been outstanding. They understand international business needs and deliver consistently.',
                'Beal Offshore Ltd has been our trusted banking partner for offshore operations. Reliable, secure, and professional service.',
                'Excellent offshore banking services from Beal Offshore Ltd. The account setup was smooth and ongoing support is great.',
                'We\'ve been working with Beal Offshore Ltd for international transactions. Their platform is secure and easy to use.',
                'Beal Offshore Ltd offers reliable offshore banking with excellent customer support. Highly satisfied with their services.',
                'Great offshore banking partner. Beal Offshore Ltd provides fast, secure transactions and professional guidance.',
                'Beal Offshore Ltd has exceeded our expectations. Their international banking solutions are comprehensive and reliable.',
                'Professional and efficient service from Beal Offshore Ltd. The offshore account management is seamless and user-friendly.',
                'We appreciate Beal Offshore Ltd\'s expertise in offshore banking. Their compliance support and platform are excellent.',
                'Beal Offshore Ltd provides outstanding offshore banking services. Fast processing, secure platform, and great support.',
                'Our offshore banking experience with Beal Offshore Ltd has been excellent. They make international operations easy.',
                'Beal Offshore Ltd is a reliable offshore banking partner. Their team is professional and the platform is intuitive.',
                'Excellent service from Beal Offshore Ltd. They handle our international banking needs with professionalism and efficiency.',
                'Beal Offshore Ltd offers top-tier offshore banking solutions. The account setup was quick and the service is outstanding.',
                'We\'ve been very satisfied with Beal Offshore Ltd. Their offshore banking platform is secure and transactions are fast.',
                'Beal Offshore Ltd provides excellent international banking services. Highly professional team and reliable platform.',
                'Great offshore banking experience with Beal Offshore Ltd. Their customer support is responsive and the service is excellent.',
                'Beal Offshore Ltd has been instrumental in our international operations. Professional service and secure platform.',
                'Outstanding offshore banking partner. Beal Offshore Ltd offers reliable services with excellent customer support.',
                'We highly recommend Beal Offshore Ltd for offshore banking. Their platform is user-friendly and service is professional.',
                'Beal Offshore Ltd provides comprehensive offshore banking solutions. Fast, secure, and reliable international transactions.',
                'Excellent offshore banking services from Beal Offshore Ltd. The team is knowledgeable and always ready to assist.',
            ];

            // Mix long + short for better variety
            const reviewPool = shortTestimonials
                .concat((Array.isArray(sampleTestimonials) ? sampleTestimonials : []).map(t => (t && t.reviewText) ? String(t.reviewText) : '').filter(Boolean));

            const out = [];
            const maxAttempts = 500;
            let attempts = 0;
            const usedNameIndices = new Set();
            const localExistingKeys = new Set(existingKeys || []);
            const localExistingNames = new Set(existingNames || []);

            while (out.length < count && attempts < maxAttempts) {
                attempts++;

                // Pick a random name from the provided list
                let nameIdx = randomInt(0, fullNames.length - 1);
                let nameAttempts = 0;
                // Try to find an unused name (up to 50 attempts)
                while (usedNameIndices.has(nameIdx) && nameAttempts < 50) {
                    nameIdx = randomInt(0, fullNames.length - 1);
                    nameAttempts++;
                }
                
                // If we've used all names, allow reuse but ensure unique testimonial content
                const authorName = fullNames[nameIdx];
                const normalizedName = normalizeKeyPart(authorName);
                
                // Only skip if exact name AND we have many unique names left
                if (usedNameIndices.size < fullNames.length * 0.8 && localExistingNames.has(normalizedName)) {
                    continue;
                }

                const company = `${companyPrefixes[randomInt(0, companyPrefixes.length - 1)]} ${companySuffixes[randomInt(0, companySuffixes.length - 1)]}`;
                const country = countries[randomInt(0, countries.length - 1)];
                const rating = Math.random() < 0.85 ? 5 : 4;
                const reviewText = reviewPool.length
                    ? reviewPool[randomInt(0, reviewPool.length - 1)]
                    : shortTestimonials[randomInt(0, shortTestimonials.length - 1)];

                const candidate = {
                    authorName,
                    company,
                    country,
                    rating,
                    reviewText,
                    verified: true,
                    published: true,
                    createdAt: randomSampleCreatedAt()
                };

                const sig = testimonialSignature(candidate);
                if (localExistingKeys.has(sig)) continue;

                out.push(candidate);
                usedNameIndices.add(nameIdx);
                localExistingNames.add(normalizedName);
                localExistingKeys.add(sig);
            }

            return out;
        }

        // Add sample testimonials
        document.getElementById('addSamplesBtn').addEventListener('click', async () => {
            const btn = document.getElementById('addSamplesBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding samples...';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                // Build a set of existing testimonial signatures so we don't add duplicates
                const existingSnap = await getDocs(collection(db, 'testimonials'));
                const existingKeys = new Set();
                const existingNames = new Set();
                existingSnap.forEach((d) => {
                    const data = d.data() || {};
                    existingKeys.add(testimonialSignature(data));
                    if (data.authorName) existingNames.add(normalizeKeyPart(data.authorName));
                });

                let added = 0;
                let skipped = 0;
                const addedThisRun = new Set();
                const usedAuthorImages = new Set();

                // Always generate a fresh random batch each click
                const desiredCount = 24;
                const generated = generateExtraSamples({ count: desiredCount, existingKeys, existingNames });

                for (const testimonial of generated) {
                    try {
                        const authorImage = testimonial.authorImage || pickSampleAuthorImage(testimonial.authorName, usedAuthorImages);
                        const likeCount = randomLikeCount();
                        const docData = {
                            ...testimonial,
                            authorImage,
                            likeCount,
                            createdAt: testimonial.createdAt || randomSampleCreatedAt()
                        };

                        const sig = testimonialSignature(docData);
                            if (existingKeys.has(sig) || addedThisRun.has(sig)) {
                                skipped++;
                                continue;
                            }

                        await addDoc(collection(db, 'testimonials'), docData);
                            added++;
                            addedThisRun.add(sig);
                        existingKeys.add(sig);
                        if (docData.authorName) existingNames.add(normalizeKeyPart(docData.authorName));
                        if (docData.authorImage) usedAuthorImages.add(docData.authorImage);
                        } catch (err) {
                        console.error('Error adding testimonial:', err);
                    }
                }

                if (added > 0) {
                if (skipped > 0) {
                    showSuccess(`Successfully added ${added} sample testimonials. Skipped ${skipped} duplicates.`);
                } else {
                    showSuccess(`Successfully added ${added} sample testimonials!`);
                    }
                } else {
                    const extra = skipped > 0 ? ` Skipped ${skipped} duplicates.` : '';
                    showError(`No new sample testimonials were added.${extra} Click again to generate a different random set.`);
                }
                loadTestimonials();
            } catch (error) {
                showError('Error adding sample testimonials: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sparkles mr-2"></i>Add Sample Testimonials';
            }
        });

        // Form submission
        document.getElementById('testimonialForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                let imageUrl = '';
                const imageFile = document.getElementById('authorImage').files[0];
                
                // Upload image if provided
                if (imageFile) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading image...';
                    try {
                        imageUrl = await uploadImageToCloudinary(imageFile);
                        console.log('Image uploaded successfully:', imageUrl);
                    } catch (error) {
                        console.error('Image upload error:', error);
                        throw new Error('Failed to upload image. Please try again.');
                    }
                }

                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

                const editingIdEl = document.getElementById('editingTestimonialId');
                const editingId = editingIdEl ? editingIdEl.value : '';
                const publishedDateEl = document.getElementById('publishedDate');
                const publishedDateInput = publishedDateEl ? publishedDateEl.value : '';

                const authorNameEl = document.getElementById('authorName');
                const companyEl = document.getElementById('company');
                const countryEl = document.getElementById('country');
                const ratingEl = document.getElementById('rating');
                const reviewTextEl = document.getElementById('reviewText');
                const verifiedEl = document.getElementById('verified');
                const publishedEl = document.getElementById('published');
                const likeCountEl = document.getElementById('likeCount');

                if (!authorNameEl || !companyEl || !countryEl || !ratingEl || !reviewTextEl || !verifiedEl || !publishedEl) {
                    throw new Error('Form elements not found. Please refresh the page.');
                }

                const testimonialData = {
                    authorName: authorNameEl.value.trim(),
                    company: companyEl.value.trim(),
                    country: countryEl.value.trim(),
                    rating: parseInt(ratingEl.value),
                    reviewText: reviewTextEl.value.trim(),
                    verified: verifiedEl.checked,
                    published: publishedEl.checked
                };

                // Like count: if empty on new testimonials, auto-generate; if empty while editing, keep current.
                if (likeCountEl) {
                    const raw = String(likeCountEl.value || '').trim();
                    if (raw) {
                        const n = parseInt(raw, 10);
                        if (!Number.isFinite(n) || n < 0) {
                            throw new Error('Like Count must be a number (0 or higher).');
                        }
                        testimonialData.likeCount = n;
                    } else if (!editingId) {
                        testimonialData.likeCount = randomLikeCount();
                    }
                } else if (!editingId) {
                    testimonialData.likeCount = randomLikeCount();
                }

                // Handle published date
                if (publishedDateInput) {
                    const date = new Date(publishedDateInput);
                    testimonialData.createdAt = date;
                } else if (!editingId) {
                    // Only set serverTimestamp for new testimonials
                    testimonialData.createdAt = serverTimestamp();
                }

                // Add image URL if uploaded (only update if new image is provided)
                if (imageUrl) {
                    testimonialData.authorImage = imageUrl;
                }

                if (editingId) {
                    // Update existing testimonial
                    const { updateDoc } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                    await updateDoc(doc(db, 'testimonials', editingId), testimonialData);
                    showSuccess('Testimonial updated successfully!');
                } else {
                    // Create new testimonial
                await addDoc(collection(db, 'testimonials'), testimonialData);
                showSuccess('Testimonial added successfully!');
                }

                const form = document.getElementById('testimonialForm');
                if (form) form.reset();
                const imagePreview = document.getElementById('imagePreview');
                if (imagePreview) imagePreview.classList.add('hidden');
                const previewImg = document.getElementById('previewImg');
                if (previewImg) previewImg.src = '';
                const editingIdField = document.getElementById('editingTestimonialId');
                if (editingIdField) editingIdField.value = '';
                const publishedDateField = document.getElementById('publishedDate');
                if (publishedDateField) publishedDateField.value = '';
                cancelEdit(); // Reset form to add mode
                loadTestimonials();
            } catch (error) {
                showError('Error adding testimonial: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                const editingIdEl = document.getElementById('editingTestimonialId');
                const editingId = editingIdEl ? editingIdEl.value : '';
                submitBtn.innerHTML = editingId 
                    ? '<i class="fas fa-save mr-2"></i>Update Testimonial'
                    : '<i class="fas fa-save mr-2"></i>Add Testimonial';
            }
        });

        // Load testimonials
        async function loadTestimonials() {
            try {
                // Get all testimonials (authenticated users can read all)
                const querySnapshot = await getDocs(collection(db, 'testimonials'));
                
                const listEl = document.getElementById('testimonialsList');
                
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-8">No testimonials found. Add your first testimonial above!</p>';
                    return;
                }

                const testimonials = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    testimonials.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date()
                    });
                });

                // Sort by createdAt client-side (newest first)
                testimonials.sort((a, b) => {
                    const dateA = a.createdAt instanceof Date ? a.createdAt : new Date(a.createdAt);
                    const dateB = b.createdAt instanceof Date ? b.createdAt : new Date(b.createdAt);
                    return dateB - dateA;
                });

                listEl.innerHTML = testimonials.map(t => {
                    const date = t.createdAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    const stars = '⭐'.repeat(t.rating || 0);
                    const likeCount = t.likeCount !== undefined ? t.likeCount : '—';
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 ${!t.published ? 'opacity-60' : ''}">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-start gap-3">
                                    ${t.authorImage ? `<img src="${t.authorImage}" alt="${t.authorName}" class="w-12 h-12 rounded-full object-cover border border-gray-200">` : '<div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-400"></i></div>'}
                                <div>
                                        <h3 class="font-semibold text-gray-900">${t.authorName}</h3>
                                        <p class="text-sm text-gray-600">${t.company} • ${t.country}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-yellow-500 text-sm">${stars}</div>
                                    <div class="text-xs text-gray-500 mt-1">${date}</div>
                                    <div class="text-xs text-gray-600 mt-1 flex items-center gap-1">
                                        <i class="fas fa-thumbs-up"></i> ${likeCount}
                                    </div>
                                </div>
                            </div>
                            <p class="text-gray-700 text-sm mt-2">${t.reviewText}</p>
                            <div class="flex items-center gap-2 mt-3 text-xs">
                                ${t.verified ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded">Verified</span>' : ''}
                                ${t.published ? '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">Published</span>' : '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">Draft</span>'}
                                <button onclick="deleteTestimonial('${t.id}')" class="text-red-600 hover:text-red-800 ml-auto">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading testimonials:', error);
                document.getElementById('testimonialsList').innerHTML = '<p class="text-red-500 text-center py-8">Error loading testimonials. Please refresh the page.</p>';
            }
        }

        // Edit testimonial
        window.editTestimonial = async (id) => {
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                const testimonialDoc = await getDoc(doc(db, 'testimonials', id));
                if (!testimonialDoc.exists()) {
                    throw new Error('Testimonial not found');
                }

                const data = testimonialDoc.data();
                
                // Populate form with testimonial data
                const authorNameField = document.getElementById('authorName');
                const companyField = document.getElementById('company');
                const countryField = document.getElementById('country');
                const ratingField = document.getElementById('rating');
                const reviewTextField = document.getElementById('reviewText');
                const verifiedField = document.getElementById('verified');
                const publishedField = document.getElementById('published');
                const likeCountField = document.getElementById('likeCount');
                const editingIdField = document.getElementById('editingTestimonialId');
                const publishedDateField = document.getElementById('publishedDate');
                const previewImg = document.getElementById('previewImg');
                const imagePreview = document.getElementById('imagePreview');
                const formTitle = document.getElementById('formTitle');
                const submitBtnText = document.getElementById('submitBtnText');
                const cancelEditBtn = document.getElementById('cancelEditBtn');

                if (authorNameField) authorNameField.value = data.authorName || '';
                if (companyField) companyField.value = data.company || '';
                if (countryField) countryField.value = data.country || '';
                if (ratingField) ratingField.value = data.rating || '';
                if (reviewTextField) reviewTextField.value = data.reviewText || '';
                if (verifiedField) verifiedField.checked = data.verified || false;
                if (publishedField) publishedField.checked = data.published || false;
                if (likeCountField) likeCountField.value = data.likeCount !== undefined ? data.likeCount : '';
                if (editingIdField) editingIdField.value = id;

                // Set published date if exists
                if (data.createdAt && data.createdAt.toDate && publishedDateField) {
                    const date = data.createdAt.toDate();
                    publishedDateField.value = date.toISOString().split('T')[0];
                }

                // Show existing image if available
                if (data.authorImage && previewImg) {
                    previewImg.src = data.authorImage;
                    if (imagePreview) imagePreview.classList.remove('hidden');
                }

                // Update form title and button
                if (formTitle) formTitle.textContent = 'Edit Testimonial';
                if (submitBtnText) submitBtnText.textContent = 'Update Testimonial';
                if (cancelEditBtn) cancelEditBtn.classList.remove('hidden');

                // Scroll to form
                document.getElementById('testimonialForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                console.error('Error loading testimonial for edit:', error);
                showError('Error loading testimonial: ' + error.message);
            }
        };

        // Cancel edit mode
        window.cancelEdit = function() {
            const form = document.getElementById('testimonialForm');
            if (form) form.reset();
            const imagePreview = document.getElementById('imagePreview');
            if (imagePreview) imagePreview.classList.add('hidden');
            const previewImg = document.getElementById('previewImg');
            if (previewImg) previewImg.src = '';
            const editingIdField = document.getElementById('editingTestimonialId');
            if (editingIdField) editingIdField.value = '';
            const publishedDateField = document.getElementById('publishedDate');
            if (publishedDateField) publishedDateField.value = '';
            const formTitle = document.getElementById('formTitle');
            if (formTitle) formTitle.textContent = 'Add New Testimonial';
            const submitBtnText = document.getElementById('submitBtnText');
            if (submitBtnText) submitBtnText.textContent = 'Add Testimonial';
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            if (cancelEditBtn) cancelEditBtn.classList.add('hidden');
        };

        // Assign random like counts to all testimonials
        document.getElementById('backfillLikesBtn').addEventListener('click', async () => {
            const btn = document.getElementById('backfillLikesBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Assigning likes...';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                const { updateDoc } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const testimonialsSnap = await getDocs(collection(db, 'testimonials'));
                
                let updated = 0;
                const updatePromises = [];
                
                testimonialsSnap.forEach((docSnap) => {
                    const likeCount = randomLikeCount();
                    updatePromises.push(
                        updateDoc(doc(db, 'testimonials', docSnap.id), { likeCount })
                    );
                    updated++;
                });

                await Promise.all(updatePromises);
                showSuccess(`Successfully assigned random like counts to ${updated} testimonials!`);
                loadTestimonials();
            } catch (error) {
                console.error('Error assigning like counts:', error);
                showError('Error assigning like counts: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-thumbs-up mr-2"></i>Assign Random Like Counts';
            }
        });

        // Delete testimonial
        window.deleteTestimonial = async (id) => {
            if (!confirm('Are you sure you want to delete this testimonial? This action cannot be undone.')) return;
            
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                await deleteDoc(doc(db, 'testimonials', id));
                showSuccess('Testimonial deleted successfully!');
                loadTestimonials();
            } catch (error) {
                console.error('Error deleting testimonial:', error);
                showError('Error deleting testimonial: ' + error.message);
            }
        };

        // Show success/error messages
        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            document.getElementById('successText').textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        // Load testimonials is triggered after auth is ready (see onAuthStateChanged above).

        // ========== LIVE CHAT MANAGEMENT ==========
        let selectedChatId = null;

        // Load all chats
        async function loadChats() {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, orderBy, onSnapshot } = firestoreModule;
                const chatsRef = collection(db, 'live_chats');
                const q = query(chatsRef, orderBy('lastMessageAt', 'desc'));

                onSnapshot(q, async (snapshot) => {
                    const chats = [];
                    let totalUnread = 0;

                    snapshot.forEach(doc => {
                        const chatData = doc.data();
                        chats.push({
                            id: doc.id,
                            ...chatData
                        });
                    });

                    // Count unread messages for each chat
                    for (const chat of chats) {
                        const unread = await getUnreadCount(chat.id);
                        totalUnread += unread;
                    }

                    renderChatsList(chats);
                    updateAdminChatBadge(totalUnread);
                }, (err) => {
                    console.error('Live chat listener error:', err);
                    const msg = err?.message || String(err);
                    document.getElementById('chatsList').innerHTML =
                      `<p class="text-red-600 text-center py-8">Live chat failed to load: ${msg}</p>`;
                    showError('Live chat failed to load: ' + msg);
                });
            } catch (error) {
                console.error('Error loading chats:', error);
                document.getElementById('chatsList').innerHTML = '<p class="text-red-500 text-center py-8">Error loading chats. Please refresh.</p>';
            }
        }

        async function getUnreadCount(chatId) {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, where, getDocs } = firestoreModule;
                const messagesRef = collection(db, 'live_chats', chatId, 'messages');
                const q = query(messagesRef, where('read', '==', false), where('sender', '==', 'user'));
                const snapshot = await getDocs(q);
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }

        function renderChatsList(chats) {
            const listEl = document.getElementById('chatsList');
            
            if (chats.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-8">No active chats yet.</p>';
                return;
            }

            listEl.innerHTML = chats.map(chat => {
                const date = chat.lastMessageAt?.toDate ? chat.lastMessageAt.toDate().toLocaleDateString() : 'N/A';
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition ${selectedChatId === chat.id ? 'bg-blue-50 border-blue-300' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 cursor-pointer" onclick="selectChat('${chat.id}', '${chat.userName || 'User'}')">
                                <h3 class="font-semibold text-gray-900">${chat.userName || 'User'}</h3>
                                <p class="text-sm text-gray-600">${chat.userId || 'Unknown'}</p>
                                <p class="text-xs text-gray-500 mt-1">Last message: ${date}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${chat.status === 'open' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${chat.status || 'open'}
                                </span>
                                <span id="unreadBadge-${chat.id}" class="bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                                <button onclick="event.stopPropagation(); deleteChat('${chat.id}')" class="text-red-500 hover:text-red-700 p-1" title="Delete Chat">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Load unread counts
            chats.forEach(async (chat) => {
                const unread = await getUnreadCount(chat.id);
                const badge = document.getElementById(`unreadBadge-${chat.id}`);
                if (badge) {
                    if (unread > 0) {
                        badge.textContent = unread;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });
        }

        async function selectChat(chatId, userName) {
            selectedChatId = chatId;
            const allChats = await getAllChats();
            renderChatsList(allChats);
            await loadChatMessages(chatId, userName);
        }

        async function getAllChats() {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, orderBy, getDocs } = firestoreModule;
                const chatsRef = collection(db, 'live_chats');
                const q = query(chatsRef, orderBy('lastMessageAt', 'desc'));
                const snapshot = await getDocs(q);
                
                const chats = [];
                snapshot.forEach(doc => {
                    chats.push({ id: doc.id, ...doc.data() });
                });
                return chats;
            } catch (error) {
                return [];
            }
        }

        async function loadChatMessages(chatId, userName) {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, orderBy, onSnapshot, getDocs } = firestoreModule;
                const messagesRef = collection(db, 'live_chats', chatId, 'messages');
                const q = query(messagesRef, orderBy('timestamp', 'asc'));

                // Create chat view
                const chatSection = document.getElementById('chatSection');
                const existingView = document.getElementById('chatView');
                if (existingView) existingView.remove();

                const chatView = document.createElement('div');
                chatView.id = 'chatView';
                chatView.className = 'mt-6 border-t border-gray-200 pt-6';
                chatView.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Chat with ${userName}</h3>
                        <button onclick="closeChatView()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="chatMessagesArea" class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto mb-4 space-y-3">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="adminReplyInput" placeholder="Type your reply..." 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            style="font-size: 16px !important;">
                        <button onclick="sendAdminReply('${chatId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-paper-plane mr-2"></i>Send
                        </button>
                    </div>
                `;
                chatSection.appendChild(chatView);

                // Load initial messages first in chronological order
                const initialSnapshot = await getDocs(q);
                const messagesArea = document.getElementById('chatMessagesArea');
                if (messagesArea) {
                    messagesArea.innerHTML = '';
                    
                    // Collect and sort messages by timestamp
                    const messages = [];
                    initialSnapshot.forEach(doc => {
                        const msg = { id: doc.id, ...doc.data() };
                        messages.push(msg);
                    });
                    
                    // Sort by timestamp (oldest first, newest last)
                    messages.sort((a, b) => {
                        const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (a.timestamp || 0);
                        const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (b.timestamp || 0);
                        return timeA - timeB;
                    });
                    
                    // Append messages in order
                    messages.forEach(msg => {
                        addMessageToAdminView(msg);
                    });
                    
                    // Scroll to bottom after loading
                    setTimeout(() => {
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }, 100);
                }

                // Listen for new messages in real-time
                onSnapshot(q, (snapshot) => {
                    const messagesArea = document.getElementById('chatMessagesArea');
                    if (!messagesArea) return;
                    
                    // Track existing message IDs to avoid duplicates
                    const existingIds = new Set();
                    messagesArea.querySelectorAll('[data-msg-id]').forEach(el => {
                        existingIds.add(el.getAttribute('data-msg-id'));
                    });
                    
                    // Collect new messages and sort them
                    const newMessages = [];
                    snapshot.forEach(doc => {
                        const msgId = doc.id;
                        if (!existingIds.has(msgId)) {
                            const msg = { id: msgId, ...doc.data() };
                            newMessages.push(msg);
                        }
                    });
                    
                    // Sort new messages by timestamp
                    newMessages.sort((a, b) => {
                        const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (a.timestamp || 0);
                        const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (b.timestamp || 0);
                        return timeA - timeB;
                    });
                    
                    // Add new messages in order (append at bottom)
                    newMessages.forEach(msg => {
                        addMessageToAdminView(msg);
                    });
                    
                    // Scroll to bottom when new messages arrive
                    setTimeout(() => {
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }, 100);
                });

                // Mark messages as read
                await markChatAsRead(chatId);
            } catch (error) {
                console.error('Error loading chat messages:', error);
            }
        }

        function addMessageToAdminView(msg) {
            const messagesArea = document.getElementById('chatMessagesArea');
            if (!messagesArea) return;

            const msgId = msg.id || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Check if message already exists to prevent duplicates
            if (messagesArea.querySelector(`[data-msg-id="${msgId}"]`)) {
                return;
            }

            const isAdmin = msg.sender === 'admin';
            let imageHtml = '';
            // Support both imageUrl (legacy) and imageBase64 (new method)
            const imageSrc = msg.imageBase64 || msg.imageUrl;
            if (imageSrc) {
                imageHtml = `
                    <div class="mb-2 rounded-lg overflow-hidden shadow-md">
                        <img src="${imageSrc}" alt="Shared image" class="max-w-full max-h-64 cursor-pointer hover:opacity-90 rounded transition-opacity" onclick="window.open('${imageSrc}', '_blank')">
                    </div>
                `;
            }
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex ${isAdmin ? 'justify-end' : 'justify-start'} mb-3`;
            msgDiv.setAttribute('data-msg-id', msgId);
            msgDiv.innerHTML = `
                <div class="max-w-[80%] ${isAdmin ? 'bg-blue-600 text-white' : 'bg-white text-gray-900 border border-gray-200'} rounded-lg p-3 shadow-sm">
                    ${imageHtml}
                    ${msg.text ? `<div class="text-sm ${isAdmin ? 'text-white' : 'text-gray-800'}">${escapeHtml(msg.text)}</div>` : ''}
                    <div class="text-xs mt-1.5 ${isAdmin ? 'text-blue-100 opacity-80' : 'text-gray-500'}">${formatChatTime(msg.timestamp)}</div>
                </div>
            `;
            
            // Always append at bottom to maintain chronological order
            messagesArea.appendChild(msgDiv);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatChatTime(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        async function sendAdminReply(chatId) {
            const input = document.getElementById('adminReplyInput');
            const text = input.value.trim();
            if (!text || !chatId) return;

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, addDoc, serverTimestamp, updateDoc, doc } = firestoreModule;
                
                // Add message
                await addDoc(collection(db, 'live_chats', chatId, 'messages'), {
                    text,
                    sender: 'admin',
                    timestamp: serverTimestamp(),
                    read: false
                });

                // Update chat
                await updateDoc(doc(db, 'live_chats', chatId), {
                    lastMessageAt: serverTimestamp(),
                    status: 'open'
                });

                input.value = '';
            } catch (error) {
                console.error('Error sending reply:', error);
                showError('Failed to send message. Please try again.');
            }
        }

        async function markChatAsRead(chatId) {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, where, getDocs, updateDoc, doc } = firestoreModule;
                const messagesRef = collection(db, 'live_chats', chatId, 'messages');
                const q = query(messagesRef, where('read', '==', false), where('sender', '==', 'user'));
                const snapshot = await getDocs(q);
                
                snapshot.forEach(async (msgDoc) => {
                    await updateDoc(doc(db, 'live_chats', chatId, 'messages', msgDoc.id), {
                        read: true
                    });
                });

                loadChats(); // Refresh list
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        function closeChatView() {
            const chatView = document.getElementById('chatView');
            if (chatView) chatView.remove();
            selectedChatId = null;
        }

        function updateAdminChatBadge(count) {
            const badge = document.getElementById('adminChatBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // Load chats after auth is ready
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadChats();
            }
        });

        async function deleteChat(chatId) {
            if (!confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
                return;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, getDocs, deleteDoc, doc } = firestoreModule;
                
                // Delete all messages in the chat
                const messagesRef = collection(db, 'live_chats', chatId, 'messages');
                const messagesSnapshot = await getDocs(messagesRef);
                
                const deletePromises = messagesSnapshot.docs.map(msgDoc => 
                    deleteDoc(doc(db, 'live_chats', chatId, 'messages', msgDoc.id))
                );
                await Promise.all(deletePromises);
                
                // Delete the chat document
                await deleteDoc(doc(db, 'live_chats', chatId));
                
                // Close chat view if it's the deleted chat
                if (selectedChatId === chatId) {
                    closeChatView();
                }
                
                // Reload chats
                loadChats();
                showSuccess('Chat deleted successfully!');
            } catch (error) {
                console.error('Error deleting chat:', error);
                showError('Failed to delete chat. Please try again.');
            }
        }

        // Section switching function
        function showSection(section) {
            // Hide all sections
            document.getElementById('testimonialsSection').classList.add('hidden');
            document.getElementById('chatSection').classList.add('hidden');
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section and update nav
            if (section === 'testimonials') {
                document.getElementById('testimonialsSection').classList.remove('hidden');
                document.querySelector('a[onclick*="testimonials"]').classList.add('active');
                document.getElementById('pageTitle').textContent = 'Testimonials';
            } else if (section === 'chat') {
                document.getElementById('chatSection').classList.remove('hidden');
                document.querySelector('a[onclick*="chat"]').classList.add('active');
                document.getElementById('pageTitle').textContent = 'Live Chat';
                // Load chats if not already loaded
                if (document.getElementById('chatsList').innerHTML.includes('Loading')) {
                    loadChats();
                }
            }
            
            // Close mobile sidebar if open
            if (window.innerWidth < 768) {
                document.querySelector('.sidebar').classList.remove('open');
            }
        }

        // Sidebar toggle for mobile
        document.getElementById('openSidebar')?.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.add('open');
        });
        document.getElementById('closeSidebar')?.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.remove('open');
        });

        // Expose functions globally
        window.showSection = showSection;
        window.selectChat = selectChat;
        window.sendAdminReply = sendAdminReply;
        window.closeChatView = closeChatView;
        window.deleteChat = deleteChat;
    </script>
</body>
</html>

