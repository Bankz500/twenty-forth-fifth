<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Manage Testimonials | Twenty Forth & Fifth</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .success-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left: 3px solid #60a5fa;
        }
        .nav-item.active:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }
        .sidebar {
            display: flex;
            flex-direction: column;
        }
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
        }
        .sidebar-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            margin-top: auto;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar fixed md:static inset-y-0 left-0 z-50 w-64 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white shadow-2xl">
            <!-- Sidebar Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-700/50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center shadow-lg">
                        <i class="fas fa-shield-alt text-white text-lg"></i>
                    </div>
                <div>
                        <h1 class="text-lg font-bold text-white">Admin Panel</h1>
                        <p class="text-xs text-slate-400">Twenty Forth & Fifth</p>
                </div>
                </div>
                <button id="closeSidebar" class="md:hidden text-slate-400 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav p-4 space-y-1">
                <a href="#testimonials" onclick="showSection('testimonials'); return false;" 
                   class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-star text-slate-300 group-hover:text-white group-hover:scale-110 transition-transform transition-colors"></i>
                    </div>
                    <span class="font-medium text-sm">Testimonials</span>
                </a>
                <a href="#chat" onclick="showSection('chat'); return false;" 
                   class="nav-item relative flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-comments text-slate-300 group-hover:text-white transition-colors"></i>
                    </div>
                    <span class="font-medium text-sm">Live Chat</span>
                    <span id="adminChatBadge" class="ml-auto text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5 hidden shadow-lg" style="background-color: #15803d;">0</span>
                </a>
                <a href="#kyc" onclick="showSection('kyc'); return false;" 
                   class="nav-item relative flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-id-card text-slate-300 group-hover:text-white transition-colors"></i>
                    </div>
                    <span class="font-medium text-sm">KYC Verification</span>
                    <span id="adminKYCBadge" class="ml-auto text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5 hidden shadow-lg" style="background-color: #15803d;">0</span>
                </a>
                <a href="#loans" onclick="showSection('loans'); return false;" 
                   class="nav-item relative flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-money-bill-wave text-slate-300 group-hover:text-white transition-colors"></i>
                    </div>
                    <span class="font-medium text-sm">Loan Requests</span>
                    <span id="adminLoanBadge" class="ml-auto text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5 hidden shadow-lg" style="background-color: #15803d;">0</span>
                </a>
                <a href="#transfers" onclick="showSection('transfers'); return false;" 
                   class="nav-item relative flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-exchange-alt text-slate-300 group-hover:text-white transition-colors"></i>
                    </div>
                    <span class="font-medium text-sm">Transfers</span>
                    <span id="adminTransferBadge" class="ml-auto text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5 hidden shadow-lg" style="background-color: #15803d;">0</span>
                </a>
                <a href="#debit-cards" onclick="showSection('debitCards'); return false;" 
                   class="nav-item relative flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-credit-card text-slate-300 group-hover:text-white transition-colors"></i>
                    </div>
                    <span class="font-medium text-sm">Debit Cards</span>
                    <span id="adminDebitCardBadge" class="ml-auto text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5 hidden shadow-lg" style="background-color: #15803d;">0</span>
                </a>
                <a href="#users" onclick="showSection('users'); return false;"
                   class="nav-item relative flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-users text-slate-300 group-hover:text-white transition-colors"></i>
                    </div>
                    <span class="font-medium text-sm">Users</span>
                </a>
            </nav>

            <!-- Sidebar Footer with Logout -->
            <div class="sidebar-footer">
                <button onclick="signOut()" 
                   class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/10 hover:border-white/10 border border-transparent cursor-pointer group">
                    <div class="w-5 flex justify-center">
                        <i class="fas fa-sign-out-alt text-slate-400 group-hover:text-white transition-colors"></i>
                    </div>
                    <span class="font-medium text-sm text-slate-300 group-hover:text-white transition-colors">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button id="openSidebar" class="md:hidden text-gray-600 hover:text-gray-900">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <h2 id="pageTitle" class="text-2xl font-bold text-gray-900">Testimonials</h2>
            </div>
        </div>
                    <div class="hidden sm:flex items-center gap-2">
                        <span id="adminAuthPill" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-50 text-gray-700 border border-gray-200">
                            <span class="w-2 h-2 rounded-full bg-gray-300"></span>
                            <span id="adminAuthEmail">Not signed in</span>
                        </span>
                    </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-6">
                <div class="max-w-7xl mx-auto">

        <!-- Success Message -->
        <div id="successMessage" class="hidden success-message bg-white border border-gray-200 text-gray-900 px-4 py-3 rounded-lg mb-4">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successText"></span>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-white border border-gray-200 text-gray-900 px-4 py-3 rounded-lg mb-4">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorText"></span>
        </div>

        <!-- Testimonials Section -->
        <div id="testimonialsSection">
        <!-- Add Testimonial Form -->
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-plus-circle text-gray-800 mr-2"></i>
                Add New Testimonial
            </h2>
            <form id="testimonialForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Author Name *</label>
                        <input type="text" id="authorName" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 bg-white"
                            placeholder="John Smith">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company *</label>
                        <input type="text" id="company" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 bg-white"
                            placeholder="ABC Corporation">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Country *</label>
                        <input type="text" id="country" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 bg-white"
                            placeholder="United States">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rating *</label>
                        <select id="rating" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 bg-white">
                            <option value="">Select rating</option>
                            <option value="5">5 ⭐⭐⭐⭐⭐</option>
                            <option value="4">4 ⭐⭐⭐⭐</option>
                            <option value="3">3 ⭐⭐⭐</option>
                            <option value="2">2 ⭐⭐</option>
                            <option value="1">1 ⭐</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Like Count (75–300)</label>
                    <input type="number" id="likeCount" min="0"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 bg-white"
                        placeholder="Leave empty to auto-generate">
                    <p class="text-xs text-gray-500 mt-1">If empty: new testimonials get a random value (75–300). When editing, leaving empty keeps the current value.</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Review Text *</label>
                    <textarea id="reviewText" required rows="4"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 bg-white"
                        placeholder="Enter the testimonial text here..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Author Image (Optional)</label>
                    <div class="flex items-center gap-4">
                        <input type="file" id="authorImage" accept="image/*"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white">
                        <div id="imagePreview" class="hidden">
                            <img id="previewImg" src="" alt="Preview" class="w-20 h-20 object-cover rounded-lg border border-gray-300">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Upload a profile image for the testimonial author (max 2MB)</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Published Date (Optional)</label>
                    <input type="date" id="publishedDate"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 bg-white">
                    <p class="text-xs text-gray-500 mt-1">Leave empty to use current date</p>
                </div>

                <div class="flex items-center gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="verified" checked
                            class="mr-2 w-4 h-4 text-gray-900 border-gray-300 rounded focus:ring-gray-900">
                        <span class="text-sm text-gray-700">Verified</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="published" checked
                            class="mr-2 w-4 h-4 text-gray-900 border-gray-300 rounded focus:ring-gray-900">
                        <span class="text-sm text-gray-700">Published (visible on testimonials page)</span>
                    </label>
                </div>

                <div class="flex gap-2">
                  <button type="submit" id="submitBtn"
                          class="flex-1 text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                        <i class="fas fa-save mr-2"></i><span id="submitBtnText">Add Testimonial</span>
                    </button>
                    <button type="button" id="cancelEditBtn" onclick="cancelEdit()" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-times mr-2"></i>Cancel
                </button>
                </div>
            </form>
        </div>

        <!-- Add Sample Testimonials -->
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-magic text-gray-800 mr-2"></i>
                Quick Setup
            </h2>
            <p class="text-gray-600 text-sm mb-4">Add realistic sample testimonials to get started quickly.</p>
            <div class="flex flex-col sm:flex-row gap-2">
            <button id="addSamplesBtn"
                class="text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                <i class="fas fa-sparkles mr-2"></i>Add Sample Testimonials
            </button>
                <button id="backfillLikesBtn"
                    class="text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="background-color: #140099;" onmouseover="this.style.backgroundColor='#0d0066'" onmouseout="this.style.backgroundColor='#140099'">
                    <i class="fas fa-thumbs-up mr-2"></i>Assign Random Like Counts
            </button>
            <button id="deleteAllTestimonialsBtn"
                class="text-white font-semibold py-2 px-4 rounded-lg transition-colors bg-red-600 hover:bg-red-700" onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#dc2626'">
                <i class="fas fa-trash-alt mr-2"></i>Delete All Testimonials
            </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Assigns a random like count (75–300) to every testimonial (overwrites existing values).</p>
        </div>

        <!-- Existing Testimonials List -->
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-list text-gray-700 mr-2"></i>
                    Existing Testimonials
                </h2>
            </div>
            <div id="testimonialsList" class="space-y-4">
                <p class="text-gray-500 text-center py-8">Loading testimonials...</p>
                </div>
            </div>
        </div>

        <!-- Live Chat Management Section -->
        <div id="chatSection" class="hidden bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-950 mb-4">
                <i class="fas fa-comments text-gray-800 mr-2"></i>
                Live Chat
            </h2>

            <!-- Start chat -->
            <div class="mb-6 bg-white border border-gray-200 rounded-xl p-4">
                <h3 class="text-sm font-semibold text-gray-950 mb-3">
                    <i class="fas fa-plus text-gray-800 mr-2"></i>
                    Start a chat
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-3 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-800 mb-1">Select user</label>
                        <select id="chatUserSelect"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white">
                            <option value="">Loading users...</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Creates (or opens) a live chat for the selected user.</p>
                    </div>
                    <button type="button"
                            id="startChatBtn"
                            class="px-4 py-2.5 rounded-lg text-white text-sm font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'"
                            onclick="window.startChatForSelectedUser && window.startChatForSelectedUser()"
                            disabled>
                        Start chat
                    </button>
                </div>
            </div>

            <div id="chatsList" class="space-y-4">
                <p class="text-gray-500 text-center py-8">Loading chats...</p>
            </div>
        </div>

        <!-- KYC Verification Management Section -->
        <div id="kycSection" class="hidden bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-950 mb-4">
                <i class="fas fa-id-card text-gray-800 mr-2"></i>
                KYC
            </h2>
            <div id="kycList" class="space-y-4">
                <p class="text-gray-500 text-center py-8">Loading KYC requests...</p>
            </div>
        </div>

        <!-- Loan Requests Management Section -->
        <div id="loansSection" class="hidden bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-950 mb-4">
                <i class="fas fa-money-bill-wave text-gray-800 mr-2"></i>
                Loans
            </h2>
            <div id="loansList" class="space-y-4">
                <p class="text-gray-500 text-center py-8">Loading loan requests...</p>
            </div>
        </div>

        <!-- Transfers Management Section -->
        <div id="transfersSection" class="hidden bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <div class="flex items-start justify-between gap-4 mb-5">
                <div>
                    <h2 class="text-xl font-semibold text-gray-950 mb-1">
                        <i class="fas fa-exchange-alt text-gray-800 mr-2"></i>
                        Transfer Management
                    </h2>
                    <p class="text-sm text-gray-600">
                        Review, approve, and edit pending transfers. Approved transfers move to user history.
                    </p>
                </div>
                <span id="transferBadge" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">
                    0 pending
                </span>
            </div>

            <!-- Pending Transfers -->
            <div class="mb-6 bg-white border border-gray-200 rounded-xl p-4">
                <h3 class="text-sm font-semibold text-gray-950 mb-3">
                    <i class="fas fa-clock text-gray-800 mr-2"></i>
                    Pending Transfers
                </h3>
                <div id="pendingTransfersList" class="space-y-3">
                    <p class="text-gray-500 text-center py-4 text-sm">Loading pending transfers...</p>
                </div>
            </div>

            <!-- History Management -->
            <div class="bg-white border border-gray-200 rounded-xl p-4">
                <h3 class="text-sm font-semibold text-gray-950 mb-3">
                    <i class="fas fa-history text-gray-800 mr-2"></i>
                    Edit History Entries
                </h3>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-800 mb-1">Select user to edit history</label>
                    <select id="transferHistoryUserSelect"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white">
                        <option value="">Select user...</option>
                    </select>
                </div>
                <div id="transferHistoryList" class="space-y-2 max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-3">
                    <p class="text-xs text-gray-500 text-center py-4">Select a user to view/edit their history entries</p>
                </div>
            </div>
        </div>

        <!-- Debit Cards Management Section -->
        <div id="debitCardsSection" class="hidden bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <div class="flex items-start justify-between gap-4 mb-5">
                <div>
                    <h2 class="text-xl font-semibold text-gray-950 mb-1">
                        <i class="fas fa-credit-card text-gray-800 mr-2"></i>
                        Debit Cards
                    </h2>
                    <p class="text-sm text-gray-600">
                        Review debit card requests, approve them, and issue virtual cards.
                    </p>
                </div>
                <span id="debitCardBadge" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">
                    0 pending
                </span>
            </div>

            <div class="bg-white border border-gray-200 rounded-xl p-4 mb-6">
                <h3 class="text-sm font-semibold text-gray-950 mb-2">
                    Pending requests
                </h3>
                <div id="debitCardRequestsList" class="space-y-3">
                    <p class="text-gray-500 text-center py-4 text-sm">Loading debit card requests...</p>
                </div>
                <p class="text-xs text-gray-500 mt-3">
                    Approving issues a virtual card and makes it visible to the user in <code>debit-card.html</code>.
                </p>
            </div>

            <div class="bg-white border border-gray-200 rounded-xl p-4">
                <h3 class="text-sm font-semibold text-gray-950 mb-2">
                    Issued cards
                </h3>
                <div id="issuedDebitCardsList" class="space-y-3">
                    <p class="text-gray-500 text-center py-4 text-sm">Loading issued cards...</p>
                </div>
            </div>
        </div>

        <!-- Users Management Section -->
        <div id="usersSection" class="hidden bg-white border border-gray-200 rounded-xl shadow-sm p-6">
            <div class="flex items-start justify-between gap-4 mb-5">
                <div>
                    <h2 class="text-xl font-semibold text-gray-950">
                        <i class="fas fa-users text-gray-800 mr-2"></i>
                        Users
            </h2>
                    <p class="text-sm text-gray-600 mt-1">
                        Manage user accounts, balances, history entries, and approval access.
            </p>
                </div>
            </div>

            <!-- Account approval requests -->
            <div class="mb-6 bg-white border border-gray-200 rounded-xl p-4">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
                    <h3 class="text-sm font-semibold text-gray-950">
                        <i class="fas fa-user-check text-gray-800 mr-2"></i>
                        Account Sign‑Up Requests
                    </h3>
                    <div class="flex flex-wrap items-center gap-2 justify-end">
                        <label class="flex items-center gap-2 text-xs text-gray-700 cursor-pointer select-none">
                            <input type="checkbox" id="approvalSelectAll" class="rounded border-gray-300 focus:ring-2 focus:ring-gray-900">
                            Select all
                        </label>
                        <button type="button"
                                id="approveSelectedAccountsBtn"
                                class="px-3 py-1.5 rounded-lg text-white text-xs font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'"
                                disabled>
                            Approve selected
                        </button>
                        <button type="button"
                                id="approveAllAccountsBtn"
                                class="px-3 py-1.5 rounded-lg bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 text-xs font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed">
                            Approve all
                        </button>
                        <span id="approvalBadge" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">
                        0 pending
                    </span>
                </div>
                </div>
                <p id="approvalSelectedCount" class="text-xs text-gray-500 mb-2"></p>
                <div id="approvalRequestsList" class="space-y-3">
                    <p class="text-gray-500 text-center py-4 text-sm">Loading approval requests...</p>
                </div>
                <p class="text-xs text-gray-500 mt-3">
                    New accounts are created as <code>pending</code>. Approving enables dashboard access.
                </p>
            </div>

            <!-- User selector -->
            <div class="mb-6 bg-white border border-gray-200 rounded-xl p-4">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="lg:col-span-1">
                        <label class="block text-sm font-medium text-gray-800 mb-1">Select user</label>
                    <select id="adminUserSelect"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white">
                        <option value="">Loading users...</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        Users are loaded from Firestore <code>users</code> collection (admins only).
                    </p>
                </div>

                <!-- Summary -->
                <div class="lg:col-span-2">
                        <div id="adminUserSummary" class="bg-white border border-gray-200 rounded-lg p-4 text-sm text-gray-800">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1">
                                <p class="mb-0.5"><span class="font-semibold">UID:</span> <span id="adminUserId">-</span></p>
                                <p class="mb-0.5"><span class="font-semibold">Status:</span> <span id="adminUserStatusLabel">-</span></p>
                                <p class="mb-0.5"><span class="font-semibold">Name:</span> <span id="adminUserName">-</span></p>
                                <p class="mb-0.5"><span class="font-semibold">Email:</span> <span id="adminUserEmail">-</span></p>
                                <p class="mb-0.5"><span class="font-semibold">Checking:</span> <span id="adminUserChecking">-</span></p>
                                <p class="mb-0.5"><span class="font-semibold">Fixed:</span> <span id="adminUserFixed">-</span></p>
                                <p class="mb-0.5"><span class="font-semibold">Savings:</span> <span id="adminUserSavings">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Currency Setting Section -->
            <div class="mb-6 bg-white border border-gray-200 rounded-xl p-4">
                <h3 class="text-sm font-semibold text-gray-950 mb-3">
                    <i class="fas fa-dollar-sign text-gray-800 mr-2"></i>
                    Currency Settings
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-800 mb-1">Currency Sign</label>
                        <input 
                            type="text" 
                            id="adminCurrencySign" 
                            maxlength="5"
                            placeholder="$"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white"
                        />
                        <p class="text-xs text-gray-500 mt-1">
                            Set the currency symbol to display with account balances (e.g., $, €, £, ¥). This will be used for checking, savings, and fixed account balances.
                        </p>
                        <div class="mt-2 text-xs text-gray-600">
                            <strong>Current setting:</strong> <span id="adminCurrencyDisplay">Loading...</span>
                        </div>
                    </div>
                    <div class="flex flex-col justify-end gap-2">
                        <button 
                            type="button"
                            id="adminSaveCurrencyBtn"
                            onclick="window.adminSaveCurrency && window.adminSaveCurrency()"
                            class="w-full text-white text-sm font-semibold py-2.5 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                            <i class="fas fa-save mr-2"></i>
                            Save Currency
                        </button>
                        <div id="adminCurrencyStatus" class="text-xs text-gray-600"></div>
                    </div>
                </div>
            </div>

            <!-- Generate History Section -->
            <div class="mb-6 bg-white border border-gray-200 rounded-xl p-4">
                <h3 class="text-sm font-semibold text-gray-950 mb-3">
                    <i class="fas fa-magic text-gray-800 mr-2"></i>
                    Generate History
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-800 mb-1">History entry template</label>
                        <input 
                            type="text" 
                            id="adminHistoryTemplateInput" 
                            placeholder="Deposit | 15-Aug-25 | Gerald Sell Jr | CP456 | +$50,000.00 | 10:22 am | TXN9A7F3C2E8B41 |"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm font-mono bg-white"
                            onkeypress="if(event.key === 'Enter') { event.preventDefault(); window.adminGenerateHistory && window.adminGenerateHistory(); }"
                        />
                        <p class="text-xs text-gray-500 mt-1">
                            Enter a history entry template. The system will generate 15 variations with backdated dates (working days) and unique transaction IDs.
                        </p>
                    </div>
                    <div class="flex flex-col justify-end gap-2">
                        <button 
                            type="button"
                            id="adminGenerateHistoryBtn"
                            onclick="window.adminGenerateHistory && window.adminGenerateHistory()"
                            class="w-full text-white text-sm font-semibold py-2.5 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Generate 15 Histories
                        </button>
                        <div id="adminHistoryGenStatus" class="text-xs text-gray-600"></div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Add/Edit Checking -->
                <div class="space-y-3 bg-white border border-gray-200 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-950">Checking Account</h3>
                    <div class="space-y-2">
                        <label class="block text-xs font-medium text-gray-700">Add Amount</label>
                        <input id="adminCheckingAddAmount"
                               type="text"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white"
                               placeholder="e.g. $1,200.00">
                        <button type="button"
                                id="adminAddCheckingBtn"
                                onclick="window.adminAddChecking && window.adminAddChecking()"
                                class="w-full text-white text-xs font-semibold py-2 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                            Add Amount
                        </button>
                    </div>
                    <div class="space-y-2 pt-2 border-t border-gray-200">
                        <label class="block text-xs font-medium text-gray-700">Set Amount (Edit)</label>
                        <input id="adminCheckingSetAmount"
                               type="text"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white"
                               placeholder="e.g. $5,000.00">
                        <button type="button"
                                id="adminSetCheckingBtn"
                                onclick="window.adminSetChecking && window.adminSetChecking()"
                                class="w-full text-white text-xs font-semibold py-2 rounded-lg transition-colors bg-gray-700 hover:bg-gray-800">
                            Set Amount
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">
                        Updates the user's <code>checking</code> field in Firestore.
                    </p>
                </div>

                <!-- Add/Edit Fixed -->
                <div class="space-y-3 bg-white border border-gray-200 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-950">Fixed Account</h3>
                    <div class="space-y-2">
                        <label class="block text-xs font-medium text-gray-700">Add Amount</label>
                        <input id="adminFixedAddAmount"
                               type="text"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white"
                               placeholder="e.g. $1,200.00">
                        <button type="button"
                                id="adminAddFixedBtn"
                                onclick="window.adminAddFixed && window.adminAddFixed()"
                                class="w-full text-white text-xs font-semibold py-2 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                            Add Amount
                        </button>
                    </div>
                    <div class="space-y-2 pt-2 border-t border-gray-200">
                        <label class="block text-xs font-medium text-gray-700">Set Amount (Edit)</label>
                        <input id="adminFixedSetAmount"
                               type="text"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white"
                               placeholder="e.g. $5,000.00">
                        <button type="button"
                                id="adminSetFixedBtn"
                                onclick="window.adminSetFixed && window.adminSetFixed()"
                                class="w-full text-white text-xs font-semibold py-2 rounded-lg transition-colors bg-gray-700 hover:bg-gray-800">
                            Set Amount
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">
                        Updates the user's <code>fixed</code> field in Firestore.
                    </p>
                </div>

                <!-- Add/Edit Savings -->
                <div class="space-y-3 bg-white border border-gray-200 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-950">Savings Account</h3>
                    <div class="space-y-2">
                        <label class="block text-xs font-medium text-gray-700">Add Amount</label>
                        <input id="adminSavingsAddAmount"
                               type="text"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white"
                               placeholder="e.g. $1,200.00">
                        <button type="button"
                                id="adminAddSavingsBtn"
                                onclick="window.adminAddSavings && window.adminAddSavings()"
                                class="w-full text-white text-xs font-semibold py-2 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                            Add Amount
                        </button>
                    </div>
                    <div class="space-y-2 pt-2 border-t border-gray-200">
                        <label class="block text-xs font-medium text-gray-700">Set Amount (Edit)</label>
                        <input id="adminSavingsSetAmount"
                               type="text"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white"
                               placeholder="e.g. $5,000.00">
                        <button type="button"
                                id="adminSetSavingsBtn"
                                onclick="window.adminSetSavings && window.adminSetSavings()"
                                class="w-full text-white text-xs font-semibold py-2 rounded-lg transition-colors bg-gray-700 hover:bg-gray-800">
                            Set Amount
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">
                        Updates the user's <code>savings</code> field in Firestore.
                    </p>
                </div>

                <!-- History 1–15 bulk update -->
                <div class="space-y-3 lg:col-span-2 bg-white border border-gray-200 rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-gray-950">History 1–15</h3>
                        <div class="flex items-center gap-2">
                            <label class="flex items-center gap-1 text-xs text-gray-700 cursor-pointer">
                                <input type="checkbox" id="adminSelectAllHistory" class="rounded border-gray-300 focus:ring-2 focus:ring-gray-900">
                                Select All
                            </label>
                        </div>
                    </div>
                    <div id="adminHistoryList" class="border border-gray-300 rounded-lg p-3 max-h-96 overflow-y-auto space-y-2">
                        <!-- History entries will be populated here -->
                        <p class="text-xs text-gray-500 text-center py-4">Generate histories or load existing ones to view/edit</p>
                    </div>
                    <div class="flex gap-2">
                        <button type="button"
                                id="adminSaveHistoryBtn"
                                onclick="window.adminSaveHistory && window.adminSaveHistory()"
                                class="flex-1 text-white text-sm font-semibold py-2.5 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                            Save History 1–15
                        </button>
                        <button type="button"
                                id="adminDeleteHistoryBtn"
                                onclick="window.adminDeleteHistory && window.adminDeleteHistory()"
                                class="flex-1 bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 text-sm font-semibold py-2.5 rounded-lg transition-colors">
                            <i class="fas fa-trash mr-1"></i>
                            Delete Selected
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">
                        Up to 15 entries will be written to <code>history1</code>–<code>history15</code> on the user's document. Check entries to delete them.
                    </p>
                </div>

                <!-- Status update -->
                <div class="space-y-3 bg-white border border-gray-200 rounded-xl p-4">
                    <h3 class="text-sm font-semibold text-gray-950">Update status</h3>
                    <select id="adminUserStatusSelect"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm bg-white">
                        <option value="">Select status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="suspended">Suspended</option>
                        <option value="processing">Processing / Under Review</option>
                        <option value="banned">Banned</option>
                    </select>
                    <button type="button"
                            id="adminSaveStatusBtn"
                            onclick="window.adminSaveStatus && window.adminSaveStatus()"
                            class="w-full text-white text-sm font-semibold py-2.5 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                        Update Status
                    </button>
                    <p class="text-xs text-gray-500">
                        Writes the selected value to the user's <code>status</code> field, which is used across the app (e.g., to allow or block transfers).
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, getDoc, setDoc, serverTimestamp, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA3x-CZApUgkWHCjlwvFtOQhYQeY6lDwpI",
            authDomain: "twenty-forth-fifth.firebaseapp.com",
            projectId: "twenty-forth-fifth",
            storageBucket: "twenty-forth-fifth.firebasestorage.app",
            messagingSenderId: "228269383587",
            appId: "1:228269383587:web:0d6f063f221f388cd2c416",
            measurementId: "G-3X9DT5MBV4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Sign out function
        window.signOut = async function() {
            const { signOut: firebaseSignOut } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
            try {
                await firebaseSignOut(auth);
                window.location.href = 'admin-login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            }
        };

        // Check authentication
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'admin-login.html';
                return;
            }
            // Debug: Log admin email to verify it matches rules
            console.log('Admin logged in with email:', user.email);
            console.log('Admin UID:', user.uid);
            
            // Show signed-in email in header + basic allowlist indicator (matches firestore.rules isAdmin())
            try {
                const allowlist = new Set(['bealoffshore@gmail.com','admin123@gmail.com','harleyzain70@gmail.com']);
                const email = (user.email || '').trim();
                const pill = document.getElementById('adminAuthPill');
                const emailEl = document.getElementById('adminAuthEmail');
                if (emailEl) emailEl.textContent = email || 'Unknown email';
                if (pill) {
                    const dot = pill.querySelector('span.w-2.h-2');
                    const isAllowed = allowlist.has(email);
                    // gray default → green if allowlisted → amber otherwise
                    if (dot) {
                        dot.classList.remove('bg-gray-300','bg-green-500','bg-amber-500');
                        dot.classList.add(isAllowed ? 'bg-green-500' : 'bg-amber-500');
                    }
                    pill.title = isAllowed
                        ? 'This email is in the Firestore admin allowlist.'
                        : 'This email is NOT in the Firestore admin allowlist (isAdmin()).';
                }
            } catch {}

            // Load once auth is ready; avoids a false "0 testimonials" before Firebase restores the session.
            loadTestimonials();
            loadCurrencySetting();
        });

        // Load currency setting from Firestore
        async function loadCurrencySetting() {
            try {
                const { doc, getDoc, setDoc } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const settingsRef = doc(db, 'settings', 'currency');
                const snap = await getDoc(settingsRef);
                
                const currencyInput = document.getElementById('adminCurrencySign');
                const currencyDisplay = document.getElementById('adminCurrencyDisplay');
                
                if (snap.exists()) {
                    const data = snap.data();
                    const currencySign = data.currencySign || '$';
                    if (currencyInput) currencyInput.value = currencySign;
                    if (currencyDisplay) currencyDisplay.textContent = currencySign || 'Not set (default: $)';
                } else {
                    // Default to $ if no setting exists
                    if (currencyInput) currencyInput.value = '$';
                    if (currencyDisplay) currencyDisplay.textContent = 'Not set (default: $)';
                }
            } catch (error) {
                console.error('Error loading currency setting:', error);
                const currencyDisplay = document.getElementById('adminCurrencyDisplay');
                if (currencyDisplay) currencyDisplay.textContent = 'Error loading setting';
            }
        }

        // Save currency setting to Firestore
        window.adminSaveCurrency = async function() {
            const currencyInput = document.getElementById('adminCurrencySign');
            if (!currencyInput) return;

            const currencySign = String(currencyInput.value || '').trim();
            if (!currencySign) {
                showError('Please enter a currency sign.');
                return;
            }

            const btnId = 'adminSaveCurrencyBtn';
            const statusEl = document.getElementById('adminCurrencyStatus');
            setButtonLoading(btnId, true);
            if (statusEl) statusEl.textContent = '';

            try {
                const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const settingsRef = doc(db, 'settings', 'currency');
                
                await setDoc(settingsRef, {
                    currencySign: currencySign,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                const currencyDisplay = document.getElementById('adminCurrencyDisplay');
                if (currencyDisplay) currencyDisplay.textContent = currencySign;
                
                if (statusEl) {
                    statusEl.textContent = 'Currency saved successfully!';
                    statusEl.className = 'text-xs text-green-600';
                }
                showSuccess(`Currency sign set to "${currencySign}". All account balances will now display with this symbol.`);
            } catch (error) {
                console.error('Error saving currency setting:', error);
                showError('Failed to save currency setting. Please try again.');
                if (statusEl) {
                    statusEl.textContent = 'Error saving';
                    statusEl.className = 'text-xs text-red-600';
                }
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        // Image preview functionality
        document.getElementById('authorImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (file) {
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('Image size must be less than 2MB');
                    e.target.value = '';
                    preview.classList.add('hidden');
                    return;
                }
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select a valid image file');
                    e.target.value = '';
                    preview.classList.add('hidden');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
            }
        });

        // Upload image to Cloudinary
        async function uploadImageToCloudinary(file) {
            const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dmgcagkqa/image/upload';
            const CLOUDINARY_UPLOAD_PRESET = 'ASHB_profile';
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                const response = await fetch(CLOUDINARY_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Image upload failed');
                }

                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Sample testimonials data - Authentic and detailed reviews
        const sampleTestimonials = [
            {
                authorName: "Michael Chen",
                company: "Global Trade Solutions Inc.",
                country: "Singapore",
                rating: 5,
                reviewText: "Twenty Forth & Fifth has been instrumental in our international expansion across Southeast Asia. Their expertise in banking solutions and regulatory compliance has saved us significant time and resources. The team is professional, responsive, and truly understands the complexities of cross-border transactions. We've processed over $2M in international transfers through their platform with zero issues. Their compliance team ensured we met all regulatory requirements for our operations in multiple jurisdictions. Highly recommended for any business looking to expand internationally.",
                verified: true,
                published: true
            },
            {
                authorName: "Sarah Williams",
                company: "Williams Financial Group",
                country: "United Kingdom",
                rating: 5,
                reviewText: "Outstanding service from Twenty Forth & Fifth. They helped us set up our banking account structure efficiently when we were establishing our presence in the European market. Their attention to detail and commitment to compliance is impressive - they walked us through every step of the KYC process and made it seamless. The online dashboard is intuitive, and their customer support team responds within hours, not days. We've been with them for 18 months now and couldn't be happier. Highly recommended for anyone looking for reliable banking services with a personal touch.",
                verified: true,
                published: true
            },
            {
                authorName: "James Rodriguez",
                company: "Rodriguez Holdings",
                country: "United States",
                rating: 5,
                reviewText: "We've been working with Twenty Forth & Fifth for over two years now, and they've consistently exceeded our expectations. As a family office managing assets across multiple countries, we needed a bank that understood international wealth management. Their team is knowledgeable, professional, and always available when we need assistance - even during off-hours. The platform is user-friendly and the transaction processing is seamless. What impressed us most was their proactive approach to compliance - they keep us informed about regulatory changes that might affect our accounts. This level of service is rare in banking.",
                verified: true,
                published: true
            },
            {
                authorName: "Emma Thompson",
                company: "Thompson Enterprises",
                country: "Canada",
                rating: 5,
                reviewText: "Twenty Forth & Fifth has transformed how we manage our international finances. The banking account setup was straightforward, and their compliance team ensured everything was done correctly from day one. We were initially concerned about the complexity of banking, but their team made the entire process transparent and easy to understand. Their customer support is top-notch - they've helped us navigate currency conversions, international wire transfers, and even provided advice on tax-efficient structures. We appreciate their transparency throughout the process. After 3 years, we still feel like valued clients, not just account numbers.",
                verified: true,
                published: true
            },
            {
                authorName: "David Kim",
                company: "Kim Capital Management",
                country: "South Korea",
                rating: 5,
                reviewText: "Excellent banking services. Twenty Forth & Fifth understands the needs of international businesses and provides tailored solutions. Their platform is secure, reliable, and their team is always ready to help. We've processed millions in transactions through their system without a single security concern. The multi-currency accounts have been particularly useful for our operations across Asia-Pacific. Their compliance documentation is thorough, which gives us confidence when dealing with auditors. We've had a great experience working with them and plan to expand our relationship.",
                verified: true,
                published: true
            },
            {
                authorName: "Robert Anderson",
                company: "Anderson & Associates",
                country: "Australia",
                rating: 5,
                reviewText: "I've worked with several banks over the past decade, and Twenty Forth & Fifth stands out for their professionalism and reliability. Their online banking platform is modern and secure - I can manage all my accounts from anywhere in the world. The transaction fees are competitive, and more importantly, they're transparent about all costs upfront. Their support team has helped me with everything from setting up beneficiary accounts to understanding tax implications. The fact that they're fully licensed and regulated gives me peace of mind. I've recommended them to several colleagues in the financial services industry.",
                verified: true,
                published: true
            },
            {
                authorName: "Maria Garcia",
                company: "Garcia International Trading",
                country: "Spain",
                rating: 5,
                reviewText: "Twenty Forth & Fifth has been our banking partner for our import-export business for the past 3 years. Their multi-currency accounts have been essential for our operations across Europe and Latin America. The wire transfer process is fast and reliable - we've never experienced delays or issues. Their compliance team is thorough but efficient, which is exactly what we need. The online platform allows us to track all transactions in real-time, and the reporting features help us with our accounting. Their customer service is exceptional - they speak multiple languages and understand international business needs. We couldn't operate our business as efficiently without them.",
                verified: true,
                published: true
            },
            {
                authorName: "Thomas Müller",
                company: "Müller Tech Solutions",
                country: "Germany",
                rating: 5,
                reviewText: "As a technology company expanding globally, we needed a banking partner that could keep up with our fast-paced growth. Twenty Forth & Fifth has been exactly that. They set up our corporate accounts quickly and have supported us through multiple funding rounds. Their platform integrates well with our accounting software, saving us hours of manual work. The team understands the unique needs of tech companies - they've helped us with everything from investor relations to payroll for our international team. Their security measures are top-tier, which is crucial for a tech company. Highly professional and reliable.",
                verified: true,
                published: true
            },
            {
                authorName: "Jennifer Lee",
                company: "Lee Investment Partners",
                country: "Hong Kong",
                rating: 5,
                reviewText: "Twenty Forth & Fifth has been our preferred banking partner for managing our clients' investments. Their expertise in wealth management and their understanding of different regulatory environments is impressive. The platform is sophisticated yet user-friendly, and their reporting capabilities are excellent for our compliance requirements. They've helped us structure accounts for clients across multiple jurisdictions while ensuring full regulatory compliance. Their team is responsive and always willing to go the extra mile. We've been with them for 4 years and have never had a reason to look elsewhere. They truly understand the needs of investment professionals.",
                verified: true,
                published: true
            },
            {
                authorName: "Ahmed Hassan",
                company: "Hassan Trading Group",
                country: "United Arab Emirates",
                rating: 5,
                reviewText: "Twenty Forth & Fifth has been instrumental in our business expansion across the Middle East and Africa. Their understanding of regional banking requirements and their ability to facilitate transactions across different currencies has been invaluable. The account setup process was smooth, and their compliance team ensured we met all regulatory requirements. Their online platform works perfectly even with slower internet connections, which is important for our operations in remote areas. The customer support team is available 24/7 and has helped us resolve issues quickly. Their commitment to security and compliance gives us confidence in every transaction. Excellent service overall.",
                verified: true,
                published: true
            },
            {
                authorName: "Sophie Martin",
                company: "Martin Real Estate Holdings",
                country: "France",
                rating: 5,
                reviewText: "We've been using Twenty Forth & Fifth for our international real estate investments for over 5 years. Their expertise in handling large transactions and their understanding of property investment structures is outstanding. They've facilitated transactions in multiple countries and currencies without any issues. The platform is secure and user-friendly, and their reporting features help us track all our investments. Their compliance team has been particularly helpful in ensuring we meet all regulatory requirements across different jurisdictions. The level of service we receive is exceptional - they treat us like partners, not just clients. We've recommended them to many colleagues in the real estate industry.",
                verified: true,
                published: true
            },
            {
                authorName: "Carlos Silva",
                company: "Silva Manufacturing Corp",
                country: "Brazil",
                rating: 5,
                reviewText: "Twenty Forth & Fifth has transformed our international operations. As a manufacturing company with suppliers and customers across multiple continents, we needed a banking partner that could handle complex international transactions. They've exceeded our expectations in every way. Their multi-currency accounts have saved us significant money on currency conversions, and their wire transfer service is fast and reliable. The online platform is excellent - we can manage all our accounts and transactions from our office in São Paulo. Their customer support team speaks Portuguese, which makes communication much easier. They've been our banking partner for 2 years, and we plan to continue working with them as we expand further.",
                verified: true,
                published: true
            }
        ];

        // Random createdAt between 2019-01-01 and 2025-12-31 (avoid "today" dates like 2026)
        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function randomLikeCount() {
            return randomInt(75, 300);
        }

        function randomSampleCreatedAt() {
            const year = randomInt(2019, 2025);
            const month = randomInt(0, 11); // 0-11
            // Days in month:
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const day = randomInt(1, daysInMonth);
            const hour = randomInt(10, 16); // daytime hours to reduce timezone date shifting
            const minute = randomInt(0, 59);
            const second = randomInt(0, 59);
            return new Date(year, month, day, hour, minute, second);
        }

        function normalizeKeyPart(value) {
            return String(value || '')
                .toLowerCase()
                .replace(/\s+/g, ' ')
                .trim();
        }

        function createdAtKey(value) {
            if (!value) return '';
            if (value instanceof Date) return String(value.getTime());
            if (typeof value.toDate === 'function') return String(value.toDate().getTime()); // Firestore Timestamp
            if (typeof value === 'number') return String(value);
            if (typeof value === 'string') {
                const ms = Date.parse(value);
                return Number.isFinite(ms) ? String(ms) : value;
            }
            if (typeof value === 'object' && typeof value.seconds === 'number') {
                const ns = typeof value.nanoseconds === 'number' ? value.nanoseconds : 0;
                return String(value.seconds * 1000 + Math.floor(ns / 1e6));
            }
            try {
                const ms = new Date(value).getTime();
                return Number.isFinite(ms) ? String(ms) : '';
            } catch {
                return '';
            }
        }

        function testimonialSignature(t) {
            // Signature used to prevent duplicates across multiple "Add Sample" clicks.
            // Uniqueness is based on name + review text + timestamp (date/time).
            return [
                normalizeKeyPart(t.authorName),
                normalizeKeyPart(t.reviewText),
                createdAtKey(t.createdAt)
            ].join('||');
        }

        function hashStringToUint32(input) {
            // FNV-1a-ish hash (stable across sessions)
            let h = 2166136261;
            const s = String(input || '');
            for (let i = 0; i < s.length; i++) {
                h ^= s.charCodeAt(i);
                h = Math.imul(h, 16777619);
            }
            return h >>> 0;
        }

        const FEMALE_FIRST_NAMES = new Set([
            'heather','nicole','ashley','lauren','jessica','kayla','stephanie','megan','danielle','courtney',
            'alicia','kimberly','samantha','rachel','christina','erica','natalie','tiffany','vanessa','emily',
            'monica','allison','paige','brielle','haley','jenna','victoria','faith','marissa','kelsey',
            'hannah','olivia','alexis','desiree','michelle','brooke','carly','naomi','chelsea','madeline',
            'rachael','autumn','kristen','savannah','bianca','lillian','kayleen',
            'sarah','emma','maria','jennifer','sophie'
        ]);

        const MALE_FIRST_NAMES = new Set([
            'michael','daniel','anthony','brian','kevin','jason','andrew','matthew','jonathan','justin','brandon',
            'eric','nicholas','ryan','steven','joseph','tyler','adam','sean','robert','zachary','carlos','patrick',
            'aaron','dylan','marcus','paul','trevor','joshua','nathan','corey','luke','omar','isaiah','miguel',
            'julian','frank','victor','evan','caleb','jordan','devin','austin','raymond','blake','terrence','noah',
            'samuel','david','ahmed','james','thomas'
        ]);

        function inferGenderFromName(authorName) {
            const first = String(authorName || '')
                .trim()
                .split(/\s+/)[0]
                .replace(/[^a-zA-Z']/g, '')
                .toLowerCase();

            if (!first) return null;
            if (FEMALE_FIRST_NAMES.has(first)) return 'female';
            if (MALE_FIRST_NAMES.has(first)) return 'male';
            return null;
        }

        function pickSampleAuthorImage(authorName, usedUrls = null) {
            // Goal:
            // - Avoid repeats (best-effort within a single click)
            // - Prefer male/female human photos when we can infer it
            // - Otherwise fall back to deterministic avatars/objects
            const baseSeed = encodeURIComponent(String(authorName || 'firstcitizensinc'));
            const baseHash = hashStringToUint32(baseSeed);
            const gender = inferGenderFromName(authorName);

            // deterministic roll in [0,1)
            const baseRoll = (baseHash % 1000) / 1000;

            for (let attempt = 0; attempt < 12; attempt++) {
                const salt = attempt ? `-${attempt}` : '';
                const seed = `${baseSeed}${salt}`;

                const roll = ((baseHash + attempt * 997) % 1000) / 1000;
                const portraitIdx = (baseHash + attempt * 101) % 100; // randomuser supports 0-99

                let url = '';
                if (roll < 0.55) {
                    const folder = gender === 'female'
                        ? 'women'
                        : gender === 'male'
                            ? 'men'
                            : ((baseHash + attempt) % 2 ? 'men' : 'women');
                    url = `https://randomuser.me/api/portraits/${folder}/${portraitIdx}.jpg`;
                } else if (roll < 0.9) {
                    url = `https://api.dicebear.com/8.x/avataaars/svg?seed=${seed}`;
                } else {
                    url = `https://api.dicebear.com/8.x/shapes/svg?seed=${seed}`;
                }

                if (!usedUrls || !usedUrls.has(url)) {
                    return url;
                }
            }

            // worst-case fallback
            if (baseRoll < 0.5) return `https://api.dicebear.com/8.x/avataaars/svg?seed=${baseSeed}`;
            return `https://api.dicebear.com/8.x/shapes/svg?seed=${baseSeed}`;
        }

        function generateExtraSamples({ count, existingKeys, existingNames }) {
            const fullNames = [
                'Daniel Thompson', 'Anthony Rodriguez', 'Brian Anderson', 'Kevin Moore', 'Jason Taylor', 'Andrew White',
                'Matthew Harris', 'Jonathan Clark', 'Justin Lewis', 'Brandon Walker', 'Eric Hall', 'Nicholas Young',
                'Ryan Allen', 'Steven King', 'Joseph Wright', 'Tyler Lopez', 'Adam Scott', 'Sean Ramirez',
                'Robert Campbell', 'Zachary Mitchell', 'Carlos Hernandez', 'Patrick O\'Neill', 'Aaron Brooks', 'Dylan Foster',
                'Marcus Green', 'Paul Simmons', 'Trevor Price', 'Joshua Bennett', 'Nathan Coleman', 'Corey Evans',
                'Luke Patterson', 'Omar Washington', 'Isaiah Turner', 'Miguel Flores', 'Julian Rivera', 'Frank Delgado',
                'Victor Morales', 'Evan Porter', 'Caleb Reed', 'Jordan Nichols', 'Devin Watson', 'Austin Grant',
                'Raymond Cruz', 'Blake Henderson', 'Terrence Powell', 'Noah Kim', 'Samuel Baker',
                'Heather Johnson', 'Nicole Ramirez', 'Ashley Thompson', 'Lauren Mitchell', 'Jessica Anderson',
                'Kayla Peterson', 'Stephanie Brown', 'Megan O\'Connor', 'Danielle White', 'Courtney Lewis',
                'Alicia Martinez', 'Kimberly Scott', 'Samantha Young', 'Rachel Turner', 'Christina Hall',
                'Erica Moore', 'Natalie Brooks', 'Tiffany Adams', 'Vanessa Flores', 'Emily Richardson',
                'Monica Rivera', 'Allison Grant', 'Paige Reynolds', 'Brielle Jackson', 'Haley Stewart',
                'Jenna Sullivan', 'Victoria Lopez', 'Faith Robinson', 'Marissa Clark', 'Kelsey Bennett',
                'Hannah Phillips', 'Jordan Evans', 'Olivia Carter', 'Alexis Green', 'Desiree Torres',
                'Michelle Ward', 'Brooke Simmons', 'Carly Foster', 'Naomi Price', 'Chelsea Nguyen',
                'Madeline Howard', 'Rachael King', 'Autumn Diaz', 'Kristen Powell', 'Savannah Morris',
                'Bianca Cruz', 'Lillian Baker', 'Kayleen Murphy'
            ];
            const companyPrefixes = [
                'Northbridge','Blue Harbor','Atlas','Summit','Cedarstone','Silverline','Evergreen','Prime','Vertex','Keystone','Oakridge','Brightwater'
            ];
            const companySuffixes = [
                'Capital','Holdings','Partners','Advisory','Trading','Logistics','Ventures','Group','Enterprises','Management','Solutions','Industries'
            ];
            const countries = [
                'United States','United Kingdom','Canada','Australia','Germany','France','Spain','Italy','Singapore','Hong Kong','United Arab Emirates',
                'South Africa','Netherlands','Switzerland','Sweden','Norway','Ireland','Brazil','Mexico','Japan'
            ];
            // Short 2-line testimonials
            const shortTestimonials = [
                'Twenty Forth & Fifth has been excellent for our international banking needs. Highly professional and reliable service.',
                'Great experience with Twenty Forth & Fifth. Their platform is user-friendly and customer support is responsive.',
                'We\'ve been using Twenty Forth & Fifth for banking and are very satisfied. Fast transactions and excellent service.',
                'Twenty Forth & Fifth made our banking account setup seamless. The team is knowledgeable and always available to help.',
                'Outstanding service from Twenty Forth & Fifth. Their compliance guidance and international transfer capabilities are top-notch.',
                'We chose Twenty Forth & Fifth for our global operations and couldn\'t be happier. Professional, secure, and efficient.',
                'Twenty Forth & Fifth provides excellent banking solutions. The platform is intuitive and transactions are processed quickly.',
                'Highly recommend Twenty Forth & Fifth for international banking. Their customer service is exceptional and the process is transparent.',
                'Our experience with Twenty Forth & Fifth has been outstanding. They understand international business needs and deliver consistently.',
                'Twenty Forth & Fifth has been our trusted banking partner for banking operations. Reliable, secure, and professional service.',
                'Excellent banking services from Twenty Forth & Fifth. The account setup was smooth and ongoing support is great.',
                'We\'ve been working with Twenty Forth & Fifth for international transactions. Their platform is secure and easy to use.',
                'Twenty Forth & Fifth offers reliable banking with excellent customer support. Highly satisfied with their services.',
                'Great banking partner. Twenty Forth & Fifth provides fast, secure transactions and professional guidance.',
                'Twenty Forth & Fifth has exceeded our expectations. Their international banking solutions are comprehensive and reliable.',
                'Professional and efficient service from Twenty Forth & Fifth. The banking account management is seamless and user-friendly.',
                'We appreciate Twenty Forth & Fifth\'s expertise in banking. Their compliance support and platform are excellent.',
                'Twenty Forth & Fifth provides outstanding banking services. Fast processing, secure platform, and great support.',
                'Our banking experience with Twenty Forth & Fifth has been excellent. They make international operations easy.',
                'Twenty Forth & Fifth is a reliable banking partner. Their team is professional and the platform is intuitive.',
                'Excellent service from Twenty Forth & Fifth. They handle our international banking needs with professionalism and efficiency.',
                'Twenty Forth & Fifth offers top-tier banking solutions. The account setup was quick and the service is outstanding.',
                'We\'ve been very satisfied with Twenty Forth & Fifth. Their banking platform is secure and transactions are fast.',
                'Twenty Forth & Fifth provides excellent international banking services. Highly professional team and reliable platform.',
                'Great banking experience with Twenty Forth & Fifth. Their customer support is responsive and the service is excellent.',
                'Twenty Forth & Fifth has been instrumental in our international operations. Professional service and secure platform.',
                'Outstanding banking partner. Twenty Forth & Fifth offers reliable services with excellent customer support.',
                'We highly recommend Twenty Forth & Fifth for banking. Their platform is user-friendly and service is professional.',
                'Twenty Forth & Fifth provides comprehensive banking solutions. Fast, secure, and reliable international transactions.',
                'Excellent banking services from Twenty Forth & Fifth. The team is knowledgeable and always ready to assist.',
            ];

            // Mix long + short for better variety
            const reviewPool = shortTestimonials
                .concat((Array.isArray(sampleTestimonials) ? sampleTestimonials : []).map(t => (t && t.reviewText) ? String(t.reviewText) : '').filter(Boolean));

            const out = [];
            const maxAttempts = 500;
            let attempts = 0;
            const usedNameIndices = new Set();
            const localExistingKeys = new Set(existingKeys || []);
            const localExistingNames = new Set(existingNames || []);

            while (out.length < count && attempts < maxAttempts) {
                attempts++;

                // Pick a random name from the provided list
                let nameIdx = randomInt(0, fullNames.length - 1);
                let nameAttempts = 0;
                // Try to find an unused name (up to 50 attempts)
                while (usedNameIndices.has(nameIdx) && nameAttempts < 50) {
                    nameIdx = randomInt(0, fullNames.length - 1);
                    nameAttempts++;
                }
                
                // If we've used all names, allow reuse but ensure unique testimonial content
                const authorName = fullNames[nameIdx];
                const normalizedName = normalizeKeyPart(authorName);
                
                // Only skip if exact name AND we have many unique names left
                if (usedNameIndices.size < fullNames.length * 0.8 && localExistingNames.has(normalizedName)) {
                    continue;
                }

                const company = `${companyPrefixes[randomInt(0, companyPrefixes.length - 1)]} ${companySuffixes[randomInt(0, companySuffixes.length - 1)]}`;
                const country = countries[randomInt(0, countries.length - 1)];
                const rating = Math.random() < 0.85 ? 5 : 4;
                const reviewText = reviewPool.length
                    ? reviewPool[randomInt(0, reviewPool.length - 1)]
                    : shortTestimonials[randomInt(0, shortTestimonials.length - 1)];

                const candidate = {
                    authorName,
                    company,
                    country,
                    rating,
                    reviewText,
                    verified: true,
                    published: true,
                    createdAt: randomSampleCreatedAt()
                };

                const sig = testimonialSignature(candidate);
                if (localExistingKeys.has(sig)) continue;

                out.push(candidate);
                usedNameIndices.add(nameIdx);
                localExistingNames.add(normalizedName);
                localExistingKeys.add(sig);
            }

            return out;
        }

        // Add sample testimonials
        document.getElementById('addSamplesBtn').addEventListener('click', async () => {
            const btn = document.getElementById('addSamplesBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding samples...';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                // Build a set of existing testimonial signatures so we don't add duplicates
                const existingSnap = await getDocs(collection(db, 'testimonials'));
                const existingKeys = new Set();
                const existingNames = new Set();
                existingSnap.forEach((d) => {
                    const data = d.data() || {};
                    existingKeys.add(testimonialSignature(data));
                    if (data.authorName) existingNames.add(normalizeKeyPart(data.authorName));
                });

                let added = 0;
                let skipped = 0;
                const addedThisRun = new Set();
                const usedAuthorImages = new Set();

                // Always generate a fresh random batch each click
                const desiredCount = 24;
                const generated = generateExtraSamples({ count: desiredCount, existingKeys, existingNames });

                for (const testimonial of generated) {
                    try {
                        const authorImage = testimonial.authorImage || pickSampleAuthorImage(testimonial.authorName, usedAuthorImages);
                        const likeCount = randomLikeCount();
                        const docData = {
                            ...testimonial,
                            authorImage,
                            likeCount,
                            createdAt: testimonial.createdAt || randomSampleCreatedAt()
                        };

                        const sig = testimonialSignature(docData);
                            if (existingKeys.has(sig) || addedThisRun.has(sig)) {
                                skipped++;
                                continue;
                            }

                        await addDoc(collection(db, 'testimonials'), docData);
                            added++;
                            addedThisRun.add(sig);
                        existingKeys.add(sig);
                        if (docData.authorName) existingNames.add(normalizeKeyPart(docData.authorName));
                        if (docData.authorImage) usedAuthorImages.add(docData.authorImage);
                        } catch (err) {
                        console.error('Error adding testimonial:', err);
                    }
                }

                if (added > 0) {
                if (skipped > 0) {
                    showSuccess(`Successfully added ${added} sample testimonials. Skipped ${skipped} duplicates.`);
                } else {
                    showSuccess(`Successfully added ${added} sample testimonials!`);
                    }
                } else {
                    const extra = skipped > 0 ? ` Skipped ${skipped} duplicates.` : '';
                    showError(`No new sample testimonials were added.${extra} Click again to generate a different random set.`);
                }
                loadTestimonials();
            } catch (error) {
                showError('Error adding sample testimonials: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sparkles mr-2"></i>Add Sample Testimonials';
            }
        });

        // Form submission
        document.getElementById('testimonialForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                let imageUrl = '';
                const imageFile = document.getElementById('authorImage').files[0];
                
                // Upload image if provided
                if (imageFile) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading image...';
                    try {
                        imageUrl = await uploadImageToCloudinary(imageFile);
                        console.log('Image uploaded successfully:', imageUrl);
                    } catch (error) {
                        console.error('Image upload error:', error);
                        throw new Error('Failed to upload image. Please try again.');
                    }
                }

                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

                const editingIdEl = document.getElementById('editingTestimonialId');
                const editingId = editingIdEl ? editingIdEl.value : '';
                const publishedDateEl = document.getElementById('publishedDate');
                const publishedDateInput = publishedDateEl ? publishedDateEl.value : '';

                const authorNameEl = document.getElementById('authorName');
                const companyEl = document.getElementById('company');
                const countryEl = document.getElementById('country');
                const ratingEl = document.getElementById('rating');
                const reviewTextEl = document.getElementById('reviewText');
                const verifiedEl = document.getElementById('verified');
                const publishedEl = document.getElementById('published');
                const likeCountEl = document.getElementById('likeCount');

                if (!authorNameEl || !companyEl || !countryEl || !ratingEl || !reviewTextEl || !verifiedEl || !publishedEl) {
                    throw new Error('Form elements not found. Please refresh the page.');
                }

                const testimonialData = {
                    authorName: authorNameEl.value.trim(),
                    company: companyEl.value.trim(),
                    country: countryEl.value.trim(),
                    rating: parseInt(ratingEl.value),
                    reviewText: reviewTextEl.value.trim(),
                    verified: verifiedEl.checked,
                    published: publishedEl.checked
                };

                // Like count: if empty on new testimonials, auto-generate; if empty while editing, keep current.
                if (likeCountEl) {
                    const raw = String(likeCountEl.value || '').trim();
                    if (raw) {
                        const n = parseInt(raw, 10);
                        if (!Number.isFinite(n) || n < 0) {
                            throw new Error('Like Count must be a number (0 or higher).');
                        }
                        testimonialData.likeCount = n;
                    } else if (!editingId) {
                        testimonialData.likeCount = randomLikeCount();
                    }
                } else if (!editingId) {
                    testimonialData.likeCount = randomLikeCount();
                }

                // Handle published date
                if (publishedDateInput) {
                    const date = new Date(publishedDateInput);
                    testimonialData.createdAt = date;
                } else if (!editingId) {
                    // Only set serverTimestamp for new testimonials
                    testimonialData.createdAt = serverTimestamp();
                }

                // Add image URL if uploaded (only update if new image is provided)
                if (imageUrl) {
                    testimonialData.authorImage = imageUrl;
                }

                if (editingId) {
                    // Update existing testimonial
                    const { updateDoc } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                    await updateDoc(doc(db, 'testimonials', editingId), testimonialData);
                    showSuccess('Testimonial updated successfully!');
                } else {
                    // Create new testimonial
                await addDoc(collection(db, 'testimonials'), testimonialData);
                showSuccess('Testimonial added successfully!');
                }

                const form = document.getElementById('testimonialForm');
                if (form) form.reset();
                const imagePreview = document.getElementById('imagePreview');
                if (imagePreview) imagePreview.classList.add('hidden');
                const previewImg = document.getElementById('previewImg');
                if (previewImg) previewImg.src = '';
                const editingIdField = document.getElementById('editingTestimonialId');
                if (editingIdField) editingIdField.value = '';
                const publishedDateField = document.getElementById('publishedDate');
                if (publishedDateField) publishedDateField.value = '';
                cancelEdit(); // Reset form to add mode
                loadTestimonials();
            } catch (error) {
                showError('Error adding testimonial: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                const editingIdEl = document.getElementById('editingTestimonialId');
                const editingId = editingIdEl ? editingIdEl.value : '';
                submitBtn.innerHTML = editingId 
                    ? '<i class="fas fa-save mr-2"></i>Update Testimonial'
                    : '<i class="fas fa-save mr-2"></i>Add Testimonial';
            }
        });

        // Load testimonials
        async function loadTestimonials() {
            try {
                // Get all testimonials (authenticated users can read all)
                const querySnapshot = await getDocs(collection(db, 'testimonials'));
                
                const listEl = document.getElementById('testimonialsList');
                
                if (querySnapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-8">No testimonials found. Add your first testimonial above!</p>';
                    return;
                }

                const testimonials = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    testimonials.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date()
                    });
                });

                // Sort by createdAt client-side (newest first)
                testimonials.sort((a, b) => {
                    const dateA = a.createdAt instanceof Date ? a.createdAt : new Date(a.createdAt);
                    const dateB = b.createdAt instanceof Date ? b.createdAt : new Date(b.createdAt);
                    return dateB - dateA;
                });

                listEl.innerHTML = testimonials.map(t => {
                    const date = t.createdAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    const stars = '⭐'.repeat(t.rating || 0);
                    const likeCount = t.likeCount !== undefined ? t.likeCount : '—';
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 ${!t.published ? 'opacity-60' : ''}">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-start gap-3">
                                    ${t.authorImage ? `<img src="${t.authorImage}" alt="${t.authorName}" class="w-12 h-12 rounded-full object-cover border border-gray-200">` : '<div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-400"></i></div>'}
                                <div>
                                        <h3 class="font-semibold text-gray-900">${t.authorName}</h3>
                                        <p class="text-sm text-gray-600">${t.company} • ${t.country}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-gray-700 text-sm">${stars}</div>
                                    <div class="text-xs text-gray-500 mt-1">${date}</div>
                                    <div class="text-xs text-gray-600 mt-1 flex items-center gap-1">
                                        <i class="fas fa-thumbs-up"></i> ${likeCount}
                                    </div>
                                </div>
                            </div>
                            <p class="text-gray-700 text-sm mt-2">${t.reviewText}</p>
                            <div class="flex items-center gap-2 mt-3 text-xs">
                                ${t.verified ? '<span class="bg-gray-100 text-gray-800 border border-gray-200 px-2 py-1 rounded">Verified</span>' : ''}
                                ${t.published ? '<span class="bg-gray-100 text-gray-800 border border-gray-200 px-2 py-1 rounded">Published</span>' : '<span class="bg-gray-100 text-gray-800 border border-gray-200 px-2 py-1 rounded">Draft</span>'}
                                <button onclick="deleteTestimonial('${t.id}')" class="text-gray-500 hover:text-gray-900 ml-auto">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading testimonials:', error);
                document.getElementById('testimonialsList').innerHTML = '<p class="text-gray-700 text-center py-8">Error loading testimonials. Please refresh the page.</p>';
            }
        }

        // Edit testimonial
        window.editTestimonial = async (id) => {
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                const testimonialDoc = await getDoc(doc(db, 'testimonials', id));
                if (!testimonialDoc.exists()) {
                    throw new Error('Testimonial not found');
                }

                const data = testimonialDoc.data();
                
                // Populate form with testimonial data
                const authorNameField = document.getElementById('authorName');
                const companyField = document.getElementById('company');
                const countryField = document.getElementById('country');
                const ratingField = document.getElementById('rating');
                const reviewTextField = document.getElementById('reviewText');
                const verifiedField = document.getElementById('verified');
                const publishedField = document.getElementById('published');
                const likeCountField = document.getElementById('likeCount');
                const editingIdField = document.getElementById('editingTestimonialId');
                const publishedDateField = document.getElementById('publishedDate');
                const previewImg = document.getElementById('previewImg');
                const imagePreview = document.getElementById('imagePreview');
                const formTitle = document.getElementById('formTitle');
                const submitBtnText = document.getElementById('submitBtnText');
                const cancelEditBtn = document.getElementById('cancelEditBtn');

                if (authorNameField) authorNameField.value = data.authorName || '';
                if (companyField) companyField.value = data.company || '';
                if (countryField) countryField.value = data.country || '';
                if (ratingField) ratingField.value = data.rating || '';
                if (reviewTextField) reviewTextField.value = data.reviewText || '';
                if (verifiedField) verifiedField.checked = data.verified || false;
                if (publishedField) publishedField.checked = data.published || false;
                if (likeCountField) likeCountField.value = data.likeCount !== undefined ? data.likeCount : '';
                if (editingIdField) editingIdField.value = id;

                // Set published date if exists
                if (data.createdAt && data.createdAt.toDate && publishedDateField) {
                    const date = data.createdAt.toDate();
                    publishedDateField.value = date.toISOString().split('T')[0];
                }

                // Show existing image if available
                if (data.authorImage && previewImg) {
                    previewImg.src = data.authorImage;
                    if (imagePreview) imagePreview.classList.remove('hidden');
                }

                // Update form title and button
                if (formTitle) formTitle.textContent = 'Edit Testimonial';
                if (submitBtnText) submitBtnText.textContent = 'Update Testimonial';
                if (cancelEditBtn) cancelEditBtn.classList.remove('hidden');

                // Scroll to form
                document.getElementById('testimonialForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                console.error('Error loading testimonial for edit:', error);
                showError('Error loading testimonial: ' + error.message);
            }
        };

        // Cancel edit mode
        window.cancelEdit = function() {
            const form = document.getElementById('testimonialForm');
            if (form) form.reset();
            const imagePreview = document.getElementById('imagePreview');
            if (imagePreview) imagePreview.classList.add('hidden');
            const previewImg = document.getElementById('previewImg');
            if (previewImg) previewImg.src = '';
            const editingIdField = document.getElementById('editingTestimonialId');
            if (editingIdField) editingIdField.value = '';
            const publishedDateField = document.getElementById('publishedDate');
            if (publishedDateField) publishedDateField.value = '';
            const formTitle = document.getElementById('formTitle');
            if (formTitle) formTitle.textContent = 'Add New Testimonial';
            const submitBtnText = document.getElementById('submitBtnText');
            if (submitBtnText) submitBtnText.textContent = 'Add Testimonial';
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            if (cancelEditBtn) cancelEditBtn.classList.add('hidden');
        };

        // Assign random like counts to all testimonials
        document.getElementById('backfillLikesBtn').addEventListener('click', async () => {
            const btn = document.getElementById('backfillLikesBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Assigning likes...';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                const { updateDoc } = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const testimonialsSnap = await getDocs(collection(db, 'testimonials'));
                
                let updated = 0;
                const updatePromises = [];
                
                testimonialsSnap.forEach((docSnap) => {
                    const likeCount = randomLikeCount();
                    updatePromises.push(
                        updateDoc(doc(db, 'testimonials', docSnap.id), { likeCount })
                    );
                    updated++;
                });

                await Promise.all(updatePromises);
                showSuccess(`Successfully assigned random like counts to ${updated} testimonials!`);
                loadTestimonials();
            } catch (error) {
                console.error('Error assigning like counts:', error);
                showError('Error assigning like counts: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-thumbs-up mr-2"></i>Assign Random Like Counts';
            }
        });

        // Delete testimonial
        window.deleteTestimonial = async (id) => {
            if (!confirm('Are you sure you want to delete this testimonial? This action cannot be undone.')) return;
            
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                await deleteDoc(doc(db, 'testimonials', id));
                showSuccess('Testimonial deleted successfully!');
                loadTestimonials();
            } catch (error) {
                console.error('Error deleting testimonial:', error);
                showError('Error deleting testimonial: ' + error.message);
            }
        };

        // Delete all testimonials
        document.getElementById('deleteAllTestimonialsBtn').addEventListener('click', async () => {
            const confirmed = confirm('⚠️ WARNING: Are you absolutely sure you want to delete ALL testimonials? This action cannot be undone and will permanently remove all testimonials from the database.');
            if (!confirmed) return;
            
            const secondConfirm = confirm('This is your last chance. Click OK to permanently delete ALL testimonials.');
            if (!secondConfirm) return;
            
            const btn = document.getElementById('deleteAllTestimonialsBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting all testimonials...';

            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Please log in first');
                }

                // Get all testimonials
                const testimonialsSnap = await getDocs(collection(db, 'testimonials'));
                
                if (testimonialsSnap.empty) {
                    showSuccess('No testimonials to delete.');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i>Delete All Testimonials';
                    return;
                }

                // Delete all testimonials
                const deletePromises = [];
                testimonialsSnap.forEach((docSnap) => {
                    deletePromises.push(deleteDoc(doc(db, 'testimonials', docSnap.id)));
                });

                await Promise.all(deletePromises);
                showSuccess(`Successfully deleted ${testimonialsSnap.size} testimonial(s)!`);
                loadTestimonials();
            } catch (error) {
                console.error('Error deleting all testimonials:', error);
                showError('Error deleting all testimonials: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash-alt mr-2"></i>Delete All Testimonials';
            }
        });

        // Show success/error messages
        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            document.getElementById('successText').textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        // Load testimonials is triggered after auth is ready (see onAuthStateChanged above).

        // ========== LIVE CHAT MANAGEMENT ==========
        let selectedChatId = null;

        // Populate the "Start a chat" user dropdown (used in Chat section)
        async function loadChatUserSelect() {
            try {
                const select = document.getElementById('chatUserSelect');
                const btn = document.getElementById('startChatBtn');
                if (!select) return;

                const currentUser = auth.currentUser;
                if (!currentUser) {
                    select.innerHTML = '<option value="">Not authenticated</option>';
                    if (btn) btn.disabled = true;
                    return;
                }

                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, getDocs } = firestoreModule;

                const usersRef = collection(db, 'users');
                const snapshot = await getDocs(usersRef);
                const options = [];
                snapshot.forEach((d) => {
                    const data = d.data() || {};
                    const uid = d.id;
                    const name = [data.firstName, data.lastName].filter(Boolean).join(' ') || data.fullName || data.name || 'Unknown';
                    const email = data.email || data.userEmail || '';
                    options.push({ uid, name, email });
                });

                options.sort((a, b) => (a.email || '').localeCompare(b.email || '') || (a.name || '').localeCompare(b.name || ''));

                select.innerHTML = '<option value="">Select a user...</option>'
                    + options.map(u => {
                        const label = u.email ? `${u.name} (${u.email})` : `${u.name} (${u.uid})`;
                        return `<option value="${u.uid}" data-name="${String(u.name).replace(/"/g, '&quot;')}" data-email="${String(u.email).replace(/"/g, '&quot;')}">${label}</option>`;
                    }).join('');

                if (btn) btn.disabled = true;
                select.onchange = function () {
                    if (btn) btn.disabled = !this.value;
                };
            } catch (e) {
                console.error('loadChatUserSelect error', e);
                const select = document.getElementById('chatUserSelect');
                if (select) select.innerHTML = '<option value="">Failed to load users</option>';
                const btn = document.getElementById('startChatBtn');
                if (btn) btn.disabled = true;
            }
        }

        // Create or open a chat for the selected user
        window.startChatForSelectedUser = async function startChatForSelectedUser() {
            const select = document.getElementById('chatUserSelect');
            const btn = document.getElementById('startChatBtn');
            if (!select || !select.value) return;

            const adminUser = auth.currentUser;
            if (!adminUser) {
                showError('Not authenticated. Please log in.');
                return;
            }

            try {
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'Starting...';
                }

                const userId = select.value;
                const opt = select.options[select.selectedIndex];
                const userName = opt?.getAttribute('data-name') || 'User';
                const userEmail = opt?.getAttribute('data-email') || '';

                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, where, getDocs, addDoc, serverTimestamp } = firestoreModule;

                // CRITICAL FIX: Check for existing chats by BOTH userId AND userEmail
                // This prevents duplicate chats for the same user even if userId differs
                let existingChatId = null;
                try {
                    const chatsRef = collection(db, 'live_chats');
                    
                    // First, try to find by userId (most reliable)
                    let snap = null;
                    try {
                        const q1 = query(chatsRef, where('userId', '==', userId));
                        snap = await getDocs(q1);
                    } catch (e) {
                        console.warn('Query by userId failed:', e);
                    }
                    
                    // If no results by userId, also check by userEmail (to catch duplicates)
                    if (!snap || snap.empty) {
                        if (userEmail) {
                            try {
                                const q2 = query(chatsRef, where('userEmail', '==', userEmail));
                                snap = await getDocs(q2);
                            } catch (e) {
                                console.warn('Query by userEmail failed:', e);
                            }
                        }
                    }
                    
                    // If still no results, get all chats and filter client-side by email
                    // This is a fallback for cases where email might be stored differently
                    if (!snap || snap.empty) {
                        try {
                            const allChats = await getDocs(chatsRef);
                            const matchingChats = [];
                            allChats.forEach(doc => {
                                const data = doc.data();
                                // Match by email (case-insensitive) or userId
                                const emailMatch = userEmail && data.userEmail && 
                                    data.userEmail.toLowerCase() === userEmail.toLowerCase();
                                const userIdMatch = data.userId === userId;
                                if (emailMatch || userIdMatch) {
                                    matchingChats.push(doc);
                                }
                            });
                            if (matchingChats.length > 0) {
                                snap = { docs: matchingChats, empty: false };
                            }
                        } catch (e) {
                            console.warn('Fallback query failed:', e);
                        }
                    }
                    
                    if (snap && !snap.empty) {
                        // Prefer the newest by lastMessageAt if present; otherwise by createdAt
                        const docs = Array.from(snap.docs);
                        docs.sort((a, b) => {
                            const aData = a.data();
                            const bData = b.data();
                            
                            // Sort by lastMessageAt first (most recent activity)
                            const aLastMsg = aData?.lastMessageAt?.toDate ? aData.lastMessageAt.toDate().getTime() : 0;
                            const bLastMsg = bData?.lastMessageAt?.toDate ? bData.lastMessageAt.toDate().getTime() : 0;
                            if (aLastMsg !== bLastMsg) {
                                return bLastMsg - aLastMsg; // Newest first
                            }
                            
                            // Fallback to createdAt if lastMessageAt is equal
                            const aCreated = aData?.createdAt?.toDate ? aData.createdAt.toDate().getTime() : 0;
                            const bCreated = bData?.createdAt?.toDate ? bData.createdAt.toDate().getTime() : 0;
                            return bCreated - aCreated; // Newest first
                        });
                        existingChatId = docs[0].id;
                        console.log('Found existing chat for user:', { userId, userEmail, chatId: existingChatId });
                    }
                } catch (e) {
                    console.error('Error checking for existing chat:', e);
                    // Don't ignore - log the error but continue to create new chat if needed
                }

                let chatId = existingChatId;
                if (!chatId) {
                    console.log('Creating new chat for user:', { userId, userEmail });
                    const docRef = await addDoc(collection(db, 'live_chats'), {
                        userId,
                        userName,
                        userEmail,
                        status: 'open',
                        createdAt: serverTimestamp(),
                        lastMessageAt: serverTimestamp(),
                        lastMessage: '',
                        startedBy: adminUser.email || 'admin'
                    });
                    chatId = docRef.id;
                } else {
                    console.log('Reusing existing chat:', chatId);
                }

                // Select/open the chat in the UI
                selectedChatId = chatId;
                try { selectChat(chatId, userName); } catch {}
                showSuccess('Chat opened.');
            } catch (e) {
                console.error('startChatForSelectedUser error', e);
                showError('Failed to start chat. Please try again.');
            } finally {
                if (btn) {
                    btn.textContent = 'Start chat';
                    btn.disabled = !select.value;
                }
            }
        };

        // Load all chats
        async function loadChats() {
            try {
                // Verify admin is authenticated
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    document.getElementById('chatsList').innerHTML = '<p class="text-gray-700 text-center py-8">Not authenticated. Please log in.</p>';
                    return;
                }

                // Log admin info for debugging
                console.log('Admin user:', {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    emailVerified: currentUser.emailVerified
                });

                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, orderBy, onSnapshot } = firestoreModule;
                const chatsRef = collection(db, 'live_chats');
                
                // Try with orderBy first, fallback to no orderBy if it fails
                let q;
                try {
                    q = query(chatsRef, orderBy('lastMessageAt', 'desc'));
                } catch (orderError) {
                    console.warn('OrderBy failed, trying without order:', orderError);
                    q = query(chatsRef);
                }

                onSnapshot(q, async (snapshot) => {
                    const chats = [];
                    let totalUnread = 0;

                    snapshot.forEach(doc => {
                        const chatData = doc.data();
                        chats.push({
                            id: doc.id,
                            ...chatData
                        });
                    });

                    // Sort manually if orderBy failed
                    if (chats.length > 0 && chats[0].lastMessageAt) {
                        chats.sort((a, b) => {
                            const timeA = a.lastMessageAt?.toDate ? a.lastMessageAt.toDate().getTime() : 0;
                            const timeB = b.lastMessageAt?.toDate ? b.lastMessageAt.toDate().getTime() : 0;
                            return timeB - timeA; // Descending
                        });
                    }

                    // Count unread messages for each chat
                    for (const chat of chats) {
                        const unread = await getUnreadCount(chat.id);
                        totalUnread += unread;
                    }

                    renderChatsList(chats);
                    updateAdminChatBadge(totalUnread);
                }, (err) => {
                    console.error('Live chat listener error:', err);
                    const msg = err?.message || String(err);
                    const errorHtml = `
                        <div class="text-gray-700 text-center py-8">
                            <p class="font-semibold mb-2">Live chat failed to load</p>
                            <p class="text-sm">${msg}</p>
                            <p class="text-xs text-gray-500 mt-4">Admin Email: ${currentUser?.email || 'Not available'}</p>
                            <p class="text-xs text-gray-500">Admin UID: ${currentUser?.uid || 'Not available'}</p>
                            <button onclick="loadChats()" class="mt-4 px-4 py-2 text-white rounded-lg" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                Retry
                            </button>
                        </div>
                    `;
                    document.getElementById('chatsList').innerHTML = errorHtml;
                    showError('Live chat failed to load: ' + msg);
                });
            } catch (error) {
                console.error('Error loading chats:', error);
                document.getElementById('chatsList').innerHTML = '<p class="text-gray-700 text-center py-8">Error loading chats. Please refresh.</p>';
            }
        }

        async function getUnreadCount(chatId) {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, where, getDocs } = firestoreModule;
                const messagesRef = collection(db, 'live_chats', chatId, 'messages');
                const q = query(messagesRef, where('read', '==', false), where('sender', '==', 'user'));
                const snapshot = await getDocs(q);
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }

        function renderChatsList(chats) {
            const listEl = document.getElementById('chatsList');
            
            if (chats.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-8">No active chats yet.</p>';
                return;
            }

            listEl.innerHTML = chats.map(chat => {
                const date = chat.lastMessageAt?.toDate ? chat.lastMessageAt.toDate().toLocaleDateString() : 'N/A';
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition ${selectedChatId === chat.id ? 'bg-gray-50 border-gray-300' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 cursor-pointer" onclick="selectChat('${chat.id}', '${chat.userName || 'User'}')">
                                <h3 class="font-semibold text-gray-900">${chat.userName || 'User'}</h3>
                                <p class="text-sm text-gray-600">${chat.userId || 'Unknown'}</p>
                                <p class="text-xs text-gray-500 mt-1">Last message: ${date}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border border-gray-200 bg-gray-100 text-gray-800">
                                    ${chat.status || 'open'}
                                </span>
                                <span id="unreadBadge-${chat.id}" class="text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden" style="background-color: #15803d;">0</span>
                                <button onclick="event.stopPropagation(); deleteChat('${chat.id}')" class="text-gray-500 hover:text-gray-900 p-1" title="Delete Chat">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Load unread counts
            chats.forEach(async (chat) => {
                const unread = await getUnreadCount(chat.id);
                const badge = document.getElementById(`unreadBadge-${chat.id}`);
                if (badge) {
                    if (unread > 0) {
                        badge.textContent = unread;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });
        }

        async function selectChat(chatId, userName) {
            selectedChatId = chatId;
            const allChats = await getAllChats();
            renderChatsList(allChats);
            await loadChatMessages(chatId, userName);
        }

        async function getAllChats() {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, orderBy, getDocs } = firestoreModule;
                const chatsRef = collection(db, 'live_chats');
                const q = query(chatsRef, orderBy('lastMessageAt', 'desc'));
                const snapshot = await getDocs(q);
                
                const chats = [];
                snapshot.forEach(doc => {
                    chats.push({ id: doc.id, ...doc.data() });
                });
                return chats;
            } catch (error) {
                return [];
            }
        }

        async function loadChatMessages(chatId, userName) {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, orderBy, onSnapshot, getDocs } = firestoreModule;
                const messagesRef = collection(db, 'live_chats', chatId, 'messages');
                const q = query(messagesRef, orderBy('timestamp', 'asc'));

                // Create chat view
                const chatSection = document.getElementById('chatSection');
                const existingView = document.getElementById('chatView');
                if (existingView) existingView.remove();

                const chatView = document.createElement('div');
                chatView.id = 'chatView';
                chatView.className = 'mt-6 border-t border-gray-200 pt-6';
                chatView.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-semibold">Chat with ${userName}</h3>
                            <span class="text-sm text-gray-500">Chat ID: ${chatId.substring(0, 8)}...</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="clearChatMessages('${chatId}')" class="text-orange-600 hover:text-orange-700 px-3 py-1 text-sm border border-orange-300 rounded-lg hover:bg-orange-50 transition" title="Clear all messages">
                                <i class="fas fa-eraser mr-1"></i>Clear
                            </button>
                            <button onclick="deleteChat('${chatId}')" class="text-gray-600 hover:text-gray-900 px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition" title="Delete entire chat">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                            <button onclick="closeChatView()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="chatMessagesArea" class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto mb-4 space-y-3">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="adminReplyInput" placeholder="Type your reply..." 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 bg-white"
                            style="font-size: 16px !important;"
                            onkeypress="if(event.key === 'Enter') sendAdminReply('${chatId}')">
                        <button onclick="sendAdminReply('${chatId}')" class="text-white px-6 py-2 rounded-lg" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                            <i class="fas fa-paper-plane mr-2"></i>Send
                        </button>
                    </div>
                `;
                chatSection.appendChild(chatView);

                // Load initial messages first in chronological order
                const initialSnapshot = await getDocs(q);
                const messagesArea = document.getElementById('chatMessagesArea');
                if (messagesArea) {
                    messagesArea.innerHTML = '';
                    
                    // Collect and sort messages by timestamp
                    const messages = [];
                    initialSnapshot.forEach(doc => {
                        const msg = { id: doc.id, ...doc.data() };
                        messages.push(msg);
                    });
                    
                    // Sort by timestamp (oldest first, newest last)
                    messages.sort((a, b) => {
                        const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (a.timestamp || 0);
                        const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (b.timestamp || 0);
                        return timeA - timeB;
                    });
                    
                    // Append messages in order
                    messages.forEach(msg => {
                        addMessageToAdminView(msg, chatId);
                    });
                    
                    // Scroll to bottom after loading
                    setTimeout(() => {
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }, 100);
                }

                // Listen for new messages in real-time
                onSnapshot(q, (snapshot) => {
                    const messagesArea = document.getElementById('chatMessagesArea');
                    if (!messagesArea) return;
                    
                    // Track existing message IDs to avoid duplicates
                    const existingIds = new Set();
                    messagesArea.querySelectorAll('[data-msg-id]').forEach(el => {
                        existingIds.add(el.getAttribute('data-msg-id'));
                    });
                    
                    // Collect new messages and sort them
                    const newMessages = [];
                    snapshot.forEach(doc => {
                        const msgId = doc.id;
                        if (!existingIds.has(msgId)) {
                            const msg = { id: msgId, ...doc.data() };
                            newMessages.push(msg);
                        }
                    });
                    
                    // Sort new messages by timestamp
                    newMessages.sort((a, b) => {
                        const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (a.timestamp || 0);
                        const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (b.timestamp || 0);
                        return timeA - timeB;
                    });
                    
                    // Add new messages in order (append at bottom)
                    newMessages.forEach(msg => {
                        addMessageToAdminView(msg, chatId);
                    });
                    
                    // Scroll to bottom when new messages arrive
                    setTimeout(() => {
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }, 100);
                });

                // Mark messages as read
                await markChatAsRead(chatId);
            } catch (error) {
                console.error('Error loading chat messages:', error);
            }
        }

        function addMessageToAdminView(msg, chatId) {
            const messagesArea = document.getElementById('chatMessagesArea');
            if (!messagesArea) return;

            const msgId = msg.id || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Check if message already exists to prevent duplicates
            if (messagesArea.querySelector(`[data-msg-id="${msgId}"]`)) {
                return;
            }

            const isAdmin = msg.sender === 'admin';
            let imageHtml = '';
            // Support both imageUrl (legacy) and imageBase64 (new method)
            const imageSrc = msg.imageBase64 || msg.imageUrl;
            if (imageSrc) {
                imageHtml = `
                    <div class="mb-2 rounded-lg overflow-hidden shadow-md">
                        <img src="${imageSrc}" alt="Shared image" class="max-w-full max-h-64 cursor-pointer hover:opacity-90 rounded transition-opacity" onclick="window.open('${imageSrc}', '_blank')">
                    </div>
                `;
            }
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex ${isAdmin ? 'justify-end' : 'justify-start'} mb-3 group relative`;
            msgDiv.setAttribute('data-msg-id', msgId);
            msgDiv.innerHTML = `
                <div class="max-w-[80%] ${isAdmin ? 'text-white' : 'bg-white text-gray-900 border border-gray-200'} rounded-lg p-3 shadow-sm relative" ${isAdmin ? 'style="background-color: #15803d;"' : ''}>
                    ${imageHtml}
                    ${msg.text ? `<div class="text-sm ${isAdmin ? 'text-white' : 'text-gray-800'}">${escapeHtml(msg.text)}</div>` : ''}
                    <div class="flex items-center justify-between mt-1.5">
                        <div class="text-xs ${isAdmin ? 'text-green-100 opacity-80' : 'text-gray-500'}">${formatChatTime(msg.timestamp)}</div>
                        <button onclick="deleteSingleMessage('${chatId}', '${msgId}')" 
                                class="ml-2 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity" 
                                title="Delete message">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Always append at bottom to maintain chronological order
            messagesArea.appendChild(msgDiv);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatChatTime(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        async function sendAdminReply(chatId) {
            const input = document.getElementById('adminReplyInput');
            const text = input.value.trim();
            if (!text || !chatId) return;

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, addDoc, serverTimestamp, updateDoc, doc } = firestoreModule;
                
                // Add message
                await addDoc(collection(db, 'live_chats', chatId, 'messages'), {
                    text,
                    sender: 'admin',
                    timestamp: serverTimestamp(),
                    read: false
                });

                // Update chat
                await updateDoc(doc(db, 'live_chats', chatId), {
                    lastMessageAt: serverTimestamp(),
                    status: 'open'
                });

                input.value = '';
            } catch (error) {
                console.error('Error sending reply:', error);
                showError('Failed to send message. Please try again.');
            }
        }

        async function deleteSingleMessage(chatId, messageId) {
            if (!chatId || !messageId) return;
            
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, deleteDoc } = firestoreModule;
                
                await deleteDoc(doc(db, 'live_chats', chatId, 'messages', messageId));
                
                // Remove message from UI
                const msgElement = document.querySelector(`[data-msg-id="${messageId}"]`);
                if (msgElement) {
                    msgElement.remove();
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                showError('Failed to delete message. Please try again.');
            }
        }

        async function markChatAsRead(chatId) {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, where, getDocs, updateDoc, doc } = firestoreModule;
                const messagesRef = collection(db, 'live_chats', chatId, 'messages');
                const q = query(messagesRef, where('read', '==', false), where('sender', '==', 'user'));
                const snapshot = await getDocs(q);
                
                snapshot.forEach(async (msgDoc) => {
                    await updateDoc(doc(db, 'live_chats', chatId, 'messages', msgDoc.id), {
                        read: true
                    });
                });

                loadChats(); // Refresh list
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        function closeChatView() {
            const chatView = document.getElementById('chatView');
            if (chatView) chatView.remove();
            selectedChatId = null;
        }

        function updateAdminChatBadge(count) {
            const badge = document.getElementById('adminChatBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // Load chats after auth is ready
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadChats();
            }
        });

        async function clearChatMessages(chatId) {
            if (!confirm('Are you sure you want to clear all messages in this chat? This action cannot be undone.')) {
                return;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, getDocs, deleteDoc, doc } = firestoreModule;
                
                // Delete all messages in the chat
                const messagesRef = collection(db, 'live_chats', chatId, 'messages');
                const messagesSnapshot = await getDocs(messagesRef);
                
                const deletePromises = messagesSnapshot.docs.map(msgDoc => 
                    deleteDoc(doc(db, 'live_chats', chatId, 'messages', msgDoc.id))
                );
                await Promise.all(deletePromises);
                
                // Clear the messages area
                const messagesArea = document.getElementById('chatMessagesArea');
                if (messagesArea) {
                    messagesArea.innerHTML = '<p class="text-gray-500 text-center py-4">All messages have been cleared.</p>';
                }
                
                // Reload chats to update last message
                loadChats();
                showSuccess('Chat messages cleared successfully!');
            } catch (error) {
                console.error('Error clearing chat messages:', error);
                showError('Failed to clear messages. Please try again.');
            }
        }

        async function deleteChat(chatId) {
            if (!confirm('Are you sure you want to delete this chat? This will delete all messages and the chat itself. This action cannot be undone.')) {
                return;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, getDocs, deleteDoc, doc } = firestoreModule;
                
                // Delete all messages in the chat
                const messagesRef = collection(db, 'live_chats', chatId, 'messages');
                const messagesSnapshot = await getDocs(messagesRef);
                
                const deletePromises = messagesSnapshot.docs.map(msgDoc => 
                    deleteDoc(doc(db, 'live_chats', chatId, 'messages', msgDoc.id))
                );
                await Promise.all(deletePromises);
                
                // Delete the chat document
                await deleteDoc(doc(db, 'live_chats', chatId));
                
                // Close chat view if it's the deleted chat
                if (selectedChatId === chatId) {
                    closeChatView();
                }
                
                // Reload chats
                loadChats();
                showSuccess('Chat deleted successfully!');
            } catch (error) {
                console.error('Error deleting chat:', error);
                showError('Failed to delete chat: ' + (error.message || 'Please try again.'));
            }
        }

        // Section switching function
        function showSection(section) {
            // Hide all sections
            document.getElementById('testimonialsSection').classList.add('hidden');
            document.getElementById('chatSection').classList.add('hidden');
            document.getElementById('kycSection').classList.add('hidden');
            document.getElementById('loansSection').classList.add('hidden');
            const transfersSection = document.getElementById('transfersSection');
            if (transfersSection) {
                transfersSection.classList.add('hidden');
            }
            const debitCardsSection = document.getElementById('debitCardsSection');
            if (debitCardsSection) {
                debitCardsSection.classList.add('hidden');
            }
            const usersSection = document.getElementById('usersSection');
            if (usersSection) {
                usersSection.classList.add('hidden');
            }
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section and update nav
            if (section === 'testimonials') {
                document.getElementById('testimonialsSection').classList.remove('hidden');
                document.querySelector('a[onclick*="testimonials"]').classList.add('active');
                document.getElementById('pageTitle').textContent = 'Testimonials';
            } else if (section === 'chat') {
                document.getElementById('chatSection').classList.remove('hidden');
                document.querySelector('a[onclick*="chat"]').classList.add('active');
                document.getElementById('pageTitle').textContent = 'Live Chat';
                // Load chats if not already loaded
                if (document.getElementById('chatsList').innerHTML.includes('Loading')) {
                    loadChats();
                }
                // Load chat user selector (for starting a chat)
                loadChatUserSelect();
            } else if (section === 'kyc') {
                document.getElementById('kycSection').classList.remove('hidden');
                document.querySelector('a[onclick*="kyc"]').classList.add('active');
                document.getElementById('pageTitle').textContent = 'KYC Verification';
                // Load KYC requests if not already loaded
                if (document.getElementById('kycList').innerHTML.includes('Loading')) {
                    loadKYCRequests();
                }
            } else if (section === 'loans') {
                document.getElementById('loansSection').classList.remove('hidden');
                document.querySelector('a[onclick*="loans"]').classList.add('active');
                document.getElementById('pageTitle').textContent = 'Loan Requests';
                // Load loan requests if not already loaded
                if (document.getElementById('loansList').innerHTML.includes('Loading')) {
                    loadLoanRequests();
                }
            } else if (section === 'transfers') {
                document.getElementById('transfersSection').classList.remove('hidden');
                document.querySelector('a[onclick*="transfers"]').classList.add('active');
                document.getElementById('pageTitle').textContent = 'Transfer Management';
                // Load pending transfers if not already loaded
                if (document.getElementById('pendingTransfersList').innerHTML.includes('Loading')) {
                    loadPendingTransfers();
                }
                // Load user selector for history editing
                loadTransferHistoryUserSelect();
            } else if (section === 'debitCards') {
                if (debitCardsSection) {
                    debitCardsSection.classList.remove('hidden');
                }
                const nav = document.querySelector('a[onclick*="debitCards"]');
                if (nav) nav.classList.add('active');
                document.getElementById('pageTitle').textContent = 'Debit Cards';
                if (!window.debitCardsLoaded) {
                    loadDebitCardRequests();
                }
            } else if (section === 'users') {
                if (usersSection) {
                    usersSection.classList.remove('hidden');
                }
                const usersNav = document.querySelector('a[onclick*="users"]');
                if (usersNav) {
                    usersNav.classList.add('active');
                }
                document.getElementById('pageTitle').textContent = 'Users';
                if (!window.adminUsersLoaded) {
                    loadAdminUsers();
                }
                if (!window.approvalRequestsLoaded) {
                    loadApprovalRequests();
                }
            }
            
            // Close mobile sidebar if open
            if (window.innerWidth < 768) {
                document.querySelector('.sidebar').classList.remove('open');
            }
        }

        // Users management helpers
        window.adminUsersLoaded = false;
        window.adminUsersCache = [];
        window.adminSelectedUserId = null;
        window.approvalRequestsLoaded = false;
        window.approvalRequestsUnsub = null;

        // Account approval requests
        async function loadApprovalRequests() {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    const listEl = document.getElementById('approvalRequestsList');
                    if (listEl) listEl.innerHTML = '<p class="text-gray-700 text-center py-4 text-sm">Not authenticated. Please log in.</p>';
                    return;
                }

                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, onSnapshot, updateDoc, doc, serverTimestamp, writeBatch } = firestoreModule;

                // Clean up previous listener if any
                if (window.approvalRequestsUnsub) {
                    try { window.approvalRequestsUnsub(); } catch {}
                    window.approvalRequestsUnsub = null;
                }

                const usersRef = collection(db, 'users');
                const listEl = document.getElementById('approvalRequestsList');
                const badge = document.getElementById('approvalBadge');

                // Wire bulk controls once (they operate on the currently-rendered list)
                if (!window.approvalBulkWired) {
                    const selectAllEl = document.getElementById('approvalSelectAll');
                    const approveSelectedBtn = document.getElementById('approveSelectedAccountsBtn');
                    const approveAllBtn = document.getElementById('approveAllAccountsBtn');

                    const updateBulkUi = () => {
                        const checkboxes = Array.from(document.querySelectorAll('#approvalRequestsList .approval-checkbox'));
                        const checked = checkboxes.filter(cb => cb.checked);
                        const selectedCountEl = document.getElementById('approvalSelectedCount');

                        if (selectedCountEl) {
                            selectedCountEl.textContent = checked.length ? `${checked.length} selected` : '';
                        }

                        if (approveSelectedBtn) approveSelectedBtn.disabled = checked.length === 0;

                        if (selectAllEl) {
                            const allChecked = checkboxes.length > 0 && checked.length === checkboxes.length;
                            const someChecked = checked.length > 0 && checked.length < checkboxes.length;
                            selectAllEl.checked = allChecked;
                            selectAllEl.indeterminate = someChecked;
                            selectAllEl.disabled = checkboxes.length === 0;
                        }
                    };

                    if (selectAllEl) {
                        selectAllEl.addEventListener('change', function () {
                            const checkboxes = Array.from(document.querySelectorAll('#approvalRequestsList .approval-checkbox'));
                            checkboxes.forEach(cb => cb.checked = this.checked);
                            updateBulkUi();
                        });
                    }

                    // Helper: approve many users (chunked batches to avoid 500-op limit)
                    window.approveUserIds = async function approveUserIds(userIds) {
                        const ids = Array.from(new Set((userIds || []).filter(Boolean)));
                        if (!ids.length) return;

                        const adminUser = auth.currentUser;
                        if (!adminUser) {
                            showError('You must be logged in to approve accounts.');
                            return;
                        }

                        const CHUNK = 450;
                        for (let i = 0; i < ids.length; i += CHUNK) {
                            const batch = writeBatch(db);
                            ids.slice(i, i + CHUNK).forEach((uid) => {
                                batch.update(doc(db, 'users', uid), {
                                    approvalStatus: 'approved',
                                    isApproved: true,
                                    approvedAt: serverTimestamp(),
                                    approvedBy: adminUser?.email || 'admin'
                                });
                            });
                            await batch.commit();
                        }
                    };

                    if (approveSelectedBtn) {
                        approveSelectedBtn.addEventListener('click', async () => {
                            const checked = Array.from(document.querySelectorAll('#approvalRequestsList .approval-checkbox:checked'))
                                .map(cb => cb.getAttribute('data-userid'))
                                .filter(Boolean);
                            if (!checked.length) return;
                            if (!confirm(`Approve ${checked.length} selected account(s)?`)) return;

                            try {
                                approveSelectedBtn.disabled = true;
                                approveSelectedBtn.textContent = 'Approving...';
                                await window.approveUserIds(checked);
                                showSuccess('Selected accounts approved successfully!');
                            } catch (err) {
                                console.error(err);
                                showError('Failed to approve selected accounts. Please try again.');
                            } finally {
                                approveSelectedBtn.textContent = 'Approve selected';
                                updateBulkUi();
                            }
                        });
                    }

                    if (approveAllBtn) {
                        approveAllBtn.addEventListener('click', async () => {
                            const ids = (window.latestApprovalQueueIds || []).slice();
                            if (!ids.length) return;
                            if (!confirm(`Approve ALL ${ids.length} account(s) currently in the approval queue?`)) return;

                            try {
                                approveAllBtn.disabled = true;
                                approveAllBtn.textContent = 'Approving...';
                                await window.approveUserIds(ids);
                                showSuccess('All queued accounts approved successfully!');
                            } catch (err) {
                                console.error(err);
                                showError('Failed to approve all queued accounts. Please try again.');
                            } finally {
                                approveAllBtn.disabled = false;
                                approveAllBtn.textContent = 'Approve all';
                            }
                        });
                    }

                    // Update bulk UI when any checkbox changes (delegated)
                    if (listEl) {
                        listEl.addEventListener('change', (e) => {
                            if (e.target && e.target.classList && e.target.classList.contains('approval-checkbox')) {
                                updateBulkUi();
                            }
                        });
                    }

                    window.approvalBulkWired = true;
                    // Initialize state
                    try { updateBulkUi(); } catch {}
                }

                window.approvalRequestsUnsub = onSnapshot(usersRef, (snapshot) => {
                    // Determine which users need approval using the same logic as login/dashboard.
                    const isUserApproved = (u) => {
                        const approvalStatus = u?.approvalStatus ?? null;
                        const isApproved = (typeof u?.isApproved === 'boolean') ? u.isApproved : null;
                        return approvalStatus === 'approved' || (approvalStatus == null && isApproved !== false);
                    };

                    const requests = [];
                    snapshot.forEach((d) => {
                        const data = d.data() || {};
                        const u = { id: d.id, ...data };
                        if (!isUserApproved(u)) {
                            requests.push(u);
                        }
                    });

                    // Store latest queue IDs for "Approve all"
                    window.latestApprovalQueueIds = requests.map(r => r.id);

                    // Client-side sort (newest first) supporting different createdAt formats
                    const toMs = (v) => {
                        if (!v) return 0;
                        if (typeof v === 'string') return new Date(v).getTime() || 0;
                        if (v.toDate) return v.toDate().getTime();
                        return 0;
                    };
                    requests.sort((a, b) => toMs(b.createdAt || b.createdAtIso) - toMs(a.createdAt || a.createdAtIso));

                    if (badge) {
                        badge.textContent = `${requests.length} pending`;
                        badge.className = requests.length
                            ? 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-900 border border-gray-300'
                            : 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200';
                    }

                    if (!listEl) return;

                    if (!requests.length) {
                        listEl.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No pending sign‑up requests.</p>';
                        return;
                    }

                    listEl.innerHTML = requests.map((u) => {
                        const name = [u.firstName, u.lastName].filter(Boolean).join(' ') || u.fullName || 'Unknown';
                        const email = u.email || u.userEmail || '-';
                        const acct = u.userAccountType || '-';
                        const product = u.accountType || '-';
                        const deposit = (u.onboarding?.depositMethods && Array.isArray(u.onboarding.depositMethods) && u.onboarding.depositMethods.length)
                            ? u.onboarding.depositMethods.join(', ')
                            : (u.onboarding?.depositMethod || '-');
                        const residency = u.onboarding?.residency || '-';
                        const created = (u.createdAt?.toDate ? u.createdAt.toDate() : (u.createdAtIso ? new Date(u.createdAtIso) : null));
                        const createdLabel = created ? created.toLocaleDateString() : 'N/A';

                        return `
                          <div class="bg-white border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                              <div class="flex items-start gap-3 min-w-0">
                                <input type="checkbox" class="approval-checkbox mt-1 rounded border-gray-300" data-userid="${u.id}">
                              <div class="min-w-0">
                                <p class="font-semibold text-gray-900 truncate">${name} <span class="text-gray-400 font-normal">(${acct})</span></p>
                                <p class="text-sm text-gray-600 truncate">${email}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                  Product: <span class="font-medium text-gray-700">${product}</span> • Submitted: ${createdLabel}
                                </p>
                                <p class="text-xs text-gray-500 mt-1">
                                  Onboarding: Deposit <span class="font-medium text-gray-700">${deposit}</span> • Residency <span class="font-medium text-gray-700">${residency}</span>
                                </p>
                                </div>
                              </div>
                              <div class="flex gap-2 shrink-0">
                                <button data-approve="${u.id}" class="approveAccountBtn px-4 py-2 rounded-lg text-white text-sm font-semibold transition" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                  <i class="fas fa-check mr-2"></i>Approve
                                </button>
                              </div>
                            </div>
                          </div>
                        `;
                    }).join('');

                    // Wire approve buttons
                    listEl.querySelectorAll('.approveAccountBtn').forEach((btn) => {
                        btn.addEventListener('click', async () => {
                            const userId = btn.getAttribute('data-approve');
                            if (!userId) return;
                            if (!confirm('Approve this account? This will allow the user to access the dashboard.')) return;

                            try {
                                btn.disabled = true;
                                btn.classList.add('opacity-75', 'cursor-not-allowed');
                                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Approving...';

                                const adminUser = auth.currentUser;
                                await updateDoc(doc(db, 'users', userId), {
                                    approvalStatus: 'approved',
                                    isApproved: true,
                                    approvedAt: serverTimestamp(),
                                    approvedBy: adminUser?.email || 'admin'
                                });

                                showSuccess('Account approved successfully!');
                            } catch (err) {
                                console.error(err);
                                showError('Failed to approve account. Please try again.');
                            } finally {
                                // The snapshot will re-render the list; no need to restore button HTML.
                            }
                        });
                    });
                }, (err) => {
                    console.error('Approval requests listener error:', err);
                    const listEl = document.getElementById('approvalRequestsList');
                    if (listEl) {
                        listEl.innerHTML = `<p class="text-gray-700 text-center py-4 text-sm">Failed to load approval requests: ${err.message}</p>`;
                    }
                });

                window.approvalRequestsLoaded = true;
            } catch (error) {
                console.error('Error loading approval requests:', error);
                const listEl = document.getElementById('approvalRequestsList');
                if (listEl) listEl.innerHTML = '<p class="text-gray-700 text-center py-4 text-sm">Error loading approval requests.</p>';
            }
        }

        async function loadAdminUsers() {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    document.getElementById('adminUserSelect').innerHTML = '<option value=\"\">Not authenticated</option>';
                    return;
                }

                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, getDocs } = firestoreModule;

                const usersRef = collection(db, 'users');
                const snapshot = await getDocs(usersRef);

                const select = document.getElementById('adminUserSelect');
                if (!snapshot.empty) {
                    window.adminUsersCache = [];
                    select.innerHTML = '<option value=\"\">Select a user...</option>';

                    snapshot.forEach(docSnap => {
                        const data = docSnap.data() || {};
                        const uid = docSnap.id;
                        const name = data.firstName || data.name || data.fullName || 'Unknown';
                        const email = data.email || data.userEmail || '';
                        window.adminUsersCache.push({ id: uid, data });

                        const option = document.createElement('option');
                        option.value = uid;
                        option.textContent = email ? `${name} (${email})` : `${name} (${uid})`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value=\"\">No users found</option>';
                }

                select.onchange = function () {
                    const userId = this.value;
                    if (userId) {
                        renderAdminUserDetails(userId);
                    } else {
                        window.adminSelectedUserId = null;
                    }
                };

                window.adminUsersLoaded = true;
            } catch (error) {
                console.error('Error loading admin users:', error);
                const select = document.getElementById('adminUserSelect');
                if (select) {
                    select.innerHTML = '<option value=\"\">Error loading users</option>';
                }
            }
        }

        function renderAdminUserDetails(userId) {
            window.adminSelectedUserId = userId;
            const entry = (window.adminUsersCache || []).find(u => u.id === userId);
            const data = entry ? (entry.data || {}) : {};

            const name = data.firstName || data.name || data.fullName || 'Unknown';
            const email = data.email || data.userEmail || '-';
            const status = data.status || '-';
            // Format amounts as "1,000.00" (no $ sign)
            const formatAmount = (value) => {
                if (!value) return '0.00';
                const num = typeof value === 'string' 
                    ? parseFloat(value.replace(/[^0-9.-]/g, '')) || 0
                    : Number(value) || 0;
                return new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                }).format(num);
            };

            const checkingRaw = data.checking ?? 0;
            const checkingDisplay = formatAmount(checkingRaw);
            const fixedRaw = data.fixed ?? 0;
            const fixedDisplay = formatAmount(fixedRaw);
            const savingsRaw = data.savings ?? 0;
            const savingsDisplay = formatAmount(savingsRaw);

            const idEl = document.getElementById('adminUserId');
            const nameEl = document.getElementById('adminUserName');
            const emailEl = document.getElementById('adminUserEmail');
            const statusEl = document.getElementById('adminUserStatusLabel');
            const checkingEl = document.getElementById('adminUserChecking');
            const fixedEl = document.getElementById('adminUserFixed');
            const savingsEl = document.getElementById('adminUserSavings');
            const statusSelect = document.getElementById('adminUserStatusSelect');

            if (idEl) idEl.textContent = userId;
            if (nameEl) nameEl.textContent = name;
            if (emailEl) emailEl.textContent = email;
            if (statusEl) statusEl.textContent = status;
            if (checkingEl) checkingEl.textContent = checkingDisplay;
            if (fixedEl) fixedEl.textContent = fixedDisplay;
            if (savingsEl) savingsEl.textContent = savingsDisplay;
            if (statusSelect) statusSelect.value = status || '';
            
            // Pre-fill set amount inputs with current values
            const checkingSetInput = document.getElementById('adminCheckingSetAmount');
            const fixedSetInput = document.getElementById('adminFixedSetAmount');
            const savingsSetInput = document.getElementById('adminSavingsSetAmount');
            if (checkingSetInput) checkingSetInput.value = '';
            if (fixedSetInput) fixedSetInput.value = '';
            if (savingsSetInput) savingsSetInput.value = '';

            // Load histories into the list
            loadUserHistories();
        }

        // Loading state helper functions
        function setButtonLoading(buttonId, isLoading, originalText = null) {
            const btn = document.getElementById(buttonId);
            if (!btn) return;
            
            if (isLoading) {
                btn.dataset.originalText = btn.innerHTML;
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-not-allowed');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                if (btn.dataset.originalText) {
                    btn.innerHTML = btn.dataset.originalText;
                    delete btn.dataset.originalText;
                } else if (originalText) {
                    btn.innerHTML = originalText;
                }
            }
        }

        // Helper function to format amount as "1,000.00" (no $)
        function formatAmountForDB(amount) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            }).format(amount);
        }

        // Helper function to parse amount from DB
        function parseAmountFromDB(value) {
            if (!value) return 0;
            return typeof value === 'string'
                ? parseFloat(value.replace(/[^0-9.-]/g, '')) || 0
                : Number(value) || 0;
        }

        // Helper function to parse currency-formatted input (e.g., "$1,200.00" -> 1200.00)
        function parseCurrencyInput(inputValue) {
            if (!inputValue) return null;
            const cleaned = String(inputValue).trim()
                .replace(/[$,\s]/g, '') // Remove $, commas, and spaces
                .replace(/[^0-9.-]/g, ''); // Remove any other non-numeric characters except . and -
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? null : parsed;
        }

        // Add to Checking
        window.adminAddChecking = async function () {
            const userId = window.adminSelectedUserId;
            if (!userId) {
                showError('Please select a user first.');
                return;
            }

            const input = document.getElementById('adminCheckingAddAmount');
            if (!input) return;

            const amount = parseCurrencyInput(input.value);
            if (amount === null || amount <= 0) {
                showError('Please enter a valid amount greater than 0 (e.g., $1,200.00).');
                return;
            }

            const btnId = 'adminAddCheckingBtn';
            setButtonLoading(btnId, true);

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, getDoc, updateDoc } = firestoreModule;

                const userRef = doc(db, 'users', userId);
                const snap = await getDoc(userRef);
                const data = snap.exists() ? snap.data() : {};

                const currentCheckingNum = parseAmountFromDB(data.checking);
                const newCheckingNum = currentCheckingNum + amount;
                const formattedChecking = formatAmountForDB(newCheckingNum);

                await updateDoc(userRef, { checking: formattedChecking });

                // Update cache
                const cacheEntry = (window.adminUsersCache || []).find(u => u.id === userId);
                if (cacheEntry) {
                    cacheEntry.data = cacheEntry.data || {};
                    cacheEntry.data.checking = formattedChecking;
                }

                renderAdminUserDetails(userId);
                input.value = '';
                showSuccess(`Added ${formatAmountForDB(amount)} to checking account.`);
            } catch (error) {
                console.error('Error adding to checking:', error);
                showError('Failed to add to checking account. Please try again.');
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        // Set Checking amount
        window.adminSetChecking = async function () {
            const userId = window.adminSelectedUserId;
            if (!userId) {
                showError('Please select a user first.');
                return;
            }

            const input = document.getElementById('adminCheckingSetAmount');
            if (!input) return;

            const amount = parseCurrencyInput(input.value);
            if (amount === null || amount < 0) {
                showError('Please enter a valid amount (0 or greater, e.g., $1,200.00).');
                return;
            }

            const btnId = 'adminSetCheckingBtn';
            setButtonLoading(btnId, true);

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, updateDoc } = firestoreModule;

                const userRef = doc(db, 'users', userId);
                const formattedChecking = formatAmountForDB(amount);

                await updateDoc(userRef, { checking: formattedChecking });

                // Update cache
                const cacheEntry = (window.adminUsersCache || []).find(u => u.id === userId);
                if (cacheEntry) {
                    cacheEntry.data = cacheEntry.data || {};
                    cacheEntry.data.checking = formattedChecking;
                }

                renderAdminUserDetails(userId);
                input.value = '';
                showSuccess(`Checking account set to ${formattedChecking}.`);
            } catch (error) {
                console.error('Error setting checking:', error);
                showError('Failed to set checking account. Please try again.');
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        // Add to Fixed
        window.adminAddFixed = async function () {
            const userId = window.adminSelectedUserId;
            if (!userId) {
                showError('Please select a user first.');
                return;
            }

            const input = document.getElementById('adminFixedAddAmount');
            if (!input) return;

            const amount = parseCurrencyInput(input.value);
            if (amount === null || amount <= 0) {
                showError('Please enter a valid amount greater than 0 (e.g., $1,200.00).');
                return;
            }

            const btnId = 'adminAddFixedBtn';
            setButtonLoading(btnId, true);

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, getDoc, updateDoc } = firestoreModule;

                const userRef = doc(db, 'users', userId);
                const snap = await getDoc(userRef);
                const data = snap.exists() ? snap.data() : {};

                const currentFixedNum = parseAmountFromDB(data.fixed);
                const newFixedNum = currentFixedNum + amount;
                const formattedFixed = formatAmountForDB(newFixedNum);

                await updateDoc(userRef, { fixed: formattedFixed });

                // Update cache
                const cacheEntry = (window.adminUsersCache || []).find(u => u.id === userId);
                if (cacheEntry) {
                    cacheEntry.data = cacheEntry.data || {};
                    cacheEntry.data.fixed = formattedFixed;
                }

                renderAdminUserDetails(userId);
                input.value = '';
                showSuccess(`Added ${formatAmountForDB(amount)} to fixed account.`);
            } catch (error) {
                console.error('Error adding to fixed:', error);
                showError('Failed to add to fixed account. Please try again.');
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        // Set Fixed amount
        window.adminSetFixed = async function () {
            const userId = window.adminSelectedUserId;
            if (!userId) {
                showError('Please select a user first.');
                return;
            }

            const input = document.getElementById('adminFixedSetAmount');
            if (!input) return;

            const amount = parseCurrencyInput(input.value);
            if (amount === null || amount < 0) {
                showError('Please enter a valid amount (0 or greater, e.g., $1,200.00).');
                return;
            }

            const btnId = 'adminSetFixedBtn';
            setButtonLoading(btnId, true);

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, updateDoc } = firestoreModule;

                const userRef = doc(db, 'users', userId);
                const formattedFixed = formatAmountForDB(amount);

                await updateDoc(userRef, { fixed: formattedFixed });

                // Update cache
                const cacheEntry = (window.adminUsersCache || []).find(u => u.id === userId);
                if (cacheEntry) {
                    cacheEntry.data = cacheEntry.data || {};
                    cacheEntry.data.fixed = formattedFixed;
                }

                renderAdminUserDetails(userId);
                input.value = '';
                showSuccess(`Fixed account set to ${formattedFixed}.`);
            } catch (error) {
                console.error('Error setting fixed:', error);
                showError('Failed to set fixed account. Please try again.');
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        // Add to Savings
        window.adminAddSavings = async function () {
            const userId = window.adminSelectedUserId;
            if (!userId) {
                showError('Please select a user first.');
                return;
            }

            const input = document.getElementById('adminSavingsAddAmount');
            if (!input) return;

            const amount = parseCurrencyInput(input.value);
            if (amount === null || amount <= 0) {
                showError('Please enter a valid amount greater than 0 (e.g., $1,200.00).');
                return;
            }

            const btnId = 'adminAddSavingsBtn';
            setButtonLoading(btnId, true);

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, getDoc, updateDoc } = firestoreModule;

                const userRef = doc(db, 'users', userId);
                const snap = await getDoc(userRef);
                const data = snap.exists() ? snap.data() : {};

                const currentSavingsNum = parseAmountFromDB(data.savings);
                const newSavingsNum = currentSavingsNum + amount;
                const formattedSavings = formatAmountForDB(newSavingsNum);

                await updateDoc(userRef, { savings: formattedSavings });

                // Update cache
                const cacheEntry = (window.adminUsersCache || []).find(u => u.id === userId);
                if (cacheEntry) {
                    cacheEntry.data = cacheEntry.data || {};
                    cacheEntry.data.savings = formattedSavings;
                }

                renderAdminUserDetails(userId);
                input.value = '';
                showSuccess(`Added ${formatAmountForDB(amount)} to savings account.`);
            } catch (error) {
                console.error('Error adding to savings:', error);
                showError('Failed to add to savings account. Please try again.');
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        // Set Savings amount
        window.adminSetSavings = async function () {
            const userId = window.adminSelectedUserId;
            if (!userId) {
                showError('Please select a user first.');
                return;
            }

            const input = document.getElementById('adminSavingsSetAmount');
            if (!input) return;

            const amount = parseCurrencyInput(input.value);
            if (amount === null || amount < 0) {
                showError('Please enter a valid amount (0 or greater, e.g., $1,200.00).');
                return;
            }

            const btnId = 'adminSetSavingsBtn';
            setButtonLoading(btnId, true);

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, updateDoc } = firestoreModule;

                const userRef = doc(db, 'users', userId);
                const formattedSavings = formatAmountForDB(amount);

                await updateDoc(userRef, { savings: formattedSavings });

                // Update cache
                const cacheEntry = (window.adminUsersCache || []).find(u => u.id === userId);
                if (cacheEntry) {
                    cacheEntry.data = cacheEntry.data || {};
                    cacheEntry.data.savings = formattedSavings;
                }

                renderAdminUserDetails(userId);
                input.value = '';
                showSuccess(`Savings account set to ${formattedSavings}.`);
            } catch (error) {
                console.error('Error setting savings:', error);
                showError('Failed to set savings account. Please try again.');
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        // Render history list with checkboxes
        function renderHistoryList(histories) {
            const listContainer = document.getElementById('adminHistoryList');
            if (!listContainer) return;

            if (!histories || histories.length === 0) {
                listContainer.innerHTML = '<p class="text-xs text-gray-500 text-center py-4">No histories to display</p>';
                return;
            }

            listContainer.innerHTML = '';
            histories.forEach((history, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'flex items-start gap-2 p-2 bg-gray-50 rounded border border-gray-200 hover:bg-gray-100';
                entryDiv.innerHTML = `
                    <input type="checkbox" 
                           class="history-checkbox mt-1 rounded border-gray-300" 
                           data-index="${index}"
                           id="history-check-${index}">
                    <label for="history-check-${index}" class="flex-1 text-xs font-mono text-gray-700 cursor-pointer">
                        ${history}
                    </label>
                `;
                listContainer.appendChild(entryDiv);
            });

            // Update select all checkbox
            updateSelectAllCheckbox();
        }

        // Update select all checkbox state
        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('adminSelectAllHistory');
            const checkboxes = document.querySelectorAll('.history-checkbox');
            if (!selectAll || checkboxes.length === 0) return;

            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            selectAll.checked = allChecked;
            selectAll.indeterminate = someChecked && !allChecked;
        }

        // Select all checkbox handler
        document.addEventListener('DOMContentLoaded', function() {
            const selectAll = document.getElementById('adminSelectAllHistory');
            if (selectAll) {
                selectAll.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.history-checkbox');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                });
            }

            // Handle individual checkbox changes
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('history-checkbox')) {
                    updateSelectAllCheckbox();
                }
            });
        });

        // Load existing histories from user document
        async function loadUserHistories() {
            const userId = window.adminSelectedUserId;
            if (!userId) {
                renderHistoryList([]);
                return;
            }

            try {
                // Try to get from cache first
                const cacheEntry = (window.adminUsersCache || []).find(u => u.id === userId);
                let data = cacheEntry ? (cacheEntry.data || {}) : {};

                // If not in cache or cache is empty, fetch from Firestore
                if (!cacheEntry || Object.keys(data).length === 0) {
                    const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                    const { doc, getDoc } = firestoreModule;

                    const userRef = doc(db, 'users', userId);
                    const snap = await getDoc(userRef);
                    
                    if (!snap.exists()) {
                        renderHistoryList([]);
                        return;
                    }

                    data = snap.data();
                }

                const histories = [];
                for (let i = 1; i <= 15; i++) {
                    const history = data[`history${i}`];
                    if (history && history.trim() !== '') {
                        histories.push(history.trim());
                    }
                }

                renderHistoryList(histories);
            } catch (error) {
                console.error('Error loading histories:', error);
                showError('Failed to load histories.');
            }
        }

        window.adminGenerateHistory = function () {
            const input = document.getElementById('adminHistoryTemplateInput');
            const statusEl = document.getElementById('adminHistoryGenStatus');
            const btnId = 'adminGenerateHistoryBtn';
            
            if (!input) {
                showError('Required elements not found.');
                return;
            }

            const template = input.value.trim();
            if (!template) {
                showError('Please enter a history entry template.');
                return;
            }

            setButtonLoading(btnId, true);

            try {
                // Parse the template
                const parts = template.split('|').map(p => p.trim());
                if (parts.length < 7) {
                    throw new Error('Invalid format. Expected: Type | Date | Name | CP | Amount | Time | TransactionID |');
                }

                const type = parts[0].trim();
                const name = parts[2].trim();
                const cp = parts[3].trim();
                const amountStr = parts[4].trim().replace(/[+$,\s]/g, '');
                const sign = parts[4].includes('-') ? '-' : '+';
                const amount = parseFloat(amountStr);

                if (isNaN(amount)) {
                    throw new Error('Invalid amount format.');
                }

                // Utility functions
                function isWeekend(d) {
                    const day = d.getDay();
                    return day === 0 || day === 6;
                }
                function toPreviousBusinessDay(d) {
                    const dd = new Date(d);
                    while (isWeekend(dd)) dd.setDate(dd.getDate() - 1);
                    return dd;
                }
                function randInt(min, max) {
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                }
                function formatDate(d) {
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const day = String(d.getDate()).padStart(2, '0');
                    const mon = months[d.getMonth()];
                    const yy = String(d.getFullYear()).slice(-2);
                    return `${day}-${mon}-${yy}`;
                }
                function formatTime(d) {
                    let h = d.getHours();
                    const m = String(d.getMinutes()).padStart(2, '0');
                    const ampm = h >= 12 ? 'pm' : 'am';
                    h = h % 12;
                    if (h === 0) h = 12;
                    return `${h}:${m} ${ampm}`;
                }
                function formatMoney(amountAbs) {
                    const nf = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    return `$${nf.format(amountAbs)}`;
                }
                function randomTxnId(len = 15) {
                    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                    let out = '';
                    for (let i = 0; i < len; i++) out += chars.charAt(randInt(0, chars.length - 1));
                    return out;
                }
                function getRandomBackdatedBusinessDay(baseDate, daysBack) {
                    // Create a date that is daysBack days before baseDate
                    let date = new Date(baseDate);
                    date.setDate(date.getDate() - daysBack);
                    
                    // Ensure it's a business day (Monday-Friday)
                    while (isWeekend(date)) {
                        date.setDate(date.getDate() - 1);
                    }
                    
                    // Set random working hours (9am to 4pm)
                    const hour = randInt(9, 16);
                    const minutes = randInt(0, 59);
                    date.setHours(hour, minutes, 0, 0);
                    
                    return date;
                }

                // Generate 15 history entries with random backdated dates from 2019-2025
                const generatedHistories = [];
                
                // Start from a random date between 2019-2025 (most recent)
                const startYear = randInt(2019, 2025);
                const startMonth = randInt(0, 11);
                const startDay = randInt(1, 28);
                let baseDate = new Date(startYear, startMonth, startDay);
                
                // Ensure base date is a business day
                while (isWeekend(baseDate)) {
                    baseDate.setDate(baseDate.getDate() - 1);
                }
                
                // Generate dates going back in time, with random months/years
                let daysBack = 0;
                for (let i = 0; i < 15; i++) {
                    // For each entry, randomly choose how many days back (increasing)
                    // This ensures backdating while allowing random months
                    daysBack += randInt(30, 180); // 1-6 months between entries
                    
                    // Generate date going back
                    let dt = getRandomBackdatedBusinessDay(baseDate, daysBack);
                    
                    // Ensure date is not before 2019
                    const minDate = new Date(2019, 0, 1);
                    if (dt < minDate) {
                        // If too old, generate a random date in 2019-2025 range
                        const year = randInt(2019, 2025);
                        const month = randInt(0, 11);
                        const day = randInt(1, 28);
                        dt = new Date(year, month, day);
                        while (isWeekend(dt)) {
                            dt.setDate(dt.getDate() - 1);
                        }
                        dt.setHours(randInt(9, 16), randInt(0, 59), 0, 0);
                    }
                    
                    const txnId = randomTxnId(15);
                    const line = `${type} | ${formatDate(dt)} | ${name} | ${cp} | ${sign}${formatMoney(amount)} | ${formatTime(dt)} | ${txnId} |`;
                    generatedHistories.push(line);
                }
                
                // Sort by date descending (newest first) to ensure proper backdating order
                const entriesWithDates = generatedHistories.map((line, idx) => {
                    const dateStr = line.split('|')[1].trim();
                    // Parse date string (e.g., "15-Aug-25")
                    const [day, monthName, year] = dateStr.split('-');
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const month = months.indexOf(monthName);
                    const fullYear = 2000 + parseInt(year);
                    const date = new Date(fullYear, month, parseInt(day));
                    return { line, date };
                });
                
                entriesWithDates.sort((a, b) => b.date - a.date);
                generatedHistories.length = 0;
                entriesWithDates.forEach(entry => generatedHistories.push(entry.line));

                // Populate the history list with checkboxes
                renderHistoryList(generatedHistories);

                // Show success message
                if (statusEl) {
                    statusEl.textContent = '✓ Generated 15 history entries successfully!';
                    statusEl.className = 'text-xs text-green-600';
                }

                showSuccess('Generated 15 history entries. Review and click "Save History 1–15" to apply.');
            } catch (error) {
                console.error('Error generating history:', error);
                if (statusEl) {
                    statusEl.textContent = `Error: ${error.message}`;
                    statusEl.className = 'text-xs text-gray-600';
                }
                showError(`Failed to generate history: ${error.message}`);
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        window.adminSaveHistory = async function () {
            const userId = window.adminSelectedUserId;
            if (!userId) {
                showError('Please select a user first.');
                return;
            }

            const btnId = 'adminSaveHistoryBtn';
            setButtonLoading(btnId, true);

            // Get histories from the list (all entries, not just checked ones)
            const historyEntries = document.querySelectorAll('#adminHistoryList .history-checkbox');
            const histories = [];
            historyEntries.forEach((checkbox) => {
                const label = checkbox.nextElementSibling;
                if (label && label.textContent.trim()) {
                    histories.push(label.textContent.trim());
                }
            });

            const updates = {};
            for (let i = 1; i <= 15; i++) {
                const line = histories[i - 1] || '';
                updates[`history${i}`] = line;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, updateDoc, getDoc } = firestoreModule;

                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, updates);

                // Refresh cache from Firestore for accuracy
                const snap = await getDoc(userRef);
                const data = snap.exists() ? snap.data() : {};
                const cacheEntry = (window.adminUsersCache || []).find(u => u.id === userId);
                if (cacheEntry) {
                    cacheEntry.data = data;
                }

                // Reload the history list
                await loadUserHistories();

                showSuccess('History 1–15 updated successfully.');
            } catch (error) {
                console.error('Error saving history:', error);
                showError('Failed to save history. Please try again.');
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        window.adminDeleteHistory = async function () {
            const userId = window.adminSelectedUserId;
            if (!userId) {
                showError('Please select a user first.');
                return;
            }

            const checkedBoxes = document.querySelectorAll('.history-checkbox:checked');
            if (checkedBoxes.length === 0) {
                showError('Please select at least one history entry to delete.');
                return;
            }

            const btnId = 'adminDeleteHistoryBtn';
            setButtonLoading(btnId, true);

            // Get all current history entries
            const allHistoryEntries = document.querySelectorAll('#adminHistoryList .history-checkbox');
            const remainingHistories = [];
            
            allHistoryEntries.forEach((checkbox) => {
                // If not checked, keep it
                if (!checkbox.checked) {
                    const label = checkbox.nextElementSibling;
                    if (label && label.textContent.trim()) {
                        remainingHistories.push(label.textContent.trim());
                    }
                }
            });

            // Remove checked entries from the UI
            checkedBoxes.forEach(checkbox => {
                const entryDiv = checkbox.closest('div');
                if (entryDiv) {
                    entryDiv.remove();
                }
            });

            // Update select all checkbox
            updateSelectAllCheckbox();

            // Save to Firestore immediately
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, updateDoc, getDoc } = firestoreModule;

                const userRef = doc(db, 'users', userId);
                
                // Prepare updates - clear all history fields first, then set remaining ones
                const updates = {};
                for (let i = 1; i <= 15; i++) {
                    updates[`history${i}`] = remainingHistories[i - 1] || '';
                }

                await updateDoc(userRef, updates);

                // Refresh cache from Firestore for accuracy
                const snap = await getDoc(userRef);
                const data = snap.exists() ? snap.data() : {};
                const cacheEntry = (window.adminUsersCache || []).find(u => u.id === userId);
                if (cacheEntry) {
                    cacheEntry.data = data;
                }

                // Reload the history list to reflect changes
                await loadUserHistories();

                showSuccess(`Deleted ${checkedBoxes.length} history entr${checkedBoxes.length === 1 ? 'y' : 'ies'} from Firestore successfully.`);
            } catch (error) {
                console.error('Error deleting history:', error);
                showError('Failed to delete histories from Firestore. Please try again.');
                
                // Reload histories to restore UI state
                await loadUserHistories();
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        window.adminSaveStatus = async function () {
            const userId = window.adminSelectedUserId;
            if (!userId) {
                showError('Please select a user first.');
                return;
            }

            const select = document.getElementById('adminUserStatusSelect');
            if (!select) return;

            const status = (select.value || '').trim();
            if (!status) {
                showError('Please select a valid status.');
                return;
            }

            const btnId = 'adminSaveStatusBtn';
            setButtonLoading(btnId, true);

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, updateDoc } = firestoreModule;

                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, { status });

                const cacheEntry = (window.adminUsersCache || []).find(u => u.id === userId);
                if (cacheEntry) {
                    cacheEntry.data = cacheEntry.data || {};
                    cacheEntry.data.status = status;
                }

                renderAdminUserDetails(userId);
                showSuccess('User status updated successfully.');
            } catch (error) {
                console.error('Error updating status:', error);
                showError('Failed to update status. Please try again.');
            } finally {
                setButtonLoading(btnId, false);
            }
        };

        // Load KYC requests
        async function loadKYCRequests() {
            try {
                // Verify admin is authenticated
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    document.getElementById('kycList').innerHTML = '<p class="text-gray-700 text-center py-8">Not authenticated. Please log in.</p>';
                    return;
                }

                // Log admin info for debugging
                console.log('Loading KYC - Admin user:', {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    emailVerified: currentUser.emailVerified
                });

                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, orderBy, getDocs, onSnapshot } = firestoreModule;
                const kycRef = collection(db, 'kyc_requests');
                
                // Try with orderBy first, fallback to no orderBy if it fails
                let q;
                try {
                    q = query(kycRef, orderBy('submittedAt', 'desc'));
                } catch (orderError) {
                    console.warn('OrderBy failed for KYC, trying without order:', orderError);
                    q = query(kycRef);
                }

                onSnapshot(q, async (snapshot) => {
                    const kycRequests = [];
                    let pendingCount = 0;

                    snapshot.forEach(doc => {
                        const kycData = doc.data();
                        kycRequests.push({
                            id: doc.id,
                            ...kycData
                        });
                        if (kycData.status === 'pending' || kycData.status === 'reviewed') {
                            pendingCount++;
                        }
                    });

                    // Sort manually if orderBy failed
                    if (kycRequests.length > 0 && kycRequests[0].submittedAt) {
                        kycRequests.sort((a, b) => {
                            const timeA = a.submittedAt?.toDate ? a.submittedAt.toDate().getTime() : 0;
                            const timeB = b.submittedAt?.toDate ? b.submittedAt.toDate().getTime() : 0;
                            return timeB - timeA; // Descending
                        });
                    }

                    renderKYCList(kycRequests);
                    updateKYCBadge(pendingCount);
                }, (err) => {
                    console.error('KYC listener error:', err);
                    const errorMessage = err.message || 'Unknown error';
                    const adminEmail = currentUser?.email || 'Not available';
                    const adminUid = currentUser?.uid || 'Not available';
                    const errorHtml = '<div class="text-gray-700 text-center py-8">' +
                        '<p class="font-semibold mb-2">Failed to load KYC requests</p>' +
                        '<p class="text-sm">' + errorMessage + '</p>' +
                        '<p class="text-xs text-gray-500 mt-4">Admin Email: ' + adminEmail + '</p>' +
                        '<p class="text-xs text-gray-500">Admin UID: ' + adminUid + '</p>' +
                        '<button onclick="loadKYCRequests()" class="mt-4 px-4 py-2 text-white rounded-lg" style="background-color: #15803d;" onmouseover="this.style.backgroundColor=\'#140099\'" onmouseout="this.style.backgroundColor=\'#15803d\'">' +
                        'Retry' +
                        '</button>' +
                        '</div>';
                    document.getElementById('kycList').innerHTML = errorHtml;
                });
            } catch (error) {
                console.error('Error loading KYC requests:', error);
                document.getElementById('kycList').innerHTML = '<p class="text-gray-700 text-center py-8">Error loading KYC requests. Please refresh.</p>';
            }
        }

        // Render KYC list
        function renderKYCList(kycRequests) {
            const listEl = document.getElementById('kycList');
            
            if (kycRequests.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-8">No KYC requests found.</p>';
                return;
            }

            listEl.innerHTML = kycRequests.map(kyc => {
                const submittedDate = kyc.submittedAt?.toDate ? kyc.submittedAt.toDate().toLocaleDateString() : 'N/A';
                const statusLabel = (kyc.status || 'pending');
                const statusBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">${statusLabel}</span>`;

                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900">${kyc.userEmail || 'Unknown User'}</h3>
                                <p class="text-sm text-gray-600">User ID: ${kyc.userId || 'N/A'}</p>
                                <p class="text-xs text-gray-500 mt-1">Submitted: ${submittedDate}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${statusBadge}
                                <button onclick="deleteKYCRecord('${kyc.id}', '${kyc.userId || ''}')" class="text-gray-500 hover:text-gray-900 p-1" title="Delete KYC record">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        ${kyc.idImageBase64 ? `
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ID Image</label>
                                <div class="border border-gray-300 rounded-lg p-2 bg-gray-50">
                                    <img src="${kyc.idImageBase64}" alt="ID Image" class="max-w-full h-auto rounded-lg max-h-64 mx-auto cursor-pointer" onclick="openImageModal('${kyc.idImageBase64}')">
                                </div>
                            </div>
                        ` : ''}
                        
                        ${kyc.status === 'pending' || kyc.status === 'reviewed' ? `
                            <div class="flex gap-2">
                                <button onclick="approveKYC('${kyc.id}', '${kyc.userId}')" 
                                    class="flex-1 text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                    <i class="fas fa-check mr-2"></i>Approve
                                </button>
                                <button onclick="rejectKYC('${kyc.id}', '${kyc.userId}')" 
                                    class="flex-1 bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-times mr-2"></i>Reject
                                </button>
                                ${kyc.status === 'pending' ? `
                                <button onclick="reviewKYC('${kyc.id}', '${kyc.userId}')" 
                                    class="flex-1 bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-eye mr-2"></i>Mark as Reviewed
                                </button>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${kyc.reviewedAt ? `
                            <p class="text-xs text-gray-500 mt-2">
                                Reviewed: ${kyc.reviewedAt.toDate ? kyc.reviewedAt.toDate().toLocaleDateString() : 'N/A'}
                                ${kyc.reviewedBy ? ` by ${kyc.reviewedBy}` : ''}
                            </p>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Approve KYC
        async function approveKYC(kycId, userId) {
            if (!confirm('Are you sure you want to approve this KYC verification?')) {
                return;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, setDoc, updateDoc, serverTimestamp } = firestoreModule;
                const adminUser = auth.currentUser;

                // Update KYC request status
                const kycRef = doc(db, 'kyc_requests', kycId);
                await updateDoc(kycRef, {
                    status: 'approved',
                    reviewedAt: serverTimestamp(),
                    reviewedBy: adminUser.email
                });

                // Update user's KYC status
                const userRef = doc(db, 'users', userId);
                await setDoc(userRef, { kycStatus: 'approved' }, { merge: true });

                showSuccess('KYC verification approved successfully!');
            } catch (error) {
                console.error('Error approving KYC:', error);
                showError('Failed to approve KYC. Please try again.');
            }
        }

        // Reject KYC
        async function rejectKYC(kycId, userId) {
            if (!confirm('Are you sure you want to reject this KYC verification?')) {
                return;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, setDoc, updateDoc, serverTimestamp } = firestoreModule;
                const adminUser = auth.currentUser;

                // Update KYC request status
                const kycRef = doc(db, 'kyc_requests', kycId);
                await updateDoc(kycRef, {
                    status: 'rejected',
                    reviewedAt: serverTimestamp(),
                    reviewedBy: adminUser.email
                });

                // Update user's KYC status
                const userRef = doc(db, 'users', userId);
                await setDoc(userRef, { kycStatus: 'rejected' }, { merge: true });

                showSuccess('KYC verification rejected.');
            } catch (error) {
                console.error('Error rejecting KYC:', error);
                showError('Failed to reject KYC. Please try again.');
            }
        }

        // Mark KYC as Reviewed
        async function reviewKYC(kycId, userId) {
            if (!confirm('Mark this KYC verification as reviewed?')) {
                return;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, setDoc, updateDoc, serverTimestamp } = firestoreModule;
                const adminUser = auth.currentUser;

                // Update KYC request status
                const kycRef = doc(db, 'kyc_requests', kycId);
                await updateDoc(kycRef, {
                    status: 'reviewed',
                    reviewedAt: serverTimestamp(),
                    reviewedBy: adminUser.email
                });

                // Update user's KYC status
                const userRef = doc(db, 'users', userId);
                await setDoc(userRef, { kycStatus: 'reviewed' }, { merge: true });

                showSuccess('KYC verification marked as reviewed.');
            } catch (error) {
                console.error('Error reviewing KYC:', error);
                showError('Failed to mark KYC as reviewed. Please try again.');
            }
        }

        // Delete KYC record (admin only)
        async function deleteKYCRecord(kycId, userId) {
            if (!confirm('Delete this KYC record? This will remove the KYC request document.')) {
                return;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, deleteDoc, setDoc } = firestoreModule;

                // Delete the KYC request document
                await deleteDoc(doc(db, 'kyc_requests', kycId));

                // Keep user's KYC status consistent (best-effort)
                if (userId) {
                    await setDoc(doc(db, 'users', userId), { kycStatus: 'not_completed' }, { merge: true });
                }

                showSuccess('KYC record deleted.');
            } catch (error) {
                console.error('Error deleting KYC record:', error);
                showError('Failed to delete KYC record. Please try again.');
            }
        }

        // Update KYC badge
        function updateKYCBadge(count) {
            const badge = document.getElementById('adminKYCBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // Debit cards badge
        function updateDebitCardBadge(count) {
            const badge = document.getElementById('adminDebitCardBadge');
            const headerBadge = document.getElementById('debitCardBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
            if (headerBadge) {
                headerBadge.textContent = `${count} pending`;
            }
        }

        function randomDigits(len) {
            let out = '';
            for (let i = 0; i < len; i++) out += Math.floor(Math.random() * 10);
            return out;
        }

        // Generate a Luhn-valid 16-digit number (looks real but is not)
        function generateLuhnPan() {
            // Start with 15 random digits, compute checksum
            const base = randomDigits(15).split('').map(Number);
            // Luhn checksum for 16-digit PAN
            let sum = 0;
            for (let i = 0; i < 15; i++) {
                let digit = base[i];
                if (i % 2 === 0) { // double odd positions (0-index) for 16-digit length
                    digit *= 2;
                    if (digit > 9) digit -= 9;
                }
                sum += digit;
            }
            const check = (10 - (sum % 10)) % 10;
            return base.join('') + String(check);
        }

        function generateExpiry() {
            const now = new Date();
            const month = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
            const year = String(now.getFullYear() + 3); // 3 years out
            return { expMonth: month, expYear: year };
        }

        // Load debit card requests + issued cards (admin)
        async function loadDebitCardRequests() {
            try {
                const currentUser = auth.currentUser;
                const reqListEl = document.getElementById('debitCardRequestsList');
                const issuedEl = document.getElementById('issuedDebitCardsList');
                if (!currentUser) {
                    if (reqListEl) reqListEl.innerHTML = '<p class="text-gray-700 text-center py-4 text-sm">Not authenticated. Please log in.</p>';
                    if (issuedEl) issuedEl.innerHTML = '<p class="text-gray-700 text-center py-4 text-sm">Not authenticated. Please log in.</p>';
                    return;
                }

                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, where, onSnapshot, doc, getDoc, setDoc, updateDoc, serverTimestamp, writeBatch, getDocs, deleteDoc } = firestoreModule;

                // Keep helpers accessible for click handlers
                window.__debitCardFirestore = { doc, getDoc, setDoc, updateDoc, serverTimestamp, writeBatch, deleteDoc };

                // Requests listener
                const appsRef = collection(db, 'debit_card_applications');
                const q = query(appsRef, where('status', '==', 'pending'));

                if (window.debitCardsUnsub) {
                    try { window.debitCardsUnsub(); } catch {}
                    window.debitCardsUnsub = null;
                }

                window.approveAndIssueDebitCard = async function approveAndIssueDebitCard(appId, userId) {
                    try {
                        const helpers = window.__debitCardFirestore;
                        if (!helpers) throw new Error('Firestore helpers not ready');
                        const { doc, getDoc, setDoc, updateDoc, serverTimestamp, writeBatch } = helpers;

                        // Fetch user to get display name
                        const userSnap = await getDoc(doc(db, 'users', userId));
                        const u = userSnap.exists() ? userSnap.data() : {};
                        const name = `${u.firstName || ''} ${u.lastName || ''}`.trim() || (u.name || 'Cardholder');

                        // Generate card details
                        const pan = generateLuhnPan();
                        const cvv = randomDigits(3);
                        const { expMonth, expYear } = generateExpiry();
                        const last4 = pan.slice(-4);

                        const batch = writeBatch(db);
                        batch.set(doc(db, 'debit_cards', userId), {
                            userId,
                            status: 'active',
                            cardholderName: name,
                            last4,
                            expMonth,
                            expYear,
                            issuedAt: serverTimestamp(),
                            issuedAtIso: new Date().toISOString()
                        }, { merge: true });

                        batch.set(doc(db, 'debit_card_secrets', userId), {
                            userId,
                            pan,
                            cvv,
                            expMonth,
                            expYear,
                            issuedAt: serverTimestamp(),
                            issuedAtIso: new Date().toISOString()
                        }, { merge: true });

                        batch.update(doc(db, 'debit_card_applications', appId), {
                            status: 'approved',
                            approvedAt: serverTimestamp(),
                            approvedAtIso: new Date().toISOString(),
                            last4,
                            expMonth,
                            expYear
                        });

                        await batch.commit();
                        showSuccess(`Approved and issued virtual debit card for ${name}.`);
                    } catch (err) {
                        console.error('approveAndIssueDebitCard error', err);
                        const code = err?.code || '';
                        if (code === 'permission-denied' || (err?.message || '').toLowerCase().includes('insufficient permissions')) {
                            const email = auth?.currentUser?.email || 'unknown';
                            showError(
                                'Missing permissions to issue debit cards. ' +
                                `Signed in as: ${email}. ` +
                                'Fix: (1) deploy the updated `firestore.rules` to the `twenty-forth-fifth` project, and (2) ensure this email is listed in `isAdmin()`.'
                            );
                        } else {
                            showError('Failed to approve/issue debit card: ' + (err.message || 'Please try again.'));
                        }
                    }
                };

                // Reject (keep request for audit) or delete (remove request so user can re-request)
                window.rejectDebitCardRequest = async function rejectDebitCardRequest(appId, userId) {
                    try {
                        const helpers = window.__debitCardFirestore;
                        if (!helpers) throw new Error('Firestore helpers not ready');
                        const { doc, updateDoc, serverTimestamp } = helpers;
                        await updateDoc(doc(db, 'debit_card_applications', appId), {
                            status: 'rejected',
                            rejectedAt: serverTimestamp(),
                            rejectedAtIso: new Date().toISOString()
                        });
                        showSuccess(`Rejected debit card request for ${userId}.`);
                    } catch (err) {
                        console.error('rejectDebitCardRequest error', err);
                        showError('Failed to reject request: ' + (err.message || 'Please try again.'));
                    }
                };

                window.deleteDebitCardRequest = async function deleteDebitCardRequest(appId, userId) {
                    try {
                        if (!confirm(`Delete debit card request for ${userId}?`)) return;
                        const helpers = window.__debitCardFirestore;
                        if (!helpers) throw new Error('Firestore helpers not ready');
                        const { doc, deleteDoc } = helpers;
                        await deleteDoc(doc(db, 'debit_card_applications', appId));
                        showSuccess(`Deleted debit card request for ${userId}.`);
                    } catch (err) {
                        console.error('deleteDebitCardRequest error', err);
                        showError('Failed to delete request: ' + (err.message || 'Please try again.'));
                    }
                };

                // Card status management
                window.setDebitCardStatus = async function setDebitCardStatus(userId, status) {
                    try {
                        const helpers = window.__debitCardFirestore;
                        if (!helpers) throw new Error('Firestore helpers not ready');
                        const { doc, setDoc, serverTimestamp } = helpers;
                        await setDoc(doc(db, 'debit_cards', userId), {
                            status,
                            statusUpdatedAt: serverTimestamp(),
                            statusUpdatedAtIso: new Date().toISOString()
                        }, { merge: true });
                        showSuccess(`Card status updated: ${userId} → ${status}.`);
                    } catch (err) {
                        console.error('setDebitCardStatus error', err);
                        showError('Failed to update card status: ' + (err.message || 'Please try again.'));
                    }
                };

                // Delete card + secrets + application so user can re-request
                window.deleteDebitCard = async function deleteDebitCard(userId) {
                    try {
                        if (!confirm(`Delete debit card for ${userId}? This removes card + secrets + request.`)) return;
                        const helpers = window.__debitCardFirestore;
                        if (!helpers) throw new Error('Firestore helpers not ready');
                        const { doc, writeBatch } = helpers;
                        const batch = writeBatch(db);
                        batch.delete(doc(db, 'debit_cards', userId));
                        batch.delete(doc(db, 'debit_card_secrets', userId));
                        batch.delete(doc(db, 'debit_card_applications', userId));
                        await batch.commit();
                        showSuccess(`Deleted debit card (and request) for ${userId}.`);
                    } catch (err) {
                        console.error('deleteDebitCard error', err);
                        showError('Failed to delete card: ' + (err.message || 'Please try again.'));
                    }
                };

                window.debitCardsUnsub = onSnapshot(q, async (snapshot) => {
                    const pending = [];
                    snapshot.forEach(d => pending.push({ id: d.id, ...d.data() }));
                    updateDebitCardBadge(pending.length);

                    if (!reqListEl) return;
                    if (pending.length === 0) {
                        reqListEl.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No pending debit card requests.</p>';
                    } else {
                        reqListEl.innerHTML = pending.map(app => {
                            const requestedAt = app.createdAt?.toDate ? app.createdAt.toDate().toLocaleString() : (app.createdAtIso || '—');
                            const uid = app.userId || app.id;
                            return `
                              <div class="border border-gray-200 rounded-xl p-4 bg-white">
                                <div class="flex items-start justify-between gap-3">
                                  <div>
                                    <div class="text-sm font-semibold text-gray-900">User: <span class="font-mono text-xs">${uid}</span></div>
                                    <div class="text-xs text-gray-600 mt-1">Requested: ${requestedAt}</div>
                                    <div class="text-xs text-gray-600 mt-1">Type: ${app.cardType || '—'} • Linked: ${app.linkedAccount || '—'}</div>
                                  </div>
                                  <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                                    <button type="button"
                                        class="px-3 py-2 rounded-lg text-white text-xs font-semibold transition" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'"
                                        onclick="approveAndIssueDebitCard('${app.id}', '${uid}')">
                                      Approve &amp; Issue
                                    </button>
                                    <button type="button"
                                        class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 text-xs font-semibold transition"
                                        onclick="rejectDebitCardRequest('${app.id}', '${uid}')">
                                      Reject
                                    </button>
                                    <button type="button"
                                        class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-red-700 border border-red-200 text-xs font-semibold transition"
                                        onclick="deleteDebitCardRequest('${app.id}', '${uid}')">
                                      Delete
                                    </button>
                                  </div>
                                </div>
                              </div>
                            `;
                        }).join('');
                    }
                }, (err) => {
                    console.error('Debit card requests listener error', err);
                    if (reqListEl) reqListEl.innerHTML = `<p class="text-gray-700 text-center py-4 text-sm">Failed to load requests: ${err.message}</p>`;
                });

                // Issued cards list (one-time fetch; can be upgraded to onSnapshot)
                try {
                    const cardsRef = collection(db, 'debit_cards');
                    const cardsSnap = await getDocs(cardsRef);
                    const cards = [];
                    cardsSnap.forEach(d => cards.push({ id: d.id, ...d.data() }));
                    if (issuedEl) {
                        if (!cards.length) {
                            issuedEl.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No issued cards yet.</p>';
                        } else {
                            issuedEl.innerHTML = cards.slice(0, 50).map(c => {
                                const issuedAt = c.issuedAt?.toDate ? c.issuedAt.toDate().toLocaleString() : (c.issuedAtIso || '—');
                                const status = (c.status || 'active').toLowerCase();
                                const badge = status === 'active'
                                    ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-200">Active</span>'
                                    : status === 'hold'
                                        ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-amber-50 text-amber-700 border border-amber-200">On hold</span>'
                                        : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">Suspended</span>';
                                return `
                                  <div class="border border-gray-200 rounded-xl p-4 bg-white">
                                    <div class="flex items-start justify-between gap-3">
                                      <div>
                                        <div class="text-sm font-semibold text-gray-900">${c.cardholderName || 'Cardholder'}</div>
                                        <div class="text-xs text-gray-600 mt-1">User: <span class="font-mono">${c.userId || c.id}</span></div>
                                        <div class="text-xs text-gray-600 mt-1">•••• ${c.last4 || '—'} • Exp ${c.expMonth || '--'}/${String(c.expYear || '').slice(-2) || '--'}</div>
                                        <div class="text-xs text-gray-500 mt-1">Issued: ${issuedAt}</div>
                                      </div>
                                      <div class="flex flex-col items-end gap-2">
                                        ${badge}
                                        <div class="flex flex-wrap gap-2 justify-end">
                                          <button type="button"
                                            class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 text-xs font-semibold transition"
                                            onclick="setDebitCardStatus('${c.userId || c.id}', 'active')">
                                            Activate
                                          </button>
                                          <button type="button"
                                            class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-amber-700 border border-amber-200 text-xs font-semibold transition"
                                            onclick="setDebitCardStatus('${c.userId || c.id}', 'hold')">
                                            Hold
                                          </button>
                                          <button type="button"
                                            class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-xs font-semibold transition"
                                            onclick="setDebitCardStatus('${c.userId || c.id}', 'suspended')">
                                            Suspend
                                          </button>
                                          <button type="button"
                                            class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-red-700 border border-red-200 text-xs font-semibold transition"
                                            onclick="deleteDebitCard('${c.userId || c.id}')">
                                            Delete
                                          </button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                `;
                            }).join('');
                        }
                    }
                } catch (e) {
                    console.warn('Issued cards list failed', e);
                    if (issuedEl) issuedEl.innerHTML = '<p class="text-gray-700 text-center py-4 text-sm">Failed to load issued cards.</p>';
                }

                window.debitCardsLoaded = true;
            } catch (error) {
                console.error('Error loading debit cards:', error);
                const reqListEl = document.getElementById('debitCardRequestsList');
                if (reqListEl) reqListEl.innerHTML = '<p class="text-gray-700 text-center py-4 text-sm">Error loading debit cards.</p>';
                updateDebitCardBadge(0);
                window.debitCardsLoaded = true;
            }
        }

        // Load Loan Requests
        async function loadLoanRequests() {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    document.getElementById('loansList').innerHTML = '<p class="text-gray-700 text-center py-8">Not authenticated. Please log in.</p>';
                    return;
                }

                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, query, orderBy, getDocs, onSnapshot } = firestoreModule;
                const loansRef = collection(db, 'loan_requests');
                
                let q;
                try {
                    q = query(loansRef, orderBy('createdAt', 'desc'));
                } catch (orderError) {
                    console.warn('OrderBy failed for loans, trying without order:', orderError);
                    q = query(loansRef);
                }

                onSnapshot(q, async (snapshot) => {
                    const loanRequests = [];
                    let pendingCount = 0;

                    snapshot.forEach(doc => {
                        const loanData = doc.data();
                        loanRequests.push({
                            id: doc.id,
                            ...loanData
                        });
                        if (loanData.status === 'pending') {
                            pendingCount++;
                        }
                    });

                    // Sort manually if orderBy failed
                    if (loanRequests.length > 0 && loanRequests[0].createdAt) {
                        loanRequests.sort((a, b) => {
                            const timeA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                            const timeB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                            return timeB - timeA; // Descending
                        });
                    }

                    renderLoanList(loanRequests);
                    updateLoanBadge(pendingCount);
                }, (err) => {
                    console.error('Loan listener error:', err);
                    const errorHtml = `
                        <div class="text-gray-700 text-center py-8">
                            <p class="font-semibold mb-2">Failed to load loan requests</p>
                            <p class="text-sm">${err.message}</p>
                            <p class="text-xs text-gray-500 mt-4">Admin Email: ${currentUser?.email || 'Not available'}</p>
                            <button onclick="loadLoanRequests()" class="mt-4 px-4 py-2 text-white rounded-lg" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                Retry
                            </button>
                        </div>
                    `;
                    document.getElementById('loansList').innerHTML = errorHtml;
                });
            } catch (error) {
                console.error('Error loading loan requests:', error);
                document.getElementById('loansList').innerHTML = '<p class="text-gray-700 text-center py-8">Error loading loan requests. Please refresh.</p>';
            }
        }

        // Render Loan list
        function renderLoanList(loanRequests) {
            const listEl = document.getElementById('loansList');
            
            if (loanRequests.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-8">No loan requests found.</p>';
                return;
            }

            listEl.innerHTML = loanRequests.map(loan => {
                const submittedDate = loan.createdAt?.toDate ? loan.createdAt.toDate().toLocaleDateString() : 'N/A';
                const statusLabel = (loan.status || 'pending');
                const statusBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">${statusLabel}</span>`;

                const repaymentWindowText = loan.repaymentWindow === 'yearly' ? 'Yearly' 
                    : loan.repaymentWindow === '12' ? '12 Months (Monthly)'
                    : loan.repaymentWindow === '6' ? '6 Months'
                    : loan.repaymentWindow === '3' ? '3 Months'
                    : loan.repaymentWindow || 'N/A';

                return `
                    <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="text-lg font-semibold text-gray-900">${loan.firstName || ''} ${loan.lastName || ''}</h3>
                                    ${statusBadge}
                                </div>
                                <p class="text-sm text-gray-600">Email: ${loan.email || 'N/A'}</p>
                                <p class="text-sm text-gray-600">Phone: ${loan.phone || 'N/A'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-gray-900">$${(loan.loanAmount || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <p class="text-sm text-gray-600">Submitted: ${submittedDate}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm">
                            <div>
                                <p class="text-gray-600"><span class="font-semibold">Credit Score:</span> ${loan.creditScore || 'N/A'}</p>
                                <p class="text-gray-600"><span class="font-semibold">Purpose:</span> ${loan.loanPurpose || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-gray-600"><span class="font-semibold">Repayment Window:</span> ${repaymentWindowText}</p>
                                <p class="text-gray-600"><span class="font-semibold">Employment:</span> ${loan.employmentStatus || 'N/A'}</p>
                            </div>
                        </div>
                        
                        ${loan.description ? `<p class="text-sm text-gray-700 mb-4 bg-gray-50 p-3 rounded"><span class="font-semibold">Additional Info:</span> ${loan.description}</p>` : ''}
                        
                        ${loan.status === 'pending' ? `
                            <div class="flex gap-2 mt-4">
                                <button onclick="window.approveLoan('${loan.id}', '${loan.userId}')" 
                                    class="flex-1 text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                    <i class="fas fa-check mr-2"></i>Approve
                                </button>
                                <button onclick="window.rejectLoan('${loan.id}', '${loan.userId}')" 
                                    class="flex-1 bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-times mr-2"></i>Reject
                                </button>
                            </div>
                        ` : loan.status === 'approved' ? `
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <button onclick="window.viewLoanPayments('${loan.userId}')" 
                                    class="w-full text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                    <i class="fas fa-calendar-check mr-2"></i>Manage Payments
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Approve Loan
        window.approveLoan = async function(requestId, userId) {
            console.log('Approve loan called with:', { requestId, userId });
            
            if (!confirm('Are you sure you want to approve this loan application?')) {
                return;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, updateDoc, setDoc, getDoc, serverTimestamp } = firestoreModule;
                const adminUser = auth.currentUser;
                
                if (!adminUser) {
                    showError('You must be logged in to approve loans.');
                    return;
                }

                console.log('Admin user:', adminUser.email);

                // Get loan request data
                const loanRequestRef = doc(db, 'loan_requests', requestId);
                const loanRequestDoc = await getDoc(loanRequestRef);
                if (!loanRequestDoc.exists()) {
                    showError('Loan request not found.');
                    return;
                }
                const loanData = loanRequestDoc.data();
                console.log('Loan data:', loanData);

                // Update loan request status
                await updateDoc(loanRequestRef, {
                    status: 'approved',
                    approvedAt: serverTimestamp(),
                    approvedBy: adminUser.email
                });

                // Get user's current balance
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                const userData = userDoc.exists() ? userDoc.data() : {};
                
                // Calculate loan amount to fund (loan amount minus collateral fee)
                const loanAmount = loanData.loanAmount || 0;
                const collateralFee = loanData.upfrontFee || (loanAmount * 0.1);
                const amountToFund = loanAmount - collateralFee;
                
                // Get current checking balance
                const currentChecking = parseFloat(userData.checking?.replace(/[$,]/g, '') || userData.checking || 0);
                const newChecking = currentChecking + amountToFund;
                
                // Format the new checking amount
                const formattedChecking = newChecking.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                // Update user's checking balance with the funded loan amount
                await setDoc(userRef, {
                    checking: formattedChecking
                }, { merge: true });
                
                // Update user's loan document
                const userLoanRef = doc(db, 'loans', userId);
                await setDoc(userLoanRef, {
                    ...loanData,
                    status: 'approved',
                    approvedAt: serverTimestamp(),
                    approvedBy: adminUser.email,
                    paidAmount: 0,
                    fundedAmount: amountToFund,
                    collateralFee: collateralFee,
                    fundedAt: serverTimestamp()
                }, { merge: true });

                showSuccess(`Loan application approved successfully! $${amountToFund.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} has been funded to the user's account.`);
                
                // Reload loan requests to update the UI
                loadLoanRequests();
            } catch (error) {
                console.error('Error approving loan:', error);
                showError('Failed to approve loan: ' + (error.message || 'Please try again.'));
            }
        };

        // Reject Loan
        window.rejectLoan = async function(requestId, userId) {
            if (!confirm('Are you sure you want to reject this loan application?')) {
                return;
            }

            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, updateDoc, setDoc, serverTimestamp } = firestoreModule;
                const adminUser = auth.currentUser;

                // Update loan request status
                const loanRequestRef = doc(db, 'loan_requests', requestId);
                await updateDoc(loanRequestRef, {
                    status: 'rejected',
                    rejectedAt: serverTimestamp(),
                    rejectedBy: adminUser.email
                });

                // Update user's loan document
                const userLoanRef = doc(db, 'loans', userId);
                await setDoc(userLoanRef, {
                    status: 'rejected',
                    rejectedAt: serverTimestamp(),
                    rejectedBy: adminUser.email
                }, { merge: true });

                showSuccess('Loan application rejected.');
                
                // Reload loan requests to update the UI
                loadLoanRequests();
            } catch (error) {
                console.error('Error rejecting loan:', error);
                showError('Failed to reject loan: ' + (error.message || 'Please try again.'));
            }
        };

        // View Loan Payments
        window.viewLoanPayments = async function(userId) {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, getDoc } = firestoreModule;
                
                // Get loan document
                const loanRef = doc(db, 'loans', userId);
                const loanDoc = await getDoc(loanRef);
                
                if (!loanDoc.exists()) {
                    showError('Loan not found.');
                    return;
                }
                
                const loanData = loanDoc.data();
                const loanAmount = loanData.loanAmount || 0;
                const repaymentWindow = loanData.repaymentWindow || '12';
                const paidAmount = loanData.paidAmount || 0;
                const paymentHistory = loanData.paymentHistory || [];
                
                // Calculate payment schedule
                let totalPayments = 0;
                let paymentAmount = 0;
                
                if (repaymentWindow === 'yearly') {
                    totalPayments = 12;
                    paymentAmount = loanAmount / 12;
                } else {
                    totalPayments = parseInt(repaymentWindow) || 12;
                    paymentAmount = loanAmount / totalPayments;
                }
                
                // Generate payment schedule HTML
                let paymentScheduleHTML = '';
                const currentDate = new Date();
                
                for (let i = 1; i <= totalPayments; i++) {
                    const paymentDate = new Date(currentDate);
                    paymentDate.setMonth(paymentDate.getMonth() + i);
                    
                    // Check payment status from history
                    const paymentIndex = i - 1;
                    const paymentStatus = paymentHistory[paymentIndex]?.status || 'pending';
                    const paymentPaidDate = paymentHistory[paymentIndex]?.paidDate || null;
                    const paymentDefaultedDate = paymentHistory[paymentIndex]?.defaultedDate || null;
                    
                    const isPaid = paymentStatus === 'paid';
                    const isDefaulted = paymentStatus === 'defaulted';
                    const isOverdue = !isPaid && !isDefaulted && paymentDate < currentDate;
                    
                    paymentScheduleHTML += `
                        <div class="flex items-center justify-between p-4 rounded-lg border bg-white border-gray-200">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="${isPaid ? 'background-color: #15803d;' : isDefaulted ? 'background-color: #140099;' : isOverdue ? 'background-color: #0d0066;' : 'background-color: #d1d5db;'}">
                                    <i class="fas ${isPaid ? 'fa-check' : isDefaulted ? 'fa-times' : isOverdue ? 'fa-exclamation' : 'fa-clock'} text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-900">Payment ${i} of ${totalPayments}</p>
                                    <p class="text-sm text-gray-600">Due: ${paymentDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                                    ${paymentPaidDate ? `<p class="text-xs text-gray-600 mt-1">Paid: ${paymentPaidDate.toDate ? paymentPaidDate.toDate().toLocaleDateString() : paymentPaidDate}</p>` : ''}
                                    ${paymentDefaultedDate ? `<p class="text-xs text-gray-600 mt-1">Defaulted: ${paymentDefaultedDate.toDate ? paymentDefaultedDate.toDate().toLocaleDateString() : paymentDefaultedDate}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right mr-4">
                                    <p class="font-semibold text-gray-900">$${paymentAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                    <p class="text-xs text-gray-600">${isPaid ? 'Paid' : isDefaulted ? 'Defaulted' : isOverdue ? 'Overdue' : 'Pending'}</p>
                                </div>
                                ${!isPaid && !isDefaulted ? `
                                    <button onclick="window.markPaymentPaid('${userId}', ${i}, ${paymentAmount})" 
                                        class="text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                        <i class="fas fa-check mr-1"></i>Paid
                                    </button>
                                    <button onclick="window.markPaymentDefaulted('${userId}', ${i}, ${paymentAmount})" 
                                        class="bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                                        <i class="fas fa-times mr-1"></i>Defaulted
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 flex items-center justify-center z-50 p-4';
                modal.style.backgroundColor = 'rgba(24, 0, 172, 0.5)';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900">Payment Management</h3>
                                <p class="text-sm text-gray-600 mt-1">${loanData.firstName || ''} ${loanData.lastName || ''} - Loan Amount: $${loanAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <p class="text-sm text-gray-600">Paid: $${paidAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} / Remaining: $${(loanAmount - paidAmount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                                &times;
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3" id="paymentScheduleContainer">
                                ${paymentScheduleHTML}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close modal on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } catch (error) {
                console.error('Error loading loan payments:', error);
                showError('Failed to load payment schedule: ' + (error.message || 'Please try again.'));
            }
        };
        
        // Mark Payment as Paid
        window.markPaymentPaid = async function(userId, paymentNumber, paymentAmount) {
            if (!confirm(`Mark Payment ${paymentNumber} as Paid?`)) {
                return;
            }
            
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, getDoc, updateDoc, serverTimestamp, Timestamp } = firestoreModule;
                const adminUser = auth.currentUser;
                
                // Get current loan data
                const loanRef = doc(db, 'loans', userId);
                const loanDoc = await getDoc(loanRef);
                
                if (!loanDoc.exists()) {
                    showError('Loan not found.');
                    return;
                }
                
                const loanData = loanDoc.data();
                const currentPaidAmount = loanData.paidAmount || 0;
                const paymentHistory = loanData.paymentHistory || [];
                
                // Use Timestamp.now() instead of serverTimestamp() for array elements
                const paidTimestamp = Timestamp.now();
                
                // Update payment history
                paymentHistory[paymentNumber - 1] = {
                    paymentNumber: paymentNumber,
                    amount: paymentAmount,
                    status: 'paid',
                    paidDate: paidTimestamp,
                    markedBy: adminUser.email
                };
                
                // Calculate new paid amount (sum of all paid payments)
                const newPaidAmount = paymentHistory
                    .filter(p => p && p.status === 'paid')
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                
                // Update loan document
                await updateDoc(loanRef, {
                    paidAmount: newPaidAmount,
                    paymentHistory: paymentHistory,
                    lastPaymentDate: serverTimestamp()
                });
                
                showSuccess(`Payment ${paymentNumber} marked as paid successfully!`);
                
                // Close current modal and reload payment view
                const currentModal = document.querySelector('.fixed.inset-0[style*="background-color"]');
                if (currentModal) {
                    currentModal.remove();
                }
                setTimeout(() => {
                    window.viewLoanPayments(userId);
                }, 300);
            } catch (error) {
                console.error('Error marking payment as paid:', error);
                showError('Failed to mark payment as paid: ' + (error.message || 'Please try again.'));
            }
        };
        
        // Mark Payment as Defaulted
        window.markPaymentDefaulted = async function(userId, paymentNumber, paymentAmount) {
            if (!confirm(`Mark Payment ${paymentNumber} as Defaulted? This will be recorded in the loan history.`)) {
                return;
            }
            
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, getDoc, updateDoc, serverTimestamp, Timestamp } = firestoreModule;
                const adminUser = auth.currentUser;
                
                // Get current loan data
                const loanRef = doc(db, 'loans', userId);
                const loanDoc = await getDoc(loanRef);
                
                if (!loanDoc.exists()) {
                    showError('Loan not found.');
                    return;
                }
                
                const loanData = loanDoc.data();
                const paymentHistory = loanData.paymentHistory || [];
                
                // Use Timestamp.now() instead of serverTimestamp() for array elements
                const defaultedTimestamp = Timestamp.now();
                
                // Update payment history
                paymentHistory[paymentNumber - 1] = {
                    paymentNumber: paymentNumber,
                    amount: paymentAmount,
                    status: 'defaulted',
                    defaultedDate: defaultedTimestamp,
                    markedBy: adminUser.email
                };
                
                // Update loan document
                await updateDoc(loanRef, {
                    paymentHistory: paymentHistory,
                    hasDefault: true,
                    lastDefaultDate: serverTimestamp()
                });
                
                showSuccess(`Payment ${paymentNumber} marked as defaulted.`);
                
                // Close current modal and reload payment view
                const currentModal = document.querySelector('.fixed.inset-0[style*="background-color"]');
                if (currentModal) {
                    currentModal.remove();
                }
                setTimeout(() => {
                    window.viewLoanPayments(userId);
                }, 300);
            } catch (error) {
                console.error('Error marking payment as defaulted:', error);
                showError('Failed to mark payment as defaulted: ' + (error.message || 'Please try again.'));
            }
        };

        // Update Loan badge
        function updateLoanBadge(count) {
            const badge = document.getElementById('adminLoanBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // Open image modal
        window.openImageModal = function(imageBase64) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 p-4';
            modal.style.backgroundColor = 'rgba(24, 0, 172, 0.75)';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-2 right-2 text-white rounded-full p-2" style="background-color: rgba(24, 0, 172, 0.5);" onmouseover="this.style.backgroundColor='rgba(24, 0, 172, 0.75)'" onmouseout="this.style.backgroundColor='rgba(24, 0, 172, 0.5)'">
                        <i class="fas fa-times"></i>
                    </button>
                    <img src="${imageBase64}" alt="ID Image" class="max-w-full max-h-screen rounded-lg">
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        };

        // Sidebar toggle for mobile
        document.getElementById('openSidebar')?.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.add('open');
        });
        document.getElementById('closeSidebar')?.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.remove('open');
        });

        // Expose functions globally
        window.showSection = showSection;
        // ========== TRANSFER MANAGEMENT FUNCTIONS ==========
        
        // Load all pending transfers from all users
        async function loadPendingTransfers() {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, getDocs } = firestoreModule;
                
                const usersRef = collection(db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                
                const pendingTransfers = [];
                
                usersSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const userId = userDoc.id;
                    
                    // Check all pending slots
                    for (let i = 1; i <= 5; i++) {
                        const pendingField = `pending${i}`;
                        const pendingValue = userData[pendingField];
                        
                        if (pendingValue && pendingValue.trim() !== '') {
                            // Parse transfer string: "Bank Name - Twenty Forth & Fifth  |  Transfer-Intl  |  $Amount |  Time  |  Date  |  FundingSource  |  Pending"
                            // Backward compatible: old format doesn't have funding source
                            const parts = pendingValue.split('|').map(p => p.trim());
                            const fundingSource = parts.length >= 7 ? parts[5] : (parts.length === 6 ? null : null); // New format has 7 parts, old has 6
                            const statusIndex = parts.length >= 7 ? 6 : 5; // Status is last part
                            
                            pendingTransfers.push({
                                userId: userId,
                                userName: userData.name || userData.firstName || userData.email || 'Unknown',
                                userEmail: userData.email || 'N/A',
                                pendingField: pendingField,
                                transferString: pendingValue,
                                bankName: parts[0]?.replace(' - Twenty Forth & Fifth', '').trim() || '',
                                transferType: parts[1] || '',
                                amount: parts[2] || '',
                                time: parts[3] || '',
                                date: parts[4] || '',
                                fundingSource: fundingSource || 'Unknown', // Store funding source
                                status: parts[statusIndex] || 'Pending'
                            });
                        }
                    }
                });
                
                renderPendingTransfers(pendingTransfers);
                updateTransferBadge(pendingTransfers.length);
            } catch (error) {
                console.error('Error loading pending transfers:', error);
                document.getElementById('pendingTransfersList').innerHTML = 
                    '<p class="text-red-500 text-center py-4 text-sm">Error loading transfers: ' + error.message + '</p>';
            }
        }
        
        // Render pending transfers list
        function renderPendingTransfers(transfers) {
            const listEl = document.getElementById('pendingTransfersList');
            
            if (transfers.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">No pending transfers found.</p>';
                return;
            }
            
            listEl.innerHTML = transfers.map((transfer, index) => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-semibold text-gray-900">${transfer.userName}</h4>
                                <span class="text-xs text-gray-500">(${transfer.userEmail})</span>
                            </div>
                            <p class="text-sm text-gray-600"><span class="font-medium">Bank:</span> ${transfer.bankName}</p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Amount:</span> ${transfer.amount}</p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Type:</span> ${transfer.transferType}</p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Funding:</span> ${transfer.fundingSource !== 'Unknown' ? transfer.fundingSource : 'Not specified (will ask on approval)'}</p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Date:</span> ${transfer.date} ${transfer.time}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editPendingTransfer('${transfer.userId}', '${transfer.pendingField}', ${index})" 
                                    class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-semibold rounded-lg transition">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button onclick="approveTransfer('${transfer.userId}', '${transfer.pendingField}', ${index})" 
                                    class="px-3 py-1.5 text-white text-xs font-semibold rounded-lg transition" 
                                    style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                <i class="fas fa-check mr-1"></i>Approve
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Approve transfer - move from pending to history
        window.approveTransfer = async function(userId, pendingField, index) {
            if (!confirm('Approve this transfer? It will be moved to the user\'s history and the amount will be deducted from their account.')) {
                return;
            }
            
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, getDoc, updateDoc } = firestoreModule;
                
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                
                if (!userDoc.exists()) {
                    showError('User not found.');
                    return;
                }
                
                const userData = userDoc.data();
                const pendingValue = userData[pendingField];
                
                if (!pendingValue || pendingValue.trim() === '') {
                    showError('Transfer not found.');
                    return;
                }
                
                // Parse transfer string to extract amount and funding source
                const parts = pendingValue.split('|').map(p => p.trim());
                // Format: "Bank Name - Twenty Forth & Fifth  |  Transfer-Intl  |  $Amount |  Time  |  Date  |  FundingSource  |  Pending"
                // Old format (backward compatible): "Bank Name - Twenty Forth & Fifth  |  Transfer-Intl  |  $Amount |  Time  |  Date  |  Pending"
                const amountStr = parts[2] || ''; // Amount is 3rd part (index 2)
                const fundingSourceStr = parts.length >= 7 ? parts[5] : null; // Funding source is 6th part in new format
                const statusIndex = parts.length >= 7 ? 6 : 5; // Status is last part
                
                // Parse amount (remove $ and commas)
                const transferAmount = parseFloat(amountStr.replace(/[^0-9.-]/g, '')) || 0;
                
                if (transferAmount <= 0) {
                    showError('Invalid transfer amount.');
                    return;
                }
                
                // Determine funding source (for display purposes only)
                // Note: Amount was already deducted when transfer was created, so we don't deduct again
                let fundingSource = null;
                if (fundingSourceStr && (fundingSourceStr.toLowerCase().includes('checking') || fundingSourceStr.toLowerCase().includes('savings'))) {
                    fundingSource = fundingSourceStr.toLowerCase().includes('checking') ? 'checking' : 'savings';
                } else {
                    // For old format transfers, default to checking
                    fundingSource = 'checking';
                }
                
                // Update status from "Pending" to "Completed"
                const updatedTransferString = pendingValue.replace('| Pending', '| Completed').replace('|Pending', '|Completed');
                
                // Check if history is full (check first 15 entries as user mentioned)
                const historyEntries = [];
                for (let i = 1; i <= 15; i++) {
                    const historyField = `history${i}`;
                    const historyValue = userData[historyField];
                    if (historyValue && historyValue.trim() !== '') {
                        historyEntries.push({ field: historyField, value: historyValue });
                    }
                }
                
                const isHistoryFull = historyEntries.length >= 15;
                
                // Prepare update data
                // Note: Balance was already deducted when transfer was created, so we only move to history
                const updateData = {
                    [pendingField]: '', // Clear pending field
                };
                
                if (isHistoryFull) {
                    // Rotate history: shift all entries down, put new one in history1
                    // history1 -> history2, history2 -> history3, ..., history14 -> history15, new -> history1
                    for (let i = 14; i >= 1; i--) {
                        const currentField = `history${i}`;
                        const nextField = `history${i + 1}`;
                        const currentValue = userData[currentField];
                        if (currentValue && currentValue.trim() !== '') {
                            updateData[nextField] = currentValue;
                        } else {
                            updateData[nextField] = '';
                        }
                    }
                    // Put new approved transfer in history1
                    updateData.history1 = updatedTransferString;
                } else {
                    // Find first available history slot (1-15)
                    let historySlot = null;
                    for (let i = 1; i <= 15; i++) {
                        const historyField = `history${i}`;
                        if (!userData[historyField] || userData[historyField].trim() === '') {
                            historySlot = historyField;
                            break;
                        }
                    }
                    
                    if (historySlot) {
                        updateData[historySlot] = updatedTransferString;
                    } else {
                        // Fallback: use history1 if somehow all are full
                        updateData.history1 = updatedTransferString;
                    }
                }
                
                await updateDoc(userRef, updateData);
                
                const accountName = fundingSource === 'checking' ? 'Checking' : 'Savings';
                showSuccess(`Transfer approved! Amount was already deducted from ${accountName} account when transfer was created. Transfer moved to history.`);
                loadPendingTransfers(); // Reload list
            } catch (error) {
                console.error('Error approving transfer:', error);
                showError('Failed to approve transfer: ' + error.message);
            }
        };
        
        // Edit pending transfer
        window.editPendingTransfer = function(userId, pendingField, index) {
            const listEl = document.getElementById('pendingTransfersList');
            const transferDiv = listEl.children[index];
            
            if (!transferDiv) return;
            
            // Get current transfer string from Firebase (we'll need to fetch it)
            // For now, show edit modal
            showEditTransferModal(userId, pendingField, 'pending');
        };
        
        // Edit history entry
        window.editHistoryEntry = function(userId, historyField, index) {
            showEditTransferModal(userId, historyField, 'history');
        };
        
        // Show edit transfer modal
        function showEditTransferModal(userId, fieldName, type) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 p-4';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.id = 'editTransferModal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Edit ${type === 'pending' ? 'Pending Transfer' : 'History Entry'}</h3>
                            <button onclick="document.getElementById('editTransferModal').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Transfer String</label>
                                <textarea id="editTransferString" 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm font-mono"
                                          rows="5"></textarea>
                                <p class="text-xs text-gray-500 mt-1">
                                    <strong>Format:</strong> Bank Name - Twenty Forth & Fifth | Transfer-Type | $Amount | Time | Date | Funding Source | Status<br>
                                    <strong>Example:</strong> Chase Bank - Twenty Forth & Fifth | Transfer-Intl | $1,000.00 | 10:30 AM | 12/25/2024 | Checking | Completed
                                </p>
                            </div>
                            <div class="flex gap-2 justify-end">
                                <button onclick="document.getElementById('editTransferModal').remove()" 
                                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition">
                                    Cancel
                                </button>
                                <button onclick="saveTransferEdit('${userId}', '${fieldName}', '${type}')" 
                                        class="px-4 py-2 text-white rounded-lg transition" 
                                        style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load current value
            loadTransferValue(userId, fieldName).then(value => {
                document.getElementById('editTransferString').value = value || '';
            });
        }
        
        // Load transfer value from Firebase
        async function loadTransferValue(userId, fieldName) {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, getDoc } = firestoreModule;
                
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    return userDoc.data()[fieldName] || '';
                }
                return '';
            } catch (error) {
                console.error('Error loading transfer value:', error);
                return '';
            }
        }
        
        // Save transfer edit
        window.saveTransferEdit = async function(userId, fieldName, type) {
            const newValue = document.getElementById('editTransferString').value.trim();
            
            if (!newValue) {
                showError('Transfer string cannot be empty.');
                return;
            }
            
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, updateDoc } = firestoreModule;
                
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, { [fieldName]: newValue });
                
                document.getElementById('editTransferModal').remove();
                showSuccess(`${type === 'pending' ? 'Pending transfer' : 'History entry'} updated successfully.`);
                
                if (type === 'pending') {
                    loadPendingTransfers();
                } else {
                    loadTransferHistory(userId);
                }
            } catch (error) {
                console.error('Error saving transfer edit:', error);
                showError('Failed to save changes: ' + error.message);
            }
        };
        
        // Load user selector for history editing
        async function loadTransferHistoryUserSelect() {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { collection, getDocs } = firestoreModule;
                
                const usersRef = collection(db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                
                const selectEl = document.getElementById('transferHistoryUserSelect');
                selectEl.innerHTML = '<option value="">Select user...</option>';
                
                usersSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const userName = userData.name || userData.firstName || userData.email || 'Unknown';
                    const option = document.createElement('option');
                    option.value = userDoc.id;
                    option.textContent = `${userName} (${userData.email || 'N/A'})`;
                    selectEl.appendChild(option);
                });
                
                selectEl.addEventListener('change', function() {
                    if (this.value) {
                        loadTransferHistory(this.value);
                    } else {
                        document.getElementById('transferHistoryList').innerHTML = 
                            '<p class="text-xs text-gray-500 text-center py-4">Select a user to view/edit their history entries</p>';
                    }
                });
            } catch (error) {
                console.error('Error loading users for history:', error);
            }
        }
        
        // Load transfer history for a user
        async function loadTransferHistory(userId) {
            try {
                const firestoreModule = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js');
                const { doc, getDoc } = firestoreModule;
                
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                
                if (!userDoc.exists()) {
                    document.getElementById('transferHistoryList').innerHTML = 
                        '<p class="text-xs text-red-500 text-center py-4">User not found</p>';
                    return;
                }
                
                const userData = userDoc.data();
                const historyEntries = [];
                
                for (let i = 1; i <= 20; i++) {
                    const historyField = `history${i}`;
                    const historyValue = userData[historyField];
                    
                    if (historyValue && historyValue.trim() !== '') {
                        historyEntries.push({
                            field: historyField,
                            value: historyValue,
                            index: i
                        });
                    }
                }
                
                renderTransferHistory(historyEntries, userId);
            } catch (error) {
                console.error('Error loading transfer history:', error);
                document.getElementById('transferHistoryList').innerHTML = 
                    '<p class="text-xs text-red-500 text-center py-4">Error loading history: ' + error.message + '</p>';
            }
        }
        
        // Render transfer history list
        function renderTransferHistory(entries, userId) {
            const listEl = document.getElementById('transferHistoryList');
            
            if (entries.length === 0) {
                listEl.innerHTML = '<p class="text-xs text-gray-500 text-center py-4">No history entries found for this user.</p>';
                return;
            }
            
            listEl.innerHTML = entries.map((entry, index) => {
                // Parse the entry to show details
                const parts = entry.value.split('|').map(p => p.trim());
                const bankName = parts[0]?.replace(' - Twenty Forth & Fifth', '').trim() || '';
                const transferType = parts[1] || '';
                const amount = parts[2] || '';
                const time = parts[3] || '';
                const date = parts[4] || '';
                const fundingSource = parts.length >= 7 ? parts[5] : '';
                const status = parts.length >= 7 ? parts[6] : (parts[5] || '');
                
                return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-white">
                    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800 border border-gray-200">
                                    History ${entry.index}
                                </span>
                                ${status ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${status.toLowerCase().includes('completed') ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${status}</span>` : ''}
                            </div>
                            <div class="space-y-1 text-sm">
                                ${bankName ? `<p class="text-gray-700"><span class="font-medium">Bank:</span> ${bankName}</p>` : ''}
                                ${amount ? `<p class="text-gray-700"><span class="font-medium">Amount:</span> ${amount}</p>` : ''}
                                ${transferType ? `<p class="text-gray-600"><span class="font-medium">Type:</span> ${transferType}</p>` : ''}
                                ${date && time ? `<p class="text-gray-600"><span class="font-medium">Date:</span> ${date} ${time}</p>` : ''}
                                ${fundingSource ? `<p class="text-gray-600"><span class="font-medium">Funding:</span> ${fundingSource}</p>` : ''}
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-200">
                                <p class="text-xs font-mono text-gray-500 break-all">${entry.value}</p>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="editHistoryEntry('${userId}', '${entry.field}', ${index})" 
                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition flex items-center gap-2 whitespace-nowrap">
                                <i class="fas fa-edit"></i>
                                <span>Edit Entry</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // Update transfer badge
        function updateTransferBadge(count) {
            const badge = document.getElementById('adminTransferBadge');
            const headerBadge = document.getElementById('transferBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
            if (headerBadge) {
                headerBadge.textContent = `${count} pending`;
            }
        }
        
        window.selectChat = selectChat;
        window.sendAdminReply = sendAdminReply;
        window.closeChatView = closeChatView;
        window.deleteChat = deleteChat;
        window.approveKYC = approveKYC;
        window.rejectKYC = rejectKYC;
        window.reviewKYC = reviewKYC;
        window.loadPendingTransfers = loadPendingTransfers;
        // editHistoryEntry, saveTransferEdit, and loadTransferHistory are already defined as window functions above
    </script>
</body>
</html>
