<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Create Cards for Existing Users</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyABYV12B7RM2ZCD2G1lFTLpgJwflJFwEXY",
            authDomain: "beal-offshore.firebaseapp.com",
            projectId: "beal-offshore",
            storageBucket: "beal-offshore.firebasestorage.app",
            messagingSenderId: "1091834410162",
            appId: "1:1091834410162:web:56285433b5751e681745ab",
            measurementId: "G-CT463F3T6J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Generate a random 16-digit card number
        function generateCardNumber() {
            let cardNumber = '';
            for (let i = 0; i < 16; i++) {
                cardNumber += Math.floor(Math.random() * 10);
            }
            // Format with spaces every 4 digits
            return cardNumber.match(/.{1,4}/g).join(' ');
        }

        // Generate a random 3-digit CVV
        function generateCVV() {
            return String(Math.floor(Math.random() * 900) + 100);
        }

        // Generate expiry date (2 years from now)
        function generateExpiryDate() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = String(now.getFullYear() + 2).slice(-2);
            return { month, year };
        }

        // Create card for a user (saves to user document's card field)
        async function createCardForUser(userId, userData) {
            try {
                const userDocRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    return { success: false, message: 'User document not found', userId };
                }
                
                const existingUserData = userDoc.data();
                
                // Check if user already has a card
                if (existingUserData.card && existingUserData.card.cardNumber) {
                    console.log(`User ${userId} already has a card. Skipping...`);
                    return { success: false, message: 'Card already exists', userId };
                }
                
                // Generate card details
                const cardNumber = generateCardNumber();
                const cvv = generateCVV();
                const expiry = generateExpiryDate();
                
                // Get cardholder name from user data
                let cardholderName = 'USER';
                if (userData.firstName && userData.lastName) {
                    cardholderName = `${userData.firstName.toUpperCase()} ${userData.lastName.toUpperCase()}`;
                } else if (userData.firstName) {
                    cardholderName = userData.firstName.toUpperCase();
                }
                
                // Save card to user document's card field
                await updateDoc(userDocRef, {
                    card: {
                        cardNumber: cardNumber,
                        cardholderName: cardholderName,
                        expiryMonth: expiry.month,
                        expiryYear: expiry.year,
                        cvv: cvv,
                        status: 'active',
                        cardType: 'debit',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                });
                
                console.log(`Card created for user ${userId} (${cardholderName})`);
                return { success: true, message: 'Card created', userId, cardholderName };
            } catch (error) {
                console.error(`Error creating card for user ${userId}:`, error);
                return { success: false, message: error.message, userId };
            }
        }

        // Main function to create cards for all existing users
        async function createCardsForAllUsers() {
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status');
            const progressDiv = document.getElementById('progress');
            
            try {
                statusDiv.textContent = 'Fetching all users...';
                resultsDiv.innerHTML = '';
                
                // Get all users from Firestore
                const usersRef = collection(db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                
                if (usersSnapshot.empty) {
                    statusDiv.textContent = 'No users found in database.';
                    return;
                }
                
                const users = [];
                usersSnapshot.forEach(doc => {
                    users.push({ id: doc.id, data: doc.data() });
                });
                
                statusDiv.textContent = `Found ${users.length} users. Creating cards...`;
                progressDiv.max = users.length;
                progressDiv.value = 0;
                
                const results = {
                    success: [],
                    skipped: [],
                    errors: []
                };
                
                // Process each user
                for (let i = 0; i < users.length; i++) {
                    const user = users[i];
                    progressDiv.value = i + 1;
                    
                    const result = await createCardForUser(user.id, user.data);
                    
                    if (result.success) {
                        results.success.push(result);
                        resultsDiv.innerHTML += `<div class="text-green-600 mb-2">✓ Card created for ${result.cardholderName} (${result.userId})</div>`;
                    } else if (result.message === 'Card already exists') {
                        results.skipped.push(result);
                        resultsDiv.innerHTML += `<div class="text-yellow-600 mb-2">⊘ Card already exists for user ${result.userId}</div>`;
                    } else {
                        results.errors.push(result);
                        resultsDiv.innerHTML += `<div class="text-red-600 mb-2">✗ Error for user ${result.userId}: ${result.message}</div>`;
                    }
                    
                    // Small delay to avoid overwhelming Firebase
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                statusDiv.textContent = `Complete! Created: ${results.success.length}, Skipped: ${results.skipped.length}, Errors: ${results.errors.length}`;
                
            } catch (error) {
                console.error('Error creating cards:', error);
                statusDiv.textContent = `Error: ${error.message}`;
            }
        }

        // Make function available globally
        window.createCardsForAllUsers = createCardsForAllUsers;
    </script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-4">Create Debit Cards for Existing Users</h1>
        <p class="text-gray-600 mb-6">
            This tool will create debit cards for all existing users in your Firebase database who don't already have a card.
        </p>
        
        <div class="mb-6">
            <button 
                onclick="createCardsForAllUsers()" 
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors"
            >
                Create Cards for All Users
            </button>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Progress</label>
            <progress id="progress" value="0" max="100" class="w-full"></progress>
        </div>
        
        <div class="mb-4">
            <p id="status" class="text-gray-700 font-medium">Ready to start...</p>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-4 max-h-96 overflow-y-auto">
            <h3 class="font-semibold mb-2">Results:</h3>
            <div id="results" class="text-sm">
                <p class="text-gray-500">No operations performed yet.</p>
            </div>
        </div>
        
        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-sm text-yellow-800">
                <strong>Note:</strong> This will only create cards for users who don't already have one. 
                Existing cards will not be overwritten.
            </p>
        </div>
    </div>
</body>
</html>

