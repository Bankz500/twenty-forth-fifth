<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Twenty Forth & Fifth Profile</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
    <link rel="icon" href="favicon.png" type="image/png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js Library -->

    <style>
        html, body {
            overflow: auto; /* Ensures scrolling is enabled */
        }
        .loader {
            border: 8px solid rgba(0, 0, 0, 0.1); /* Light grey */
            border-top: 8px solid #16a34a; /* Green */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* New spinner styles */
        .smart-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #16a34a, #15803d);
            animation: smart-spin 1.5s linear infinite;
        }

        @keyframes smart-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .smart-spinner::before {
            content: '';
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            position: absolute;
        }
    </style>
    
    <script type="module">

    import { auth, db, cacheUserData, getCachedUserData, clearCachedUserData } from "./firebase-client.js";
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { doc, getDoc, setDoc } from "firebase/firestore";
    // Expose for non-module scripts
    window.auth = auth;
    window.db = db;

    // Expose helper to join credit card waitlist from non-module script
    window.joinCreditCardWaitlist = async function(payload) {
        try {
            const user = auth.currentUser;
            const userId = user ? user.uid : `anon_${Date.now()}`;
            const waitlistRef = doc(db, 'credit_card_waitlist', userId);
            await setDoc(waitlistRef, {
                name: payload.name,
                email: payload.email,
                creditScore: payload.creditScore || '',
                address: payload.address,
                requestedAt: new Date().toISOString()
            }, { merge: true });
            return { ok: true };
        } catch (e) {
            console.error('joinCreditCardWaitlist error', e);
            // Fallback: queue locally so user still sees success
            try {
                const key = 'waitlistQueue';
                const existing = JSON.parse(localStorage.getItem(key) || '[]');
                existing.push({ ...payload, requestedAt: new Date().toISOString() });
                localStorage.setItem(key, JSON.stringify(existing));
            } catch (_) {}
            return { ok: true, queued: true, error: e };
        }
    };


    // Function to update transfer limits based on KYC status
    function updateTransferLimits(userData) {
        const kycStatus = (userData.kycStatus || '').toLowerCase().trim();
        const tierBadge = document.getElementById('transferTierBadge');
        const tierText = document.getElementById('transferTierText');
        const minLimit = document.getElementById('minTransferLimit');
        const maxLimit = document.getElementById('maxTransferLimit');
        const verificationTier = document.getElementById('verificationTier');
        const upgradeSection = document.getElementById('upgradeTransferLimitSection');

        if (!tierBadge || !tierText || !minLimit || !maxLimit || !verificationTier) {
            return;
        }

        // Determine tier based on KYC status
        let tier = 1;
        let tierName = 'Tier 1 - Unverified';
        let dailyLimit = '$1 - $250,000';
        let perTransferLimit = '$50,000';
        let monthlyLimit = '$1,000,000';
        let badgeClass = 'bg-gray-400 text-white';
        let showUpgrade = true;

        if (kycStatus === 'approved' || kycStatus === 'completed') {
            tier = 3;
            tierName = 'Tier 3 - Verified';
            dailyLimit = '$1 - $100,000,000';
            perTransferLimit = '$5,000,000';
            monthlyLimit = 'Unlimited';
            badgeClass = 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white';
            showUpgrade = false;
        } else if (kycStatus === 'pending' || kycStatus === 'reviewed') {
            tier = 2;
            tierName = 'Tier 2 - Under Review';
            dailyLimit = '$1 - $500,000';
            perTransferLimit = '$100,000';
            monthlyLimit = '$3,000,000';
            badgeClass = 'bg-gray-600 text-white';
            showUpgrade = false; // Don't show upgrade if already pending
        } else {
            // Tier 1 - Unverified
            tier = 1;
            tierName = 'Tier 1 - Unverified';
            dailyLimit = '$1 - $250,000';
            perTransferLimit = '$50,000';
            monthlyLimit = '$1,000,000';
            badgeClass = 'bg-gray-400 text-white';
            showUpgrade = true;
        }

        // Update UI elements
        tierText.textContent = `Tier ${tier}`;
        tierBadge.className = `inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm ${badgeClass}`;
        
        // Update limit displays
        const dailyLimitEl = document.getElementById('dailyTransferLimit');
        const perTransferLimitEl = document.getElementById('perTransferLimit');
        const monthlyLimitEl = document.getElementById('monthlyTransferLimit');
        
        if (dailyLimitEl) dailyLimitEl.textContent = dailyLimit;
        if (perTransferLimitEl) perTransferLimitEl.textContent = perTransferLimit;
        if (monthlyLimitEl) monthlyLimitEl.textContent = monthlyLimit;
        
        // Keep old elements for backward compatibility
        if (minLimit) minLimit.textContent = dailyLimit;
        if (maxLimit) maxLimit.textContent = monthlyLimit;
        if (verificationTier) verificationTier.textContent = tierName;

        // Show/hide upgrade section
        if (upgradeSection) {
            if (showUpgrade) {
                upgradeSection.classList.remove('hidden');
            } else {
                upgradeSection.classList.add('hidden');
            }
        }
    }

    // Function to load and display user data
    async function loadUserData(user) {
        // Show loading state immediately
        const statusEl = document.getElementById('status');
        if (statusEl) {
            statusEl.className = 'inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm bg-gray-200 text-gray-700';
            statusEl.innerHTML = '<div class="h-2 w-2 rounded-full bg-gray-500 mr-2 animate-pulse"></div><span>Loading...</span>';
        }
        
        try {
            const userDocRef = doc(db, 'users', user.uid);
            // Fetch user document without timeout to ensure reliable loading
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                const userData = userDoc.data();
                console.log('User data loaded:', userData);
                
                // Update transfer limits based on KYC status
                updateTransferLimits(userData);

                // Safety check - make sure elements exist before accessing them
                const updateElementIfExists = (id, value, defaultValue = '') => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.tagName === 'INPUT') {
                            element.value = value || defaultValue;
                            element.placeholder = value || defaultValue;
                        } else {
                            element.textContent = value || defaultValue;
                        }
                    } else {
                        console.warn(`Element with id "${id}" not found`);
                    }
                };

                // Update user interface elements safely - only update elements that exist
                updateElementIfExists('firstName', userData.firstName, 'First Name');
                updateElementIfExists('email', user.email, user.email);

                // Fetch user status from Firestore and update the UI
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    // Set default if no status exists
                    const userStatus = userData.status || 'Processing...';
                    
                    // Update the status text
                    statusElement.textContent = userStatus;
                    
                    // Apply appropriate styling based on status (monochrome)
                    switch (userStatus.toLowerCase()) {
                        case 'active':
                            statusElement.className = 'inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm bg-gray-800 text-white';
                            statusElement.innerHTML = '<div class="h-2 w-2 rounded-full bg-white mr-2"></div><span>' + userStatus + '</span>';
                            break;
                        case 'suspended':
                            statusElement.className = 'inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm bg-gray-600 text-white';
                            statusElement.innerHTML = '<div class="h-2 w-2 rounded-full bg-white mr-2"></div><span>' + userStatus + '</span>';
                            break;
                        case 'banned':
                            statusElement.className = 'inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm bg-gray-900 text-white';
                            statusElement.innerHTML = '<div class="h-2 w-2 rounded-full bg-white mr-2"></div><span>' + userStatus + '</span>';
                            break;
                        case 'processing':
                            statusElement.className = 'inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm bg-gray-600 text-white';
                            statusElement.innerHTML = '<div class="h-2 w-2 rounded-full bg-white mr-2 animate-pulse"></div><span>' + userStatus + '</span>';
                            break;
                        case 'inactive':
                            statusElement.className = 'inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm bg-gray-500 text-white';
                            statusElement.innerHTML = '<div class="h-2 w-2 rounded-full bg-white mr-2"></div><span>' + userStatus + '</span>';
                            break;
                        default:
                            statusElement.textContent = 'Processing';
                            statusElement.className = 'inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm bg-gray-600 text-white';
                            statusElement.innerHTML = '<div class="h-2 w-2 rounded-full bg-white mr-2 animate-pulse"></div><span>Processing</span>';
                    }
                }
            } else {
                console.log('No user document found.');
                // Using console.error instead of alert to avoid disrupting UX
                console.error('No user data found.');
                // Still update email from auth user even if document doesn't exist
                const emailElement = document.getElementById('email');
                if (emailElement) {
                    emailElement.value = user.email;
                    emailElement.placeholder = user.email;
                }
            }
        } catch (error) {
            console.error('Error fetching user data:', error);
            // Show error in status if fetch fails
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.className = 'inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm bg-gray-900 text-white';
                statusEl.innerHTML = '<div class="h-2 w-2 rounded-full bg-white mr-2"></div><span>Error loading data</span>';
            }
        }
    }

    // Check if the user is authenticated
    let authCheckComplete = false;
    let redirectTimeout = null;
    let hasSeenAuthenticatedUser = false;
    
    onAuthStateChanged(auth, async (user) => {
        // Clear any pending redirect timeout
        if (redirectTimeout) {
            clearTimeout(redirectTimeout);
            redirectTimeout = null;
        }
        
        if (user) {
            // Mark that we've seen an authenticated user
            hasSeenAuthenticatedUser = true;
            authCheckComplete = true;
            
            console.log('User authenticated:', user.uid, user.email);
            // Wait for DOM to be ready before loading user data
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => loadUserData(user));
            } else {
                loadUserData(user);
            }
        } else {
            // Only redirect if:
            // 1. We've never seen an authenticated user (initial load check)
            // 2. OR we've completed the auth check and user is definitely not authenticated
            // This prevents false redirects during page transitions or Firebase re-initialization
            
            if (!authCheckComplete) {
                // First check - wait a bit for Firebase to initialize
                await new Promise(resolve => setTimeout(resolve, 500));
                authCheckComplete = true;
            }
            
            // Only redirect if we've never seen an authenticated user AND current user is still null
            if (!hasSeenAuthenticatedUser) {
                redirectTimeout = setTimeout(() => {
                    // Final verification - check auth state one more time before redirecting
                    const currentUser = auth.currentUser;
                    if (!currentUser && !hasSeenAuthenticatedUser) {
                        console.log('No user signed in after verification. Redirecting to sign-in page.');
                        window.location.href = 'login.html';
                    } else if (currentUser) {
                        // If user became authenticated during the delay, cancel redirect
                        console.log('Auth state changed - user is now authenticated, canceling redirect');
                        hasSeenAuthenticatedUser = true;
                    }
                }, 1000); // Increased delay to allow Firebase to fully initialize
            } else {
                // If we've seen an authenticated user before but now user is null,
                // it might be a temporary state change - don't redirect immediately
                console.log('User state changed to null, but user was previously authenticated. Waiting...');
            }
        }
    });

    // Expose signOut function to window
    window.signOut = function() {
        signOut(auth).then(() => {
            alert('Signed out successfully!');
            window.location.href = 'login.html';
        }).catch((error) => {
            alert('Error signing out: ' + error.message);
        });
    };

    // Function to update user profile - expose to window
    window.updateProfile = async function() {
        const user = auth.currentUser;
        if (user) {
            const userDocRef = doc(db, 'users', user.uid);

            const updatedData = {
                firstName: document.getElementById('firstName')?.value.trim() || '',
                lastName: document.getElementById('lastName')?.value.trim() || '',
            };

            const saveButton = document.querySelector('button[type="submit"]');
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.textContent = 'Saving changes...';
            }

            try {
                await setDoc(userDocRef, updatedData, { merge: true });
                alert('Profile updated successfully!');
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile: ' + error.message);
            } finally {
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save Changes';
                }
            }
        } else {
            alert('No user is currently signed in.');
        }
    };

    // Function to show user info - expose to window
    window.showUserInfo = async function() {
        const user = auth.currentUser;
        if (user) {
            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();

                    // Safely update form elements
                    const updateFormField = (id, value, defaultValue = '') => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = value || defaultValue;
                            if (element.hasAttribute('placeholder')) {
                                element.placeholder = value || defaultValue;
                            }
                        }
                    };

                    updateFormField('firstName', userData.firstName, 'First Name');
                    updateFormField('status', userData.status, 'status');
                    updateFormField('email', user.email);
                    updateFormField('phone', userData.phone);

                    // Make the profile info div visible
                    const userInfoDiv = document.getElementById('profileInfoCard');
                    if (userInfoDiv) {
                        userInfoDiv.classList.remove('hidden');
                    }
                } else {
                    console.log('No user document found.');
                    alert('No user data found.');
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
                alert('Error fetching user information.');
            }
        } else {
            alert('No user is currently signed in.');
        }
    };
    </script>
    <style>
        :root {
            --ttf-brand: #16a34a;
            --ttf-brand-hover: #15803d;
        }
        /* Replace “black/dark” accents with brand blue on dashboard pages */
        .bg-gray-900 { background-color: var(--ttf-brand) !important; }
        .bg-gray-800 { background-color: var(--ttf-brand-hover) !important; }
        .hover\:bg-gray-800:hover { background-color: var(--ttf-brand-hover) !important; }
        .border-gray-900 { border-color: var(--ttf-brand) !important; }
        .focus\:ring-gray-800:focus { --tw-ring-color: var(--ttf-brand-hover) !important; }
        .focus\:ring-gray-900:focus { --tw-ring-color: var(--ttf-brand) !important; }
        .bg-black { background-color: rgba(22, 163, 74, 0.55) !important; }
    </style>
    
    
    </head>
    <body class="font-sans antialiased bg-gray-100">

<!-- Navbar -->
<nav class="bg-white border-b border-gray-300 p-4 shadow-sm">
    <div class="container mx-auto flex items-center justify-between">
        <img src="11.png" alt="Twenty Forth & Fifth Logo" class="h-14 md:h-16 w-auto">
        <button onclick="signOut()"
            class="bg-white border border-gray-400 text-xs text-gray-800 px-4 md:px-6 py-2 rounded-full hover:bg-gray-50 transition">Sign Out</button>
    </div>
</nav>


<script>
    // Ensure global handler exists for inline onclick, early in the document
    window.openCardWaitlist = window.openCardWaitlist || function() {
        var modal = document.getElementById('cardWaitlistModal');
        if (modal) modal.classList.remove('hidden');
    };
    window.closeCardWaitlist = window.closeCardWaitlist || function() {
        var modal = document.getElementById('cardWaitlistModal');
        if (modal) modal.classList.add('hidden');
    };
    window.showWaitlistSuccess = window.showWaitlistSuccess || function() {
        var modal = document.getElementById('cardWaitlistModal');
        var success = document.getElementById('waitlistSuccessModal');
        if (modal) modal.classList.add('hidden');
        if (success) success.classList.remove('hidden');
    };
    window.closeWaitlistSuccess = window.closeWaitlistSuccess || function() {
        var success = document.getElementById('waitlistSuccessModal');
        if (success) success.classList.add('hidden');
    };
</script>

<!-- Main Profile Content -->
<div class="p-4 md:p-6 lg:p-8 mt-2 mb-32">
    <div class="container mx-auto max-w-7xl">
        <!-- Desktop: Two-column layout, Mobile: Stacked -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <!-- Left Column: Account Status Card (2/3 on desktop) -->
            <div class="lg:col-span-2 order-1 lg:order-1">
                <div class="bg-white rounded-lg shadow-sm border border-gray-300 p-5 md:p-6 lg:p-8">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-2">Account Status</h2>
                            <p class="text-sm md:text-base text-gray-600">Your account information and quick actions</p>
                        </div>
                        <div id="status" class="inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm">
                <div class="h-2 w-2 rounded-full bg-white mr-2 animate-pulse"></div>
                            <span>Loading...</span>
            </div>
        </div>

                    <div class="bg-gray-50 rounded-lg p-4 md:p-5 mb-6 border border-gray-300">
                        <div class="flex items-start gap-3 md:gap-4">
                            <div class="bg-gray-900 rounded-lg p-2 md:p-3 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                            <div class="flex-1">
                                <p class="text-sm md:text-base text-gray-700 leading-relaxed">View your transaction history to track all account activities and payments in real-time.</p>
                            </div>
            </div>
        </div>

                    <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                        <button onclick="navigateWithSpinner('dashboard.html#recent-transactions')" class="bg-gray-900 hover:bg-gray-800 text-white text-sm md:text-base font-semibold py-3 md:py-4 px-6 rounded-lg w-full transition-all duration-200 flex items-center justify-center group focus:outline-none focus:ring-2 focus:ring-gray-800 focus:ring-offset-2">
                <span>View Transaction History</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5 ml-2 group-hover:translate-x-1 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
            </button>
        </div>
    </div>

                <!-- Transfer Limit Section -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-300 p-5 md:p-6 lg:p-8 mt-12">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-2">Transfer Limits</h2>
                            <p class="text-sm md:text-base text-gray-600">Your current transfer limit based on verification tier</p>
                        </div>
                        <div id="transferTierBadge" class="inline-flex items-center text-xs md:text-sm px-4 py-2 rounded-full font-semibold shadow-sm bg-gray-400 text-white">
                            <span id="transferTierText">Tier 1</span>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4 md:p-5 mb-6 border border-gray-300">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                                <span class="text-sm md:text-base text-gray-700 font-medium">Daily Limit:</span>
                                <span id="dailyTransferLimit" class="text-sm md:text-base font-semibold text-gray-900">$1 - $250,000</span>
                            </div>
                            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                                <span class="text-sm md:text-base text-gray-700 font-medium">Maximum Per Transfer:</span>
                                <span id="perTransferLimit" class="text-sm md:text-base font-semibold text-gray-900">$50,000</span>
                            </div>
                            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                                <span class="text-sm md:text-base text-gray-700 font-medium">Monthly Limit:</span>
                                <span id="monthlyTransferLimit" class="text-sm md:text-base font-semibold text-gray-900">$1,000,000</span>
                            </div>
                            <div class="flex items-center justify-between py-2">
                                <span class="text-sm md:text-base text-gray-700 font-medium">Verification Tier:</span>
                                <span id="verificationTier" class="text-sm md:text-base font-semibold text-gray-900">Tier 1 - Unverified</span>
                            </div>
                            <!-- Hidden elements for backward compatibility -->
                            <span id="minTransferLimit" class="hidden">$1 - $250,000</span>
                            <span id="maxTransferLimit" class="hidden">$1,000,000</span>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button onclick="navigateWithSpinner('security.html')" class="bg-gray-900 hover:bg-gray-800 text-white text-sm md:text-base font-semibold py-3 md:py-4 px-6 rounded-lg w-full transition-all duration-200 flex items-center justify-center group focus:outline-none focus:ring-2 focus:ring-gray-800 focus:ring-offset-2">
                            <span>Upgrade Transfer Limit</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5 ml-2 group-hover:translate-x-1 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>

                    <div id="upgradeTransferLimitSection" class="bg-gray-50 rounded-lg p-4 md:p-5 mb-6 mt-6hidden">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-gray-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-gray-400 mb-1">Upgrade Your Transfer Limit</p>
                                <p class="text-sm text-gray-500 mb-3">Complete KYC verification to unlock higher transfer limits and unlimited transfers.</p>
                                <button onclick="navigateWithSpinner('security.html')" class="bg-gray-900 hover:bg-gray-800 text-white text-sm md:text-base font-semibold py-2.5 md:py-3 px-6 rounded-lg transition-all duration-200 flex items-center justify-center group focus:outline-none focus:ring-2 focus:ring-gray-800 focus:ring-offset-2">
                                    <span>Upgrade Transfer Limit</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5 ml-2 group-hover:translate-x-1 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Profile Menu Sections (1/3 on desktop) -->
            <div class="lg:col-span-1 order-2 lg:order-2">
                <div class="bg-white rounded-lg shadow-sm border border-gray-300 overflow-hidden">
                    <div class="bg-gray-900 p-4 md:p-5 lg:p-6">
                        <h2 class="text-lg md:text-xl font-bold text-white">Profile Settings</h2>
                        <p class="text-xs md:text-sm text-gray-300 mt-1">Manage your account preferences</p>
                    </div>

                    <div class="divide-y divide-gray-300">
                        <a href="profile-2.html" onclick="showUserInfo()" class="flex items-center justify-between p-4 md:p-5 hover:bg-gray-50 transition-colors group">
                            <div class="flex items-center gap-3 md:gap-4 flex-1">
                                <div class="bg-gray-900 rounded-lg p-2.5 md:p-3 group-hover:bg-gray-800 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm md:text-base font-semibold text-gray-900">Profile Details</h3>
                                    <p class="text-xs md:text-sm text-gray-500 mt-0.5">View and edit your personal information</p>
                                </div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-gray-800 transition-colors flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                        
                        <a href="support.html" class="flex items-center justify-between p-4 md:p-5 hover:bg-gray-50 transition-colors group">
                            <div class="flex items-center gap-3 md:gap-4 flex-1">
                                <div class="bg-gray-900 rounded-lg p-2.5 md:p-3 group-hover:bg-gray-800 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm md:text-base font-semibold text-gray-900">Support</h3>
                                    <p class="text-xs md:text-sm text-gray-500 mt-0.5">Get help and contact support</p>
                                </div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-gray-800 transition-colors flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                        
                        <a href="security.html" class="flex items-center justify-between p-4 md:p-5 hover:bg-gray-50 transition-colors group">
                            <div class="flex items-center gap-3 md:gap-4 flex-1">
                                <div class="bg-gray-900 rounded-lg p-2.5 md:p-3 group-hover:bg-gray-800 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm md:text-base font-semibold text-gray-900">Security</h3>
                                    <p class="text-xs md:text-sm text-gray-500 mt-0.5">Change and manage your security settings</p>
                                </div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-gray-800 transition-colors flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


        <!-- Waitlist Success Modal -->
        <div id="waitlistSuccessModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
            <div class="bg-white rounded-3xl shadow-2xl w-11/12 md:w-1/2 max-w-md relative overflow-hidden">
                <!-- Header with Gradient -->
                <div class="bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 p-6 text-white text-center">
                    <button type="button" class="absolute top-4 right-4 text-white hover:text-gray-200 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20" onclick="closeWaitlistSuccess()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="w-20 h-20 mx-auto mb-4 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-7.25 7.25a1 1 0 01-1.414 0l-3-3a1 1 0 011.414-1.414L8.75 11.586l6.543-6.543a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                </div>
                    <h3 class="text-2xl font-bold">Welcome Onboard!</h3>
                    <p class="text-green-100 text-sm mt-2">You've successfully joined the waitlist</p>
                </div>
                
                <!-- Content -->
                <div class="p-6">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg p-4 mb-6">
                        <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 mt-0.5 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="text-sm text-gray-700">
                                <p class="font-semibold text-gray-900 mb-1">What's Next?</p>
                                <p class="text-gray-600">You have joined 1000+ other customers on the waitlist. We will get in touch with you via email when your card is ready.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <p class="text-sm text-gray-600 text-center">
                            Your request has been received and is being processed. Check your email for confirmation and updates.
                        </p>
                    </div>
                    
                    <!-- Action Button -->
                    <button type="button" class="w-full bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 text-white text-sm font-semibold py-3.5 rounded-xl hover:from-green-700 hover:via-emerald-700 hover:to-teal-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5" onclick="closeWaitlistSuccess()">
                        <i class="fas fa-check-circle mr-2"></i>Great, thanks!
                    </button>
                </div>
            </div>
        </div>

        <!-- Inline fallback for waitlist submit to ensure global availability -->
        <script>
            (function(){
                if (typeof window.submitCardWaitlist !== 'function') {
                    window.submitCardWaitlist = async function() {
                        var submitBtn = document.getElementById('ccSubmit');
                        var name = (document.getElementById('ccName')||{}).value ? document.getElementById('ccName').value.trim() : '';
                        var email = (document.getElementById('ccEmail')||{}).value ? document.getElementById('ccEmail').value.trim() : '';
                        var creditScore = (document.getElementById('ccCreditScore')||{}).value ? document.getElementById('ccCreditScore').value.trim() : '';
                        var address = (document.getElementById('ccAddress')||{}).value ? document.getElementById('ccAddress').value.trim() : '';

                        if (!name || !email || !creditScore || !address) return;

                        var originalText = submitBtn ? submitBtn.textContent : '';
                        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Please wait...'; }

                        try {
                            var helper = window.joinCreditCardWaitlist;
                            var result = helper ? await helper({ name: name, email: email, creditScore: creditScore, address: address }) : { ok: false };
                            if (result && result.ok) {
                                if (typeof window.showWaitlistSuccess === 'function') window.showWaitlistSuccess();
                            } else {
                                throw new Error('Failed to save waitlist entry');
                            }
                        } catch (e) {
                            console.error('Error joining waitlist', e);
                            alert('Could not join the waitlist. Please try again.');
                        } finally {
                            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = originalText; }
                        }
                    };
                }

                // Also wire the form submit if inline fails for any reason
                document.addEventListener('DOMContentLoaded', function(){
                    var form = document.getElementById('cardWaitlistForm');
                    if (form) {
                        form.addEventListener('submit', function(e){
                            e.preventDefault();
                            if (typeof window.submitCardWaitlist === 'function') {
                                window.submitCardWaitlist();
                            }
                        });
                    }
                });
            })();
        </script>


        <script>
            // Cloudinary configuration
            const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dmgcagkqa/image/upload';
            const CLOUDINARY_UPLOAD_PRESET = 'ASHB_profile';
        
            // Function to upload the profile picture to Cloudinary
            async function uploadProfilePicture(event) {
                const file = event.target.files[0];
                const MAX_FILE_SIZE_MB = 2;
        
                if (!file) {
                    alert('Please select an image file.');
                    return;
                }
        
                if (!file.type.startsWith('image/') || file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                    alert('Please upload a valid image file smaller than 2MB.');
                    return;
                }
        
                // Authenticate the user
                const user = auth.currentUser;
                if (!user) {
                    alert('You must be signed in to upload a profile picture.');
                    return;
                }
        
                // Prepare the file for Cloudinary upload
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        
                try {
                    // Upload the image to Cloudinary
                    const response = await fetch(CLOUDINARY_URL, {
                        method: 'POST',
                        body: formData,
                    });
        
                    if (response.ok) {
                        const data = await response.json();
                        const imageUrl = data.secure_url;
        
                        // Update the profile picture on the page
                        const profilePic = document.getElementById('profilePic');
                        if (profilePic) profilePic.src = imageUrl;
        
                        // Save the profile picture URL to Firestore
                        const userDocRef = doc(db, 'users', user.uid);
                        await setDoc(
                            userDocRef,
                            { profilePicture: imageUrl },
                            { merge: true }
                        );
        
                        alert('Profile picture updated successfully!');
                    } else {
                        alert('Error uploading the image to Cloudinary. Please try again.');
                    }
                } catch (error) {
                    console.error('Error uploading the profile picture:', error);
                    alert('An error occurred while uploading the profile picture. Please try again.');
                }
            }
        
            // Load the user's profile picture on authentication state change
            // Note: This is handled in the main onAuthStateChanged above to avoid conflicts
        
            // Add the event listener for the file input
            document.addEventListener('DOMContentLoaded', () => {
                const fileInput = document.getElementById('profileImageInput');
                if (fileInput) {
                    fileInput.addEventListener('change', uploadProfilePicture);
                }
            });

            // Credit Card Waitlist handlers
            window.openCardWaitlist = function() {
                const modal = document.getElementById('cardWaitlistModal');
                if (modal) modal.classList.remove('hidden');
            };

            window.closeCardWaitlist = function() {
                const modal = document.getElementById('cardWaitlistModal');
                if (modal) modal.classList.add('hidden');
            };
            
            window.submitCardWaitlist = async function() {
                const submitBtn = document.getElementById('ccSubmit');
                const nameEl = document.getElementById('ccName');
                const emailEl = document.getElementById('ccEmail');
                const creditScoreEl = document.getElementById('ccCreditScore');
                const addressEl = document.getElementById('ccAddress');

                if (!submitBtn || !nameEl || !emailEl || !creditScoreEl || !addressEl) return;

                const name = nameEl.value.trim();
                const email = emailEl.value.trim();
                const creditScore = creditScoreEl.value.trim();
                const address = addressEl.value.trim();

                if (!name || !email || !creditScore || !address) return;

                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Please wait...';

                try {
                    const result = await (window.joinCreditCardWaitlist ? window.joinCreditCardWaitlist({ name, email, creditScore, address }) : Promise.resolve({ ok: false }));
                    if (result && result.ok) {
                        showWaitlistSuccess();
                    } else {
                        throw new Error('Failed to save waitlist entry');
                    }
                } catch (e) {
                    console.error('Error joining waitlist', e);
                    alert('Could not join the waitlist. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            };

            // Fallback ensure global handler exists for inline onclick
            if (typeof window.openCardWaitlist !== 'function') {
                window.openCardWaitlist = function() {
                    var modal = document.getElementById('cardWaitlistModal');
                    if (modal) modal.classList.remove('hidden');
                };
            }
        </script>
        
            


<div id="profileInfoCard" class="max-w-full bg-white rounded p-6 mt-8 hidden">
    <h2 class="text-sm font-semibold text-gray-800 mb-6">Profile Information</h2>
    <form class="space-y-6" onsubmit="event.preventDefault(); updateProfile();">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="firstName" class="block text-xs font-medium text-gray-700">Full Name</label>
                <input type="text" id="firstName" name="firstName" class="mt-1 block w-full border border-gray-300 px-4 py-3 rounded shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 text-xs">
            </div>
            <div>
                <label for="lastName" class="block text-xs font-medium text-gray-700">Username</label>
                <input type="text" id="lastName" name="lastName" class="mt-1 block w-full border border-gray-300 px-4 py-3 rounded shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 text-xs">
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="email" class="text-xs">Email address</label>
                <input type="email" id="email" class="border rounded w-full px-4 py-3 text-xs" readonly placeholder="Loading email...">
            </div>
        </div>
        <div class="flex justify-end">
            <button id="saveChangesButton" type="submit" class="px-4 py-3 bg-gray-900 text-white text-xs rounded-lg hover:bg-gray-800 transition duration-200 w-full mt-8 focus:outline-none focus:ring-2 focus:ring-gray-800 focus:ring-offset-2">Save Changes</button>
        </div>
    </form>
</div>

<script>
    // Function to update the full name and username locally with a delay for processing state
    function updateProfile() {
        const saveButton = document.getElementById("saveChangesButton");
        const originalButtonText = saveButton.textContent;

        // Show processing state
        saveButton.disabled = true;
        saveButton.textContent = "Processing...";

        // Delay the actual update by 2 seconds (you can adjust this duration)
        setTimeout(function() {
            try {
                const newFullName = document.getElementById('firstName').value.trim();
                const newUsername = document.getElementById('lastName').value.trim();

                if (!newFullName || !newUsername) {
                    alert('Please enter valid information for full name and username.');
                    return;
                }

                // Store the full name and username in localStorage
                localStorage.setItem('fullName', newFullName);
                localStorage.setItem('username', newUsername);

                // Note: profileUsername element doesn't exist in this page, so we skip updating it

                // Show success message
                alert('Profile updated successfully! my Chief');
            } catch (error) {
                console.error('Ehhh... my Chief there was an error updating profile:', error);
                alert('An error occurred while updating your profile. Please try again.');
            } finally {
                // Revert button to original state after the operation
                saveButton.disabled = false;
                saveButton.textContent = originalButtonText;
            }
        }, 2000);  // This is where we delay the actual change, 2000ms = 2 seconds
    }

    // Load the stored full name and username on page load
    window.onload = function () {
        // Check if there's a stored full name and username in localStorage
        const storedFullName = localStorage.getItem('fullName');
        const storedUsername = localStorage.getItem('username');

        if (storedFullName) {
            // Populate the full name field and the profile display with the stored value
            const fullNameField = document.getElementById('firstName');
            fullNameField.value = storedFullName;
            fullNameField.placeholder = storedFullName;
        }

        if (storedUsername) {
            // Populate the username field with the stored value
            const usernameField = document.getElementById('lastName');
            usernameField.value = storedUsername;
            usernameField.placeholder = storedUsername;
        }

        // Use window.auth which is exposed from the module script
        if (window.auth && window.auth.currentUser) {
            const user = window.auth.currentUser;
            const emailField = document.getElementById('email');
            if (emailField) {
                emailField.placeholder = user.email; // Email is read-only and cannot be changed
                emailField.value = user.email; // Optional: Set email as the value
            }

            // Populate the full name from Firebase (will be updated by onAuthStateChanged)
            const fullNameField = document.getElementById('firstName');
            if (fullNameField && !fullNameField.value) {
                fullNameField.placeholder = user.displayName || "Enter your full name";
                fullNameField.value = user.displayName || "";
            }

            // Populate the username (if available from Firebase or set a default)
            const usernameField = document.getElementById('lastName');
            if (usernameField && !usernameField.value) {
                usernameField.placeholder = user.displayName?.split(' ')[0] || "Enter your username";
                usernameField.value = storedUsername || "";
            }
        }
    };
</script>



<section class="py-10" id="spacing"></section>
    <div class="container mx-auto text-center">
    </div>
</section>


<!-- Bottom Navbar (Mobile Friendly) -->
<div class="mobile-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-300 p-3" style="height: 100px; z-index: 100;">
    <div class="flex justify-around items-center h-full">
        <!-- Home Icon -->
        <a href="dashboard.html" class="nav-item flex flex-col items-center" data-page="dashboard">
            <div class="bg-white rounded p-2">
                <img src="1221.png" alt="Wallet Icon" class="h-6 w-6" />
            </div>
            <span class="text-xs font-medium mt-2 text-gray-700">Home</span>
        </a>
        <!-- Deposit Icon -->
        <a href="deposit.html" class="nav-item flex flex-col items-center" data-page="deposit">
            <div class="bg-white rounded p-2">
                <img src="deposit.png" alt="Deposit Icon" class="h-6 w-6" />
            </div>
            <span class="text-xs font-medium mt-2 text-gray-700">Deposit</span>
        </a>
        <!-- Support Icon -->
        <a href="support.html" class="nav-item flex flex-col items-center" data-page="support">
            <div class="bg-white rounded p-2">
                <img src="support.png" alt="Support Icon" class="h-6 w-6" />
            </div>
            <span class="text-xs font-medium mt-2 text-gray-700">Support</span>
        </a>
        <!-- Profile Icon -->
        <a href="profile.html" class="nav-item flex flex-col items-center" data-page="profile">
            <div class="bg-white rounded p-2">
                <img src="profile.png" alt="Profile Icon" class="h-6 w-6" />
            </div>
            <span class="text-xs font-medium mt-2 text-gray-700">Profile</span>
        </a>
    </div>
</div>
<script src="bottom-navbar.js"></script>


<!-- Script -->
<script>

        // NOTE: Inactivity timeout is already handled in the module script above
        // This duplicate code has been removed to prevent conflicts

</script>

<!-- Spinner -->
<div id="spinner" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
    <div class="smart-spinner"></div>
</div>

<script>
    function navigateWithSpinner(url) {
        // Show the spinner
        document.getElementById('spinner').classList.remove('hidden');

        // Simulate a delay for loading (e.g., 1 second)
        setTimeout(() => {
            // Navigate to the specified URL
            window.location.href = url;
        }, 1000); // Adjust the delay as needed
    }
</script>

    <!-- Inactivity Timeout: Auto-logout after 5 minutes of inactivity -->
    <script src="inactivity-timeout.js"></script>
</body>
</html>