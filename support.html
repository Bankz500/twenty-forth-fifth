<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Twenty Forth & Fifth Support</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
    <link rel="icon" href="favicon.png" type="image/png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        // Initialize Email.js with your user ID
        emailjs.init("uEd3R25mqCi5tk0te"); // Replace with your Email.js public key
    </script>

    <style>
        html, body {
            overflow: auto;
        }
        .loader {
            border: 8px solid rgba(0, 0, 0, 0.1);
            border-top: 8px solid #15803d;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .smart-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #333, #666);
            animation: smart-spin 1.5s linear infinite;
        }

        @keyframes smart-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .smart-spinner::before {
            content: '';
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            position: absolute;
        }

        /* Chat Modal Styles */
        #chatMessagesArea::-webkit-scrollbar {
            width: 6px;
        }
        #chatMessagesArea::-webkit-scrollbar-track {
            background: transparent;
        }
        #chatMessagesArea::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        #chatMessagesArea::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        /* Prevent zoom on focus - iOS Safari fix */
        #chatMessageInput {
            font-size: 16px !important;
        }
        #chatMessageInput:focus {
            font-size: 16px !important;
        }
    </style>
    <script type="module">
        // Shared Firebase client (auth/db are consistent across all pages)
    import { auth, db } from './firebase-client.js';
    import { onAuthStateChanged, signOut } from 'firebase/auth';
    import { doc, getDoc } from 'firebase/firestore';
    // Expose for non-module scripts on this page
    window.__onAuthStateChanged = onAuthStateChanged;

        // Check if the user is authenticated
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is authenticated, page can load
            } else {
                console.log('No user signed in, redirecting to sign-in page.');
                window.location.href = 'login.html';
            }
        });

        // Sign out function
        window.signOut = function() {
            signOut(auth).then(() => {
                alert('Signed out successfully!');
                window.location.href = 'login.html';
            }).catch((error) => {
                alert('Error signing out: ' + error.message);
            });
        };
    </script>
    <style>
        :root {
            --ttf-brand: #15803d;
            --ttf-brand-hover: #166534;
        }
        .bg-gray-900 { background-color: var(--ttf-brand) !important; }
        .bg-gray-800 { background-color: var(--ttf-brand-hover) !important; }
        .hover\:bg-gray-800:hover { background-color: var(--ttf-brand-hover) !important; }
        .focus\:ring-gray-800:focus { --tw-ring-color: var(--ttf-brand-hover) !important; }
        .bg-black { background-color: rgba(24, 0, 172, 0.55) !important; }
    </style>
</head>
<body class="font-sans antialiased bg-gray-100">

<!-- Navbar -->
<nav class="bg-white border-b border-gray-300 p-4 shadow-sm fixed top-0 w-full z-50">
    <div class="container mx-auto flex items-center justify-between">
        <a href="dashboard.html" class="flex items-center">
            <img src="11.png" alt="Twenty Forth & Fifth Logo" class="h-14 md:h-16 w-auto">
        </a>
        <button onclick="signOut()" class="bg-white border border-gray-400 text-xs text-gray-800 px-4 md:px-6 py-2 rounded-full hover:bg-gray-50 transition">Sign Out</button>
    </div>
</nav>

<!-- Spacer to prevent content overlap -->
<div class="h-20"></div>

<!-- Main Content -->
<div class="min-h-screen py-6 md:py-12 px-4 sm:px-6 lg:px-8 pb-40 md:pb-16">
    <div class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Customer Support</h1>
            <p class="text-gray-600 text-sm md:text-base">We're here to help with any questions</p>
        </div>

        <!-- Support Options -->
        <div class="space-y-6 mb-8">
            <!-- Chat with Us Button -->
            <div class="bg-white border border-gray-300 rounded-lg p-6 md:p-8 shadow-sm">
                <div class="flex flex-col md:flex-row items-center gap-6">
                    <div class="bg-gray-900 rounded-lg p-4 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-10 md:w-10 text-white" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                            <path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
                        </svg>
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <h3 class="text-lg md:text-xl font-semibold text-gray-900 mb-2">Live Chat Support</h3>
                        <p class="text-gray-600 text-sm md:text-base mb-4">Chat with our support team in real-time for immediate assistance</p>
                        <button onclick="openChatModal()" class="inline-block relative bg-gray-900 hover:bg-gray-800 text-white font-semibold py-3 px-6 md:px-8 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-800 focus:ring-offset-2">
                            Chat with Us
                            <span id="chatUnreadBadge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5 shadow-lg animate-pulse">0</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Email Support -->
            <div class="bg-white border border-gray-300 rounded-lg p-6 md:p-8 shadow-sm">
                <div class="flex flex-col md:flex-row items-center gap-6">
                    <div class="bg-gray-900 rounded-lg p-4 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-10 md:w-10 text-white" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 8a2 2 0 00-2-2H6a2 2 0 00-2 2v.217l8 4.8 8-4.8V8zM4 10.383V16a2 2 0 002 2h12a2 2 0 002-2v-5.617l-7.445 4.468a2 2 0 01-2.11 0L4 10.383z"/>
                        </svg>
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <h3 class="text-lg md:text-xl font-semibold text-gray-900 mb-2">Email Support</h3>
                        <p class="text-gray-600 text-sm md:text-base mb-4">Send us an email and we'll get back to you as soon as possible</p>
                        <a href="mailto:support@twentyforthfifth.com?subject=Support Inquiry&body=Hello," class="inline-flex items-center gap-2 text-gray-900 font-medium hover:text-gray-700 transition-colors">
                            <span>support@twentyforthfifth.com</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.293 2.293a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L14 5.414V13a1 1 0 11-2 0V5.414L8.707 8.707A1 1 0 017.293 7.293l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Support Center Link -->
            <div class="bg-white border border-gray-300 rounded-lg p-6 md:p-8 shadow-sm">
                <div class="flex flex-col md:flex-row items-center gap-6">
                    <div class="bg-gray-900 rounded-lg p-4 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-10 md:w-10 text-white" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <h3 class="text-lg md:text-xl font-semibold text-gray-900 mb-2">Support Center</h3>
                        <p class="text-gray-600 text-sm md:text-base mb-4">Visit our help center for FAQs and documentation</p>
                        <button onclick="openChatModal()" class="inline-flex items-center gap-2 text-gray-900 font-medium hover:text-gray-700 transition-colors">
                            <span>twentyforthfifth.com/helpcenter</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.293 2.293a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L14 5.414V13a1 1 0 11-2 0V5.414L8.707 8.707A1 1 0 017.293 7.293l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support Hours -->
        <div class="bg-gray-50 border border-gray-300 rounded-lg p-3 md:p-10 lg:p-10 text-center md:text-lg lg:text-xl md:mb-12">
            <p class="text-sm md:text-base lg:text-lg text-gray-700">
                <strong class="text-gray-900 text-base md:text-lg lg:text-xl">Available 24/7</strong>
                <span class="hidden md:inline">for your support needs</span>
                <!-- <span class="block md:hidden">for your support needs</span> -->
            </p>
        </div>
    </div>
</div>

<!-- Bottom Navbar (Mobile Friendly) -->
<div class="mobile-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-300 p-3" style="height: 100px;">
    <div class="flex justify-around items-center h-full">
        <!-- Wallet Icon -->
        <a href="dashboard.html" class="nav-item flex flex-col items-center" onclick="setActive(this)">
            <div class="bg-white rounded p-2">
                <img src="1221.png" alt="Wallet Icon" class="h-6 w-6" />
            </div>
            <span class="text-xs font-medium mt-2 text-gray-700">Home</span>
        </a>
        <!-- Deposit Icon -->
        <a href="deposit.html" class="nav-item flex flex-col items-center" onclick="setActive(this)">
            <div class="bg-white rounded p-2">
                <img src="deposit.png" alt="Redeem Icon" class="h-6 w-6" />
            </div>
            <span class="text-xs font-medium mt-2 text-gray-700">Deposit</span>
        </a>
        <!-- Support Icon -->
        <a href="support.html" class="nav-item flex flex-col items-center" onclick="setActive(this)">
            <div class="bg-white rounded p-2">
                <img src="support.png" alt="Support Icon" class="h-6 w-6" />
            </div>
            <span class="text-xs font-medium mt-2 text-gray-700">Support</span>
        </a>
        <!-- Profile Icon -->
        <a href="profile.html" class="nav-item flex flex-col items-center" onclick="setActive(this)">
            <div class="bg-white rounded p-2">
                <img src="profile.png" alt="Profile Icon" class="h-6 w-6" />
            </div>
            <span class="text-xs font-medium mt-2 text-gray-700">Profile</span>
        </a>
    </div>
</div>

<!-- Script -->
<script>
    // Function to set the active navbar item
    function setActive(element) {
        // Reset all items to default styles
        const icons = document.querySelectorAll('.nav-item div');
        const texts = document.querySelectorAll('.nav-item span');
        icons.forEach(icon => icon.classList.remove('bg-gray-800', 'text-white'));
        texts.forEach(text => text.classList.remove('text-gray-900'));

        // Add active styles to the clicked item
        const icon = element.querySelector('div');
        const text = element.querySelector('span');
        icon.classList.add('bg-gray-800', 'text-white');
        text.classList.add('text-gray-900');
    }

    // Set the active state on page load based on the current URL
    const currentPath = window.location.pathname;
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        if (item.href.includes(currentPath)) {
            setActive(item);
        }
    });
</script>

<script>
    function navigateWithSpinner(url) {
        // Show the spinner
        document.getElementById('spinner').classList.remove('hidden');

        // Simulate a delay for loading (e.g., 1 second)
        setTimeout(() => {
            // Navigate to the specified URL
            window.location.href = url;
        }, 1000);
    }
</script>

<!-- Spinner -->
<div id="spinner" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
    <div class="smart-spinner"></div>
</div>

<!-- Chat Modal -->
<div id="chatModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[85vh] md:h-[700px] flex flex-col overflow-hidden">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-gray-900 to-gray-800 text-white p-4 md:p-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-headset text-lg"></i>
                </div>
                <div>
                    <div class="font-semibold text-base md:text-lg">Twenty Forth & Fifth Support</div>
                    <div class="text-xs md:text-sm text-gray-300 flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        Online now
                    </div>
                </div>
            </div>
            <button onclick="closeChatModal()" class="text-white hover:bg-white/20 rounded-full p-2 transition-colors">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="chatMessagesArea" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-3 bg-gradient-to-b from-gray-50 to-white">
            <!-- FAQ Topics Section (shown first) -->
            <div id="faqTopicsSection" class="space-y-3">
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-4 px-1">Popular Topics</div>
                
                <!-- FAQ Topic Cards -->
                <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="account-setup">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center text-green-600 group-hover:bg-green-100 transition-colors flex-shrink-0">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-sm text-gray-900 mb-1">Account Setup</div>
                            <div class="text-xs text-gray-500">How do I open an banking account?</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                    </div>
                </div>

                <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="transfers">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center text-green-600 group-hover:bg-green-100 transition-colors flex-shrink-0">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-sm text-gray-900 mb-1">International Transfers</div>
                            <div class="text-xs text-gray-500">How do I make international wire transfers?</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                    </div>
                </div>

                <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="fees">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-yellow-50 rounded-lg flex items-center justify-center text-yellow-600 group-hover:bg-yellow-100 transition-colors flex-shrink-0">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-sm text-gray-900 mb-1">Fees & Charges</div>
                            <div class="text-xs text-gray-500">What are your banking fees?</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                    </div>
                </div>

                <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="security">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-red-50 rounded-lg flex items-center justify-center text-red-600 group-hover:bg-red-100 transition-colors flex-shrink-0">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-sm text-gray-900 mb-1">Security & Compliance</div>
                            <div class="text-xs text-gray-500">How secure is my account?</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                    </div>
                </div>

                <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="multi-currency">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-purple-50 rounded-lg flex items-center justify-center text-purple-600 group-hover:bg-purple-100 transition-colors flex-shrink-0">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-sm text-gray-900 mb-1">Multi-Currency Accounts</div>
                            <div class="text-xs text-gray-500">What currencies do you support?</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                    </div>
                </div>

                <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="investment">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-indigo-50 rounded-lg flex items-center justify-center text-indigo-600 group-hover:bg-indigo-100 transition-colors flex-shrink-0">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-sm text-gray-900 mb-1">Investment Services</div>
                            <div class="text-xs text-gray-500">What investment options are available?</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <button onclick="startLiveChat()" class="w-full bg-gradient-to-r from-gray-900 to-gray-800 hover:from-gray-800 hover:to-gray-700 text-white font-semibold py-3 px-4 rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                        <i class="fas fa-comment-dots"></i>
                        <span>Start Live Chat</span>
                    </button>
                </div>
            </div>

            <!-- Live Chat Messages (hidden initially) -->
            <div id="liveChatMessages" class="hidden space-y-3">
                <!-- Messages will be inserted here -->
            </div>
        </div>

        <!-- Input Area (only shown in live chat mode) -->
        <div id="chatInputArea" class="hidden p-4 border-t border-gray-200 bg-white">
            <!-- Image Preview -->
            <div id="imagePreviewContainer" class="hidden mb-3">
                <div class="relative inline-block">
                    <img id="imagePreview" src="" alt="Preview" class="max-w-32 max-h-32 rounded-xl border-2 border-gray-200 shadow-sm">
                    <button onclick="removeImagePreview()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 shadow-lg transition-transform hover:scale-110">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            </div>
            <div class="flex gap-2 items-end">
                <input type="file" id="imageInput" accept="image/*" class="hidden">
                <button onclick="document.getElementById('imageInput').click()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-3 rounded-xl transition-all hover:scale-105" title="Attach image">
                    <i class="fas fa-image"></i>
                </button>
                <div class="flex-1 relative">
                    <textarea id="chatMessageInput" placeholder="Type your message..." 
                        class="w-full px-4 py-3 pr-12 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent bg-gray-50 resize-none"
                        style="font-size: 16px !important; min-height: 48px; max-height: 150px;"
                        rows="1"
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); }"
                        oninput="this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 150) + 'px';"></textarea>
                </div>
                <button onclick="sendChatMessage()" id="sendMessageBtn" class="bg-gradient-to-r from-gray-900 to-gray-800 hover:from-gray-800 hover:to-gray-700 text-white px-4 py-3 rounded-xl transition-all shadow-lg hover:shadow-xl hover:scale-105">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Chat Modal Script -->
<script type="module">
    import { auth, db } from './firebase-client.js';
    import { collection, addDoc, query, where, getDocs, orderBy, onSnapshot, updateDoc, doc, serverTimestamp } from 'firebase/firestore';

    // Make these available globally
    window.chatModal = {
        currentChatId: null,
        currentUserId: null,
        realtimeUnsubscribe: null,
        unreadListener: null,
        unreadCount: 0,
        selectedImageBase64: null,
        selectedImageFile: null,
        chatMode: 'faq' // 'faq' or 'live'
    };

    // FAQ Answers
    const faqAnswers = {
        'account-setup': 'To open an banking account with Twenty Forth & Fifth, please visit our sign-up page and complete the registration form. You\'ll need to provide identification documents and proof of address. Our compliance team will review your application within 1-2 business days.',
        'transfers': 'You can make international wire transfers through your online dashboard. Navigate to the Transfer section, enter the recipient details, amount, and currency. Transfers are typically processed within 1-3 business days. Fees vary by currency and destination.',
        'fees': 'Our fee structure is transparent and competitive. Account maintenance fees start at $50/month. Wire transfer fees range from $25-$75 depending on currency and destination. Please contact us for a detailed fee schedule tailored to your needs.',
        'security': 'Your account is protected by bank-level encryption, multi-factor authentication, and regular security audits. We comply with international banking regulations and maintain strict KYC/AML procedures. Your funds are held in segregated accounts.',
        'multi-currency': 'We support over 20 major currencies including USD, EUR, GBP, JPY, CHF, AUD, CAD, and more. You can hold multiple currencies in a single account and convert between them at competitive exchange rates.',
        'investment': 'We offer various investment options including fixed deposits, treasury bonds, and managed investment portfolios. Minimum investment amounts and returns vary by product. Please schedule a consultation with our investment team for personalized advice.'
    };

    const topicTitles = {
        'account-setup': 'ðŸ“‹ Account Setup',
        'transfers': 'ðŸ’¸ International Transfers',
        'fees': 'ðŸ’° Fees & Charges',
        'security': 'ðŸ”’ Security & Compliance',
        'multi-currency': 'ðŸŒ Multi-Currency Accounts',
        'investment': 'ðŸ“ˆ Investment Services'
    };

    // Initialize user
    async function initializeChatUser() {
        // CRITICAL: Only initialize if user is authenticated
        if (!auth.currentUser) {
            console.warn('Cannot initialize chat: User not authenticated');
            return;
        }
        
        window.chatModal.currentUserId = auth.currentUser.uid;
        await loadOrCreateChat();
        await setupUnreadListener();
    }

    // Setup unread messages listener
    async function setupUnreadListener() {
        if (!window.chatModal.currentUserId) return;

        // Remove existing listener if any
        if (window.chatModal.unreadListener) {
            window.chatModal.unreadListener();
        }

        try {
            // First, find the user's chat
            const chatsQuery = query(collection(db, 'live_chats'), where('userId', '==', window.chatModal.currentUserId));
            const chatsSnapshot = await getDocs(chatsQuery);
            
            if (chatsSnapshot.empty) {
                updateUnreadBadge(0);
                return;
            }

            const chatId = chatsSnapshot.docs[0].id;
            window.chatModal.currentChatId = chatId;

            // Listen for unread admin messages
            const messagesRef = collection(db, 'live_chats', chatId, 'messages');
            const unreadQuery = query(
                messagesRef, 
                where('read', '==', false),
                where('sender', '==', 'admin')
            );

            window.chatModal.unreadListener = onSnapshot(unreadQuery, (snapshot) => {
                const unreadCount = snapshot.size;
                window.chatModal.unreadCount = unreadCount;
                updateUnreadBadge(unreadCount);
            }, (error) => {
                console.error('Error listening to unread messages:', error);
            });
        } catch (error) {
            console.error('Error setting up unread listener:', error);
        }
    }

    // Update unread badge display
    function updateUnreadBadge(count) {
        const badge = document.getElementById('chatUnreadBadge');
        if (badge) {
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
                // Add pulse animation for new messages
                badge.classList.add('animate-pulse');
                setTimeout(() => badge.classList.remove('animate-pulse'), 2000);
            } else {
                badge.classList.add('hidden');
            }
        }
    }

    // Mark messages as read when chat modal opens
    async function markMessagesAsRead() {
        if (!window.chatModal.currentChatId) return;

        try {
            const messagesRef = collection(db, 'live_chats', window.chatModal.currentChatId, 'messages');
            const unreadQuery = query(
                messagesRef,
                where('read', '==', false),
                where('sender', '==', 'admin')
            );
            const snapshot = await getDocs(unreadQuery);
            
            const updatePromises = [];
            snapshot.forEach((msgDoc) => {
                updatePromises.push(
                    updateDoc(doc(db, 'live_chats', window.chatModal.currentChatId, 'messages', msgDoc.id), {
                        read: true
                    })
                );
            });
            
            await Promise.all(updatePromises);
            updateUnreadBadge(0);
        } catch (error) {
            console.error('Error marking messages as read:', error);
        }
    }

    // Load or create chat
    async function loadOrCreateChat() {
        if (!window.chatModal.currentUserId) return;

        try {
            // Check for existing chat
            const q = query(collection(db, 'live_chats'), where('userId', '==', window.chatModal.currentUserId));
            const snapshot = await getDocs(q);
            
            if (!snapshot.empty) {
                window.chatModal.currentChatId = snapshot.docs[0].id;
                await loadMessages();
                setupRealtimeListener();
            }
        } catch (error) {
            console.error('Error loading chat:', error);
        }
    }

    // Load messages
    async function loadMessages() {
        if (!window.chatModal.currentChatId) return;

        try {
            const messagesRef = collection(db, 'live_chats', window.chatModal.currentChatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));
            const snapshot = await getDocs(q);

            const messagesArea = document.getElementById('liveChatMessages');
            if (messagesArea) {
                // CRITICAL MOBILE FIX: Ensure section is visible before loading messages
                messagesArea.classList.remove('hidden');
                const faqSection = document.getElementById('faqTopicsSection');
                if (faqSection) faqSection.classList.add('hidden');
                const chatInputArea = document.getElementById('chatInputArea');
                if (chatInputArea) chatInputArea.classList.remove('hidden');
                
                messagesArea.innerHTML = '';
                showWelcomeMessage();

                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                messages.sort((a, b) => {
                    const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (a.timestamp || 0);
                    const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (b.timestamp || 0);
                    return timeA - timeB;
                });

                messages.forEach(msg => {
                    addMessageToUI(msg, false);
                });

                setTimeout(() => {
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                }, 100);
            }

            await setupRealtimeListener();
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    // Setup realtime listener
    async function setupRealtimeListener() {
        if (!window.chatModal.currentChatId) return;

        if (window.chatModal.realtimeUnsubscribe) {
            window.chatModal.realtimeUnsubscribe();
        }

        try {
            const messagesRef = collection(db, 'live_chats', window.chatModal.currentChatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));

            window.chatModal.realtimeUnsubscribe = onSnapshot(q, (snapshot) => {
                const messagesArea = document.getElementById('liveChatMessages');
                if (!messagesArea) {
                    console.warn('Messages area not found in realtime listener');
                    return;
                }

                // More reliable duplicate checking - check both data-msg-id and content
                const existingIds = new Set();
                const existingContent = new Set();
                messagesArea.querySelectorAll('[data-msg-id]').forEach(el => {
                    const id = el.getAttribute('data-msg-id');
                    if (id) existingIds.add(id);
                    // Also check content for mobile reliability
                    const textContent = el.textContent?.trim();
                    if (textContent) existingContent.add(textContent.substring(0, 100));
                });

                // CRITICAL: Ensure liveChatMessages is visible before adding messages
                if (messagesArea.classList.contains('hidden')) {
                    console.log('Support: Making liveChatMessages visible for new messages');
                    messagesArea.classList.remove('hidden');
                    const faqSection = document.getElementById('faqTopicsSection');
                    if (faqSection) faqSection.classList.add('hidden');
                    const chatInputArea = document.getElementById('chatInputArea');
                    if (chatInputArea) chatInputArea.classList.remove('hidden');
                }

                const newMessages = [];
                snapshot.forEach(doc => {
                    const msgId = doc.id;
                    const msgData = doc.data();
                    const msgText = msgData.text?.trim() || '';
                    
                    // Check if message exists in DOM
                    const existingMsgEl = messagesArea.querySelector(`[data-msg-id="${msgId}"]`);
                    const msgExistsInDOM = existingMsgEl !== null;
                    
                    // Less aggressive duplicate check for mobile - only skip if truly visible
                    let shouldSkip = false;
                    if (msgExistsInDOM) {
                        const computedStyle = window.getComputedStyle(existingMsgEl);
                        // Only skip if element is actually visible
                        if (computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden' && 
                            !existingMsgEl.classList.contains('hidden')) {
                            shouldSkip = true;
                        } else {
                            // Element exists but is hidden - remove it so we can re-add
                            console.log('Support: Removing hidden duplicate message:', msgId);
                            existingMsgEl.remove();
                        }
                    }
                    
                    // Also check ID and content sets (for messages that might not be in DOM yet)
                    if (!shouldSkip && !existingIds.has(msgId)) {
                        // Only check content if message text is substantial (avoid false positives)
                        const contentKey = msgText.substring(0, 100);
                        if (msgText.length > 0 && existingContent.has(contentKey)) {
                            // Content match found - check if it's actually visible
                            const contentMatch = Array.from(messagesArea.querySelectorAll('[data-msg-id]'))
                                .find(el => el.textContent?.trim().substring(0, 100) === contentKey);
                            if (contentMatch) {
                                const matchStyle = window.getComputedStyle(contentMatch);
                                if (matchStyle.display !== 'none' && matchStyle.visibility !== 'hidden') {
                                    shouldSkip = true;
                                }
                            }
                        }
                    }
                    
                    if (!shouldSkip) {
                        newMessages.push({ id: msgId, ...msgData });
                        existingIds.add(msgId);
                        const contentKey = msgText.substring(0, 100);
                        if (contentKey) existingContent.add(contentKey);
                    }
                });

                newMessages.sort((a, b) => {
                    const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : (a.timestamp || 0);
                    const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : (b.timestamp || 0);
                    return timeA - timeB;
                });

                if (newMessages.length > 0) {
                    console.log(`Adding ${newMessages.length} new messages to UI`);
                }

                newMessages.forEach(msg => {
                    addMessageToUI(msg, true);
                    
                    // Update unread count if it's a new admin message
                    if (msg.sender === 'admin' && !msg.read) {
                        window.chatModal.unreadCount = (window.chatModal.unreadCount || 0) + 1;
                        updateUnreadBadge(window.chatModal.unreadCount);
                    }
                });

                // Enhanced scrolling for mobile
                const scrollToBottom = () => {
                    if (messagesArea) {
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }
                };
                
                scrollToBottom();
                setTimeout(scrollToBottom, 100);
                setTimeout(scrollToBottom, 300);
                setTimeout(scrollToBottom, 600);
            }, (error) => {
                console.error('Realtime listener error:', error);
            });
        } catch (error) {
            console.error('Error setting up realtime listener:', error);
        }
    }

    // Add message to UI
    function addMessageToUI(msg, isNew = false) {
        const messagesArea = document.getElementById('liveChatMessages');
        if (!messagesArea) {
            console.warn('Messages area not found');
            return;
        }

        // CRITICAL MOBILE FIX: Ensure liveChatMessages is visible when adding messages
        if (messagesArea.classList.contains('hidden')) {
            console.log('Support: Making liveChatMessages visible for message display');
            messagesArea.classList.remove('hidden');
            // Also ensure FAQ is hidden and input area is visible
            const faqSection = document.getElementById('faqTopicsSection');
            if (faqSection) faqSection.classList.add('hidden');
            const chatInputArea = document.getElementById('chatInputArea');
            if (chatInputArea) chatInputArea.classList.remove('hidden');
        }

        const isUser = msg.sender === 'user';
        // Use document ID as primary identifier, fallback to generated ID
        const msgId = msg.id || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        // Check if message already exists - less aggressive for mobile
        const existingMsg = messagesArea.querySelector(`[data-msg-id="${msgId}"]`);
        if (existingMsg) {
            // On mobile, check if element is actually visible
            const computedStyle = window.getComputedStyle(existingMsg);
            if (computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden') {
                console.log('Message already exists and is visible, skipping:', msgId);
                return;
            } else {
                // Element exists but is hidden - remove it and re-add (mobile fix)
                console.log('Message exists but is hidden, removing and re-adding:', msgId);
                existingMsg.remove();
            }
        }

        const msgDiv = document.createElement('div');
        msgDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-3`;
        msgDiv.setAttribute('data-msg-id', msgId);
        // Add timestamp attribute for debugging
        msgDiv.setAttribute('data-timestamp', msg.timestamp?.toDate ? msg.timestamp.toDate().getTime() : Date.now());
        
        let imageHtml = '';
        const imageSrc = msg.imageBase64 || msg.imageUrl;
        if (imageSrc) {
            imageHtml = `
                <div class="mb-2 rounded-xl overflow-hidden shadow-md">
                    <img src="${imageSrc}" alt="Shared image" class="max-w-full max-h-64 cursor-pointer hover:opacity-90 transition-opacity rounded-lg" onclick="window.open('${imageSrc}', '_blank')">
                </div>
            `;
        }
        
        const messageText = msg.text || '';
        const timeStr = formatTime(msg.timestamp);
        
        if (isUser) {
            msgDiv.innerHTML = `
                <div class="max-w-[75%] bg-gradient-to-br from-gray-900 to-gray-800 text-white rounded-2xl rounded-tr-sm p-3 shadow-md">
                    ${imageHtml}
                    ${messageText ? `<div class="text-sm leading-relaxed">${escapeHtml(messageText)}</div>` : ''}
                    <div class="text-xs mt-1.5 text-gray-300 opacity-80 flex items-center justify-end gap-1">
                        ${timeStr}
                        <i class="fas fa-check ml-1 text-xs"></i>
                    </div>
                </div>
            `;
        } else {
            msgDiv.innerHTML = `
                <div class="max-w-[75%] bg-white text-gray-900 border border-gray-100 rounded-2xl rounded-tl-sm p-3 shadow-sm">
                    ${imageHtml}
                    ${messageText ? `<div class="text-sm leading-relaxed text-gray-800">${escapeHtml(messageText)}</div>` : ''}
                    <div class="text-xs mt-1.5 text-gray-400">${timeStr}</div>
                </div>
            `;
        }
        
        messagesArea.appendChild(msgDiv);
        
        // CRITICAL MOBILE FIX: Ensure message is visible after appending
        // Force reflow on mobile devices
        msgDiv.offsetHeight;
        
        // Double-check visibility on mobile - sometimes elements are added but not visible
        const computedStyle = window.getComputedStyle(msgDiv);
        if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
            console.warn('Support: Message element is hidden after append, forcing visibility:', msgId);
            msgDiv.style.display = 'flex';
            msgDiv.style.visibility = 'visible';
        }
        
        // Ensure parent container is also visible
        if (messagesArea.classList.contains('hidden')) {
            console.warn('Support: Parent container was hidden, making visible');
            messagesArea.classList.remove('hidden');
        }
        
        // Scroll to bottom with multiple attempts for mobile
        const scrollToBottom = () => {
            if (messagesArea) {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }
        };
        
        // Immediate scroll
        scrollToBottom();
        
        // Delayed scrolls for mobile devices that need time to render
        setTimeout(scrollToBottom, 50);
        setTimeout(scrollToBottom, 200);
        setTimeout(scrollToBottom, 500);
        
        // CRITICAL MOBILE FIX: Periodic visibility check for mobile devices
        // Sometimes mobile browsers hide elements after render - check and fix
        if (isNew) {
            setTimeout(() => {
                const computedStyle = window.getComputedStyle(msgDiv);
                if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || 
                    msgDiv.classList.contains('hidden')) {
                    console.warn('Support: Message became hidden after render, fixing:', msgId);
                    msgDiv.style.display = 'flex';
                    msgDiv.style.visibility = 'visible';
                    msgDiv.classList.remove('hidden');
                }
                // Also check parent
                if (messagesArea.classList.contains('hidden')) {
                    console.warn('Support: Parent became hidden, fixing');
                    messagesArea.classList.remove('hidden');
                }
            }, 100);
        }
        
        // Log for debugging on mobile
        if (isNew) {
            console.log('Added message to UI:', { msgId, sender: msg.sender, text: msg.text?.substring(0, 50) });
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTime(timestamp) {
        if (!timestamp) return '';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function showWelcomeMessage() {
        const messagesArea = document.getElementById('liveChatMessages');
        if (!messagesArea || document.getElementById('welcomeMessage')) return;

        const welcomeDiv = document.createElement('div');
        welcomeDiv.id = 'welcomeMessage';
        welcomeDiv.className = 'flex justify-center mb-4';
        welcomeDiv.innerHTML = `
            <div class="bg-gradient-to-br from-gray-50 via-gray-100 to-gray-50 border border-gray-200 rounded-2xl p-5 max-w-[90%] shadow-lg">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-gradient-to-br from-gray-900 to-gray-800 rounded-full flex items-center justify-center shadow-md">
                            <i class="fas fa-headset text-white text-lg"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-900 mb-2 text-base">Welcome to Twenty Forth & Fifth Support! ðŸ‘‹</h4>
                        <p class="text-sm text-gray-700 leading-relaxed mb-3">
                            We're here to help you with any questions about our banking services. 
                            Our support team will respond to your message as soon as possible.
                        </p>
                        <div class="flex items-center gap-4 text-xs text-gray-600">
                            <div class="flex items-center gap-1.5">
                                <i class="far fa-clock text-gray-600"></i>
                                <span>5-10 min response</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <i class="fas fa-shield-alt text-green-500"></i>
                                <span>Secure & Private</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        messagesArea.appendChild(welcomeDiv);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    // Create new chat
    async function createNewChat() {
        // CRITICAL: Ensure user is authenticated before creating chat
        if (!auth.currentUser) {
            alert('Please log in to start a chat.');
            sessionStorage.setItem('redirectAfterLogin', 'support.html?openChat=true');
            window.location.href = 'login.html';
            throw new Error('User not authenticated');
        }
        
        if (!window.chatModal.currentUserId) {
            window.chatModal.currentUserId = auth.currentUser.uid;
        }

        try {
            const userName = auth.currentUser?.email || 'User';
            
            const chatRef = await addDoc(collection(db, 'live_chats'), {
                userId: window.chatModal.currentUserId,
                userName: userName,
                userEmail: auth.currentUser.email || '',
                isAnonymous: false,
                status: 'open',
                createdAt: serverTimestamp(),
                lastMessageAt: serverTimestamp()
            });
            
            window.chatModal.currentChatId = chatRef.id;
            await setupRealtimeListener();
        } catch (error) {
            console.error('Error creating chat:', error);
            alert('Failed to start chat. Please try again.');
            throw error;
        }
    }

    // Send message
    window.sendChatMessage = async function() {
        // CRITICAL: Ensure user is authenticated before sending messages
        if (!auth.currentUser) {
            alert('Please log in to send messages.');
            sessionStorage.setItem('redirectAfterLogin', 'support.html?openChat=true');
            window.location.href = 'login.html';
            return;
        }
        
        const input = document.getElementById('chatMessageInput');
        const sendBtn = document.getElementById('sendMessageBtn');
        const text = input.value.trim();
        const hasImage = window.chatModal.selectedImageBase64 !== null;
        
        if (!text && !hasImage) return;
        
        // CRITICAL MOBILE FIX: Ensure liveChatMessages is visible before sending
        const messagesArea = document.getElementById('liveChatMessages');
        if (messagesArea && messagesArea.classList.contains('hidden')) {
            console.log('Support: Making liveChatMessages visible before sending message');
            messagesArea.classList.remove('hidden');
            const faqSection = document.getElementById('faqTopicsSection');
            if (faqSection) faqSection.classList.add('hidden');
            const chatInputArea = document.getElementById('chatInputArea');
            if (chatInputArea) chatInputArea.classList.remove('hidden');
            window.chatModal.chatMode = 'live';
        }
        
        if (!window.chatModal.currentChatId) {
            try {
                await createNewChat();
            } catch (error) {
                return;
            }
        }

        if (sendBtn) {
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }

        try {
            let imageBase64 = null;
            if (hasImage) {
                imageBase64 = window.chatModal.selectedImageBase64;
                removeImagePreview();
            }
            
            const messageData = {
                text: text || (hasImage ? 'ðŸ“· Image' : ''),
                sender: 'user',
                timestamp: serverTimestamp(),
                read: false
            };
            
            if (imageBase64) {
                messageData.imageBase64 = imageBase64;
            }
            
            await addDoc(collection(db, 'live_chats', window.chatModal.currentChatId, 'messages'), messageData);

            await updateDoc(doc(db, 'live_chats', window.chatModal.currentChatId), {
                lastMessageAt: serverTimestamp(),
                status: 'open'
            });

            input.value = '';
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message. Please try again.');
        } finally {
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }
    };

    // Start live chat
    window.startLiveChat = function() {
        // CRITICAL: Ensure user is authenticated before starting live chat
        if (!auth.currentUser) {
            alert('Please log in to start a live chat.');
            sessionStorage.setItem('redirectAfterLogin', 'support.html?openChat=true');
            window.location.href = 'login.html';
            return;
        }
        
        window.chatModal.chatMode = 'live';
        document.getElementById('faqTopicsSection').classList.add('hidden');
        document.getElementById('liveChatMessages').classList.remove('hidden');
        document.getElementById('chatInputArea').classList.remove('hidden');
        
        showWelcomeMessage();
        
        if (window.chatModal.currentChatId) {
            loadMessages();
        } else {
            createNewChat().then(() => {
                loadMessages();
            });
        }
    };

    // Handle image selection
    document.getElementById('imageInput')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 700 * 1024) {
            alert('Image size must be less than 700KB. Please compress the image.');
            return;
        }

        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.getElementById('imagePreview');
            const container = document.getElementById('imagePreviewContainer');
            preview.src = e.target.result;
            container.classList.remove('hidden');
            window.chatModal.selectedImageBase64 = e.target.result;
            window.chatModal.selectedImageFile = file;
        };
        reader.readAsDataURL(file);
    });

    // Remove image preview
    window.removeImagePreview = function() {
        document.getElementById('imagePreviewContainer').classList.add('hidden');
        document.getElementById('imageInput').value = '';
        window.chatModal.selectedImageFile = null;
        window.chatModal.selectedImageBase64 = null;
    };

    // FAQ topic click handlers
    document.querySelectorAll('.faq-topic-card').forEach(card => {
        card.addEventListener('click', function() {
            const topic = this.dataset.topic;
            showFAQAnswer(topic);
        });
    });

    function showFAQAnswer(topic) {
        const answer = faqAnswers[topic];
        if (!answer) return;

        const faqSection = document.getElementById('faqTopicsSection');
        faqSection.innerHTML = `
            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-xl">
                <div class="font-semibold text-green-900 mb-2">${topicTitles[topic]}</div>
                <div class="text-sm text-gray-700 mb-4">${answer}</div>
                <button onclick="resetFAQ()" class="text-green-600 hover:text-green-800 text-sm font-semibold flex items-center gap-1">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Topics</span>
                </button>
            </div>
        `;
    }

    window.resetFAQ = function() {
        const faqSection = document.getElementById('faqTopicsSection');
        faqSection.innerHTML = `
            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-4 px-1">Popular Topics</div>
            
            <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="account-setup">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center text-green-600 group-hover:bg-green-100 transition-colors flex-shrink-0">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-sm text-gray-900 mb-1">Account Setup</div>
                        <div class="text-xs text-gray-500">How do I open an banking account?</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                </div>
            </div>

            <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="transfers">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center text-green-600 group-hover:bg-green-100 transition-colors flex-shrink-0">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-sm text-gray-900 mb-1">International Transfers</div>
                        <div class="text-xs text-gray-500">How do I make international wire transfers?</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                </div>
            </div>

            <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="fees">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-yellow-50 rounded-lg flex items-center justify-center text-yellow-600 group-hover:bg-yellow-100 transition-colors flex-shrink-0">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-sm text-gray-900 mb-1">Fees & Charges</div>
                        <div class="text-xs text-gray-500">What are your banking fees?</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                </div>
            </div>

            <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="security">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-red-50 rounded-lg flex items-center justify-center text-red-600 group-hover:bg-red-100 transition-colors flex-shrink-0">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-sm text-gray-900 mb-1">Security & Compliance</div>
                        <div class="text-xs text-gray-500">How secure is my account?</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                </div>
            </div>

            <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="multi-currency">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-purple-50 rounded-lg flex items-center justify-center text-purple-600 group-hover:bg-purple-100 transition-colors flex-shrink-0">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-sm text-gray-900 mb-1">Multi-Currency Accounts</div>
                        <div class="text-xs text-gray-500">What currencies do you support?</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                </div>
            </div>

            <div class="faq-topic-card bg-white p-4 rounded-xl border border-gray-200 cursor-pointer hover:border-gray-900 hover:shadow-md transition-all group" data-topic="investment">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-indigo-50 rounded-lg flex items-center justify-center text-indigo-600 group-hover:bg-indigo-100 transition-colors flex-shrink-0">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-sm text-gray-900 mb-1">Investment Services</div>
                        <div class="text-xs text-gray-500">What investment options are available?</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 text-xs mt-1 group-hover:text-gray-900 transition-colors"></i>
                </div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-200">
                <button onclick="startLiveChat()" class="w-full bg-gradient-to-r from-gray-900 to-gray-800 hover:from-gray-800 hover:to-gray-700 text-white font-semibold py-3 px-4 rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                    <i class="fas fa-comment-dots"></i>
                    <span>Start Live Chat</span>
                </button>
            </div>
        `;

        // Re-attach event listeners
        document.querySelectorAll('.faq-topic-card').forEach(card => {
            card.addEventListener('click', function() {
                const topic = this.dataset.topic;
                showFAQAnswer(topic);
            });
        });
    };

    // Open/Close modal functions
    window.openChatModal = function() {
        // CRITICAL: Ensure user is authenticated before opening chat
        if (!auth.currentUser) {
            // Store the intent to open chat, then redirect to login
            sessionStorage.setItem('redirectAfterLogin', 'support.html?openChat=true');
            window.location.href = 'login.html';
            return;
        }
        
        document.getElementById('chatModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        initializeChatUser();
        // Mark messages as read when opening modal
        markMessagesAsRead();
    };

    window.closeChatModal = function() {
        document.getElementById('chatModal').classList.add('hidden');
        document.body.style.overflow = '';
        
        // Reset to FAQ mode
        window.chatModal.chatMode = 'faq';
        document.getElementById('faqTopicsSection').classList.remove('hidden');
        document.getElementById('liveChatMessages').classList.add('hidden');
        document.getElementById('chatInputArea').classList.add('hidden');
        
        // Clean up realtime listener
        if (window.chatModal.realtimeUnsubscribe) {
            window.chatModal.realtimeUnsubscribe();
            window.chatModal.realtimeUnsubscribe = null;
        }
    };

    // Close modal when clicking backdrop
    document.getElementById('chatModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            window.closeChatModal();
        }
    });

    // Initialize auth state monitoring
    (async function() {
        // Import onAuthStateChanged for auth state monitoring
        const authStateChanged = window.__onAuthStateChanged;
        if (!authStateChanged) {
            console.warn('Auth state listener unavailable.');
            return;
        }

        // Initialize on page load
        if (auth.currentUser) {
            initializeChatUser();
            
            // Check if we should auto-open chat modal (from redirect after login)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('openChat') === 'true') {
                // Remove query param from URL
                window.history.replaceState({}, document.title, window.location.pathname);
                // Auto-open chat modal
                setTimeout(() => {
                    window.openChatModal();
                }, 500);
            }
        }

        // Also listen for auth state changes
        authStateChanged(auth, (user) => {
            if (user) {
                window.chatModal.currentUserId = user.uid;
                initializeChatUser();
                
                // Check if we should auto-open chat modal (from redirect after login)
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('openChat') === 'true') {
                    // Remove query param from URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    // Auto-open chat modal
                    setTimeout(() => {
                        window.openChatModal();
                    }, 500);
                }
            } else {
                // Clean up listeners when user signs out
                if (window.chatModal.unreadListener) {
                    window.chatModal.unreadListener();
                    window.chatModal.unreadListener = null;
                }
                updateUnreadBadge(0);
            }
        });
    })();
</script>

    <!-- Inactivity Timeout: Auto-logout after 5 minutes of inactivity -->
    <script src="inactivity-timeout.js"></script>
</body>
</html>
