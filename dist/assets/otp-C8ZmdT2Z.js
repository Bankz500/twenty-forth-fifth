import"./modulepreload-polyfill-B5Qt9EMX.js";import{initializeApp as b}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";import{getAuth as x}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";import{f as $}from"./firebase-config-C56FTJjz.js";import{s as T}from"./compliance-modals-gjj2jsv3.js";const N=b($),q=x(N),I=document.getElementById("email-display"),c=document.getElementById("otp-status"),m=document.getElementById("otp-error"),p=document.getElementById("otp"),s=document.getElementById("verify-otp-btn"),i=document.getElementById("resend-otp");function E(e){c&&(c.textContent=e,c.classList.remove("hidden"))}function P(){c&&(c.textContent="",c.classList.add("hidden"))}function l(e){m&&(m.textContent=e,m.classList.remove("hidden"))}function B(){m&&(m.textContent="",m.classList.add("hidden"))}function L(e=6){return Array.from({length:e},()=>Math.floor(Math.random()*10)).join("")}function J(e,t,n="operation"){let o;const f=new Promise((z,y)=>{o=setTimeout(()=>y(new Error(`${n} timed out after ${t}ms`)),t)});return Promise.race([e,f]).finally(()=>clearTimeout(o))}function M(){var n;const e=(sessionStorage.getItem("loginEmail")||"").trim(),t=(((n=q.currentUser)==null?void 0:n.email)||"").trim();return e||t||""}function j(){return(sessionStorage.getItem("loginOtp")||"").trim()}async function k(e,t){if(!e)throw new Error("Missing email. Please log in again.");if(!t)throw new Error("Missing OTP. Please log in again.");if(typeof emailjs>"u")throw new Error("Email service not loaded. Please disable ad blockers and try again.");emailjs.init("PpoJ-7X-bqUjp3Wa7");const n=emailjs.send("service_dou8hz3","template_nncgc6k",{to_email:e,email:e,otp:t});return await J(n,12e3,"OTP send"),!0}async function R(){B();const e=M();I&&(I.textContent=e||"(unknown)");let t=j();t||(t=L(),sessionStorage.setItem("loginOtp",t)),E("Sending verification code…"),await k(e,t),E("Code sent. Please check your inbox (and spam)."),setTimeout(()=>P(),6e3)}var C;(C=document.getElementById("otp-form"))==null||C.addEventListener("submit",async e=>{e.preventDefault(),B(),P();const t=((p==null?void 0:p.value)||"").trim(),n=j();if(!t||t.length!==6||!/^[0-9]{6}$/.test(t)){l("Please enter a valid 6-digit code.");return}if(!n){l("Your session expired. Please log in again.");return}s&&(s.disabled=!0,s.textContent="Verifying…");try{if(t!==n){l("Invalid OTP. Please try again.");return}sessionStorage.removeItem("loginOtp"),sessionStorage.removeItem("loginEmail");try{T({onContinue:()=>{window.location.href="dashboard.html"}})}catch(o){console.error(o),l((o==null?void 0:o.message)||"Could not open the AML notice. Please refresh and try again.")}return}finally{s&&(s.disabled=!1,s.textContent="Proceed")}});i==null||i.addEventListener("click",async()=>{try{i.disabled=!0,i.textContent="Sending…";const e=M(),t=L();sessionStorage.setItem("loginOtp",t),sessionStorage.setItem("loginEmail",e),await k(e,t),E("New code sent."),setTimeout(()=>P(),6e3)}catch(e){console.error(e),l((e==null?void 0:e.message)||"Failed to resend code. Please try again.")}finally{i.disabled=!1,i.textContent="Resend code"}});(async()=>{try{await R()}catch(e){console.error(e),l((e==null?void 0:e.message)||"Failed to send OTP. Please try again.")}})();const V=b($),W=x(V),S=document.getElementById("email-display"),u=document.getElementById("otp-status"),g=document.getElementById("otp-error"),h=document.getElementById("otp"),a=document.getElementById("verify-otp-btn"),r=document.getElementById("resend-otp");function w(e){u&&(u.textContent=e,u.classList.remove("hidden"))}function v(){u&&(u.textContent="",u.classList.add("hidden"))}function d(e){g&&(g.textContent=e,g.classList.remove("hidden"))}function A(){g&&(g.textContent="",g.classList.add("hidden"))}function _(e=6){return Array.from({length:e},()=>Math.floor(Math.random()*10)).join("")}function X(e,t,n="operation"){let o;const f=new Promise((z,y)=>{o=setTimeout(()=>y(new Error(`${n} timed out after ${t}ms`)),t)});return Promise.race([e,f]).finally(()=>clearTimeout(o))}function D(){var n;const e=(sessionStorage.getItem("loginEmail")||"").trim(),t=(((n=W.currentUser)==null?void 0:n.email)||"").trim();return e||t||""}function F(){return(sessionStorage.getItem("loginOtp")||"").trim()}async function U(e,t){if(!e)throw new Error("Missing email. Please log in again.");if(!t)throw new Error("Missing OTP. Please log in again.");if(typeof emailjs>"u")throw new Error("Email service not loaded. Please disable ad blockers and try again.");emailjs.init("PpoJ-7X-bqUjp3Wa7");const n=emailjs.send("service_dou8hz3","template_nncgc6k",{to_email:e,email:e,otp:t});return await X(n,12e3,"OTP send"),!0}async function Y(){A();const e=D();S&&(S.textContent=e||"(unknown)");let t=F();t||(t=_(),sessionStorage.setItem("loginOtp",t)),w("Sending verification code…"),await U(e,t),w("Code sent. Please check your inbox (and spam)."),setTimeout(()=>v(),6e3)}var O;(O=document.getElementById("otp-form"))==null||O.addEventListener("submit",async e=>{e.preventDefault(),A(),v();const t=((h==null?void 0:h.value)||"").trim(),n=F();if(!t||t.length!==6||!/^[0-9]{6}$/.test(t)){d("Please enter a valid 6-digit code.");return}if(!n){d("Your session expired. Please log in again.");return}a&&(a.disabled=!0,a.textContent="Verifying…");try{if(t!==n){d("Invalid OTP. Please try again.");return}sessionStorage.removeItem("loginOtp"),sessionStorage.removeItem("loginEmail");try{T({onContinue:()=>{window.location.href="dashboard.html"}})}catch(o){console.error(o),d((o==null?void 0:o.message)||"Could not open the AML notice. Please refresh and try again.")}return}finally{a&&(a.disabled=!1,a.textContent="Proceed")}});r==null||r.addEventListener("click",async()=>{try{r.disabled=!0,r.textContent="Sending…";const e=D(),t=_();sessionStorage.setItem("loginOtp",t),sessionStorage.setItem("loginEmail",e),await U(e,t),w("New code sent."),setTimeout(()=>v(),6e3)}catch(e){console.error(e),d((e==null?void 0:e.message)||"Failed to resend code. Please try again.")}finally{r.disabled=!1,r.textContent="Resend code"}});(async()=>{try{await Y()}catch(e){console.error(e),d((e==null?void 0:e.message)||"Failed to send OTP. Please try again.")}})();
