import{b as E,g as _,d as h,a as S,o as I,s as F,c as T,e as D,A as q,B as U,C as R,D as O,x as H,F as V,y as Y,z as Q,G as $,H as j,Q as W,I as K,J as G,K as Z,L as J,M as X,N as ee,S as te,T as re,V as ae,_ as ne,O as se,P as ie,R as oe,U as ce,W as de,X as le,Y as ue,Z as fe,f as pe,h as ge,$ as me,l as ye,a0 as be,a1 as ve,k as xe,a2 as he,j as we,r as Se,q as Ce,u as _e,w as Ee}from"./firebase-client-CmfDEE6w.js";import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as Le}from"./preload-helper-D7HrI6pR.js";import"./firebase-config-C56FTJjz.js";const De=Object.freeze(Object.defineProperty({__proto__:null,AbstractUserDataWriter:q,Bytes:U,CollectionReference:R,DocumentReference:O,DocumentSnapshot:H,FieldPath:V,FieldValue:Y,Firestore:Q,FirestoreError:$,GeoPoint:j,Query:W,QueryCompositeFilterConstraint:K,QueryConstraint:G,QueryDocumentSnapshot:Z,QueryFieldFilterConstraint:J,QueryOrderByConstraint:X,QuerySnapshot:ee,SnapshotMetadata:te,Timestamp:re,VectorValue:ae,_AutoId:ne,_ByteString:se,_DatabaseId:ie,_DocumentKey:oe,_EmptyAuthCredentialsProvider:ce,_FieldPath:de,_cast:le,_logWarn:ue,_validateIsNotUsedTogether:fe,addDoc:pe,collection:ge,connectFirestoreEmulator:me,deleteDoc:ye,doc:h,ensureFirestoreConfigured:be,executeWrite:ve,getDoc:_,getDocs:xe,getFirestore:he,onSnapshot:we,orderBy:Se,query:Ce,serverTimestamp:D,setDoc:T,updateDoc:_e,where:Ee},Symbol.toStringTag,{value:"Module"})),e=t=>document.getElementById(t);let b=null,o=null,y=null;function m(t,n){const a=e("status");a&&(a.className="text-sm mt-3",t==="error"?a.classList.add("text-red-600"):t==="success"?a.classList.add("text-green-700"):a.classList.add("text-gray-600"),a.textContent=n||"")}function A(t){const n=e("submitBtn"),a=e("submitBtnText"),r=e("submitBtnSpinner");!n||!a||!r||(n.disabled=t,r.classList.toggle("hidden",!t),a.textContent=t?"Submitting...":"Submit for approval")}function d(t){t==null||t.classList.remove("hidden")}function p(t){t==null||t.classList.add("hidden")}function C(t){p(e("requestPanel")),p(e("pendingPanel")),p(e("approvedPanel")),d(e(t==="pending"?"pendingPanel":t==="approved"?"approvedPanel":"requestPanel"))}async function ke(t){var n;try{const a=await _(h(S,"users",t.uid));b=a.exists()?a.data():{};const r=a.exists()?a.data():{},i=[r.firstName,r.lastName].filter(Boolean).join(" ").trim();(n=e("who"))==null||n.classList.remove("hidden"),e("whoName")&&(e("whoName").textContent=i||"Signed in"),e("whoEmail")&&(e("whoEmail").textContent=t.email||"")}catch(a){console.warn("Debit card: could not load user profile",a)}}function Pe(t){return`•••• •••• •••• ${(t||"").toString().slice(-4)||"••••"}`}function N(t,n){const a=String(t||"").padStart(2,"0"),r=String(n||"").slice(-2);return`${a}/${r}`}function M(t){const n=typeof t=="string"?parseFloat(t.replace(/[^0-9.-]/g,""))||0:t||0;return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(n)}function Ae(){const t=b||{},n=[t.firstName,t.lastName].filter(Boolean).join(" ").trim()||"Cardholder",a=(o==null?void 0:o.last4)||"",r=(o==null?void 0:o.expMonth)||"",i=(o==null?void 0:o.expYear)||"",l=(o==null?void 0:o.linkedAccount)||(y==null?void 0:y.linkedAccount)||"";e("cardHolderName")&&(e("cardHolderName").textContent=n.toUpperCase()),e("cardNumberMasked")&&(e("cardNumberMasked").textContent=Pe(a)),e("cardExp")&&(e("cardExp").textContent=N(r,i));let s=0;e("cardAccountBalance")&&(l==="checking"?s=typeof t.checking=="string"?parseFloat(t.checking.replace(/[^0-9.-]/g,""))||0:t.checking||0:l==="savings"&&(s=typeof t.savings=="string"?parseFloat(t.savings.replace(/[^0-9.-]/g,""))||0:t.savings||0),e("cardAccountBalance").textContent=M(s));const g=e("depositRequirementItem");g&&(s<2?d(g):p(g))}async function k(t){try{const r=await _(h(S,"debit_cards",t.uid));o=r.exists()?r.data():null}catch(r){console.warn("Debit card: could not load issued card",r),o=null}try{const r=await _(h(S,"debit_card_applications",t.uid));y=r.exists()?r.data():null}catch(r){console.warn("Debit card: could not load application",r),y=null}if(o){C("approved"),Ae();const r=(o.status||"active").toLowerCase(),i=e("cardStatusBadge"),l=e("viewDetailsBtn"),s=e("cardStatusNote"),g=e("infoSidebar"),u=e("freezeCardBtn"),v=e("freezeCardBtnText"),w=e("depositRequirementItem");if(g&&d(g),w){const c=b||{},P=(o==null?void 0:o.linkedAccount)||"";let L=0;P==="checking"?L=typeof c.deposit=="string"?parseFloat(c.deposit.replace(/[^0-9.-]/g,""))||0:c.deposit||0:P==="savings"&&(L=typeof c.fixed=="string"?parseFloat(c.fixed.replace(/[^0-9.-]/g,""))||0:c.fixed||0),L<2?d(w):p(w)}u&&v&&(r==="active"?(v.textContent="Freeze card",u.onclick=()=>B(!0)):(r==="hold"||r==="frozen")&&(v.textContent="Unfreeze card",u.onclick=()=>B(!1))),i&&(i.className="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full border font-medium",r==="active"?(i.classList.add("bg-green-50","text-green-700","border-green-200"),i.innerHTML='<i class="fas fa-check-circle"></i> Active'):r==="frozen"?(i.classList.add("bg-green-50","text-green-700","border-green-200"),i.innerHTML='<i class="fas fa-snowflake"></i> Frozen'):r==="hold"?(i.classList.add("bg-amber-50","text-amber-700","border-amber-200"),i.innerHTML='<i class="fas fa-pause-circle"></i> On hold'):(i.classList.add("bg-gray-100","text-gray-700","border-gray-200"),i.innerHTML='<i class="fas fa-ban"></i> Suspended'));const x=r==="active"||r==="frozen",f=document.querySelector("#approvedPanel .rounded-2xl.p-5.text-white.shadow-lg")||document.querySelector('#approvedPanel [style*="radial-gradient"]');if(f)if(r==="frozen"){if(f.style.opacity="0.6",f.style.filter="grayscale(40%)",f.classList.add("relative"),!f.querySelector(".frozen-overlay")){const c=document.createElement("div");c.className="frozen-overlay absolute inset-0 rounded-2xl flex items-center justify-center",c.style.background="rgba(0, 0, 0, 0.1)",c.innerHTML='<div class="bg-white/90 px-4 py-2 rounded-lg border-2 border-green-500"><span class="text-green-900 font-bold text-sm">FROZEN</span></div>',f.appendChild(c)}}else{f.style.opacity="1",f.style.filter="none";const c=f.querySelector(".frozen-overlay");c&&c.remove()}l&&(l.disabled=!x,l.classList.toggle("opacity-50",!x),l.classList.toggle("cursor-not-allowed",!x)),u&&(r==="frozen"?(u.classList.remove("border-gray-300","text-gray-800","hover:bg-gray-50"),u.classList.add("bg-green-600","text-white","hover:bg-green-700","border-green-600")):(u.classList.remove("bg-green-600","text-white","hover:bg-green-700","border-green-600"),u.classList.add("border-gray-300","text-gray-800","hover:bg-gray-50"))),s&&(r==="frozen"?(s.className="text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-lg px-4 py-3",s.innerHTML='<div class="flex items-start gap-3"><i class="fas fa-snowflake text-gray-600 mt-0.5"></i><div><div class="font-semibold mb-1 text-gray-900">Card Frozen</div><div class="text-gray-700">Your card is currently frozen and cannot be used for transactions. Click "Unfreeze card" to activate it again.</div></div></div>',d(s)):r==="hold"?(s.className="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-4 py-3",s.innerHTML='<div class="flex items-start gap-3"><i class="fas fa-pause-circle text-amber-600 mt-0.5"></i><div><div class="font-semibold mb-1">Card On Hold</div><div>Your debit card is currently on hold. Contact support if you need help.</div></div></div>',d(s)):r==="suspended"?(s.className="text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg px-4 py-3",s.innerHTML='<div class="flex items-start gap-3"><i class="fas fa-ban text-red-600 mt-0.5"></i><div><div class="font-semibold mb-1">Card Suspended</div><div>Your debit card is suspended. Contact support to resolve this.</div></div></div>',d(s)):p(s));return}const n=e("infoSidebar");if(n&&d(n),((y==null?void 0:y.status)||"").toLowerCase()==="pending"){C("pending");return}C("request")}function Be(){var g,u,v,w,x,f;const t=((g=e("cardType"))==null?void 0:g.value)||"",n=((u=e("linkedAccount"))==null?void 0:u.value)||"",a=(((v=e("deliveryAddress"))==null?void 0:v.value)||"").trim(),r=(((w=e("phoneNumber"))==null?void 0:w.value)||"").trim(),i=(x=e("authorize"))==null?void 0:x.checked,l=(f=e("confirm"))==null?void 0:f.checked,s=[];return t||s.push("Select a card type."),n||s.push("Select a linked account."),a||s.push("Enter a delivery address."),r||s.push("Enter a phone number."),(!i||!l)&&s.push("Authorization and confirmation are required."),s}async function Te(){var a;m("","");const t=E.currentUser;if(!t){m("error","You must be signed in.");return}if(await k(t),o){m("error","You already have an active debit card."),C("approved");return}if(((y==null?void 0:y.status)||"").toLowerCase()==="pending"){m("error","Your request is already pending approval."),C("pending");return}const n=Be();if(n.length){m("error",n[0]);return}A(!0);try{await T(h(S,"debit_card_applications",t.uid),{userId:t.uid,cardType:e("cardType").value,linkedAccount:e("linkedAccount").value,deliveryAddress:e("deliveryAddress").value.trim(),phoneNumber:e("phoneNumber").value.trim(),status:"pending",createdAt:D(),createdAtIso:new Date().toISOString()}),(a=e("form"))==null||a.reset(),p(e("successModal")),d(e("successModal")),C("pending")}catch(r){console.error("Debit card submit error",r),m("error","We couldn’t submit your request. Please try again.")}finally{A(!1)}}async function B(t){const n=E.currentUser;if(!n){m("error","You must be signed in.");return}try{const{updateDoc:a}=await Le(async()=>{const{updateDoc:i}=await Promise.resolve().then(()=>De);return{updateDoc:i}},void 0),r=h(S,"debit_cards",n.uid);await a(r,{status:t?"frozen":"active",updatedAt:D()}),await k(n),m("success",t?"Card frozen successfully.":"Card unfrozen successfully.")}catch(a){console.error("Freeze card error",a),m("error","Unable to update card status. Please try again.")}}function z(){var s;const t=((s=e("linkedAccount"))==null?void 0:s.value)||"",n=e("accountBalanceDisplay"),a=e("accountTypeLabel"),r=e("accountBalanceAmount");if(!n||!a||!r)return;if(!t||!b){p(n);return}let i=0,l="";t==="checking"?(i=typeof b.deposit=="string"?parseFloat(b.deposit.replace(/[^0-9.-]/g,""))||0:b.deposit||0,l="Checking Offshore"):t==="savings"&&(i=typeof b.fixed=="string"?parseFloat(b.fixed.replace(/[^0-9.-]/g,""))||0:b.fixed||0,l="Savings Offshore"),l?(a.textContent=l,r.textContent=M(i),d(n)):p(n)}window.addEventListener("DOMContentLoaded",()=>{var t,n,a,r,i,l,s;(t=e("submitBtn"))==null||t.addEventListener("click",Te),(n=e("closeSuccessModalBtn"))==null||n.addEventListener("click",()=>p(e("successModal"))),(a=e("linkedAccount"))==null||a.addEventListener("change",z),(r=e("viewDetailsBtn"))==null||r.addEventListener("click",()=>{m("",""),e("pinInput").value="",p(e("pinError")),d(e("pinModal"))}),(i=e("closePinModalBtn"))==null||i.addEventListener("click",()=>p(e("pinModal"))),(l=e("pinConfirmBtn"))==null||l.addEventListener("click",async()=>{try{p(e("pinError"));const g=(e("pinInput").value||"").trim();if(!/^\d{5}$/.test(g)){e("pinError").textContent="Enter your 5-digit PIN.",d(e("pinError"));return}const u=E.currentUser;if(!u)throw new Error("Not signed in");const v=await _(h(S,"users",u.uid)),x=((v.exists()?v.data():{}).pin||"").toString().trim();if(!x||x!==g){e("pinError").textContent="Incorrect PIN.",d(e("pinError"));return}const f=await _(h(S,"debit_card_secrets",u.uid));if(!f.exists()){e("pinError").textContent="Card details not available yet.",d(e("pinError"));return}const c=f.data();e("detailPan").textContent=c.pan||"—",e("detailCvv").textContent=c.cvv||"—",e("detailExp").textContent=N(c.expMonth,c.expYear),p(e("pinModal")),d(e("detailsModal"))}catch(g){console.error("View details error",g),e("pinError").textContent="Unable to verify PIN. Please try again.",d(e("pinError"))}}),(s=e("closeDetailsModalBtn"))==null||s.addEventListener("click",()=>p(e("detailsModal")))});I(E,async t=>{if(!t){window.location.href="login.html";return}await ke(t),await k(t),e("requestPanel")&&!e("requestPanel").classList.contains("hidden")&&z()});window.signOut=function(){F(E).then(()=>window.location.href="login.html").catch(t=>{console.error("Sign out error",t),m("error","Unable to sign out. Please try again.")})};
