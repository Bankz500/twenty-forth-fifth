import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as C}from"./preload-helper-D7HrI6pR.js";import{initializeApp as Ie}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";import{getAuth as Se,onAuthStateChanged as pe}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";import{getFirestore as Ce,serverTimestamp as fe,getDocs as te,collection as q,addDoc as he,doc as G,getDoc as Le,deleteDoc as ye}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";const Be={apiKey:"AIzaSyDk8K22XfrsAQAX7WarxSq_BnwO1YQLDSc",authDomain:"twenty-third-forth-ee57c.firebaseapp.com",projectId:"twenty-third-forth-ee57c",storageBucket:"twenty-third-forth-ee57c.firebasestorage.app",messagingSenderId:"47210898997",appId:"1:47210898997:web:d25c23eee45a7660cef37c",measurementId:"G-ESYD665GWG"},ve=Ie(Be),B=Se(ve),b=Ce(ve);window.signOut=async function(){const{signOut:e}=await C(async()=>{const{signOut:t}=await import("https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js");return{signOut:t}},[]);try{await e(B),window.location.href="admin-login.html"}catch(t){console.error("Error signing out:",t),alert("Error signing out. Please try again.")}};pe(B,e=>{if(!e){window.location.href="admin-login.html";return}console.log("Admin logged in with email:",e.email),console.log("Admin UID:",e.uid);try{const t=new Set(["bealoffshore@gmail.com","admin123@gmail.com","harleyzain70@gmail.com"]),n=(e.email||"").trim(),s=document.getElementById("adminAuthPill"),a=document.getElementById("adminAuthEmail");if(a&&(a.textContent=n||"Unknown email"),s){const r=s.querySelector("span.w-2.h-2"),o=t.has(n);r&&(r.classList.remove("bg-gray-300","bg-green-500","bg-amber-500"),r.classList.add(o?"bg-green-500":"bg-amber-500")),s.title=o?"This email is in the Firestore admin allowlist.":"This email is NOT in the Firestore admin allowlist (isAdmin())."}}catch{}j(),$e()});async function $e(){try{const{doc:e,getDoc:t,setDoc:n}=await C(async()=>{const{doc:d,getDoc:c,setDoc:i}=await import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js");return{doc:d,getDoc:c,setDoc:i}},[]),s=e(b,"settings","currency"),a=await t(s),r=document.getElementById("adminCurrencySign"),o=document.getElementById("adminCurrencyDisplay");if(a.exists()){const c=a.data().currencySign||"$";r&&(r.value=c),o&&(o.textContent=c||"Not set (default: $)")}else r&&(r.value="$"),o&&(o.textContent="Not set (default: $)")}catch(e){console.error("Error loading currency setting:",e);const t=document.getElementById("adminCurrencyDisplay");t&&(t.textContent="Error loading setting")}}window.adminSaveCurrency=async function(){const e=document.getElementById("adminCurrencySign");if(!e)return;const t=String(e.value||"").trim();if(!t){D("Please enter a currency sign.");return}const n="adminSaveCurrencyBtn",s=document.getElementById("adminCurrencyStatus");F(n,!0),s&&(s.textContent="");try{const{doc:a,setDoc:r}=await C(async()=>{const{doc:c,setDoc:i}=await import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js");return{doc:c,setDoc:i}},[]),o=a(b,"settings","currency");await r(o,{currencySign:t,updatedAt:fe()},{merge:!0});const d=document.getElementById("adminCurrencyDisplay");d&&(d.textContent=t),s&&(s.textContent="Currency saved successfully!",s.className="text-xs text-green-600"),L(`Currency sign set to "${t}". All account balances will now display with this symbol.`)}catch(a){console.error("Error saving currency setting:",a),D("Failed to save currency setting. Please try again."),s&&(s.textContent="Error saving",s.className="text-xs text-red-600")}finally{F(n,!1)}};document.getElementById("authorImage").addEventListener("change",function(e){const t=e.target.files[0],n=document.getElementById("imagePreview"),s=document.getElementById("previewImg");if(t){if(t.size>2*1024*1024){alert("Image size must be less than 2MB"),e.target.value="",n.classList.add("hidden");return}if(!t.type.startsWith("image/")){alert("Please select a valid image file"),e.target.value="",n.classList.add("hidden");return}const a=new FileReader;a.onload=function(r){s.src=r.target.result,n.classList.remove("hidden")},a.readAsDataURL(t)}else n.classList.add("hidden")});async function _e(e){const t="https://api.cloudinary.com/v1_1/dmgcagkqa/image/upload",n="ASHB_profile",s=new FormData;s.append("file",e),s.append("upload_preset",n);try{const a=await fetch(t,{method:"POST",body:s});if(!a.ok)throw new Error("Image upload failed");return(await a.json()).secure_url}catch(a){throw console.error("Error uploading image:",a),a}}const de=[{authorName:"Michael Chen",company:"Global Trade Solutions Inc.",country:"Singapore",rating:5,reviewText:"Twenty Forth & Fifth has been instrumental in our international expansion across Southeast Asia. Their expertise in banking solutions and regulatory compliance has saved us significant time and resources. The team is professional, responsive, and truly understands the complexities of cross-border transactions. We've processed over $2M in international transfers through their platform with zero issues. Their compliance team ensured we met all regulatory requirements for our operations in multiple jurisdictions. Highly recommended for any business looking to expand internationally.",verified:!0,published:!0},{authorName:"Sarah Williams",company:"Williams Financial Group",country:"United Kingdom",rating:5,reviewText:"Outstanding service from Twenty Forth & Fifth. They helped us set up our banking account structure efficiently when we were establishing our presence in the European market. Their attention to detail and commitment to compliance is impressive - they walked us through every step of the KYC process and made it seamless. The online dashboard is intuitive, and their customer support team responds within hours, not days. We've been with them for 18 months now and couldn't be happier. Highly recommended for anyone looking for reliable banking services with a personal touch.",verified:!0,published:!0},{authorName:"James Rodriguez",company:"Rodriguez Holdings",country:"United States",rating:5,reviewText:"We've been working with Twenty Forth & Fifth for over two years now, and they've consistently exceeded our expectations. As a family office managing assets across multiple countries, we needed a bank that understood international wealth management. Their team is knowledgeable, professional, and always available when we need assistance - even during off-hours. The platform is user-friendly and the transaction processing is seamless. What impressed us most was their proactive approach to compliance - they keep us informed about regulatory changes that might affect our accounts. This level of service is rare in banking.",verified:!0,published:!0},{authorName:"Emma Thompson",company:"Thompson Enterprises",country:"Canada",rating:5,reviewText:"Twenty Forth & Fifth has transformed how we manage our international finances. The banking account setup was straightforward, and their compliance team ensured everything was done correctly from day one. We were initially concerned about the complexity of banking, but their team made the entire process transparent and easy to understand. Their customer support is top-notch - they've helped us navigate currency conversions, international wire transfers, and even provided advice on tax-efficient structures. We appreciate their transparency throughout the process. After 3 years, we still feel like valued clients, not just account numbers.",verified:!0,published:!0},{authorName:"David Kim",company:"Kim Capital Management",country:"South Korea",rating:5,reviewText:"Excellent banking services. Twenty Forth & Fifth understands the needs of international businesses and provides tailored solutions. Their platform is secure, reliable, and their team is always ready to help. We've processed millions in transactions through their system without a single security concern. The multi-currency accounts have been particularly useful for our operations across Asia-Pacific. Their compliance documentation is thorough, which gives us confidence when dealing with auditors. We've had a great experience working with them and plan to expand our relationship.",verified:!0,published:!0},{authorName:"Robert Anderson",company:"Anderson & Associates",country:"Australia",rating:5,reviewText:"I've worked with several banks over the past decade, and Twenty Forth & Fifth stands out for their professionalism and reliability. Their online banking platform is modern and secure - I can manage all my accounts from anywhere in the world. The transaction fees are competitive, and more importantly, they're transparent about all costs upfront. Their support team has helped me with everything from setting up beneficiary accounts to understanding tax implications. The fact that they're fully licensed and regulated gives me peace of mind. I've recommended them to several colleagues in the financial services industry.",verified:!0,published:!0},{authorName:"Maria Garcia",company:"Garcia International Trading",country:"Spain",rating:5,reviewText:"Twenty Forth & Fifth has been our banking partner for our import-export business for the past 3 years. Their multi-currency accounts have been essential for our operations across Europe and Latin America. The wire transfer process is fast and reliable - we've never experienced delays or issues. Their compliance team is thorough but efficient, which is exactly what we need. The online platform allows us to track all transactions in real-time, and the reporting features help us with our accounting. Their customer service is exceptional - they speak multiple languages and understand international business needs. We couldn't operate our business as efficiently without them.",verified:!0,published:!0},{authorName:"Thomas Müller",company:"Müller Tech Solutions",country:"Germany",rating:5,reviewText:"As a technology company expanding globally, we needed a banking partner that could keep up with our fast-paced growth. Twenty Forth & Fifth has been exactly that. They set up our corporate accounts quickly and have supported us through multiple funding rounds. Their platform integrates well with our accounting software, saving us hours of manual work. The team understands the unique needs of tech companies - they've helped us with everything from investor relations to payroll for our international team. Their security measures are top-tier, which is crucial for a tech company. Highly professional and reliable.",verified:!0,published:!0},{authorName:"Jennifer Lee",company:"Lee Investment Partners",country:"Hong Kong",rating:5,reviewText:"Twenty Forth & Fifth has been our preferred banking partner for managing our clients' investments. Their expertise in wealth management and their understanding of different regulatory environments is impressive. The platform is sophisticated yet user-friendly, and their reporting capabilities are excellent for our compliance requirements. They've helped us structure accounts for clients across multiple jurisdictions while ensuring full regulatory compliance. Their team is responsive and always willing to go the extra mile. We've been with them for 4 years and have never had a reason to look elsewhere. They truly understand the needs of investment professionals.",verified:!0,published:!0},{authorName:"Ahmed Hassan",company:"Hassan Trading Group",country:"United Arab Emirates",rating:5,reviewText:"Twenty Forth & Fifth has been instrumental in our business expansion across the Middle East and Africa. Their understanding of regional banking requirements and their ability to facilitate transactions across different currencies has been invaluable. The account setup process was smooth, and their compliance team ensured we met all regulatory requirements. Their online platform works perfectly even with slower internet connections, which is important for our operations in remote areas. The customer support team is available 24/7 and has helped us resolve issues quickly. Their commitment to security and compliance gives us confidence in every transaction. Excellent service overall.",verified:!0,published:!0},{authorName:"Sophie Martin",company:"Martin Real Estate Holdings",country:"France",rating:5,reviewText:"We've been using Twenty Forth & Fifth for our international real estate investments for over 5 years. Their expertise in handling large transactions and their understanding of property investment structures is outstanding. They've facilitated transactions in multiple countries and currencies without any issues. The platform is secure and user-friendly, and their reporting features help us track all our investments. Their compliance team has been particularly helpful in ensuring we meet all regulatory requirements across different jurisdictions. The level of service we receive is exceptional - they treat us like partners, not just clients. We've recommended them to many colleagues in the real estate industry.",verified:!0,published:!0},{authorName:"Carlos Silva",company:"Silva Manufacturing Corp",country:"Brazil",rating:5,reviewText:"Twenty Forth & Fifth has transformed our international operations. As a manufacturing company with suppliers and customers across multiple continents, we needed a banking partner that could handle complex international transactions. They've exceeded our expectations in every way. Their multi-currency accounts have saved us significant money on currency conversions, and their wire transfer service is fast and reliable. The online platform is excellent - we can manage all our accounts and transactions from our office in São Paulo. Their customer support team speaks Portuguese, which makes communication much easier. They've been our banking partner for 2 years, and we plan to continue working with them as we expand further.",verified:!0,published:!0}];function R(e,t){return Math.floor(Math.random()*(t-e+1))+e}function Z(){return R(75,300)}function we(){const e=R(2019,2025),t=R(0,11),n=new Date(e,t+1,0).getDate(),s=R(1,n),a=R(10,16),r=R(0,59),o=R(0,59);return new Date(e,t,s,a,r,o)}function z(e){return String(e||"").toLowerCase().replace(/\s+/g," ").trim()}function Fe(e){if(!e)return"";if(e instanceof Date)return String(e.getTime());if(typeof e.toDate=="function")return String(e.toDate().getTime());if(typeof e=="number")return String(e);if(typeof e=="string"){const t=Date.parse(e);return Number.isFinite(t)?String(t):e}if(typeof e=="object"&&typeof e.seconds=="number"){const t=typeof e.nanoseconds=="number"?e.nanoseconds:0;return String(e.seconds*1e3+Math.floor(t/1e6))}try{const t=new Date(e).getTime();return Number.isFinite(t)?String(t):""}catch{return""}}function ae(e){return[z(e.authorName),z(e.reviewText),Fe(e.createdAt)].join("||")}function Me(e){let t=2166136261;const n=String(e||"");for(let s=0;s<n.length;s++)t^=n.charCodeAt(s),t=Math.imul(t,16777619);return t>>>0}const Pe=new Set(["heather","nicole","ashley","lauren","jessica","kayla","stephanie","megan","danielle","courtney","alicia","kimberly","samantha","rachel","christina","erica","natalie","tiffany","vanessa","emily","monica","allison","paige","brielle","haley","jenna","victoria","faith","marissa","kelsey","hannah","olivia","alexis","desiree","michelle","brooke","carly","naomi","chelsea","madeline","rachael","autumn","kristen","savannah","bianca","lillian","kayleen","sarah","emma","maria","jennifer","sophie"]),Re=new Set(["michael","daniel","anthony","brian","kevin","jason","andrew","matthew","jonathan","justin","brandon","eric","nicholas","ryan","steven","joseph","tyler","adam","sean","robert","zachary","carlos","patrick","aaron","dylan","marcus","paul","trevor","joshua","nathan","corey","luke","omar","isaiah","miguel","julian","frank","victor","evan","caleb","jordan","devin","austin","raymond","blake","terrence","noah","samuel","david","ahmed","james","thomas"]);function Ne(e){const t=String(e||"").trim().split(/\s+/)[0].replace(/[^a-zA-Z']/g,"").toLowerCase();return t?Pe.has(t)?"female":Re.has(t)?"male":null:null}function Ue(e,t=null){const n=encodeURIComponent(String(e||"firstcitizensinc")),s=Me(n),a=Ne(e),r=s%1e3/1e3;for(let o=0;o<12;o++){const d=o?`-${o}`:"",c=`${n}${d}`,i=(s+o*997)%1e3/1e3,u=(s+o*101)%100;let g="";if(i<.55?g=`https://randomuser.me/api/portraits/${a==="female"?"women":a==="male"||(s+o)%2?"men":"women"}/${u}.jpg`:i<.9?g=`https://api.dicebear.com/8.x/avataaars/svg?seed=${c}`:g=`https://api.dicebear.com/8.x/shapes/svg?seed=${c}`,!t||!t.has(g))return g}return r<.5?`https://api.dicebear.com/8.x/avataaars/svg?seed=${n}`:`https://api.dicebear.com/8.x/shapes/svg?seed=${n}`}function He({count:e,existingKeys:t,existingNames:n}){const s=["Daniel Thompson","Anthony Rodriguez","Brian Anderson","Kevin Moore","Jason Taylor","Andrew White","Matthew Harris","Jonathan Clark","Justin Lewis","Brandon Walker","Eric Hall","Nicholas Young","Ryan Allen","Steven King","Joseph Wright","Tyler Lopez","Adam Scott","Sean Ramirez","Robert Campbell","Zachary Mitchell","Carlos Hernandez","Patrick O'Neill","Aaron Brooks","Dylan Foster","Marcus Green","Paul Simmons","Trevor Price","Joshua Bennett","Nathan Coleman","Corey Evans","Luke Patterson","Omar Washington","Isaiah Turner","Miguel Flores","Julian Rivera","Frank Delgado","Victor Morales","Evan Porter","Caleb Reed","Jordan Nichols","Devin Watson","Austin Grant","Raymond Cruz","Blake Henderson","Terrence Powell","Noah Kim","Samuel Baker","Heather Johnson","Nicole Ramirez","Ashley Thompson","Lauren Mitchell","Jessica Anderson","Kayla Peterson","Stephanie Brown","Megan O'Connor","Danielle White","Courtney Lewis","Alicia Martinez","Kimberly Scott","Samantha Young","Rachel Turner","Christina Hall","Erica Moore","Natalie Brooks","Tiffany Adams","Vanessa Flores","Emily Richardson","Monica Rivera","Allison Grant","Paige Reynolds","Brielle Jackson","Haley Stewart","Jenna Sullivan","Victoria Lopez","Faith Robinson","Marissa Clark","Kelsey Bennett","Hannah Phillips","Jordan Evans","Olivia Carter","Alexis Green","Desiree Torres","Michelle Ward","Brooke Simmons","Carly Foster","Naomi Price","Chelsea Nguyen","Madeline Howard","Rachael King","Autumn Diaz","Kristen Powell","Savannah Morris","Bianca Cruz","Lillian Baker","Kayleen Murphy"],a=["Northbridge","Blue Harbor","Atlas","Summit","Cedarstone","Silverline","Evergreen","Prime","Vertex","Keystone","Oakridge","Brightwater"],r=["Capital","Holdings","Partners","Advisory","Trading","Logistics","Ventures","Group","Enterprises","Management","Solutions","Industries"],o=["United States","United Kingdom","Canada","Australia","Germany","France","Spain","Italy","Singapore","Hong Kong","United Arab Emirates","South Africa","Netherlands","Switzerland","Sweden","Norway","Ireland","Brazil","Mexico","Japan"],d=["Twenty Forth & Fifth has been excellent for our international banking needs. Highly professional and reliable service.","Great experience with Twenty Forth & Fifth. Their platform is user-friendly and customer support is responsive.","We've been using Twenty Forth & Fifth for banking and are very satisfied. Fast transactions and excellent service.","Twenty Forth & Fifth made our banking account setup seamless. The team is knowledgeable and always available to help.","Outstanding service from Twenty Forth & Fifth. Their compliance guidance and international transfer capabilities are top-notch.","We chose Twenty Forth & Fifth for our global operations and couldn't be happier. Professional, secure, and efficient.","Twenty Forth & Fifth provides excellent banking solutions. The platform is intuitive and transactions are processed quickly.","Highly recommend Twenty Forth & Fifth for international banking. Their customer service is exceptional and the process is transparent.","Our experience with Twenty Forth & Fifth has been outstanding. They understand international business needs and deliver consistently.","Twenty Forth & Fifth has been our trusted banking partner for banking operations. Reliable, secure, and professional service.","Excellent banking services from Twenty Forth & Fifth. The account setup was smooth and ongoing support is great.","We've been working with Twenty Forth & Fifth for international transactions. Their platform is secure and easy to use.","Twenty Forth & Fifth offers reliable banking with excellent customer support. Highly satisfied with their services.","Great banking partner. Twenty Forth & Fifth provides fast, secure transactions and professional guidance.","Twenty Forth & Fifth has exceeded our expectations. Their international banking solutions are comprehensive and reliable.","Professional and efficient service from Twenty Forth & Fifth. The banking account management is seamless and user-friendly.","We appreciate Twenty Forth & Fifth's expertise in banking. Their compliance support and platform are excellent.","Twenty Forth & Fifth provides outstanding banking services. Fast processing, secure platform, and great support.","Our banking experience with Twenty Forth & Fifth has been excellent. They make international operations easy.","Twenty Forth & Fifth is a reliable banking partner. Their team is professional and the platform is intuitive.","Excellent service from Twenty Forth & Fifth. They handle our international banking needs with professionalism and efficiency.","Twenty Forth & Fifth offers top-tier banking solutions. The account setup was quick and the service is outstanding.","We've been very satisfied with Twenty Forth & Fifth. Their banking platform is secure and transactions are fast.","Twenty Forth & Fifth provides excellent international banking services. Highly professional team and reliable platform.","Great banking experience with Twenty Forth & Fifth. Their customer support is responsive and the service is excellent.","Twenty Forth & Fifth has been instrumental in our international operations. Professional service and secure platform.","Outstanding banking partner. Twenty Forth & Fifth offers reliable services with excellent customer support.","We highly recommend Twenty Forth & Fifth for banking. Their platform is user-friendly and service is professional.","Twenty Forth & Fifth provides comprehensive banking solutions. Fast, secure, and reliable international transactions.","Excellent banking services from Twenty Forth & Fifth. The team is knowledgeable and always ready to assist."],c=d.concat((Array.isArray(de)?de:[]).map(l=>l&&l.reviewText?String(l.reviewText):"").filter(Boolean)),i=[],u=500;let g=0;const p=new Set,m=new Set(t||[]),y=new Set(n||[]);for(;i.length<e&&g<u;){g++;let l=R(0,s.length-1),f=0;for(;p.has(l)&&f<50;)l=R(0,s.length-1),f++;const x=s[l],T=z(x);if(p.size<s.length*.8&&y.has(T))continue;const h=`${a[R(0,a.length-1)]} ${r[R(0,r.length-1)]}`,v=o[R(0,o.length-1)],w=Math.random()<.85?5:4,E=c.length?c[R(0,c.length-1)]:d[R(0,d.length-1)],A={authorName:x,company:h,country:v,rating:w,reviewText:E,verified:!0,published:!0,createdAt:we()},k=ae(A);m.has(k)||(i.push(A),p.add(l),y.add(T),m.add(k))}return i}document.getElementById("addSamplesBtn").addEventListener("click",async()=>{const e=document.getElementById("addSamplesBtn");e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Adding samples...';try{if(!B.currentUser)throw new Error("Please log in first");const n=await te(q(b,"testimonials")),s=new Set,a=new Set;n.forEach(g=>{const p=g.data()||{};s.add(ae(p)),p.authorName&&a.add(z(p.authorName))});let r=0,o=0;const d=new Set,c=new Set,u=He({count:24,existingKeys:s,existingNames:a});for(const g of u)try{const p=g.authorImage||Ue(g.authorName,c),m=Z(),y={...g,authorImage:p,likeCount:m,createdAt:g.createdAt||we()},l=ae(y);if(s.has(l)||d.has(l)){o++;continue}await he(q(b,"testimonials"),y),r++,d.add(l),s.add(l),y.authorName&&a.add(z(y.authorName)),y.authorImage&&c.add(y.authorImage)}catch(p){console.error("Error adding testimonial:",p)}if(r>0)o>0?L(`Successfully added ${r} sample testimonials. Skipped ${o} duplicates.`):L(`Successfully added ${r} sample testimonials!`);else{const g=o>0?` Skipped ${o} duplicates.`:"";D(`No new sample testimonials were added.${g} Click again to generate a different random set.`)}j()}catch(t){D("Error adding sample testimonials: "+t.message)}finally{e.disabled=!1,e.innerHTML='<i class="fas fa-sparkles mr-2"></i>Add Sample Testimonials'}});document.getElementById("testimonialForm").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("submitBtn");t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';try{if(!B.currentUser)throw new Error("Please log in first");let s="";const a=document.getElementById("authorImage").files[0];if(a){t.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Uploading image...';try{s=await _e(a),console.log("Image uploaded successfully:",s)}catch(A){throw console.error("Image upload error:",A),new Error("Failed to upload image. Please try again.")}}t.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';const r=document.getElementById("editingTestimonialId"),o=r?r.value:"",d=document.getElementById("publishedDate"),c=d?d.value:"",i=document.getElementById("authorName"),u=document.getElementById("company"),g=document.getElementById("country"),p=document.getElementById("rating"),m=document.getElementById("reviewText"),y=document.getElementById("verified"),l=document.getElementById("published"),f=document.getElementById("likeCount");if(!i||!u||!g||!p||!m||!y||!l)throw new Error("Form elements not found. Please refresh the page.");const x={authorName:i.value.trim(),company:u.value.trim(),country:g.value.trim(),rating:parseInt(p.value),reviewText:m.value.trim(),verified:y.checked,published:l.checked};if(f){const A=String(f.value||"").trim();if(A){const k=parseInt(A,10);if(!Number.isFinite(k)||k<0)throw new Error("Like Count must be a number (0 or higher).");x.likeCount=k}else o||(x.likeCount=Z())}else o||(x.likeCount=Z());if(c){const A=new Date(c);x.createdAt=A}else o||(x.createdAt=fe());if(s&&(x.authorImage=s),o){const{updateDoc:A}=await C(async()=>{const{updateDoc:k}=await import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js");return{updateDoc:k}},[]);await A(G(b,"testimonials",o),x),L("Testimonial updated successfully!")}else await he(q(b,"testimonials"),x),L("Testimonial added successfully!");const T=document.getElementById("testimonialForm");T&&T.reset();const h=document.getElementById("imagePreview");h&&h.classList.add("hidden");const v=document.getElementById("previewImg");v&&(v.src="");const w=document.getElementById("editingTestimonialId");w&&(w.value="");const E=document.getElementById("publishedDate");E&&(E.value=""),cancelEdit(),j()}catch(n){D("Error adding testimonial: "+n.message)}finally{t.disabled=!1;const n=document.getElementById("editingTestimonialId"),s=n?n.value:"";t.innerHTML=s?'<i class="fas fa-save mr-2"></i>Update Testimonial':'<i class="fas fa-save mr-2"></i>Add Testimonial'}});async function j(){try{const e=await te(q(b,"testimonials")),t=document.getElementById("testimonialsList");if(e.empty){t.innerHTML='<p class="text-gray-500 text-center py-8">No testimonials found. Add your first testimonial above!</p>';return}const n=[];e.forEach(s=>{var r;const a=s.data();n.push({id:s.id,...a,createdAt:(r=a.createdAt)!=null&&r.toDate?a.createdAt.toDate():new Date})}),n.sort((s,a)=>{const r=s.createdAt instanceof Date?s.createdAt:new Date(s.createdAt);return(a.createdAt instanceof Date?a.createdAt:new Date(a.createdAt))-r}),t.innerHTML=n.map(s=>{const a=s.createdAt.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),r="⭐".repeat(s.rating||0),o=s.likeCount!==void 0?s.likeCount:"—";return`
                        <div class="border border-gray-200 rounded-lg p-4 ${s.published?"":"opacity-60"}">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-start gap-3">
                                    ${s.authorImage?`<img src="${s.authorImage}" alt="${s.authorName}" class="w-12 h-12 rounded-full object-cover border border-gray-200">`:'<div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-400"></i></div>'}
                                <div>
                                        <h3 class="font-semibold text-gray-900">${s.authorName}</h3>
                                        <p class="text-sm text-gray-600">${s.company} • ${s.country}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-gray-700 text-sm">${r}</div>
                                    <div class="text-xs text-gray-500 mt-1">${a}</div>
                                    <div class="text-xs text-gray-600 mt-1 flex items-center gap-1">
                                        <i class="fas fa-thumbs-up"></i> ${o}
                                    </div>
                                </div>
                            </div>
                            <p class="text-gray-700 text-sm mt-2">${s.reviewText}</p>
                            <div class="flex items-center gap-2 mt-3 text-xs">
                                ${s.verified?'<span class="bg-gray-100 text-gray-800 border border-gray-200 px-2 py-1 rounded">Verified</span>':""}
                                ${s.published?'<span class="bg-gray-100 text-gray-800 border border-gray-200 px-2 py-1 rounded">Published</span>':'<span class="bg-gray-100 text-gray-800 border border-gray-200 px-2 py-1 rounded">Draft</span>'}
                                <button onclick="deleteTestimonial('${s.id}')" class="text-gray-500 hover:text-gray-900 ml-auto">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `}).join("")}catch(e){console.error("Error loading testimonials:",e),document.getElementById("testimonialsList").innerHTML='<p class="text-gray-700 text-center py-8">Error loading testimonials. Please refresh the page.</p>'}}window.editTestimonial=async e=>{try{if(!B.currentUser)throw new Error("Please log in first");const n=await Le(G(b,"testimonials",e));if(!n.exists())throw new Error("Testimonial not found");const s=n.data(),a=document.getElementById("authorName"),r=document.getElementById("company"),o=document.getElementById("country"),d=document.getElementById("rating"),c=document.getElementById("reviewText"),i=document.getElementById("verified"),u=document.getElementById("published"),g=document.getElementById("likeCount"),p=document.getElementById("editingTestimonialId"),m=document.getElementById("publishedDate"),y=document.getElementById("previewImg"),l=document.getElementById("imagePreview"),f=document.getElementById("formTitle"),x=document.getElementById("submitBtnText"),T=document.getElementById("cancelEditBtn");if(a&&(a.value=s.authorName||""),r&&(r.value=s.company||""),o&&(o.value=s.country||""),d&&(d.value=s.rating||""),c&&(c.value=s.reviewText||""),i&&(i.checked=s.verified||!1),u&&(u.checked=s.published||!1),g&&(g.value=s.likeCount!==void 0?s.likeCount:""),p&&(p.value=e),s.createdAt&&s.createdAt.toDate&&m){const h=s.createdAt.toDate();m.value=h.toISOString().split("T")[0]}s.authorImage&&y&&(y.src=s.authorImage,l&&l.classList.remove("hidden")),f&&(f.textContent="Edit Testimonial"),x&&(x.textContent="Update Testimonial"),T&&T.classList.remove("hidden"),document.getElementById("testimonialForm").scrollIntoView({behavior:"smooth",block:"start"})}catch(t){console.error("Error loading testimonial for edit:",t),D("Error loading testimonial: "+t.message)}};window.cancelEdit=function(){const e=document.getElementById("testimonialForm");e&&e.reset();const t=document.getElementById("imagePreview");t&&t.classList.add("hidden");const n=document.getElementById("previewImg");n&&(n.src="");const s=document.getElementById("editingTestimonialId");s&&(s.value="");const a=document.getElementById("publishedDate");a&&(a.value="");const r=document.getElementById("formTitle");r&&(r.textContent="Add New Testimonial");const o=document.getElementById("submitBtnText");o&&(o.textContent="Add Testimonial");const d=document.getElementById("cancelEditBtn");d&&d.classList.add("hidden")};document.getElementById("backfillLikesBtn").addEventListener("click",async()=>{const e=document.getElementById("backfillLikesBtn");e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Assigning likes...';try{if(!B.currentUser)throw new Error("Please log in first");const{updateDoc:n}=await C(async()=>{const{updateDoc:o}=await import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js");return{updateDoc:o}},[]),s=await te(q(b,"testimonials"));let a=0;const r=[];s.forEach(o=>{const d=Z();r.push(n(G(b,"testimonials",o.id),{likeCount:d})),a++}),await Promise.all(r),L(`Successfully assigned random like counts to ${a} testimonials!`),j()}catch(t){console.error("Error assigning like counts:",t),D("Error assigning like counts: "+t.message)}finally{e.disabled=!1,e.innerHTML='<i class="fas fa-thumbs-up mr-2"></i>Assign Random Like Counts'}});window.deleteTestimonial=async e=>{if(confirm("Are you sure you want to delete this testimonial? This action cannot be undone."))try{if(!B.currentUser)throw new Error("Please log in first");await ye(G(b,"testimonials",e)),L("Testimonial deleted successfully!"),j()}catch(t){console.error("Error deleting testimonial:",t),D("Error deleting testimonial: "+t.message)}};document.getElementById("deleteAllTestimonialsBtn").addEventListener("click",async()=>{if(!confirm("⚠️ WARNING: Are you absolutely sure you want to delete ALL testimonials? This action cannot be undone and will permanently remove all testimonials from the database.")||!confirm("This is your last chance. Click OK to permanently delete ALL testimonials."))return;const n=document.getElementById("deleteAllTestimonialsBtn");n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Deleting all testimonials...';try{if(!B.currentUser)throw new Error("Please log in first");const a=await te(q(b,"testimonials"));if(a.empty){L("No testimonials to delete."),n.disabled=!1,n.innerHTML='<i class="fas fa-trash-alt mr-2"></i>Delete All Testimonials';return}const r=[];a.forEach(o=>{r.push(ye(G(b,"testimonials",o.id)))}),await Promise.all(r),L(`Successfully deleted ${a.size} testimonial(s)!`),j()}catch(s){console.error("Error deleting all testimonials:",s),D("Error deleting all testimonials: "+s.message)}finally{n.disabled=!1,n.innerHTML='<i class="fas fa-trash-alt mr-2"></i>Delete All Testimonials'}});function L(e){const t=document.getElementById("successMessage");document.getElementById("successText").textContent=e,t.classList.remove("hidden"),setTimeout(()=>t.classList.add("hidden"),5e3)}function D(e){const t=document.getElementById("errorMessage");document.getElementById("errorText").textContent=e,t.classList.remove("hidden"),setTimeout(()=>t.classList.add("hidden"),5e3)}let J=null;async function qe(){try{const e=document.getElementById("chatUserSelect"),t=document.getElementById("startChatBtn");if(!e)return;if(!B.currentUser){e.innerHTML='<option value="">Not authenticated</option>',t&&(t.disabled=!0);return}const s=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:a,getDocs:r}=s,o=a(b,"users"),d=await r(o),c=[];d.forEach(i=>{const u=i.data()||{},g=i.id,p=[u.firstName,u.lastName].filter(Boolean).join(" ")||u.fullName||u.name||"Unknown",m=u.email||u.userEmail||"";c.push({uid:g,name:p,email:m})}),c.sort((i,u)=>(i.email||"").localeCompare(u.email||"")||(i.name||"").localeCompare(u.name||"")),e.innerHTML='<option value="">Select a user...</option>'+c.map(i=>{const u=i.email?`${i.name} (${i.email})`:`${i.name} (${i.uid})`;return`<option value="${i.uid}" data-name="${String(i.name).replace(/"/g,"&quot;")}" data-email="${String(i.email).replace(/"/g,"&quot;")}">${u}</option>`}).join(""),t&&(t.disabled=!0),e.onchange=function(){t&&(t.disabled=!this.value)}}catch(e){console.error("loadChatUserSelect error",e);const t=document.getElementById("chatUserSelect");t&&(t.innerHTML='<option value="">Failed to load users</option>');const n=document.getElementById("startChatBtn");n&&(n.disabled=!0)}}window.startChatForSelectedUser=async function(){const t=document.getElementById("chatUserSelect"),n=document.getElementById("startChatBtn");if(!t||!t.value)return;const s=B.currentUser;if(!s){D("Not authenticated. Please log in.");return}try{n&&(n.disabled=!0,n.textContent="Starting...");const a=t.value,r=t.options[t.selectedIndex],o=(r==null?void 0:r.getAttribute("data-name"))||"User",d=(r==null?void 0:r.getAttribute("data-email"))||"",c=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:i,query:u,where:g,getDocs:p,addDoc:m,serverTimestamp:y}=c;let l=null;try{const x=i(b,"live_chats");let T=null;try{const h=u(x,g("userId","==",a));T=await p(h)}catch(h){console.warn("Query by userId failed:",h)}if((!T||T.empty)&&d)try{const h=u(x,g("userEmail","==",d));T=await p(h)}catch(h){console.warn("Query by userEmail failed:",h)}if(!T||T.empty)try{const h=await p(x),v=[];h.forEach(w=>{const E=w.data(),A=d&&E.userEmail&&E.userEmail.toLowerCase()===d.toLowerCase(),k=E.userId===a;(A||k)&&v.push(w)}),v.length>0&&(T={docs:v,empty:!1})}catch(h){console.warn("Fallback query failed:",h)}if(T&&!T.empty){const h=Array.from(T.docs);h.sort((v,w)=>{var _,M,P,N;const E=v.data(),A=w.data(),k=(_=E==null?void 0:E.lastMessageAt)!=null&&_.toDate?E.lastMessageAt.toDate().getTime():0,$=(M=A==null?void 0:A.lastMessageAt)!=null&&M.toDate?A.lastMessageAt.toDate().getTime():0;if(k!==$)return $-k;const S=(P=E==null?void 0:E.createdAt)!=null&&P.toDate?E.createdAt.toDate().getTime():0;return((N=A==null?void 0:A.createdAt)!=null&&N.toDate?A.createdAt.toDate().getTime():0)-S}),l=h[0].id,console.log("Found existing chat for user:",{userId:a,userEmail:d,chatId:l})}}catch(x){console.error("Error checking for existing chat:",x)}let f=l;f?console.log("Reusing existing chat:",f):(console.log("Creating new chat for user:",{userId:a,userEmail:d}),f=(await m(i(b,"live_chats"),{userId:a,userName:o,userEmail:d,status:"open",createdAt:y(),lastMessageAt:y(),lastMessage:"",startedBy:s.email||"admin"})).id),J=f;try{Ee(f,o)}catch{}L("Chat opened.")}catch(a){console.error("startChatForSelectedUser error",a),D("Failed to start chat. Please try again.")}finally{n&&(n.textContent="Start chat",n.disabled=!t.value)}};async function ne(){try{const e=B.currentUser;if(!e){document.getElementById("chatsList").innerHTML='<p class="text-gray-700 text-center py-8">Not authenticated. Please log in.</p>';return}console.log("Admin user:",{uid:e.uid,email:e.email,emailVerified:e.emailVerified});const t=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:n,query:s,orderBy:a,onSnapshot:r}=t,o=n(b,"live_chats");let d;try{d=s(o,a("lastMessageAt","desc"))}catch(c){console.warn("OrderBy failed, trying without order:",c),d=s(o)}r(d,async c=>{const i=[];let u=0;c.forEach(g=>{const p=g.data();i.push({id:g.id,...p})}),i.length>0&&i[0].lastMessageAt&&i.sort((g,p)=>{var l,f;const m=(l=g.lastMessageAt)!=null&&l.toDate?g.lastMessageAt.toDate().getTime():0;return((f=p.lastMessageAt)!=null&&f.toDate?p.lastMessageAt.toDate().getTime():0)-m});for(const g of i){const p=await be(g.id);u+=p}xe(i),ze(u)},c=>{console.error("Live chat listener error:",c);const i=(c==null?void 0:c.message)||String(c),u=`
                        <div class="text-gray-700 text-center py-8">
                            <p class="font-semibold mb-2">Live chat failed to load</p>
                            <p class="text-sm">${i}</p>
                            <p class="text-xs text-gray-500 mt-4">Admin Email: ${(e==null?void 0:e.email)||"Not available"}</p>
                            <p class="text-xs text-gray-500">Admin UID: ${(e==null?void 0:e.uid)||"Not available"}</p>
                            <button onclick="loadChats()" class="mt-4 px-4 py-2 text-white rounded-lg" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                Retry
                            </button>
                        </div>
                    `;document.getElementById("chatsList").innerHTML=u,D("Live chat failed to load: "+i)})}catch(e){console.error("Error loading chats:",e),document.getElementById("chatsList").innerHTML='<p class="text-gray-700 text-center py-8">Error loading chats. Please refresh.</p>'}}async function be(e){try{const t=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:n,query:s,where:a,getDocs:r}=t,o=n(b,"live_chats",e,"messages"),d=s(o,a("read","==",!1),a("sender","==","user"));return(await r(d)).size}catch{return 0}}function xe(e){const t=document.getElementById("chatsList");if(e.length===0){t.innerHTML='<p class="text-gray-500 text-center py-8">No active chats yet.</p>';return}t.innerHTML=e.map(n=>{var a;const s=(a=n.lastMessageAt)!=null&&a.toDate?n.lastMessageAt.toDate().toLocaleDateString():"N/A";return`
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition ${J===n.id?"bg-gray-50 border-gray-300":""}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 cursor-pointer" onclick="selectChat('${n.id}', '${n.userName||"User"}')">
                                <h3 class="font-semibold text-gray-900">${n.userName||"User"}</h3>
                                <p class="text-sm text-gray-600">${n.userId||"Unknown"}</p>
                                <p class="text-xs text-gray-500 mt-1">Last message: ${s}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium border border-gray-200 bg-gray-100 text-gray-800">
                                    ${n.status||"open"}
                                </span>
                                <span id="unreadBadge-${n.id}" class="text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden" style="background-color: #15803d;">0</span>
                                <button onclick="event.stopPropagation(); deleteChat('${n.id}')" class="text-gray-500 hover:text-gray-900 p-1" title="Delete Chat">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `}).join(""),e.forEach(async n=>{const s=await be(n.id),a=document.getElementById(`unreadBadge-${n.id}`);a&&(s>0?(a.textContent=s,a.classList.remove("hidden")):a.classList.add("hidden"))})}async function Ee(e,t){J=e;const n=await je();xe(n),await Oe(e,t)}async function je(){try{const e=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:t,query:n,orderBy:s,getDocs:a}=e,r=t(b,"live_chats"),o=n(r,s("lastMessageAt","desc")),d=await a(o),c=[];return d.forEach(i=>{c.push({id:i.id,...i.data()})}),c}catch{return[]}}async function Oe(e,t){try{const n=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:s,query:a,orderBy:r,onSnapshot:o,getDocs:d}=n,c=s(b,"live_chats",e,"messages"),i=a(c,r("timestamp","asc")),u=document.getElementById("chatSection"),g=document.getElementById("chatView");g&&g.remove();const p=document.createElement("div");p.id="chatView",p.className="mt-6 border-t border-gray-200 pt-6",p.innerHTML=`
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-semibold">Chat with ${t}</h3>
                            <span class="text-sm text-gray-500">Chat ID: ${e.substring(0,8)}...</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="clearChatMessages('${e}')" class="text-orange-600 hover:text-orange-700 px-3 py-1 text-sm border border-orange-300 rounded-lg hover:bg-orange-50 transition" title="Clear all messages">
                                <i class="fas fa-eraser mr-1"></i>Clear
                            </button>
                            <button onclick="deleteChat('${e}')" class="text-gray-600 hover:text-gray-900 px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition" title="Delete entire chat">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                            <button onclick="closeChatView()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="chatMessagesArea" class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto mb-4 space-y-3">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="adminReplyInput" placeholder="Type your reply..." 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 bg-white"
                            style="font-size: 16px !important;"
                            onkeypress="if(event.key === 'Enter') sendAdminReply('${e}')">
                        <button onclick="sendAdminReply('${e}')" class="text-white px-6 py-2 rounded-lg" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                            <i class="fas fa-paper-plane mr-2"></i>Send
                        </button>
                    </div>
                `,u.appendChild(p);const m=await d(i),y=document.getElementById("chatMessagesArea");if(y){y.innerHTML="";const l=[];m.forEach(f=>{const x={id:f.id,...f.data()};l.push(x)}),l.sort((f,x)=>{var v,w;const T=(v=f.timestamp)!=null&&v.toDate?f.timestamp.toDate().getTime():f.timestamp||0,h=(w=x.timestamp)!=null&&w.toDate?x.timestamp.toDate().getTime():x.timestamp||0;return T-h}),l.forEach(f=>{le(f,e)}),setTimeout(()=>{y.scrollTop=y.scrollHeight},100)}o(i,l=>{const f=document.getElementById("chatMessagesArea");if(!f)return;const x=new Set;f.querySelectorAll("[data-msg-id]").forEach(h=>{x.add(h.getAttribute("data-msg-id"))});const T=[];l.forEach(h=>{const v=h.id;if(!x.has(v)){const w={id:v,...h.data()};T.push(w)}}),T.sort((h,v)=>{var A,k;const w=(A=h.timestamp)!=null&&A.toDate?h.timestamp.toDate().getTime():h.timestamp||0,E=(k=v.timestamp)!=null&&k.toDate?v.timestamp.toDate().getTime():v.timestamp||0;return w-E}),T.forEach(h=>{le(h,e)}),setTimeout(()=>{f.scrollTop=f.scrollHeight},100)}),await We(e)}catch(n){console.error("Error loading chat messages:",n)}}function le(e,t){const n=document.getElementById("chatMessagesArea");if(!n)return;const s=e.id||`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;if(n.querySelector(`[data-msg-id="${s}"]`))return;const a=e.sender==="admin";let r="";const o=e.imageBase64||e.imageUrl;o&&(r=`
                    <div class="mb-2 rounded-lg overflow-hidden shadow-md">
                        <img src="${o}" alt="Shared image" class="max-w-full max-h-64 cursor-pointer hover:opacity-90 rounded transition-opacity" onclick="window.open('${o}', '_blank')">
                    </div>
                `);const d=document.createElement("div");d.className=`flex ${a?"justify-end":"justify-start"} mb-3 group relative`,d.setAttribute("data-msg-id",s),d.innerHTML=`
                <div class="max-w-[80%] ${a?"text-white":"bg-white text-gray-900 border border-gray-200"} rounded-lg p-3 shadow-sm relative" ${a?'style="background-color: #15803d;"':""}>
                    ${r}
                    ${e.text?`<div class="text-sm ${a?"text-white":"text-gray-800"}">${Ve(e.text)}</div>`:""}
                    <div class="flex items-center justify-between mt-1.5">
                        <div class="text-xs ${a?"text-green-100 opacity-80":"text-gray-500"}">${Ke(e.timestamp)}</div>
                        <button onclick="deleteSingleMessage('${t}', '${s}')" 
                                class="ml-2 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity" 
                                title="Delete message">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `,n.appendChild(d)}function Ve(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Ke(e){return e?(e.toDate?e.toDate():new Date(e)).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):""}async function Ye(e){const t=document.getElementById("adminReplyInput"),n=t.value.trim();if(!(!n||!e))try{const s=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:a,addDoc:r,serverTimestamp:o,updateDoc:d,doc:c}=s;await r(a(b,"live_chats",e,"messages"),{text:n,sender:"admin",timestamp:o(),read:!1}),await d(c(b,"live_chats",e),{lastMessageAt:o(),status:"open"}),t.value=""}catch(s){console.error("Error sending reply:",s),D("Failed to send message. Please try again.")}}async function We(e){try{const t=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:n,query:s,where:a,getDocs:r,updateDoc:o,doc:d}=t,c=n(b,"live_chats",e,"messages"),i=s(c,a("read","==",!1),a("sender","==","user"));(await r(i)).forEach(async g=>{await o(d(b,"live_chats",e,"messages",g.id),{read:!0})}),ne()}catch(t){console.error("Error marking as read:",t)}}function Te(){const e=document.getElementById("chatView");e&&e.remove(),J=null}function ze(e){const t=document.getElementById("adminChatBadge");t&&(e>0?(t.textContent=e,t.classList.remove("hidden")):t.classList.add("hidden"))}pe(B,e=>{e&&ne()});async function Ge(e){if(confirm("Are you sure you want to delete this chat? This will delete all messages and the chat itself. This action cannot be undone."))try{const t=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:n,getDocs:s,deleteDoc:a,doc:r}=t,o=n(b,"live_chats",e,"messages"),c=(await s(o)).docs.map(i=>a(r(b,"live_chats",e,"messages",i.id)));await Promise.all(c),await a(r(b,"live_chats",e)),J===e&&Te(),ne(),L("Chat deleted successfully!")}catch(t){console.error("Error deleting chat:",t),D("Failed to delete chat: "+(t.message||"Please try again."))}}function Je(e){document.getElementById("testimonialsSection").classList.add("hidden"),document.getElementById("chatSection").classList.add("hidden"),document.getElementById("kycSection").classList.add("hidden"),document.getElementById("loansSection").classList.add("hidden");const t=document.getElementById("transfersSection");t&&t.classList.add("hidden");const n=document.getElementById("debitCardsSection");n&&n.classList.add("hidden");const s=document.getElementById("usersSection");if(s&&s.classList.add("hidden"),document.querySelectorAll(".nav-item").forEach(a=>{a.classList.remove("active")}),e==="testimonials")document.getElementById("testimonialsSection").classList.remove("hidden"),document.querySelector('a[onclick*="testimonials"]').classList.add("active"),document.getElementById("pageTitle").textContent="Testimonials";else if(e==="chat")document.getElementById("chatSection").classList.remove("hidden"),document.querySelector('a[onclick*="chat"]').classList.add("active"),document.getElementById("pageTitle").textContent="Live Chat",document.getElementById("chatsList").innerHTML.includes("Loading")&&ne(),qe();else if(e==="kyc")document.getElementById("kycSection").classList.remove("hidden"),document.querySelector('a[onclick*="kyc"]').classList.add("active"),document.getElementById("pageTitle").textContent="KYC Verification",document.getElementById("kycList").innerHTML.includes("Loading")&&Ze();else if(e==="loans")document.getElementById("loansSection").classList.remove("hidden"),document.querySelector('a[onclick*="loans"]').classList.add("active"),document.getElementById("pageTitle").textContent="Loan Requests",document.getElementById("loansList").innerHTML.includes("Loading")&&ie();else if(e==="transfers")document.getElementById("transfersSection").classList.remove("hidden"),document.querySelector('a[onclick*="transfers"]').classList.add("active"),document.getElementById("pageTitle").textContent="Transfer Management",document.getElementById("pendingTransfersList").innerHTML.includes("Loading")&&se(),mt();else if(e==="debitCards"){n&&n.classList.remove("hidden");const a=document.querySelector('a[onclick*="debitCards"]');a&&a.classList.add("active"),document.getElementById("pageTitle").textContent="Debit Cards",window.debitCardsLoaded||it()}else if(e==="users"){s&&s.classList.remove("hidden");const a=document.querySelector('a[onclick*="users"]');a&&a.classList.add("active"),document.getElementById("pageTitle").textContent="Users",window.adminUsersLoaded||Xe(),window.approvalRequestsLoaded||Qe()}window.innerWidth<768&&document.querySelector(".sidebar").classList.remove("open")}window.adminUsersLoaded=!1;window.adminUsersCache=[];window.adminSelectedUserId=null;window.approvalRequestsLoaded=!1;window.approvalRequestsUnsub=null;async function Qe(){try{if(!B.currentUser){const g=document.getElementById("approvalRequestsList");g&&(g.innerHTML='<p class="text-gray-700 text-center py-4 text-sm">Not authenticated. Please log in.</p>');return}const t=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:n,onSnapshot:s,updateDoc:a,doc:r,serverTimestamp:o,writeBatch:d}=t;if(window.approvalRequestsUnsub){try{window.approvalRequestsUnsub()}catch{}window.approvalRequestsUnsub=null}const c=n(b,"users"),i=document.getElementById("approvalRequestsList"),u=document.getElementById("approvalBadge");if(!window.approvalBulkWired){const g=document.getElementById("approvalSelectAll"),p=document.getElementById("approveSelectedAccountsBtn"),m=document.getElementById("approveAllAccountsBtn"),y=()=>{const l=Array.from(document.querySelectorAll("#approvalRequestsList .approval-checkbox")),f=l.filter(T=>T.checked),x=document.getElementById("approvalSelectedCount");if(x&&(x.textContent=f.length?`${f.length} selected`:""),p&&(p.disabled=f.length===0),g){const T=l.length>0&&f.length===l.length,h=f.length>0&&f.length<l.length;g.checked=T,g.indeterminate=h,g.disabled=l.length===0}};g&&g.addEventListener("change",function(){Array.from(document.querySelectorAll("#approvalRequestsList .approval-checkbox")).forEach(f=>f.checked=this.checked),y()}),window.approveUserIds=async function(f){const x=Array.from(new Set((f||[]).filter(Boolean)));if(!x.length)return;const T=B.currentUser;if(!T){D("You must be logged in to approve accounts.");return}const h=450;for(let v=0;v<x.length;v+=h){const w=d(b);x.slice(v,v+h).forEach(E=>{w.update(r(b,"users",E),{approvalStatus:"approved",isApproved:!0,approvedAt:o(),approvedBy:(T==null?void 0:T.email)||"admin"})}),await w.commit()}},p&&p.addEventListener("click",async()=>{const l=Array.from(document.querySelectorAll("#approvalRequestsList .approval-checkbox:checked")).map(f=>f.getAttribute("data-userid")).filter(Boolean);if(l.length&&confirm(`Approve ${l.length} selected account(s)?`))try{p.disabled=!0,p.textContent="Approving...",await window.approveUserIds(l),L("Selected accounts approved successfully!")}catch(f){console.error(f),D("Failed to approve selected accounts. Please try again.")}finally{p.textContent="Approve selected",y()}}),m&&m.addEventListener("click",async()=>{const l=(window.latestApprovalQueueIds||[]).slice();if(l.length&&confirm(`Approve ALL ${l.length} account(s) currently in the approval queue?`))try{m.disabled=!0,m.textContent="Approving...",await window.approveUserIds(l),L("All queued accounts approved successfully!")}catch(f){console.error(f),D("Failed to approve all queued accounts. Please try again.")}finally{m.disabled=!1,m.textContent="Approve all"}}),i&&i.addEventListener("change",l=>{l.target&&l.target.classList&&l.target.classList.contains("approval-checkbox")&&y()}),window.approvalBulkWired=!0;try{y()}catch{}}window.approvalRequestsUnsub=s(c,g=>{const p=l=>{const f=(l==null?void 0:l.approvalStatus)??null,x=typeof(l==null?void 0:l.isApproved)=="boolean"?l.isApproved:null;return f==="approved"||f==null&&x!==!1},m=[];g.forEach(l=>{const f=l.data()||{},x={id:l.id,...f};p(x)||m.push(x)}),window.latestApprovalQueueIds=m.map(l=>l.id);const y=l=>l?typeof l=="string"?new Date(l).getTime()||0:l.toDate?l.toDate().getTime():0:0;if(m.sort((l,f)=>y(f.createdAt||f.createdAtIso)-y(l.createdAt||l.createdAtIso)),u&&(u.textContent=`${m.length} pending`,u.className=m.length?"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-900 border border-gray-300":"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200"),!!i){if(!m.length){i.innerHTML='<p class="text-gray-500 text-center py-4 text-sm">No pending sign‑up requests.</p>';return}i.innerHTML=m.map(l=>{var k,$,S,I;const f=[l.firstName,l.lastName].filter(Boolean).join(" ")||l.fullName||"Unknown",x=l.email||l.userEmail||"-",T=l.userAccountType||"-",h=l.accountType||"-",v=(k=l.onboarding)!=null&&k.depositMethods&&Array.isArray(l.onboarding.depositMethods)&&l.onboarding.depositMethods.length?l.onboarding.depositMethods.join(", "):(($=l.onboarding)==null?void 0:$.depositMethod)||"-",w=((S=l.onboarding)==null?void 0:S.residency)||"-",E=(I=l.createdAt)!=null&&I.toDate?l.createdAt.toDate():l.createdAtIso?new Date(l.createdAtIso):null,A=E?E.toLocaleDateString():"N/A";return`
                          <div class="bg-white border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                              <div class="flex items-start gap-3 min-w-0">
                                <input type="checkbox" class="approval-checkbox mt-1 rounded border-gray-300" data-userid="${l.id}">
                              <div class="min-w-0">
                                <p class="font-semibold text-gray-900 truncate">${f} <span class="text-gray-400 font-normal">(${T})</span></p>
                                <p class="text-sm text-gray-600 truncate">${x}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                  Product: <span class="font-medium text-gray-700">${h}</span> • Submitted: ${A}
                                </p>
                                <p class="text-xs text-gray-500 mt-1">
                                  Onboarding: Deposit <span class="font-medium text-gray-700">${v}</span> • Residency <span class="font-medium text-gray-700">${w}</span>
                                </p>
                                </div>
                              </div>
                              <div class="flex gap-2 shrink-0">
                                <button data-approve="${l.id}" class="approveAccountBtn px-4 py-2 rounded-lg text-white text-sm font-semibold transition" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                  <i class="fas fa-check mr-2"></i>Approve
                                </button>
                              </div>
                            </div>
                          </div>
                        `}).join(""),i.querySelectorAll(".approveAccountBtn").forEach(l=>{l.addEventListener("click",async()=>{const f=l.getAttribute("data-approve");if(f&&confirm("Approve this account? This will allow the user to access the dashboard."))try{l.disabled=!0,l.classList.add("opacity-75","cursor-not-allowed"),l.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Approving...';const x=B.currentUser;await a(r(b,"users",f),{approvalStatus:"approved",isApproved:!0,approvedAt:o(),approvedBy:(x==null?void 0:x.email)||"admin"}),L("Account approved successfully!")}catch(x){console.error(x),D("Failed to approve account. Please try again.")}finally{}})})}},g=>{console.error("Approval requests listener error:",g);const p=document.getElementById("approvalRequestsList");p&&(p.innerHTML=`<p class="text-gray-700 text-center py-4 text-sm">Failed to load approval requests: ${g.message}</p>`)}),window.approvalRequestsLoaded=!0}catch(e){console.error("Error loading approval requests:",e);const t=document.getElementById("approvalRequestsList");t&&(t.innerHTML='<p class="text-gray-700 text-center py-4 text-sm">Error loading approval requests.</p>')}}async function Xe(){try{if(!B.currentUser){document.getElementById("adminUserSelect").innerHTML='<option value="">Not authenticated</option>';return}const t=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:n,getDocs:s}=t,a=n(b,"users"),r=await s(a),o=document.getElementById("adminUserSelect");r.empty?o.innerHTML='<option value="">No users found</option>':(window.adminUsersCache=[],o.innerHTML='<option value="">Select a user...</option>',r.forEach(d=>{const c=d.data()||{},i=d.id,u=c.firstName||c.name||c.fullName||"Unknown",g=c.email||c.userEmail||"";window.adminUsersCache.push({id:i,data:c});const p=document.createElement("option");p.value=i,p.textContent=g?`${u} (${g})`:`${u} (${i})`,o.appendChild(p)})),o.onchange=function(){const d=this.value;d?H(d):window.adminSelectedUserId=null},window.adminUsersLoaded=!0}catch(e){console.error("Error loading admin users:",e);const t=document.getElementById("adminUserSelect");t&&(t.innerHTML='<option value="">Error loading users</option>')}}function H(e){window.adminSelectedUserId=e;const t=(window.adminUsersCache||[]).find(k=>k.id===e),n=t?t.data||{}:{},s=n.firstName||n.name||n.fullName||"Unknown",a=n.email||n.userEmail||"-",r=n.status||"-",o=k=>{if(!k)return"0.00";const $=typeof k=="string"?parseFloat(k.replace(/[^0-9.-]/g,""))||0:Number(k)||0;return new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format($)},d=n.checking??0,c=o(d),i=n.fixed??0,u=o(i),g=n.savings??0,p=o(g),m=document.getElementById("adminUserId"),y=document.getElementById("adminUserName"),l=document.getElementById("adminUserEmail"),f=document.getElementById("adminUserStatusLabel"),x=document.getElementById("adminUserChecking"),T=document.getElementById("adminUserFixed"),h=document.getElementById("adminUserSavings"),v=document.getElementById("adminUserStatusSelect");m&&(m.textContent=e),y&&(y.textContent=s),l&&(l.textContent=a),f&&(f.textContent=r),x&&(x.textContent=c),T&&(T.textContent=u),h&&(h.textContent=p),v&&(v.value=r);const w=document.getElementById("adminCheckingSetAmount"),E=document.getElementById("adminFixedSetAmount"),A=document.getElementById("adminSavingsSetAmount");w&&(w.value=""),E&&(E.value=""),A&&(A.value=""),ee()}function F(e,t,n=null){const s=document.getElementById(e);s&&(t?(s.dataset.originalText=s.innerHTML,s.disabled=!0,s.classList.add("opacity-75","cursor-not-allowed"),s.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Processing...'):(s.disabled=!1,s.classList.remove("opacity-75","cursor-not-allowed"),s.dataset.originalText?(s.innerHTML=s.dataset.originalText,delete s.dataset.originalText):n&&(s.innerHTML=n)))}function U(e){return new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}function re(e){return e?typeof e=="string"?parseFloat(e.replace(/[^0-9.-]/g,""))||0:Number(e)||0:0}function O(e){if(!e)return null;const t=String(e).trim().replace(/[$,\s]/g,"").replace(/[^0-9.-]/g,""),n=parseFloat(t);return isNaN(n)?null:n}window.adminAddChecking=async function(){const e=window.adminSelectedUserId;if(!e){D("Please select a user first.");return}const t=document.getElementById("adminCheckingAddAmount");if(!t)return;const n=O(t.value);if(n===null||n<=0){D("Please enter a valid amount greater than 0 (e.g., $1,200.00).");return}const s="adminAddCheckingBtn";F(s,!0);try{const a=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:r,getDoc:o,updateDoc:d}=a,c=r(b,"users",e),i=await o(c),u=i.exists()?i.data():{},p=re(u.checking)+n,m=U(p);await d(c,{checking:m});const y=(window.adminUsersCache||[]).find(l=>l.id===e);y&&(y.data=y.data||{},y.data.checking=m),H(e),t.value="",L(`Added ${U(n)} to checking account.`)}catch(a){console.error("Error adding to checking:",a),D("Failed to add to checking account. Please try again.")}finally{F(s,!1)}};window.adminSetChecking=async function(){const e=window.adminSelectedUserId;if(!e){D("Please select a user first.");return}const t=document.getElementById("adminCheckingSetAmount");if(!t)return;const n=O(t.value);if(n===null||n<0){D("Please enter a valid amount (0 or greater, e.g., $1,200.00).");return}const s="adminSetCheckingBtn";F(s,!0);try{const a=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:r,updateDoc:o}=a,d=r(b,"users",e),c=U(n);await o(d,{checking:c});const i=(window.adminUsersCache||[]).find(u=>u.id===e);i&&(i.data=i.data||{},i.data.checking=c),H(e),t.value="",L(`Checking account set to ${c}.`)}catch(a){console.error("Error setting checking:",a),D("Failed to set checking account. Please try again.")}finally{F(s,!1)}};window.adminAddFixed=async function(){const e=window.adminSelectedUserId;if(!e){D("Please select a user first.");return}const t=document.getElementById("adminFixedAddAmount");if(!t)return;const n=O(t.value);if(n===null||n<=0){D("Please enter a valid amount greater than 0 (e.g., $1,200.00).");return}const s="adminAddFixedBtn";F(s,!0);try{const a=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:r,getDoc:o,updateDoc:d}=a,c=r(b,"users",e),i=await o(c),u=i.exists()?i.data():{},p=re(u.fixed)+n,m=U(p);await d(c,{fixed:m});const y=(window.adminUsersCache||[]).find(l=>l.id===e);y&&(y.data=y.data||{},y.data.fixed=m),H(e),t.value="",L(`Added ${U(n)} to fixed account.`)}catch(a){console.error("Error adding to fixed:",a),D("Failed to add to fixed account. Please try again.")}finally{F(s,!1)}};window.adminSetFixed=async function(){const e=window.adminSelectedUserId;if(!e){D("Please select a user first.");return}const t=document.getElementById("adminFixedSetAmount");if(!t)return;const n=O(t.value);if(n===null||n<0){D("Please enter a valid amount (0 or greater, e.g., $1,200.00).");return}const s="adminSetFixedBtn";F(s,!0);try{const a=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:r,updateDoc:o}=a,d=r(b,"users",e),c=U(n);await o(d,{fixed:c});const i=(window.adminUsersCache||[]).find(u=>u.id===e);i&&(i.data=i.data||{},i.data.fixed=c),H(e),t.value="",L(`Fixed account set to ${c}.`)}catch(a){console.error("Error setting fixed:",a),D("Failed to set fixed account. Please try again.")}finally{F(s,!1)}};window.adminAddSavings=async function(){const e=window.adminSelectedUserId;if(!e){D("Please select a user first.");return}const t=document.getElementById("adminSavingsAddAmount");if(!t)return;const n=O(t.value);if(n===null||n<=0){D("Please enter a valid amount greater than 0 (e.g., $1,200.00).");return}const s="adminAddSavingsBtn";F(s,!0);try{const a=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:r,getDoc:o,updateDoc:d}=a,c=r(b,"users",e),i=await o(c),u=i.exists()?i.data():{},p=re(u.savings)+n,m=U(p);await d(c,{savings:m});const y=(window.adminUsersCache||[]).find(l=>l.id===e);y&&(y.data=y.data||{},y.data.savings=m),H(e),t.value="",L(`Added ${U(n)} to savings account.`)}catch(a){console.error("Error adding to savings:",a),D("Failed to add to savings account. Please try again.")}finally{F(s,!1)}};window.adminSetSavings=async function(){const e=window.adminSelectedUserId;if(!e){D("Please select a user first.");return}const t=document.getElementById("adminSavingsSetAmount");if(!t)return;const n=O(t.value);if(n===null||n<0){D("Please enter a valid amount (0 or greater, e.g., $1,200.00).");return}const s="adminSetSavingsBtn";F(s,!0);try{const a=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:r,updateDoc:o}=a,d=r(b,"users",e),c=U(n);await o(d,{savings:c});const i=(window.adminUsersCache||[]).find(u=>u.id===e);i&&(i.data=i.data||{},i.data.savings=c),H(e),t.value="",L(`Savings account set to ${c}.`)}catch(a){console.error("Error setting savings:",a),D("Failed to set savings account. Please try again.")}finally{F(s,!1)}};function X(e){const t=document.getElementById("adminHistoryList");if(t){if(!e||e.length===0){t.innerHTML='<p class="text-xs text-gray-500 text-center py-4">No histories to display</p>';return}t.innerHTML="",e.forEach((n,s)=>{const a=document.createElement("div");a.className="flex items-start gap-2 p-2 bg-gray-50 rounded border border-gray-200 hover:bg-gray-100",a.innerHTML=`
                    <input type="checkbox" 
                           class="history-checkbox mt-1 rounded border-gray-300" 
                           data-index="${s}"
                           id="history-check-${s}">
                    <label for="history-check-${s}" class="flex-1 text-xs font-mono text-gray-700 cursor-pointer">
                        ${n}
                    </label>
                `,t.appendChild(a)}),oe()}}function oe(){const e=document.getElementById("adminSelectAllHistory"),t=document.querySelectorAll(".history-checkbox");if(!e||t.length===0)return;const n=Array.from(t).every(a=>a.checked),s=Array.from(t).some(a=>a.checked);e.checked=n,e.indeterminate=s&&!n}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("adminSelectAllHistory");e&&e.addEventListener("change",function(){document.querySelectorAll(".history-checkbox").forEach(n=>n.checked=this.checked)}),document.addEventListener("change",function(t){t.target.classList.contains("history-checkbox")&&oe()})});async function ee(){const e=window.adminSelectedUserId;if(!e){X([]);return}try{const t=(window.adminUsersCache||[]).find(a=>a.id===e);let n=t?t.data||{}:{};if(!t||Object.keys(n).length===0){const a=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:r,getDoc:o}=a,d=r(b,"users",e),c=await o(d);if(!c.exists()){X([]);return}n=c.data()}const s=[];for(let a=1;a<=15;a++){const r=n[`history${a}`];r&&r.trim()!==""&&s.push(r.trim())}X(s)}catch(t){console.error("Error loading histories:",t),D("Failed to load histories.")}}window.adminGenerateHistory=function(){const e=document.getElementById("adminHistoryTemplateInput"),t=document.getElementById("adminHistoryGenStatus"),n="adminGenerateHistoryBtn";if(!e){D("Required elements not found.");return}const s=e.value.trim();if(!s){D("Please enter a history entry template.");return}F(n,!0);try{let g=function(S){const I=S.getDay();return I===0||I===6},p=function(S){const I=new Date(S);for(;g(I);)I.setDate(I.getDate()-1);return I},m=function(S,I){return Math.floor(Math.random()*(I-S+1))+S},y=function(S){const I=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],_=String(S.getDate()).padStart(2,"0"),M=I[S.getMonth()],P=String(S.getFullYear()).slice(-2);return`${_}-${M}-${P}`},l=function(S){let I=S.getHours();const _=String(S.getMinutes()).padStart(2,"0"),M=I>=12?"pm":"am";return I=I%12,I===0&&(I=12),`${I}:${_} ${M}`},f=function(S){return`$${new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(S)}`},x=function(S=15){const I="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let _="";for(let M=0;M<S;M++)_+=I.charAt(m(0,I.length-1));return _},T=function(S,I){let _=new Date(S);for(_.setDate(_.getDate()-I);g(_);)_.setDate(_.getDate()-1);const M=m(9,16),P=m(0,59);return _.setHours(M,P,0,0),_};const a=s.split("|").map(S=>S.trim());if(a.length<7)throw new Error("Invalid format. Expected: Type | Date | Name | CP | Amount | Time | TransactionID |");const r=a[0].trim(),o=a[2].trim(),d=a[3].trim(),c=a[4].trim().replace(/[+$,\s]/g,""),i=a[4].includes("-")?"-":"+",u=parseFloat(c);if(isNaN(u))throw new Error("Invalid amount format.");const h=[],v=m(2019,2025),w=m(0,11),E=m(1,28);let A=new Date(v,w,E);for(;g(A);)A.setDate(A.getDate()-1);let k=0;for(let S=0;S<15;S++){k+=m(30,180);let I=T(A,k);const _=new Date(2019,0,1);if(I<_){const N=m(2019,2025),V=m(0,11),K=m(1,28);for(I=new Date(N,V,K);g(I);)I.setDate(I.getDate()-1);I.setHours(m(9,16),m(0,59),0,0)}const M=x(15),P=`${r} | ${y(I)} | ${o} | ${d} | ${i}${f(u)} | ${l(I)} | ${M} |`;h.push(P)}const $=h.map((S,I)=>{const _=S.split("|")[1].trim(),[M,P,N]=_.split("-"),K=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(P),Y=2e3+parseInt(N),W=new Date(Y,K,parseInt(M));return{line:S,date:W}});$.sort((S,I)=>I.date-S.date),h.length=0,$.forEach(S=>h.push(S.line)),X(h),t&&(t.textContent="✓ Generated 15 history entries successfully!",t.className="text-xs text-green-600"),L('Generated 15 history entries. Review and click "Save History 1–15" to apply.')}catch(a){console.error("Error generating history:",a),t&&(t.textContent=`Error: ${a.message}`,t.className="text-xs text-gray-600"),D(`Failed to generate history: ${a.message}`)}finally{F(n,!1)}};window.adminSaveHistory=async function(){const e=window.adminSelectedUserId;if(!e){D("Please select a user first.");return}const t="adminSaveHistoryBtn";F(t,!0);const n=document.querySelectorAll("#adminHistoryList .history-checkbox"),s=[];n.forEach(r=>{const o=r.nextElementSibling;o&&o.textContent.trim()&&s.push(o.textContent.trim())});const a={};for(let r=1;r<=15;r++){const o=s[r-1]||"";a[`history${r}`]=o}try{const r=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:o,updateDoc:d,getDoc:c}=r,i=o(b,"users",e);await d(i,a);const u=await c(i),g=u.exists()?u.data():{},p=(window.adminUsersCache||[]).find(m=>m.id===e);p&&(p.data=g),await ee(),L("History 1–15 updated successfully.")}catch(r){console.error("Error saving history:",r),D("Failed to save history. Please try again.")}finally{F(t,!1)}};window.adminDeleteHistory=async function(){const e=window.adminSelectedUserId;if(!e){D("Please select a user first.");return}const t=document.querySelectorAll(".history-checkbox:checked");if(t.length===0){D("Please select at least one history entry to delete.");return}const n="adminDeleteHistoryBtn";F(n,!0);const s=document.querySelectorAll("#adminHistoryList .history-checkbox"),a=[];s.forEach(r=>{if(!r.checked){const o=r.nextElementSibling;o&&o.textContent.trim()&&a.push(o.textContent.trim())}}),t.forEach(r=>{const o=r.closest("div");o&&o.remove()}),oe();try{const r=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:o,updateDoc:d,getDoc:c}=r,i=o(b,"users",e),u={};for(let y=1;y<=15;y++)u[`history${y}`]=a[y-1]||"";await d(i,u);const g=await c(i),p=g.exists()?g.data():{},m=(window.adminUsersCache||[]).find(y=>y.id===e);m&&(m.data=p),await ee(),L(`Deleted ${t.length} history entr${t.length===1?"y":"ies"} from Firestore successfully.`)}catch(r){console.error("Error deleting history:",r),D("Failed to delete histories from Firestore. Please try again."),await ee()}finally{F(n,!1)}};window.adminSaveStatus=async function(){const e=window.adminSelectedUserId;if(!e){D("Please select a user first.");return}const t=document.getElementById("adminUserStatusSelect");if(!t)return;const n=(t.value||"").trim();if(!n){D("Please select a valid status.");return}const s="adminSaveStatusBtn";F(s,!0);try{const a=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:r,updateDoc:o}=a,d=r(b,"users",e);await o(d,{status:n});const c=(window.adminUsersCache||[]).find(i=>i.id===e);c&&(c.data=c.data||{},c.data.status=n),H(e),L("User status updated successfully.")}catch(a){console.error("Error updating status:",a),D("Failed to update status. Please try again.")}finally{F(s,!1)}};async function Ze(){try{const e=B.currentUser;if(!e){document.getElementById("kycList").innerHTML='<p class="text-gray-700 text-center py-8">Not authenticated. Please log in.</p>';return}console.log("Loading KYC - Admin user:",{uid:e.uid,email:e.email,emailVerified:e.emailVerified});const t=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:n,query:s,orderBy:a,getDocs:r,onSnapshot:o}=t,d=n(b,"kyc_requests");let c;try{c=s(d,a("submittedAt","desc"))}catch(i){console.warn("OrderBy failed for KYC, trying without order:",i),c=s(d)}o(c,async i=>{const u=[];let g=0;i.forEach(p=>{const m=p.data();u.push({id:p.id,...m}),(m.status==="pending"||m.status==="reviewed")&&g++}),u.length>0&&u[0].submittedAt&&u.sort((p,m)=>{var f,x;const y=(f=p.submittedAt)!=null&&f.toDate?p.submittedAt.toDate().getTime():0;return((x=m.submittedAt)!=null&&x.toDate?m.submittedAt.toDate().getTime():0)-y}),et(u),at(g)},i=>{console.error("KYC listener error:",i);const u=i.message||"Unknown error",g=(e==null?void 0:e.email)||"Not available",p=(e==null?void 0:e.uid)||"Not available",m='<div class="text-gray-700 text-center py-8"><p class="font-semibold mb-2">Failed to load KYC requests</p><p class="text-sm">'+u+'</p><p class="text-xs text-gray-500 mt-4">Admin Email: '+g+'</p><p class="text-xs text-gray-500">Admin UID: '+p+`</p><button onclick="loadKYCRequests()" class="mt-4 px-4 py-2 text-white rounded-lg" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">Retry</button></div>`;document.getElementById("kycList").innerHTML=m})}catch(e){console.error("Error loading KYC requests:",e),document.getElementById("kycList").innerHTML='<p class="text-gray-700 text-center py-8">Error loading KYC requests. Please refresh.</p>'}}function et(e){const t=document.getElementById("kycList");if(e.length===0){t.innerHTML='<p class="text-gray-500 text-center py-8">No KYC requests found.</p>';return}t.innerHTML=e.map(n=>{var o;const s=(o=n.submittedAt)!=null&&o.toDate?n.submittedAt.toDate().toLocaleDateString():"N/A",r=`<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">${n.status||"pending"}</span>`;return`
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900">${n.userEmail||"Unknown User"}</h3>
                                <p class="text-sm text-gray-600">User ID: ${n.userId||"N/A"}</p>
                                <p class="text-xs text-gray-500 mt-1">Submitted: ${s}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${r}
                                <button onclick="deleteKYCRecord('${n.id}', '${n.userId||""}')" class="text-gray-500 hover:text-gray-900 p-1" title="Delete KYC record">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        ${n.idImageBase64?`
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ID Image</label>
                                <div class="border border-gray-300 rounded-lg p-2 bg-gray-50">
                                    <img src="${n.idImageBase64}" alt="ID Image" class="max-w-full h-auto rounded-lg max-h-64 mx-auto cursor-pointer" onclick="openImageModal('${n.idImageBase64}')">
                                </div>
                            </div>
                        `:""}
                        
                        ${n.status==="pending"||n.status==="reviewed"?`
                            <div class="flex gap-2">
                                <button onclick="approveKYC('${n.id}', '${n.userId}')" 
                                    class="flex-1 text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                    <i class="fas fa-check mr-2"></i>Approve
                                </button>
                                <button onclick="rejectKYC('${n.id}', '${n.userId}')" 
                                    class="flex-1 bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-times mr-2"></i>Reject
                                </button>
                                ${n.status==="pending"?`
                                <button onclick="reviewKYC('${n.id}', '${n.userId}')" 
                                    class="flex-1 bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-eye mr-2"></i>Mark as Reviewed
                                </button>
                                `:""}
                            </div>
                        `:""}
                        
                        ${n.reviewedAt?`
                            <p class="text-xs text-gray-500 mt-2">
                                Reviewed: ${n.reviewedAt.toDate?n.reviewedAt.toDate().toLocaleDateString():"N/A"}
                                ${n.reviewedBy?` by ${n.reviewedBy}`:""}
                            </p>
                        `:""}
                    </div>
                `}).join("")}async function tt(e,t){if(confirm("Are you sure you want to approve this KYC verification?"))try{const n=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:s,setDoc:a,updateDoc:r,serverTimestamp:o}=n,d=B.currentUser,c=s(b,"kyc_requests",e);await r(c,{status:"approved",reviewedAt:o(),reviewedBy:d.email});const i=s(b,"users",t);await a(i,{kycStatus:"approved"},{merge:!0}),L("KYC verification approved successfully!")}catch(n){console.error("Error approving KYC:",n),D("Failed to approve KYC. Please try again.")}}async function nt(e,t){if(confirm("Are you sure you want to reject this KYC verification?"))try{const n=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:s,setDoc:a,updateDoc:r,serverTimestamp:o}=n,d=B.currentUser,c=s(b,"kyc_requests",e);await r(c,{status:"rejected",reviewedAt:o(),reviewedBy:d.email});const i=s(b,"users",t);await a(i,{kycStatus:"rejected"},{merge:!0}),L("KYC verification rejected.")}catch(n){console.error("Error rejecting KYC:",n),D("Failed to reject KYC. Please try again.")}}async function st(e,t){if(confirm("Mark this KYC verification as reviewed?"))try{const n=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:s,setDoc:a,updateDoc:r,serverTimestamp:o}=n,d=B.currentUser,c=s(b,"kyc_requests",e);await r(c,{status:"reviewed",reviewedAt:o(),reviewedBy:d.email});const i=s(b,"users",t);await a(i,{kycStatus:"reviewed"},{merge:!0}),L("KYC verification marked as reviewed.")}catch(n){console.error("Error reviewing KYC:",n),D("Failed to mark KYC as reviewed. Please try again.")}}function at(e){const t=document.getElementById("adminKYCBadge");t&&(e>0?(t.textContent=e,t.classList.remove("hidden")):t.classList.add("hidden"))}function ue(e){const t=document.getElementById("adminDebitCardBadge"),n=document.getElementById("debitCardBadge");t&&(e>0?(t.textContent=e,t.classList.remove("hidden")):t.classList.add("hidden")),n&&(n.textContent=`${e} pending`)}function De(e){let t="";for(let n=0;n<e;n++)t+=Math.floor(Math.random()*10);return t}function rt(){const e=De(15).split("").map(Number);let t=0;for(let s=0;s<15;s++){let a=e[s];s%2===0&&(a*=2,a>9&&(a-=9)),t+=a}const n=(10-t%10)%10;return e.join("")+String(n)}function ot(){const e=new Date,t=String(Math.floor(Math.random()*12)+1).padStart(2,"0"),n=String(e.getFullYear()+3);return{expMonth:t,expYear:n}}async function it(){try{const e=B.currentUser,t=document.getElementById("debitCardRequestsList"),n=document.getElementById("issuedDebitCardsList");if(!e){t&&(t.innerHTML='<p class="text-gray-700 text-center py-4 text-sm">Not authenticated. Please log in.</p>'),n&&(n.innerHTML='<p class="text-gray-700 text-center py-4 text-sm">Not authenticated. Please log in.</p>');return}const s=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:a,query:r,where:o,onSnapshot:d,doc:c,getDoc:i,setDoc:u,updateDoc:g,serverTimestamp:p,writeBatch:m,getDocs:y,deleteDoc:l}=s;window.__debitCardFirestore={doc:c,getDoc:i,setDoc:u,updateDoc:g,serverTimestamp:p,writeBatch:m,deleteDoc:l};const f=a(b,"debit_card_applications"),x=r(f,o("status","==","pending"));if(window.debitCardsUnsub){try{window.debitCardsUnsub()}catch{}window.debitCardsUnsub=null}window.approveAndIssueDebitCard=async function(h,v){var w;try{const E=window.__debitCardFirestore;if(!E)throw new Error("Firestore helpers not ready");const{doc:A,getDoc:k,setDoc:$,updateDoc:S,serverTimestamp:I,writeBatch:_}=E,M=await k(A(b,"users",v)),P=M.exists()?M.data():{},N=`${P.firstName||""} ${P.lastName||""}`.trim()||P.name||"Cardholder",V=rt(),K=De(3),{expMonth:Y,expYear:W}=ot(),ce=V.slice(-4),Q=_(b);Q.set(A(b,"debit_cards",v),{userId:v,status:"active",cardholderName:N,last4:ce,expMonth:Y,expYear:W,issuedAt:I(),issuedAtIso:new Date().toISOString()},{merge:!0}),Q.set(A(b,"debit_card_secrets",v),{userId:v,pan:V,cvv:K,expMonth:Y,expYear:W,issuedAt:I(),issuedAtIso:new Date().toISOString()},{merge:!0}),Q.update(A(b,"debit_card_applications",h),{status:"approved",approvedAt:I(),approvedAtIso:new Date().toISOString(),last4:ce,expMonth:Y,expYear:W}),await Q.commit(),L(`Approved and issued virtual debit card for ${N}.`)}catch(E){if(console.error("approveAndIssueDebitCard error",E),((E==null?void 0:E.code)||"")==="permission-denied"||((E==null?void 0:E.message)||"").toLowerCase().includes("insufficient permissions")){const k=((w=B==null?void 0:B.currentUser)==null?void 0:w.email)||"unknown";D(`Missing permissions to issue debit cards. Signed in as: ${k}. Fix: (1) deploy the updated \`firestore.rules\` to the \`twenty-forth-fifth\` project, and (2) ensure this email is listed in \`isAdmin()\`.`)}else D("Failed to approve/issue debit card: "+(E.message||"Please try again."))}},window.rejectDebitCardRequest=async function(h,v){try{const w=window.__debitCardFirestore;if(!w)throw new Error("Firestore helpers not ready");const{doc:E,updateDoc:A,serverTimestamp:k}=w;await A(E(b,"debit_card_applications",h),{status:"rejected",rejectedAt:k(),rejectedAtIso:new Date().toISOString()}),L(`Rejected debit card request for ${v}.`)}catch(w){console.error("rejectDebitCardRequest error",w),D("Failed to reject request: "+(w.message||"Please try again."))}},window.deleteDebitCardRequest=async function(h,v){try{if(!confirm(`Delete debit card request for ${v}?`))return;const w=window.__debitCardFirestore;if(!w)throw new Error("Firestore helpers not ready");const{doc:E,deleteDoc:A}=w;await A(E(b,"debit_card_applications",h)),L(`Deleted debit card request for ${v}.`)}catch(w){console.error("deleteDebitCardRequest error",w),D("Failed to delete request: "+(w.message||"Please try again."))}},window.setDebitCardStatus=async function(h,v){try{const w=window.__debitCardFirestore;if(!w)throw new Error("Firestore helpers not ready");const{doc:E,setDoc:A,serverTimestamp:k}=w;await A(E(b,"debit_cards",h),{status:v,statusUpdatedAt:k(),statusUpdatedAtIso:new Date().toISOString()},{merge:!0}),L(`Card status updated: ${h} → ${v}.`)}catch(w){console.error("setDebitCardStatus error",w),D("Failed to update card status: "+(w.message||"Please try again."))}},window.deleteDebitCard=async function(h){try{if(!confirm(`Delete debit card for ${h}? This removes card + secrets + request.`))return;const v=window.__debitCardFirestore;if(!v)throw new Error("Firestore helpers not ready");const{doc:w,writeBatch:E}=v,A=E(b);A.delete(w(b,"debit_cards",h)),A.delete(w(b,"debit_card_secrets",h)),A.delete(w(b,"debit_card_applications",h)),await A.commit(),L(`Deleted debit card (and request) for ${h}.`)}catch(v){console.error("deleteDebitCard error",v),D("Failed to delete card: "+(v.message||"Please try again."))}},window.debitCardsUnsub=d(x,async T=>{const h=[];T.forEach(v=>h.push({id:v.id,...v.data()})),ue(h.length),t&&(h.length===0?t.innerHTML='<p class="text-gray-500 text-center py-4 text-sm">No pending debit card requests.</p>':t.innerHTML=h.map(v=>{var A;const w=(A=v.createdAt)!=null&&A.toDate?v.createdAt.toDate().toLocaleString():v.createdAtIso||"—",E=v.userId||v.id;return`
                              <div class="border border-gray-200 rounded-xl p-4 bg-white">
                                <div class="flex items-start justify-between gap-3">
                                  <div>
                                    <div class="text-sm font-semibold text-gray-900">User: <span class="font-mono text-xs">${E}</span></div>
                                    <div class="text-xs text-gray-600 mt-1">Requested: ${w}</div>
                                    <div class="text-xs text-gray-600 mt-1">Type: ${v.cardType||"—"} • Linked: ${v.linkedAccount||"—"}</div>
                                  </div>
                                  <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                                    <button type="button"
                                        class="px-3 py-2 rounded-lg text-white text-xs font-semibold transition" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'"
                                        onclick="approveAndIssueDebitCard('${v.id}', '${E}')">
                                      Approve &amp; Issue
                                    </button>
                                    <button type="button"
                                        class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 text-xs font-semibold transition"
                                        onclick="rejectDebitCardRequest('${v.id}', '${E}')">
                                      Reject
                                    </button>
                                    <button type="button"
                                        class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-red-700 border border-red-200 text-xs font-semibold transition"
                                        onclick="deleteDebitCardRequest('${v.id}', '${E}')">
                                      Delete
                                    </button>
                                  </div>
                                </div>
                              </div>
                            `}).join(""))},T=>{console.error("Debit card requests listener error",T),t&&(t.innerHTML=`<p class="text-gray-700 text-center py-4 text-sm">Failed to load requests: ${T.message}</p>`)});try{const T=a(b,"debit_cards"),h=await y(T),v=[];h.forEach(w=>v.push({id:w.id,...w.data()})),n&&(v.length?n.innerHTML=v.slice(0,50).map(w=>{var $;const E=($=w.issuedAt)!=null&&$.toDate?w.issuedAt.toDate().toLocaleString():w.issuedAtIso||"—",A=(w.status||"active").toLowerCase(),k=A==="active"?'<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-200">Active</span>':A==="hold"?'<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-amber-50 text-amber-700 border border-amber-200">On hold</span>':'<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">Suspended</span>';return`
                                  <div class="border border-gray-200 rounded-xl p-4 bg-white">
                                    <div class="flex items-start justify-between gap-3">
                                      <div>
                                        <div class="text-sm font-semibold text-gray-900">${w.cardholderName||"Cardholder"}</div>
                                        <div class="text-xs text-gray-600 mt-1">User: <span class="font-mono">${w.userId||w.id}</span></div>
                                        <div class="text-xs text-gray-600 mt-1">•••• ${w.last4||"—"} • Exp ${w.expMonth||"--"}/${String(w.expYear||"").slice(-2)||"--"}</div>
                                        <div class="text-xs text-gray-500 mt-1">Issued: ${E}</div>
                                      </div>
                                      <div class="flex flex-col items-end gap-2">
                                        ${k}
                                        <div class="flex flex-wrap gap-2 justify-end">
                                          <button type="button"
                                            class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 text-xs font-semibold transition"
                                            onclick="setDebitCardStatus('${w.userId||w.id}', 'active')">
                                            Activate
                                          </button>
                                          <button type="button"
                                            class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-amber-700 border border-amber-200 text-xs font-semibold transition"
                                            onclick="setDebitCardStatus('${w.userId||w.id}', 'hold')">
                                            Hold
                                          </button>
                                          <button type="button"
                                            class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 text-xs font-semibold transition"
                                            onclick="setDebitCardStatus('${w.userId||w.id}', 'suspended')">
                                            Suspend
                                          </button>
                                          <button type="button"
                                            class="px-3 py-2 rounded-lg bg-white hover:bg-gray-50 text-red-700 border border-red-200 text-xs font-semibold transition"
                                            onclick="deleteDebitCard('${w.userId||w.id}')">
                                            Delete
                                          </button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                `}).join(""):n.innerHTML='<p class="text-gray-500 text-center py-4 text-sm">No issued cards yet.</p>')}catch(T){console.warn("Issued cards list failed",T),n&&(n.innerHTML='<p class="text-gray-700 text-center py-4 text-sm">Failed to load issued cards.</p>')}window.debitCardsLoaded=!0}catch(e){console.error("Error loading debit cards:",e);const t=document.getElementById("debitCardRequestsList");t&&(t.innerHTML='<p class="text-gray-700 text-center py-4 text-sm">Error loading debit cards.</p>'),ue(0),window.debitCardsLoaded=!0}}async function ie(){try{const e=B.currentUser;if(!e){document.getElementById("loansList").innerHTML='<p class="text-gray-700 text-center py-8">Not authenticated. Please log in.</p>';return}const t=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:n,query:s,orderBy:a,getDocs:r,onSnapshot:o}=t,d=n(b,"loan_requests");let c;try{c=s(d,a("createdAt","desc"))}catch(i){console.warn("OrderBy failed for loans, trying without order:",i),c=s(d)}o(c,async i=>{const u=[];let g=0;i.forEach(p=>{const m=p.data();u.push({id:p.id,...m}),m.status==="pending"&&g++}),u.length>0&&u[0].createdAt&&u.sort((p,m)=>{var f,x;const y=(f=p.createdAt)!=null&&f.toDate?p.createdAt.toDate().getTime():0;return((x=m.createdAt)!=null&&x.toDate?m.createdAt.toDate().getTime():0)-y}),ct(u),dt(g)},i=>{console.error("Loan listener error:",i);const u=`
                        <div class="text-gray-700 text-center py-8">
                            <p class="font-semibold mb-2">Failed to load loan requests</p>
                            <p class="text-sm">${i.message}</p>
                            <p class="text-xs text-gray-500 mt-4">Admin Email: ${(e==null?void 0:e.email)||"Not available"}</p>
                            <button onclick="loadLoanRequests()" class="mt-4 px-4 py-2 text-white rounded-lg" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                Retry
                            </button>
                        </div>
                    `;document.getElementById("loansList").innerHTML=u})}catch(e){console.error("Error loading loan requests:",e),document.getElementById("loansList").innerHTML='<p class="text-gray-700 text-center py-8">Error loading loan requests. Please refresh.</p>'}}function ct(e){const t=document.getElementById("loansList");if(e.length===0){t.innerHTML='<p class="text-gray-500 text-center py-8">No loan requests found.</p>';return}t.innerHTML=e.map(n=>{var d;const s=(d=n.createdAt)!=null&&d.toDate?n.createdAt.toDate().toLocaleDateString():"N/A",r=`<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">${n.status||"pending"}</span>`,o=n.repaymentWindow==="yearly"?"Yearly":n.repaymentWindow==="12"?"12 Months (Monthly)":n.repaymentWindow==="6"?"6 Months":n.repaymentWindow==="3"?"3 Months":n.repaymentWindow||"N/A";return`
                    <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="text-lg font-semibold text-gray-900">${n.firstName||""} ${n.lastName||""}</h3>
                                    ${r}
                                </div>
                                <p class="text-sm text-gray-600">Email: ${n.email||"N/A"}</p>
                                <p class="text-sm text-gray-600">Phone: ${n.phone||"N/A"}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-gray-900">$${(n.loanAmount||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</p>
                                <p class="text-sm text-gray-600">Submitted: ${s}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm">
                            <div>
                                <p class="text-gray-600"><span class="font-semibold">Credit Score:</span> ${n.creditScore||"N/A"}</p>
                                <p class="text-gray-600"><span class="font-semibold">Purpose:</span> ${n.loanPurpose||"N/A"}</p>
                            </div>
                            <div>
                                <p class="text-gray-600"><span class="font-semibold">Repayment Window:</span> ${o}</p>
                                <p class="text-gray-600"><span class="font-semibold">Employment:</span> ${n.employmentStatus||"N/A"}</p>
                            </div>
                        </div>
                        
                        ${n.description?`<p class="text-sm text-gray-700 mb-4 bg-gray-50 p-3 rounded"><span class="font-semibold">Additional Info:</span> ${n.description}</p>`:""}
                        
                        ${n.status==="pending"?`
                            <div class="flex gap-2 mt-4">
                                <button onclick="window.approveLoan('${n.id}', '${n.userId}')" 
                                    class="flex-1 text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                    <i class="fas fa-check mr-2"></i>Approve
                                </button>
                                <button onclick="window.rejectLoan('${n.id}', '${n.userId}')" 
                                    class="flex-1 bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-times mr-2"></i>Reject
                                </button>
                            </div>
                        `:n.status==="approved"?`
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <button onclick="window.viewLoanPayments('${n.userId}')" 
                                    class="w-full text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                    <i class="fas fa-calendar-check mr-2"></i>Manage Payments
                                </button>
                            </div>
                        `:""}
                    </div>
                `}).join("")}window.approveLoan=async function(e,t){var n;if(console.log("Approve loan called with:",{requestId:e,userId:t}),!!confirm("Are you sure you want to approve this loan application?"))try{const s=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:a,updateDoc:r,setDoc:o,getDoc:d,serverTimestamp:c}=s,i=B.currentUser;if(!i){D("You must be logged in to approve loans.");return}console.log("Admin user:",i.email);const u=a(b,"loan_requests",e),g=await d(u);if(!g.exists()){D("Loan request not found.");return}const p=g.data();console.log("Loan data:",p),await r(u,{status:"approved",approvedAt:c(),approvedBy:i.email});const m=a(b,"users",t),y=await d(m),l=y.exists()?y.data():{},f=p.loanAmount||0,x=p.upfrontFee||f*.1,T=f-x,w=(parseFloat(((n=l.checking)==null?void 0:n.replace(/[$,]/g,""))||l.checking||0)+T).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});await o(m,{checking:w},{merge:!0});const E=a(b,"loans",t);await o(E,{...p,status:"approved",approvedAt:c(),approvedBy:i.email,paidAmount:0,fundedAmount:T,collateralFee:x,fundedAt:c()},{merge:!0}),L(`Loan application approved successfully! $${T.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})} has been funded to the user's account.`),ie()}catch(s){console.error("Error approving loan:",s),D("Failed to approve loan: "+(s.message||"Please try again."))}};window.rejectLoan=async function(e,t){if(confirm("Are you sure you want to reject this loan application?"))try{const n=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:s,updateDoc:a,setDoc:r,serverTimestamp:o}=n,d=B.currentUser,c=s(b,"loan_requests",e);await a(c,{status:"rejected",rejectedAt:o(),rejectedBy:d.email});const i=s(b,"loans",t);await r(i,{status:"rejected",rejectedAt:o(),rejectedBy:d.email},{merge:!0}),L("Loan application rejected."),ie()}catch(n){console.error("Error rejecting loan:",n),D("Failed to reject loan: "+(n.message||"Please try again."))}};window.viewLoanPayments=async function(e){var t,n,s;try{const a=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:r,getDoc:o}=a,d=r(b,"loans",e),c=await o(d);if(!c.exists()){D("Loan not found.");return}const i=c.data(),u=i.loanAmount||0,g=i.repaymentWindow||"12",p=i.paidAmount||0,m=i.paymentHistory||[];let y=0,l=0;g==="yearly"?(y=12,l=u/12):(y=parseInt(g)||12,l=u/y);let f="";const x=new Date;for(let h=1;h<=y;h++){const v=new Date(x);v.setMonth(v.getMonth()+h);const w=h-1,E=((t=m[w])==null?void 0:t.status)||"pending",A=((n=m[w])==null?void 0:n.paidDate)||null,k=((s=m[w])==null?void 0:s.defaultedDate)||null,$=E==="paid",S=E==="defaulted",I=!$&&!S&&v<x;f+=`
                        <div class="flex items-center justify-between p-4 rounded-lg border bg-white border-gray-200">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="${$?"background-color: #15803d;":S?"background-color: #140099;":I?"background-color: #0d0066;":"background-color: #d1d5db;"}">
                                    <i class="fas ${$?"fa-check":S?"fa-times":I?"fa-exclamation":"fa-clock"} text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-900">Payment ${h} of ${y}</p>
                                    <p class="text-sm text-gray-600">Due: ${v.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}</p>
                                    ${A?`<p class="text-xs text-gray-600 mt-1">Paid: ${A.toDate?A.toDate().toLocaleDateString():A}</p>`:""}
                                    ${k?`<p class="text-xs text-gray-600 mt-1">Defaulted: ${k.toDate?k.toDate().toLocaleDateString():k}</p>`:""}
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right mr-4">
                                    <p class="font-semibold text-gray-900">$${l.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</p>
                                    <p class="text-xs text-gray-600">${$?"Paid":S?"Defaulted":I?"Overdue":"Pending"}</p>
                                </div>
                                ${!$&&!S?`
                                    <button onclick="window.markPaymentPaid('${e}', ${h}, ${l})" 
                                        class="text-white font-semibold py-2 px-4 rounded-lg transition-colors text-sm" style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                        <i class="fas fa-check mr-1"></i>Paid
                                    </button>
                                    <button onclick="window.markPaymentDefaulted('${e}', ${h}, ${l})" 
                                        class="bg-white hover:bg-gray-50 text-gray-900 border border-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">
                                        <i class="fas fa-times mr-1"></i>Defaulted
                                    </button>
                                `:""}
                            </div>
                        </div>
                    `}const T=document.createElement("div");T.className="fixed inset-0 flex items-center justify-center z-50 p-4",T.style.backgroundColor="rgba(24, 0, 172, 0.5)",T.innerHTML=`
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900">Payment Management</h3>
                                <p class="text-sm text-gray-600 mt-1">${i.firstName||""} ${i.lastName||""} - Loan Amount: $${u.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</p>
                                <p class="text-sm text-gray-600">Paid: $${p.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})} / Remaining: $${(u-p).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                                &times;
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3" id="paymentScheduleContainer">
                                ${f}
                            </div>
                        </div>
                    </div>
                `,document.body.appendChild(T),T.addEventListener("click",h=>{h.target===T&&T.remove()})}catch(a){console.error("Error loading loan payments:",a),D("Failed to load payment schedule: "+(a.message||"Please try again."))}};window.markPaymentPaid=async function(e,t,n){if(confirm(`Mark Payment ${t} as Paid?`))try{const s=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:a,getDoc:r,updateDoc:o,serverTimestamp:d,Timestamp:c}=s,i=B.currentUser,u=a(b,"loans",e),g=await r(u);if(!g.exists()){D("Loan not found.");return}const p=g.data(),m=p.paidAmount||0,y=p.paymentHistory||[],l=c.now();y[t-1]={paymentNumber:t,amount:n,status:"paid",paidDate:l,markedBy:i.email};const f=y.filter(T=>T&&T.status==="paid").reduce((T,h)=>T+(h.amount||0),0);await o(u,{paidAmount:f,paymentHistory:y,lastPaymentDate:d()}),L(`Payment ${t} marked as paid successfully!`);const x=document.querySelector('.fixed.inset-0[style*="background-color"]');x&&x.remove(),setTimeout(()=>{window.viewLoanPayments(e)},300)}catch(s){console.error("Error marking payment as paid:",s),D("Failed to mark payment as paid: "+(s.message||"Please try again."))}};window.markPaymentDefaulted=async function(e,t,n){if(confirm(`Mark Payment ${t} as Defaulted? This will be recorded in the loan history.`))try{const s=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:a,getDoc:r,updateDoc:o,serverTimestamp:d,Timestamp:c}=s,i=B.currentUser,u=a(b,"loans",e),g=await r(u);if(!g.exists()){D("Loan not found.");return}const m=g.data().paymentHistory||[],y=c.now();m[t-1]={paymentNumber:t,amount:n,status:"defaulted",defaultedDate:y,markedBy:i.email},await o(u,{paymentHistory:m,hasDefault:!0,lastDefaultDate:d()}),L(`Payment ${t} marked as defaulted.`);const l=document.querySelector('.fixed.inset-0[style*="background-color"]');l&&l.remove(),setTimeout(()=>{window.viewLoanPayments(e)},300)}catch(s){console.error("Error marking payment as defaulted:",s),D("Failed to mark payment as defaulted: "+(s.message||"Please try again."))}};function dt(e){const t=document.getElementById("adminLoanBadge");t&&(e>0?(t.textContent=e,t.classList.remove("hidden")):t.classList.add("hidden"))}window.openImageModal=function(e){const t=document.createElement("div");t.className="fixed inset-0 flex items-center justify-center z-50 p-4",t.style.backgroundColor="rgba(24, 0, 172, 0.75)",t.innerHTML=`
                <div class="relative max-w-4xl max-h-full">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-2 right-2 text-white rounded-full p-2" style="background-color: rgba(24, 0, 172, 0.5);" onmouseover="this.style.backgroundColor='rgba(24, 0, 172, 0.75)'" onmouseout="this.style.backgroundColor='rgba(24, 0, 172, 0.5)'">
                        <i class="fas fa-times"></i>
                    </button>
                    <img src="${e}" alt="ID Image" class="max-w-full max-h-screen rounded-lg">
                </div>
            `,document.body.appendChild(t),t.addEventListener("click",n=>{n.target===t&&t.remove()})};var me;(me=document.getElementById("openSidebar"))==null||me.addEventListener("click",()=>{document.querySelector(".sidebar").classList.add("open")});var ge;(ge=document.getElementById("closeSidebar"))==null||ge.addEventListener("click",()=>{document.querySelector(".sidebar").classList.remove("open")});window.showSection=Je;async function se(){try{const e=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:t,getDocs:n}=e,s=t(b,"users"),a=await n(s),r=[];a.forEach(o=>{var i;const d=o.data(),c=o.id;for(let u=1;u<=5;u++){const g=`pending${u}`,p=d[g];if(p&&p.trim()!==""){const m=p.split("|").map(f=>f.trim()),y=m.length>=7?m[5]:(m.length===6,null),l=m.length>=7?6:5;r.push({userId:c,userName:d.name||d.firstName||d.email||"Unknown",userEmail:d.email||"N/A",pendingField:g,transferString:p,bankName:((i=m[0])==null?void 0:i.replace(" - Twenty Forth & Fifth","").trim())||"",transferType:m[1]||"",amount:m[2]||"",time:m[3]||"",date:m[4]||"",fundingSource:y||"Unknown",status:m[l]||"Pending"})}}}),lt(r),pt(r.length)}catch(e){console.error("Error loading pending transfers:",e),document.getElementById("pendingTransfersList").innerHTML='<p class="text-red-500 text-center py-4 text-sm">Error loading transfers: '+e.message+"</p>"}}function lt(e){const t=document.getElementById("pendingTransfersList");if(e.length===0){t.innerHTML='<p class="text-gray-500 text-center py-4 text-sm">No pending transfers found.</p>';return}t.innerHTML=e.map((n,s)=>`
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-semibold text-gray-900">${n.userName}</h4>
                                <span class="text-xs text-gray-500">(${n.userEmail})</span>
                            </div>
                            <p class="text-sm text-gray-600"><span class="font-medium">Bank:</span> ${n.bankName}</p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Amount:</span> ${n.amount}</p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Type:</span> ${n.transferType}</p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Funding:</span> ${n.fundingSource!=="Unknown"?n.fundingSource:"Not specified (will ask on approval)"}</p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Date:</span> ${n.date} ${n.time}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editPendingTransfer('${n.userId}', '${n.pendingField}', ${s})" 
                                    class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-semibold rounded-lg transition">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button onclick="approveTransfer('${n.userId}', '${n.pendingField}', ${s})" 
                                    class="px-3 py-1.5 text-white text-xs font-semibold rounded-lg transition" 
                                    style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                <i class="fas fa-check mr-1"></i>Approve
                            </button>
                        </div>
                    </div>
                </div>
            `).join("")}window.approveTransfer=async function(e,t,n){if(confirm("Approve this transfer? It will be moved to the user's history and the amount will be deducted from their account."))try{const s=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:a,getDoc:r,updateDoc:o}=s,d=a(b,"users",e),c=await r(d);if(!c.exists()){D("User not found.");return}const i=c.data(),u=i[t];if(!u||u.trim()===""){D("Transfer not found.");return}const g=u.split("|").map(E=>E.trim()),p=g[2]||"",m=g.length>=7?g[5]:null,y=g.length>=7?6:5;if((parseFloat(p.replace(/[^0-9.-]/g,""))||0)<=0){D("Invalid transfer amount.");return}let f=null;m&&(m.toLowerCase().includes("checking")||m.toLowerCase().includes("savings"))?f=m.toLowerCase().includes("checking")?"checking":"savings":f="checking";const x=u.replace("| Pending","| Completed").replace("|Pending","|Completed"),T=[];for(let E=1;E<=15;E++){const A=`history${E}`,k=i[A];k&&k.trim()!==""&&T.push({field:A,value:k})}const h=T.length>=15,v={[t]:""};if(h){for(let E=14;E>=1;E--){const A=`history${E}`,k=`history${E+1}`,$=i[A];$&&$.trim()!==""?v[k]=$:v[k]=""}v.history1=x}else{let E=null;for(let A=1;A<=15;A++){const k=`history${A}`;if(!i[k]||i[k].trim()===""){E=k;break}}E?v[E]=x:v.history1=x}await o(d,v),L(`Transfer approved! Amount was already deducted from ${f==="checking"?"Checking":"Savings"} account when transfer was created. Transfer moved to history.`),se()}catch(s){console.error("Error approving transfer:",s),D("Failed to approve transfer: "+s.message)}};window.editPendingTransfer=function(e,t,n){document.getElementById("pendingTransfersList").children[n]&&Ae(e,t,"pending")};window.editHistoryEntry=function(e,t,n){Ae(e,t,"history")};function Ae(e,t,n){const s=document.createElement("div");s.className="fixed inset-0 flex items-center justify-center z-50 p-4",s.style.backgroundColor="rgba(0, 0, 0, 0.5)",s.id="editTransferModal",s.innerHTML=`
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Edit ${n==="pending"?"Pending Transfer":"History Entry"}</h3>
                            <button onclick="document.getElementById('editTransferModal').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Transfer String</label>
                                <textarea id="editTransferString" 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 text-sm font-mono"
                                          rows="5"></textarea>
                                <p class="text-xs text-gray-500 mt-1">
                                    <strong>Format:</strong> Bank Name - Twenty Forth & Fifth | Transfer-Type | $Amount | Time | Date | Funding Source | Status<br>
                                    <strong>Example:</strong> Chase Bank - Twenty Forth & Fifth | Transfer-Intl | $1,000.00 | 10:30 AM | 12/25/2024 | Checking | Completed
                                </p>
                            </div>
                            <div class="flex gap-2 justify-end">
                                <button onclick="document.getElementById('editTransferModal').remove()" 
                                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition">
                                    Cancel
                                </button>
                                <button onclick="saveTransferEdit('${e}', '${t}', '${n}')" 
                                        class="px-4 py-2 text-white rounded-lg transition" 
                                        style="background-color: #15803d;" onmouseover="this.style.backgroundColor='#140099'" onmouseout="this.style.backgroundColor='#15803d'">
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `,document.body.appendChild(s),ut(e,t).then(a=>{document.getElementById("editTransferString").value=a||""})}async function ut(e,t){try{const n=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:s,getDoc:a}=n,r=s(b,"users",e),o=await a(r);return o.exists()&&o.data()[t]||""}catch(n){return console.error("Error loading transfer value:",n),""}}window.saveTransferEdit=async function(e,t,n){const s=document.getElementById("editTransferString").value.trim();if(!s){D("Transfer string cannot be empty.");return}try{const a=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:r,updateDoc:o}=a,d=r(b,"users",e);await o(d,{[t]:s}),document.getElementById("editTransferModal").remove(),L(`${n==="pending"?"Pending transfer":"History entry"} updated successfully.`),n==="pending"?se():ke(e)}catch(a){console.error("Error saving transfer edit:",a),D("Failed to save changes: "+a.message)}};async function mt(){try{const e=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{collection:t,getDocs:n}=e,s=t(b,"users"),a=await n(s),r=document.getElementById("transferHistoryUserSelect");r.innerHTML='<option value="">Select user...</option>',a.forEach(o=>{const d=o.data(),c=d.name||d.firstName||d.email||"Unknown",i=document.createElement("option");i.value=o.id,i.textContent=`${c} (${d.email||"N/A"})`,r.appendChild(i)}),r.addEventListener("change",function(){this.value?ke(this.value):document.getElementById("transferHistoryList").innerHTML='<p class="text-xs text-gray-500 text-center py-4">Select a user to view/edit their history entries</p>'})}catch(e){console.error("Error loading users for history:",e)}}async function ke(e){try{const t=await C(()=>import("https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"),[]),{doc:n,getDoc:s}=t,a=n(b,"users",e),r=await s(a);if(!r.exists()){document.getElementById("transferHistoryList").innerHTML='<p class="text-xs text-red-500 text-center py-4">User not found</p>';return}const o=r.data(),d=[];for(let c=1;c<=20;c++){const i=`history${c}`,u=o[i];u&&u.trim()!==""&&d.push({field:i,value:u,index:c})}gt(d,e)}catch(t){console.error("Error loading transfer history:",t),document.getElementById("transferHistoryList").innerHTML='<p class="text-xs text-red-500 text-center py-4">Error loading history: '+t.message+"</p>"}}function gt(e,t){const n=document.getElementById("transferHistoryList");if(e.length===0){n.innerHTML='<p class="text-xs text-gray-500 text-center py-4">No history entries found for this user.</p>';return}n.innerHTML=e.map((s,a)=>{var m;const r=s.value.split("|").map(y=>y.trim()),o=((m=r[0])==null?void 0:m.replace(" - Twenty Forth & Fifth","").trim())||"",d=r[1]||"",c=r[2]||"",i=r[3]||"",u=r[4]||"",g=r.length>=7?r[5]:"",p=r.length>=7?r[6]:r[5]||"";return`
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-white">
                    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800 border border-gray-200">
                                    History ${s.index}
                                </span>
                                ${p?`<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${p.toLowerCase().includes("completed")?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}">${p}</span>`:""}
                            </div>
                            <div class="space-y-1 text-sm">
                                ${o?`<p class="text-gray-700"><span class="font-medium">Bank:</span> ${o}</p>`:""}
                                ${c?`<p class="text-gray-700"><span class="font-medium">Amount:</span> ${c}</p>`:""}
                                ${d?`<p class="text-gray-600"><span class="font-medium">Type:</span> ${d}</p>`:""}
                                ${u&&i?`<p class="text-gray-600"><span class="font-medium">Date:</span> ${u} ${i}</p>`:""}
                                ${g?`<p class="text-gray-600"><span class="font-medium">Funding:</span> ${g}</p>`:""}
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-200">
                                <p class="text-xs font-mono text-gray-500 break-all">${s.value}</p>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="editHistoryEntry('${t}', '${s.field}', ${a})" 
                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition flex items-center gap-2 whitespace-nowrap">
                                <i class="fas fa-edit"></i>
                                <span>Edit Entry</span>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join("")}function pt(e){const t=document.getElementById("adminTransferBadge"),n=document.getElementById("transferBadge");t&&(e>0?(t.textContent=e,t.classList.remove("hidden")):t.classList.add("hidden")),n&&(n.textContent=`${e} pending`)}window.selectChat=Ee;window.sendAdminReply=Ye;window.closeChatView=Te;window.deleteChat=Ge;window.approveKYC=tt;window.rejectKYC=nt;window.reviewKYC=st;window.loadPendingTransfers=se;
