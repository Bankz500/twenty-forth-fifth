import"./modulepreload-polyfill-B5Qt9EMX.js";import{a as C,b as y,e as b,d as v,o as D,l as k,s as B,h as P}from"./firebase-client-BQD81AQz.js";import"./firebase-config-D2Ob3NcO.js";const t=e=>document.getElementById(e);let L=null,o=null,p=null;function u(e,a){const n=t("status");n&&(n.className="text-sm mt-3",e==="error"?n.classList.add("text-red-600"):e==="success"?n.classList.add("text-green-700"):n.classList.add("text-gray-600"),n.textContent=a||"")}function S(e){const a=t("submitBtn"),n=t("submitBtnText"),r=t("submitBtnSpinner");!a||!n||!r||(a.disabled=e,r.classList.toggle("hidden",!e),n.textContent=e?"Submitting...":"Submit for approval")}function d(e){e==null||e.classList.remove("hidden")}function c(e){e==null||e.classList.add("hidden")}function g(e){c(t("requestPanel")),c(t("pendingPanel")),c(t("approvedPanel")),d(t(e==="pending"?"pendingPanel":e==="approved"?"approvedPanel":"requestPanel"))}async function I(e){var a;try{const n=await y(b(v,"users",e.uid));L=n.exists()?n.data():{};const r=n.exists()?n.data():{},i=[r.firstName,r.lastName].filter(Boolean).join(" ").trim();(a=t("who"))==null||a.classList.remove("hidden"),t("whoName")&&(t("whoName").textContent=i||"Signed in"),t("whoEmail")&&(t("whoEmail").textContent=e.email||"")}catch(n){console.warn("Debit card: could not load user profile",n)}}function A(e){return`•••• •••• •••• ${(e||"").toString().slice(-4)||"••••"}`}function N(e,a){const n=String(e||"").padStart(2,"0"),r=String(a||"").slice(-2);return`${n}/${r}`}function Y(){const e=L||{},a=[e.firstName,e.lastName].filter(Boolean).join(" ").trim()||"Cardholder",n=(o==null?void 0:o.last4)||"",r=(o==null?void 0:o.expMonth)||"",i=(o==null?void 0:o.expYear)||"";t("cardHolderName")&&(t("cardHolderName").textContent=a.toUpperCase()),t("cardNumberMasked")&&(t("cardNumberMasked").textContent=A(n)),t("cardExp")&&(t("cardExp").textContent=N(r,i))}async function M(e){try{const n=await y(b(v,"debit_cards",e.uid));o=n.exists()?n.data():null}catch(n){console.warn("Debit card: could not load issued card",n),o=null}try{const n=await y(b(v,"debit_card_applications",e.uid));p=n.exists()?n.data():null}catch(n){console.warn("Debit card: could not load application",n),p=null}if(o){g("approved"),Y();const n=(o.status||"active").toLowerCase(),r=t("cardStatusBadge"),i=t("viewDetailsBtn"),l=t("cardStatusNote");r&&(r.className="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full border",n==="active"?(r.classList.add("bg-green-50","text-green-700","border-green-200"),r.textContent="Active"):n==="hold"?(r.classList.add("bg-amber-50","text-amber-700","border-amber-200"),r.textContent="On hold"):(r.classList.add("bg-gray-100","text-gray-700","border-gray-200"),r.textContent="Suspended"));const s=n==="active";i&&(i.disabled=!s,i.classList.toggle("opacity-50",!s),i.classList.toggle("cursor-not-allowed",!s)),l&&(s?c(l):(l.textContent=n==="hold"?"Your debit card is currently on hold. Contact support if you need help.":"Your debit card is suspended. Contact support to resolve this.",d(l)));return}if(((p==null?void 0:p.status)||"").toLowerCase()==="pending"){g("pending");return}g("request")}function T(){var m,h,E,x,w,f;const e=((m=t("cardType"))==null?void 0:m.value)||"",a=((h=t("linkedAccount"))==null?void 0:h.value)||"",n=(((E=t("deliveryAddress"))==null?void 0:E.value)||"").trim(),r=(((x=t("phoneNumber"))==null?void 0:x.value)||"").trim(),i=(w=t("authorize"))==null?void 0:w.checked,l=(f=t("confirm"))==null?void 0:f.checked,s=[];return e||s.push("Select a card type."),a||s.push("Select a linked account."),n||s.push("Enter a delivery address."),r||s.push("Enter a phone number."),(!i||!l)&&s.push("Authorization and confirmation are required."),s}async function U(){var n;u("","");const e=C.currentUser;if(!e){u("error","You must be signed in.");return}if(await M(e),o){u("error","You already have an active debit card."),g("approved");return}if(((p==null?void 0:p.status)||"").toLowerCase()==="pending"){u("error","Your request is already pending approval."),g("pending");return}const a=T();if(a.length){u("error",a[0]);return}S(!0);try{await B(b(v,"debit_card_applications",e.uid),{userId:e.uid,cardType:t("cardType").value,linkedAccount:t("linkedAccount").value,deliveryAddress:t("deliveryAddress").value.trim(),phoneNumber:t("phoneNumber").value.trim(),status:"pending",createdAt:P(),createdAtIso:new Date().toISOString()}),(n=t("form"))==null||n.reset(),c(t("successModal")),d(t("successModal")),g("pending")}catch(r){console.error("Debit card submit error",r),u("error","We couldn’t submit your request. Please try again.")}finally{S(!1)}}window.addEventListener("DOMContentLoaded",()=>{var e,a,n,r,i,l;(e=t("submitBtn"))==null||e.addEventListener("click",U),(a=t("closeSuccessModalBtn"))==null||a.addEventListener("click",()=>c(t("successModal"))),(n=t("viewDetailsBtn"))==null||n.addEventListener("click",()=>{u("",""),t("pinInput").value="",c(t("pinError")),d(t("pinModal"))}),(r=t("closePinModalBtn"))==null||r.addEventListener("click",()=>c(t("pinModal"))),(i=t("pinConfirmBtn"))==null||i.addEventListener("click",async()=>{try{c(t("pinError"));const s=(t("pinInput").value||"").trim();if(!/^\d{5}$/.test(s)){t("pinError").textContent="Enter your 5-digit PIN.",d(t("pinError"));return}const m=C.currentUser;if(!m)throw new Error("Not signed in");const h=await y(b(v,"users",m.uid)),x=((h.exists()?h.data():{}).pin||"").toString().trim();if(!x||x!==s){t("pinError").textContent="Incorrect PIN.",d(t("pinError"));return}const w=await y(b(v,"debit_card_secrets",m.uid));if(!w.exists()){t("pinError").textContent="Card details not available yet.",d(t("pinError"));return}const f=w.data();t("detailPan").textContent=f.pan||"—",t("detailCvv").textContent=f.cvv||"—",t("detailExp").textContent=N(f.expMonth,f.expYear),c(t("pinModal")),d(t("detailsModal"))}catch(s){console.error("View details error",s),t("pinError").textContent="Unable to verify PIN. Please try again.",d(t("pinError"))}}),(l=t("closeDetailsModalBtn"))==null||l.addEventListener("click",()=>c(t("detailsModal")))});D(C,async e=>{if(!e){window.location.href="login.html";return}await I(e),await M(e)});window.signOut=function(){k(C).then(()=>window.location.href="login.html").catch(e=>{console.error("Sign out error",e),u("error","Unable to sign out. Please try again.")})};
