import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css             */import{initializeApp as k}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";import{getAuth as U,signInWithEmailAndPassword as _,signOut as D}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";import{getFirestore as H,doc as E,getDoc as L,serverTimestamp as I,setDoc as R}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";import{f as q}from"./firebase-config-LdbrzKVt.js";import{a as P,s as z}from"./compliance-modals-BQvUBI0-.js";const O=k(q),C=U(O),x=H(O);emailjs.init("PpoJ-7X-bqUjp3Wa7");const A=document.getElementById("login-section"),b=document.getElementById("otp-section"),V=document.getElementById("login-form"),W=document.getElementById("otp-form"),l=document.getElementById("login-btn"),f=document.getElementById("resend-otp"),$=document.getElementById("email-display"),n=document.getElementById("login-status"),d=document.getElementById("login-error");let m=null;(async function(){try{const e=new URL(window.location.href);e.searchParams.get("pending")==="1"&&(e.searchParams.delete("pending"),window.history.replaceState({},document.title,e.toString()),await P())}catch{}})();function B(t=6){return Array.from({length:t},()=>Math.floor(Math.random()*10)).join("")}function u(t,e,a="operation"){let i;const s=new Promise((c,r)=>{i=setTimeout(()=>r(new Error(`${a} timed out after ${e}ms`)),e)});return Promise.race([t,s]).finally(()=>clearTimeout(i))}async function T(t,e){try{const a=emailjs.send("service_dou8hz3","template_nncgc6k",{to_email:t,email:t,otp:e});return await u(a,12e3,"OTP send"),!0}catch(a){return console.error("Error sending OTP:",a),!1}}V.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("email").value.trim(),a=document.getElementById("password").value;try{n&&(n.classList.add("hidden"),n.textContent=""),d&&(d.classList.add("hidden"),d.textContent=""),l.disabled=!0,l.textContent="Authenticating...",n&&(n.textContent="Signing in…",n.classList.remove("hidden")),m=(await u(_(C,e,a),15e3,"Sign in")).user,n&&(n.textContent="Checking approval status…");const s=E(x,"users",m.uid),c=await u(L(s),12e3,"Load user profile");let r=c.exists()?c.data()||{}:null;if(!r){let p=null;try{const g=(m.email||e||"").trim();if(g){const j=E(x,"users",g),S=await L(j);S.exists()&&(p=S.data()||{})}}catch(g){console.warn("Legacy email-doc migration skipped/failed:",g)}const o=p&&typeof p=="object"?p:{},w=m.displayName||"",M=o.firstName||(typeof o.name=="string"?o.name.split(" ")[0]:"")||(typeof o.fullName=="string"?o.fullName.split(" ")[0]:"")||(w?w.split(" ")[0]:"")||(m.email||e||"").split("@")[0]||"",v={...o,email:o.email||m.email||e,firstName:o.firstName||M||null,approvalStatus:o.approvalStatus||"approved",isApproved:typeof o.isApproved=="boolean"?o.isApproved:!0,approvedAt:o.approvedAt||I(),approvedBy:o.approvedBy||(p?"legacy_migrated":"legacy_auto"),createdAt:o.createdAt||I(),createdAtIso:o.createdAtIso||new Date().toISOString(),migratedFrom:p?"users/{email}":null};n&&(n.textContent="Finalizing profile…"),await u(R(s,v,{merge:!0}),12e3,"Create legacy profile"),r=v}const y=(r==null?void 0:r.approvalStatus)||null,N=typeof(r==null?void 0:r.isApproved)=="boolean"?r.isApproved:null,F=y==="approved"||y==null&&N!==!1;if(!r||!F){try{await D(C)}catch{}l.disabled=!1,l.textContent="Log in",n&&(n.classList.add("hidden"),n.textContent=""),await P();return}n&&(n.textContent="Sending verification code…");const h=B();if(sessionStorage.setItem("loginOtp",h),!await T(e,h))throw new Error("Failed to send OTP");n&&(n.classList.add("hidden"),n.textContent=""),$.textContent=e,A&&A.classList.add("hidden"),b&&b.classList.remove("hidden")}catch(i){console.error("Login error:",i);let s="An error occurred during login.";i.code==="auth/user-not-found"||i.code==="auth/wrong-password"?s="Invalid email or password.":i.code==="auth/too-many-requests"?s="Too many failed attempts. Please try again later.":String((i==null?void 0:i.message)||"").includes("timed out")&&(s="Network timeout while signing in. Please check your connection and try again."),n&&(n.classList.add("hidden"),n.textContent=""),d?(d.textContent=s,d.classList.remove("hidden")):alert(s)}finally{l.disabled=!1,l.textContent="Log in"}});window.addEventListener("unhandledrejection",t=>{var e;try{if(console.error("Unhandled promise rejection:",t==null?void 0:t.reason),l&&(l.disabled=!1,l.textContent="Log in"),d){const a=((e=t==null?void 0:t.reason)==null?void 0:e.message)||String((t==null?void 0:t.reason)||"Unexpected error");d.textContent=a,d.classList.remove("hidden")}}catch{}});W.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("verify-otp-btn"),a=document.getElementById("otp").value,i=sessionStorage.getItem("loginOtp"),s=(e==null?void 0:e.innerHTML)||"";e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Verifying...');try{if(!i)throw new Error("OTP session expired");if(a===i){sessionStorage.removeItem("loginOtp");const c=sessionStorage.getItem("redirectAfterLogin");if(c){sessionStorage.removeItem("redirectAfterLogin"),window.location.href=c;return}z({onContinue:()=>{window.location.href="dashboard.html"}});return}else throw new Error("Invalid OTP")}catch(c){alert(c.message+". Please try again.")}finally{if(e){e.disabled=!1,e.innerHTML=s||'<i class="fas fa-check mr-2"></i>Verify & Continue';try{e.dispatchEvent(new Event("site:button-reset"))}catch{}}}});f.addEventListener("click",async t=>{if(t.preventDefault(),!m){alert("Session expired. Please login again."),window.location.reload();return}f.textContent="Sending...";const e=B();await T(m.email,e)?(sessionStorage.setItem("loginOtp",e),alert("New OTP has been sent to your email.")):alert("Failed to send new OTP. Please try again."),f.textContent="Request again"});sessionStorage.removeItem("loginOtp");
