import"./modulepreload-polyfill-B5Qt9EMX.js";import{initializeApp as v}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";import{getAuth as I}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";import{f as C}from"./firebase-config-D2Ob3NcO.js";import{a as S}from"./compliance-modals-gNe9-PES.js";const b=v(C),O=I(b),u=document.getElementById("email-display"),a=document.getElementById("otp-status"),l=document.getElementById("otp-error"),d=document.getElementById("otp"),r=document.getElementById("verify-otp-btn"),i=document.getElementById("resend-otp");function c(e){a&&(a.textContent=e,a.classList.remove("hidden"))}function m(){a&&(a.textContent="",a.classList.add("hidden"))}function s(e){l&&(l.textContent=e,l.classList.remove("hidden"))}function g(){l&&(l.textContent="",l.classList.add("hidden"))}function p(e=6){return Array.from({length:e},()=>Math.floor(Math.random()*10)).join("")}function x(e,t,n="operation"){let o;const w=new Promise((B,P)=>{o=setTimeout(()=>P(new Error(`${n} timed out after ${t}ms`)),t)});return Promise.race([e,w]).finally(()=>clearTimeout(o))}function y(){var n;const e=(sessionStorage.getItem("loginEmail")||"").trim(),t=(((n=O.currentUser)==null?void 0:n.email)||"").trim();return e||t||""}function h(){return(sessionStorage.getItem("loginOtp")||"").trim()}async function E(e,t){if(!e)throw new Error("Missing email. Please log in again.");if(!t)throw new Error("Missing OTP. Please log in again.");if(typeof emailjs>"u")throw new Error("Email service not loaded. Please disable ad blockers and try again.");emailjs.init("PpoJ-7X-bqUjp3Wa7");const n=emailjs.send("service_dou8hz3","template_nncgc6k",{to_email:e,email:e,otp:t});return await x(n,12e3,"OTP send"),!0}async function T(){g();const e=y();u&&(u.textContent=e||"(unknown)");let t=h();t||(t=p(),sessionStorage.setItem("loginOtp",t)),c("Sending verification code…"),await E(e,t),c("Code sent. Please check your inbox (and spam)."),setTimeout(()=>m(),6e3)}var f;(f=document.getElementById("otp-form"))==null||f.addEventListener("submit",async e=>{e.preventDefault(),g(),m();const t=((d==null?void 0:d.value)||"").trim(),n=h();if(!t||t.length!==6||!/^[0-9]{6}$/.test(t)){s("Please enter a valid 6-digit code.");return}if(!n){s("Your session expired. Please log in again.");return}r&&(r.disabled=!0,r.textContent="Verifying…");try{if(t!==n){s("Invalid OTP. Please try again.");return}sessionStorage.removeItem("loginOtp"),sessionStorage.removeItem("loginEmail");try{S({onContinue:()=>{window.location.href="dashboard.html"}})}catch(o){console.error(o),s((o==null?void 0:o.message)||"Could not open the AML notice. Please refresh and try again.")}return}finally{r&&(r.disabled=!1,r.textContent="Proceed")}});i==null||i.addEventListener("click",async()=>{try{i.disabled=!0,i.textContent="Sending…";const e=y(),t=p();sessionStorage.setItem("loginOtp",t),sessionStorage.setItem("loginEmail",e),await E(e,t),c("New code sent."),setTimeout(()=>m(),6e3)}catch(e){console.error(e),s((e==null?void 0:e.message)||"Failed to resend code. Please try again.")}finally{i.disabled=!1,i.textContent="Resend code"}});(async()=>{try{await T()}catch(e){console.error(e),s((e==null?void 0:e.message)||"Failed to send OTP. Please try again.")}})();
