import"./modulepreload-polyfill-B5Qt9EMX.js";import{o as $,a as b,k as A,b as E,d as h,m as C,g as M,e as v,s as T,h as U,f as N}from"./firebase-client-Drf6QgQf.js";import"./firebase-config-D2Ob3NcO.js";let r=null;$(b,async t=>{t?await B(t):(r&&(r(),r=null),console.log("No user signed in, redirecting to sign-in page."),window.location.href="login.html")});window.signOut=function(){r&&(r(),r=null),A(b).then(()=>{alert("Signed out successfully!"),window.location.href="login.html"}).catch(t=>{alert("Error signing out: "+t.message)})};async function B(t){try{const e=E(h,"loans",t.uid);r&&r(),r=C(e,n=>{if(n.exists()){const o=n.data(),a=o.status||"pending",i=String(a).toLowerCase().trim();if(console.log("Loan status changed:",{rawStatus:a,normalizedStatus:i,loanData:o}),i==="approved")console.log("Loan approved - showing repayment progress"),showRepaymentProgress(o);else if(i==="rejected")console.log("Loan rejected - showing rejection message"),k();else if(i==="pending"){console.log("Loan pending - keeping application flow");const s=document.querySelector(".step-section:not(.hidden)");(!s||s.id==="repaymentProgressSection")&&goToStep(1)}else console.log("Unknown loan status:",i,"raw:",a)}else{console.log("Loan document does not exist");const o=document.getElementById("repaymentProgressSection");o&&!o.classList.contains("hidden")&&goToStep(1)}},n=>{n.code==="permission-denied"?console.warn("Permission denied for loan document. This may be normal if the document does not exist yet."):console.error("Error listening to loan data:",n)})}catch(e){console.error("Error loading loan data:",e)}}window.loadLoanData=B;function k(){document.getElementById("loanPlansSection").classList.add("hidden"),document.getElementById("creditScoreSection").classList.add("hidden"),document.getElementById("loanApplicationForm").classList.add("hidden"),document.getElementById("repaymentProgressSection").classList.add("hidden");const t=document.getElementById("creditScoreSection");t.classList.remove("hidden"),t.innerHTML=`
                <div class="text-center">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-times-circle text-red-600 text-3xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Loan Application Rejected</h2>
                    <p class="text-gray-600 mb-6">We're sorry, but your loan application has been rejected. Please contact support for more information or try applying again later.</p>
                    <button onclick="window.location.href='dashboard.html'" class="bg-gray-900 hover:bg-gray-800 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200">
                        Return to Dashboard
                    </button>
                </div>
            `}let f=null,d=null,D=null;window.goToStep=function(t){if(t===2&&(!d||d===null)){alert("Please select a loan plan first.");return}if(document.querySelectorAll(".step-section").forEach(e=>{e.classList.add("hidden")}),t===1)document.getElementById("loanPlansSection").classList.remove("hidden");else if(t===2){if(document.getElementById("creditScoreSection").classList.remove("hidden"),d){const e=document.getElementById("selectedPlanInfo"),n=document.getElementById("selectedPlanAmount");e&&n&&(e.classList.remove("hidden"),n.textContent=`$${d.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`)}}else t===3&&document.getElementById("loanApplicationForm").classList.remove("hidden");w(t),window.scrollTo({top:0,behavior:"smooth"})};function w(t){for(let e=1;e<=3;e++){const n=document.getElementById(`step${e}Indicator`);e<=t?(n.classList.remove("bg-gray-300","text-gray-600"),n.classList.add("bg-gray-900","text-white")):(n.classList.remove("bg-gray-900","text-white"),n.classList.add("bg-gray-300","text-gray-600"))}}document.addEventListener("DOMContentLoaded",function(){const t=document.querySelectorAll(".loan-plan"),e=document.getElementById("nextToStep2Btn");t.forEach(n=>{n.addEventListener("click",function(){t.forEach(m=>{m.classList.remove("border-gray-900","bg-gray-50"),m.classList.add("border-gray-200")}),this.classList.remove("border-gray-200"),this.classList.add("border-gray-900","bg-gray-50"),d=parseFloat(this.dataset.amount),D=d*.1;const o=document.getElementById("loanAmount");o&&(o.value=d);const a=document.getElementById("upfrontFeeDisplay");a&&(a.innerHTML=`Collateral Fee (10%): $${D.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})} <span class="text-gray-400 italic">(Soft security collateral)</span>`),e&&(e.classList.remove("hidden"),e.disabled=!1);const i=document.getElementById("selectedPlanInfo"),s=document.getElementById("selectedPlanAmount");i&&s&&(i.classList.remove("hidden"),s.textContent=`$${d.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`)})}),w(1)});window.checkCreditScore=function(){if(!d||d===null){alert("Please select a loan plan first before checking your eligibility."),goToStep(1);return}const t=document.getElementById("creditScore"),e=parseInt(t.value),n=document.getElementById("checkEligibilityBtn"),o=document.getElementById("creditScoreForm"),a=document.getElementById("creditScoreLoading");if(!e||e<300||e>850){alert("Please enter a valid credit score between 300 and 850");return}o.classList.add("hidden"),a.classList.add("active"),n.disabled=!0,n.classList.add("btn-loading"),setTimeout(()=>{f=e,a.classList.remove("active"),o.classList.remove("hidden"),n.disabled=!1,n.classList.remove("btn-loading"),e<500?(document.getElementById("enteredCreditScore").textContent=e,document.getElementById("notEligibleModal").classList.remove("hidden")):(goToStep(3),j())},2500)};async function j(){try{const t=b.currentUser;if(!t)return;const e=E(h,"users",t.uid),n=await M(e);if(n.exists()){const o=n.data();o.firstName&&(document.getElementById("loanFirstName").value=o.firstName),o.lastName&&(document.getElementById("loanLastName").value=o.lastName),o.email&&(document.getElementById("loanEmail").value=o.email),o.phone&&(document.getElementById("loanPhone").value=o.phone)}}catch(t){console.error("Error loading user data:",t)}}window.closeNotEligibleModal=function(){document.getElementById("notEligibleModal").classList.add("hidden"),document.getElementById("creditScore").value=""};window.closeSuccessModal=function(){document.getElementById("successModal").classList.add("hidden"),window.location.href="dashboard.html"};document.getElementById("loanForm").addEventListener("submit",async t=>{t.preventDefault();const e=b.currentUser;if(!e){alert("You must be logged in to submit a loan application");return}if(!f||f<500){alert("Credit score must be 500 or higher");return}const n=t.target.querySelector('button[type="submit"]'),o=n.textContent;n.disabled=!0,n.classList.add("btn-loading"),n.textContent="Processing...";try{const a=parseFloat(document.getElementById("loanAmount").value),i=a*.1,s={userId:e.uid,firstName:document.getElementById("loanFirstName").value.trim(),lastName:document.getElementById("loanLastName").value.trim(),email:document.getElementById("loanEmail").value.trim(),phone:document.getElementById("loanPhone").value.trim(),loanAmount:a,upfrontFee:i,loanPurpose:document.getElementById("loanPurpose").value,repaymentWindow:document.getElementById("repaymentWindow").value,employmentStatus:document.getElementById("employmentStatus").value,description:document.getElementById("loanDescription").value.trim(),creditScore:f,status:"pending",createdAt:v(),submittedAt:v()};await T(E(h,"loans",e.uid),s),await U(N(h,"loan_requests"),{...s,userEmail:e.email||s.email}),document.getElementById("successModal").classList.remove("hidden")}catch(a){console.error("Error submitting loan application:",a),alert("Failed to submit loan application. Please try again."),n.disabled=!1,n.classList.remove("btn-loading"),n.textContent=o}});window.showRepaymentProgress=function(t){document.getElementById("loanPlansSection").classList.add("hidden"),document.getElementById("creditScoreSection").classList.add("hidden"),document.getElementById("loanApplicationForm").classList.add("hidden"),document.getElementById("repaymentProgressSection").classList.remove("hidden");const e=t.loanAmount||0,n=t.repaymentWindow,o=t.paidAmount||0,a=e-o,i=o/e*100;document.getElementById("repaymentLoanAmount").textContent=`$${e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`,document.getElementById("repaymentPeriod").textContent=R(n),document.getElementById("totalRemaining").textContent=`$${a.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`;let s=0;if(n==="yearly")s=e/12;else{const c=parseInt(n)||12;s=e/c}document.getElementById("monthlyPayment").textContent=`$${s.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`,document.getElementById("progressBar").style.width=`${i}%`,document.getElementById("progressPercentage").textContent=`${i.toFixed(1)}%`;const m=t.paymentHistory||[];H(e,n,o,m)};function R(t){switch(t){case"3":return"3 Months";case"6":return"6 Months";case"12":return"12 Months (Monthly)";case"yearly":return"Yearly";default:return t}}function H(t,e,n,o=[]){const a=document.getElementById("paymentSchedule");a.innerHTML="";let i=0,s=0;e==="yearly"?(i=12,s=t/12):(i=parseInt(e)||12,s=t/i);const m=new Date;for(let c=1;c<=i;c++){const u=new Date(m);u.setMonth(u.getMonth()+c);const P=c-1,l=o[P],I=(l==null?void 0:l.status)||"pending",g=I==="paid",y=I==="defaulted",p=!g&&!y&&u<m;let S="",L="";l&&(l.paidDate&&(S=(l.paidDate.toDate?l.paidDate.toDate():new Date(l.paidDate)).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})),l.defaultedDate&&(L=(l.defaultedDate.toDate?l.defaultedDate.toDate():new Date(l.defaultedDate)).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})));const x=document.createElement("div");x.className=`flex items-center justify-between p-4 rounded-lg border ${g?"bg-blue-50 border-blue-200":y?"bg-red-50 border-red-200":p?"bg-orange-50 border-orange-200":"bg-white border-gray-200"}`,x.innerHTML=`
                <div class="flex items-center gap-3 flex-1">
                    <div class="w-10 h-10 rounded-full ${g?"bg-blue-500":y?"bg-red-500":p?"bg-orange-500":"bg-gray-300"} flex items-center justify-center">
                        <i class="fas ${g?"fa-check":y?"fa-times":p?"fa-exclamation":"fa-clock"} text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">Payment ${c} of ${i}</p>
                        <p class="text-sm text-gray-600">Due: ${u.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}</p>
                        ${S?`<p class="text-xs text-blue-600 mt-1">Paid: ${S}</p>`:""}
                        ${L?`<p class="text-xs text-red-600 mt-1">Defaulted: ${L}</p>`:""}
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-gray-900">$${s.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</p>
                    <p class="text-xs ${g?"text-blue-600":y?"text-red-600":p?"text-orange-600":"text-gray-500"}">
                        ${g?"Paid":y?"Defaulted":p?"Overdue":"Pending"}
                    </p>
                </div>
            `,a.appendChild(x)}}
