import"./modulepreload-polyfill-B5Qt9EMX.js";import{a as m,d as p,E as L,r as v,e as g,u as I,o as B,l as b,b as P,t as N}from"./firebase-client-BQD81AQz.js";import"./firebase-config-D2Ob3NcO.js";window.auth=m;window.db=p;const y=document.getElementById("profileInfoCard");y&&y.classList.remove("hidden");async function x(e){const n=document.getElementById("email"),a=document.getElementById("firstName"),o=document.getElementById("accountType"),t=document.getElementById("phone-number-text"),d=document.getElementById("phone-number-action"),c=document.getElementById("profileImage");n&&(n.value=e.email||"",n.placeholder=e.email||"Email"),c&&(c.src=e.photoURL||"https://via.placeholder.com/150"),a&&(a.value=e.displayName||"",a.placeholder=e.displayName||"Full Name");try{const r=P(g(p,"users",e.uid)),h=new Promise((s,i)=>setTimeout(()=>i(new Error("Firestore query timeout")),5e3)),u=await Promise.race([r,h]);if(u.exists()){const s=u.data();if(a){const i=s.firstName&&s.lastName?`${s.firstName} ${s.lastName}`:s.firstName||e.displayName||"No name set";a.value=i,a.placeholder=i}if(o){const i=s.accountType||s.account_type||"Standard";o.value=i,o.placeholder=i}if(t){const i=s.phoneNumber||s.phone||"";i&&i.trim()!==""?(t.textContent=i,t.classList.remove("text-gray-500","italic"),t.classList.add("text-gray-700"),d&&d.classList.add("hidden")):(t.textContent="No phone number attached",t.classList.add("text-gray-500","italic"),t.classList.remove("text-gray-700"),d&&d.classList.remove("hidden"))}s.photoURL&&c&&(c.src=s.photoURL)}else o&&(o.value="Standard",o.placeholder="Standard"),t&&(t.textContent="No phone number attached",t.classList.add("text-gray-500","italic"),d&&d.classList.remove("hidden"))}catch(r){console.warn("Firestore query failed or timed out, using auth data:",r),o&&(o.value="Standard",o.placeholder="Standard"),t&&(t.textContent="No phone number attached",t.classList.add("text-gray-500","italic"),d&&d.classList.remove("hidden"))}finally{}}window.openAttachPhoneModal=function(e){e&&(e.preventDefault(),e.stopPropagation());const n=document.getElementById("attachPhoneModal");return n&&(n.classList.remove("hidden"),document.getElementById("new-phone-number").value="",document.getElementById("verify-password").value="",document.getElementById("phone-input-step").classList.remove("hidden"),document.getElementById("password-verification-step").classList.add("hidden"),document.getElementById("phone-modal-error").classList.add("hidden")),!1};window.closeAttachPhoneModal=function(){const e=document.getElementById("attachPhoneModal");e&&e.classList.add("hidden")};window.closePhoneSuccessModal=function(){const e=document.getElementById("phoneSuccessModal");e&&e.classList.add("hidden")};window.proceedToPasswordStep=function(){if(!document.getElementById("new-phone-number").value.trim()){l("Please enter a phone number");return}document.getElementById("phone-input-step").classList.add("hidden"),document.getElementById("password-verification-step").classList.remove("hidden"),document.getElementById("phone-modal-error").classList.add("hidden")};window.backToPhoneStep=function(){document.getElementById("phone-input-step").classList.remove("hidden"),document.getElementById("password-verification-step").classList.add("hidden"),document.getElementById("phone-modal-error").classList.add("hidden")};function l(e){const n=document.getElementById("phone-modal-error"),a=document.getElementById("phone-modal-error-text");n&&a&&(a.textContent=e,n.classList.remove("hidden"))}window.attachPhoneNumber=async function(){const e=document.getElementById("new-phone-number").value.trim(),n=document.getElementById("verify-password").value,a=document.getElementById("attach-phone-btn-text"),o=document.getElementById("attach-phone-spinner");if(!e){l("Please enter a phone number");return}if(!n){l("Please enter your password");return}try{a.classList.add("hidden"),o.classList.remove("hidden"),document.getElementById("phone-modal-error").classList.add("hidden");const t=m.currentUser;if(!t){l("User not authenticated");return}const d=L.credential(t.email,n);await v(t,d);const c=g(p,"users",t.uid);await I(c,{phoneNumber:e,phone:e,phoneUpdatedAt:new Date().toISOString()}),console.log("âœ… Phone number saved to Firestore:",e);const r=document.getElementById("phone-number-text"),h=document.getElementById("phone-number-action");r&&(r.textContent=e,r.classList.remove("text-gray-500","italic"),r.classList.add("text-gray-700")),h&&h.classList.add("hidden"),closeAttachPhoneModal();const u=document.getElementById("success-phone-number");u&&(u.textContent=e);const s=document.getElementById("phoneSuccessModal");s&&s.classList.remove("hidden")}catch(t){console.error("Error attaching phone number:",t),t.code==="auth/wrong-password"?l("Incorrect password. Please try again."):t.code==="auth/invalid-email"?l("Invalid email address."):l("Failed to attach phone number. Please try again.")}finally{a.classList.remove("hidden"),o.classList.add("hidden")}};let f=!1,w=!1;B(m,async e=>{e?(w=!0,f=!0,await x(e)):(f||(await new Promise(n=>setTimeout(n,500)),f=!0),w||m.currentUser||(window.location.href="login.html"))});function E(){const e=document.getElementById("imageUpload");e&&e.addEventListener("change",async function(n){const a=n.target.files[0];if(!a)return;const o=new FormData;o.append("file",a),o.append("upload_preset","ASHB_profile");try{const d=await(await fetch("https://api.cloudinary.com/v1_1/dmgcagkqa/image/upload",{method:"POST",body:o})).json();if(d.secure_url){const c=document.getElementById("profileImage");c&&(c.src=d.secure_url);const r=m.currentUser;r&&(await Promise.all([I(g(p,"users",r.uid),{photoURL:d.secure_url}),N(r,{photoURL:d.secure_url})]),alert("Profile image updated successfully!"))}}catch(t){console.error("Error uploading image:",t),alert("Failed to upload image. Please try again.")}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",E):E();window.signOut=function(){b(m).then(()=>{window.location.href="login.html"}).catch(e=>{console.error("Sign out error:",e),window.location.href="login.html"})};
