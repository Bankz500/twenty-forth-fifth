import"./modulepreload-polyfill-B5Qt9EMX.js";import{b as m,a as p,E as L,t as v,d as g,u as I,o as B,s as b,g as P,v as N}from"./firebase-client-C4wrmMWL.js";import"./firebase-config-BJbrxyFw.js";window.auth=m;window.db=p;const y=document.getElementById("profileInfoCard");y&&y.classList.remove("hidden");async function x(e){const n=document.getElementById("email"),a=document.getElementById("firstName"),o=document.getElementById("accountType"),t=document.getElementById("phone-number-text"),s=document.getElementById("phone-number-action"),c=document.getElementById("profileImage");n&&(n.value=e.email||"",n.placeholder=e.email||"Email"),c&&(c.src=e.photoURL||"https://via.placeholder.com/150"),a&&(a.value=e.displayName||"",a.placeholder=e.displayName||"Full Name");try{const i=P(g(p,"users",e.uid)),h=new Promise((d,r)=>setTimeout(()=>r(new Error("Firestore query timeout")),5e3)),u=await Promise.race([i,h]);if(u.exists()){const d=u.data();if(a){const r=d.firstName&&d.lastName?`${d.firstName} ${d.lastName}`:d.firstName||e.displayName||"No name set";a.value=r,a.placeholder=r}if(o){const r=d.accountType||d.account_type||"Standard";o.value=r,o.placeholder=r}if(t){const r=d.phoneNumber||d.phone||"";r&&r.trim()!==""?(t.textContent=r,t.classList.remove("text-gray-500","italic"),t.classList.add("text-gray-700"),s&&s.classList.add("hidden")):(t.textContent="No phone number attached",t.classList.add("text-gray-500","italic"),t.classList.remove("text-gray-700"),s&&s.classList.remove("hidden"))}d.photoURL&&c&&(c.src=d.photoURL)}else o&&(o.value="Standard",o.placeholder="Standard"),t&&(t.textContent="No phone number attached",t.classList.add("text-gray-500","italic"),s&&s.classList.remove("hidden"))}catch(i){console.warn("Firestore query failed or timed out, using auth data:",i),o&&(o.value="Standard",o.placeholder="Standard"),t&&(t.textContent="No phone number attached",t.classList.add("text-gray-500","italic"),s&&s.classList.remove("hidden"))}finally{}}window.openAttachPhoneModal=function(e){e&&(e.preventDefault(),e.stopPropagation());const n=document.getElementById("attachPhoneModal");return n&&(n.classList.remove("hidden"),document.getElementById("new-phone-number").value="",document.getElementById("verify-password").value="",document.getElementById("phone-input-step").classList.remove("hidden"),document.getElementById("password-verification-step").classList.add("hidden"),document.getElementById("phone-modal-error").classList.add("hidden")),!1};window.closeAttachPhoneModal=function(){const e=document.getElementById("attachPhoneModal");e&&e.classList.add("hidden")};window.closePhoneSuccessModal=function(){const e=document.getElementById("phoneSuccessModal");e&&e.classList.add("hidden")};window.proceedToPasswordStep=function(){if(!document.getElementById("new-phone-number").value.trim()){l("Please enter a phone number");return}document.getElementById("phone-input-step").classList.add("hidden"),document.getElementById("password-verification-step").classList.remove("hidden"),document.getElementById("phone-modal-error").classList.add("hidden")};window.backToPhoneStep=function(){document.getElementById("phone-input-step").classList.remove("hidden"),document.getElementById("password-verification-step").classList.add("hidden"),document.getElementById("phone-modal-error").classList.add("hidden")};function l(e){const n=document.getElementById("phone-modal-error"),a=document.getElementById("phone-modal-error-text");n&&a&&(a.textContent=e,n.classList.remove("hidden"))}window.attachPhoneNumber=async function(){const e=document.getElementById("new-phone-number").value.trim(),n=document.getElementById("verify-password").value,a=document.getElementById("attach-phone-btn-text"),o=document.getElementById("attach-phone-spinner");if(!e){l("Please enter a phone number");return}if(!n){l("Please enter your password");return}try{a.classList.add("hidden"),o.classList.remove("hidden"),document.getElementById("phone-modal-error").classList.add("hidden");const t=m.currentUser;if(!t){l("User not authenticated");return}const s=L.credential(t.email,n);await v(t,s);const c=g(p,"users",t.uid);await I(c,{phoneNumber:e,phone:e,phoneUpdatedAt:new Date().toISOString()}),console.log("âœ… Phone number saved to Firestore:",e);const i=document.getElementById("phone-number-text"),h=document.getElementById("phone-number-action");i&&(i.textContent=e,i.classList.remove("text-gray-500","italic"),i.classList.add("text-gray-700")),h&&h.classList.add("hidden"),closeAttachPhoneModal();const u=document.getElementById("success-phone-number");u&&(u.textContent=e);const d=document.getElementById("phoneSuccessModal");d&&d.classList.remove("hidden")}catch(t){console.error("Error attaching phone number:",t),t.code==="auth/wrong-password"?l("Incorrect password. Please try again."):t.code==="auth/invalid-email"?l("Invalid email address."):l("Failed to attach phone number. Please try again.")}finally{a.classList.remove("hidden"),o.classList.add("hidden")}};let f=!1,w=!1;B(m,async e=>{e?(w=!0,f=!0,await x(e)):(f||(await new Promise(n=>setTimeout(n,500)),f=!0),w||m.currentUser||(window.location.href="login.html"))});function E(){const e=document.getElementById("imageUpload");e&&e.addEventListener("change",async function(n){const a=n.target.files[0];if(!a)return;const o=new FormData;o.append("file",a),o.append("upload_preset","ASHB_profile");try{const s=await(await fetch("https://api.cloudinary.com/v1_1/dmgcagkqa/image/upload",{method:"POST",body:o})).json();if(s.secure_url){const c=document.getElementById("profileImage");c&&(c.src=s.secure_url);const i=m.currentUser;i&&(await Promise.all([I(g(p,"users",i.uid),{photoURL:s.secure_url}),N(i,{photoURL:s.secure_url})]),alert("Profile image updated successfully!"))}}catch(t){console.error("Error uploading image:",t),alert("Failed to upload image. Please try again.")}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",E):E();window.signOut=function(){b(m).then(()=>{window.location.href="login.html"}).catch(e=>{console.error("Sign out error:",e),window.location.href="login.html"})};
