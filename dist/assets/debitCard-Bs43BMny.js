import"./modulepreload-polyfill-B5Qt9EMX.js";import{a as M,b as E,e as f,d as m,o as A,l as Y,s as $,h as U}from"./firebase-client-B2F1CqW_.js";import"./firebase-config-C56FTJjz.js";const n=t=>document.getElementById(t);let _=null,l=null,L=null;function C(t,s){const e=n("status");e&&(e.className="text-sm mt-3",t==="error"?e.classList.add("text-red-600"):t==="success"?e.classList.add("text-green-700"):e.classList.add("text-gray-600"),e.textContent=s||"")}function P(t){const s=n("submitBtn"),e=n("submitBtnText"),a=n("submitBtnSpinner");!s||!e||!a||(s.disabled=t,a.classList.toggle("hidden",!t),e.textContent=t?"Submitting...":"Submit for approval")}function x(t){t==null||t.classList.remove("hidden")}function h(t){t==null||t.classList.add("hidden")}function D(t){h(n("requestPanel")),h(n("pendingPanel")),h(n("approvedPanel")),x(n(t==="pending"?"pendingPanel":t==="approved"?"approvedPanel":"requestPanel"))}async function H(t){var s;try{const e=await E(f(m,"users",t.uid));_=e.exists()?e.data():{};const a=e.exists()?e.data():{},i=[a.firstName,a.lastName].filter(Boolean).join(" ").trim();(s=n("who"))==null||s.classList.remove("hidden"),n("whoName")&&(n("whoName").textContent=i||"Signed in"),n("whoEmail")&&(n("whoEmail").textContent=t.email||"")}catch(e){console.warn("Debit card: could not load user profile",e)}}function V(t){return`•••• •••• •••• ${(t||"").toString().slice(-4)||"••••"}`}function T(t,s){const e=String(t||"").padStart(2,"0"),a=String(s||"").slice(-2);return`${e}/${a}`}function W(){const t=_||{},s=[t.firstName,t.lastName].filter(Boolean).join(" ").trim()||"Cardholder",e=(l==null?void 0:l.last4)||"",a=(l==null?void 0:l.expMonth)||"",i=(l==null?void 0:l.expYear)||"";n("cardHolderName")&&(n("cardHolderName").textContent=s.toUpperCase()),n("cardNumberMasked")&&(n("cardNumberMasked").textContent=V(e)),n("cardExp")&&(n("cardExp").textContent=T(a,i))}async function q(t){try{const e=await E(f(m,"debit_cards",t.uid));l=e.exists()?e.data():null}catch(e){console.warn("Debit card: could not load issued card",e),l=null}try{const e=await E(f(m,"debit_card_applications",t.uid));L=e.exists()?e.data():null}catch(e){console.warn("Debit card: could not load application",e),L=null}if(l){D("approved"),W();const e=(l.status||"active").toLowerCase(),a=n("cardStatusBadge"),i=n("viewDetailsBtn"),d=n("cardStatusNote");a&&(a.className="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full border",e==="active"?(a.classList.add("bg-green-50","text-green-700","border-green-200"),a.textContent="Active"):e==="hold"?(a.classList.add("bg-amber-50","text-amber-700","border-amber-200"),a.textContent="On hold"):(a.classList.add("bg-gray-100","text-gray-700","border-gray-200"),a.textContent="Suspended"));const o=e==="active";i&&(i.disabled=!o,i.classList.toggle("opacity-50",!o),i.classList.toggle("cursor-not-allowed",!o)),d&&(o?h(d):(d.textContent=e==="hold"?"Your debit card is currently on hold. Contact support if you need help.":"Your debit card is suspended. Contact support to resolve this.",x(d)));return}if(((L==null?void 0:L.status)||"").toLowerCase()==="pending"){D("pending");return}D("request")}function F(){var p,g,k,b,v,c;const t=((p=n("cardType"))==null?void 0:p.value)||"",s=((g=n("linkedAccount"))==null?void 0:g.value)||"",e=(((k=n("deliveryAddress"))==null?void 0:k.value)||"").trim(),a=(((b=n("phoneNumber"))==null?void 0:b.value)||"").trim(),i=(v=n("authorize"))==null?void 0:v.checked,d=(c=n("confirm"))==null?void 0:c.checked,o=[];return t||o.push("Select a card type."),s||o.push("Select a linked account."),e||o.push("Enter a delivery address."),a||o.push("Enter a phone number."),(!i||!d)&&o.push("Authorization and confirmation are required."),o}async function G(){var e;C("","");const t=M.currentUser;if(!t){C("error","You must be signed in.");return}if(await q(t),l){C("error","You already have an active debit card."),D("approved");return}if(((L==null?void 0:L.status)||"").toLowerCase()==="pending"){C("error","Your request is already pending approval."),D("pending");return}const s=F();if(s.length){C("error",s[0]);return}P(!0);try{await $(f(m,"debit_card_applications",t.uid),{userId:t.uid,cardType:n("cardType").value,linkedAccount:n("linkedAccount").value,deliveryAddress:n("deliveryAddress").value.trim(),phoneNumber:n("phoneNumber").value.trim(),status:"pending",createdAt:U(),createdAtIso:new Date().toISOString()}),(e=n("form"))==null||e.reset(),h(n("successModal")),x(n("successModal")),D("pending")}catch(a){console.error("Debit card submit error",a),C("error","We couldn’t submit your request. Please try again.")}finally{P(!1)}}window.addEventListener("DOMContentLoaded",()=>{var t,s,e,a,i,d;(t=n("submitBtn"))==null||t.addEventListener("click",G),(s=n("closeSuccessModalBtn"))==null||s.addEventListener("click",()=>h(n("successModal"))),(e=n("viewDetailsBtn"))==null||e.addEventListener("click",()=>{C("",""),n("pinInput").value="",h(n("pinError")),x(n("pinModal"))}),(a=n("closePinModalBtn"))==null||a.addEventListener("click",()=>h(n("pinModal"))),(i=n("pinConfirmBtn"))==null||i.addEventListener("click",async()=>{try{h(n("pinError"));const o=(n("pinInput").value||"").trim();if(!/^\d{5}$/.test(o)){n("pinError").textContent="Enter your 5-digit PIN.",x(n("pinError"));return}const p=M.currentUser;if(!p)throw new Error("Not signed in");const g=await E(f(m,"users",p.uid)),b=((g.exists()?g.data():{}).pin||"").toString().trim();if(!b||b!==o){n("pinError").textContent="Incorrect PIN.",x(n("pinError"));return}const v=await E(f(m,"debit_card_secrets",p.uid));if(!v.exists()){n("pinError").textContent="Card details not available yet.",x(n("pinError"));return}const c=v.data();n("detailPan").textContent=c.pan||"—",n("detailCvv").textContent=c.cvv||"—",n("detailExp").textContent=T(c.expMonth,c.expYear),h(n("pinModal")),x(n("detailsModal"))}catch(o){console.error("View details error",o),n("pinError").textContent="Unable to verify PIN. Please try again.",x(n("pinError"))}}),(d=n("closeDetailsModalBtn"))==null||d.addEventListener("click",()=>h(n("detailsModal")))});A(M,async t=>{if(!t){window.location.href="login.html";return}await H(t),await q(t)});window.signOut=function(){Y(M).then(()=>window.location.href="login.html").catch(t=>{console.error("Sign out error",t),C("error","Unable to sign out. Please try again.")})};const r=t=>document.getElementById(t);let O=null,u=null,N=null;function S(t,s){const e=r("status");e&&(e.className="text-sm mt-3",t==="error"?e.classList.add("text-red-600"):t==="success"?e.classList.add("text-green-700"):e.classList.add("text-gray-600"),e.textContent=s||"")}function I(t){const s=r("submitBtn"),e=r("submitBtnText"),a=r("submitBtnSpinner");!s||!e||!a||(s.disabled=t,a.classList.toggle("hidden",!t),e.textContent=t?"Submitting...":"Submit for approval")}function w(t){t==null||t.classList.remove("hidden")}function y(t){t==null||t.classList.add("hidden")}function B(t){y(r("requestPanel")),y(r("pendingPanel")),y(r("approvedPanel")),w(r(t==="pending"?"pendingPanel":t==="approved"?"approvedPanel":"requestPanel"))}async function J(t){var s;try{const e=await E(f(m,"users",t.uid));O=e.exists()?e.data():{};const a=e.exists()?e.data():{},i=[a.firstName,a.lastName].filter(Boolean).join(" ").trim();(s=r("who"))==null||s.classList.remove("hidden"),r("whoName")&&(r("whoName").textContent=i||"Signed in"),r("whoEmail")&&(r("whoEmail").textContent=t.email||"")}catch(e){console.warn("Debit card: could not load user profile",e)}}function K(t){return`•••• •••• •••• ${(t||"").toString().slice(-4)||"••••"}`}function z(t,s){const e=String(t||"").padStart(2,"0"),a=String(s||"").slice(-2);return`${e}/${a}`}function Q(){const t=O||{},s=[t.firstName,t.lastName].filter(Boolean).join(" ").trim()||"Cardholder",e=(u==null?void 0:u.last4)||"",a=(u==null?void 0:u.expMonth)||"",i=(u==null?void 0:u.expYear)||"";r("cardHolderName")&&(r("cardHolderName").textContent=s.toUpperCase()),r("cardNumberMasked")&&(r("cardNumberMasked").textContent=K(e)),r("cardExp")&&(r("cardExp").textContent=z(a,i))}async function j(t){try{const e=await E(f(m,"debit_cards",t.uid));u=e.exists()?e.data():null}catch(e){console.warn("Debit card: could not load issued card",e),u=null}try{const e=await E(f(m,"debit_card_applications",t.uid));N=e.exists()?e.data():null}catch(e){console.warn("Debit card: could not load application",e),N=null}if(u){B("approved"),Q();const e=(u.status||"active").toLowerCase(),a=r("cardStatusBadge"),i=r("viewDetailsBtn"),d=r("cardStatusNote");a&&(a.className="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full border",e==="active"?(a.classList.add("bg-green-50","text-green-700","border-green-200"),a.textContent="Active"):e==="hold"?(a.classList.add("bg-amber-50","text-amber-700","border-amber-200"),a.textContent="On hold"):(a.classList.add("bg-gray-100","text-gray-700","border-gray-200"),a.textContent="Suspended"));const o=e==="active";i&&(i.disabled=!o,i.classList.toggle("opacity-50",!o),i.classList.toggle("cursor-not-allowed",!o)),d&&(o?y(d):(d.textContent=e==="hold"?"Your debit card is currently on hold. Contact support if you need help.":"Your debit card is suspended. Contact support to resolve this.",w(d)));return}if(((N==null?void 0:N.status)||"").toLowerCase()==="pending"){B("pending");return}B("request")}function R(){var p,g,k,b,v,c;const t=((p=r("cardType"))==null?void 0:p.value)||"",s=((g=r("linkedAccount"))==null?void 0:g.value)||"",e=(((k=r("deliveryAddress"))==null?void 0:k.value)||"").trim(),a=(((b=r("phoneNumber"))==null?void 0:b.value)||"").trim(),i=(v=r("authorize"))==null?void 0:v.checked,d=(c=r("confirm"))==null?void 0:c.checked,o=[];return t||o.push("Select a card type."),s||o.push("Select a linked account."),e||o.push("Enter a delivery address."),a||o.push("Enter a phone number."),(!i||!d)&&o.push("Authorization and confirmation are required."),o}async function X(){var e;S("","");const t=M.currentUser;if(!t){S("error","You must be signed in.");return}if(await j(t),u){S("error","You already have an active debit card."),B("approved");return}if(((N==null?void 0:N.status)||"").toLowerCase()==="pending"){S("error","Your request is already pending approval."),B("pending");return}const s=R();if(s.length){S("error",s[0]);return}I(!0);try{await $(f(m,"debit_card_applications",t.uid),{userId:t.uid,cardType:r("cardType").value,linkedAccount:r("linkedAccount").value,deliveryAddress:r("deliveryAddress").value.trim(),phoneNumber:r("phoneNumber").value.trim(),status:"pending",createdAt:U(),createdAtIso:new Date().toISOString()}),(e=r("form"))==null||e.reset(),y(r("successModal")),w(r("successModal")),B("pending")}catch(a){console.error("Debit card submit error",a),S("error","We couldn’t submit your request. Please try again.")}finally{I(!1)}}window.addEventListener("DOMContentLoaded",()=>{var t,s,e,a,i,d;(t=r("submitBtn"))==null||t.addEventListener("click",X),(s=r("closeSuccessModalBtn"))==null||s.addEventListener("click",()=>y(r("successModal"))),(e=r("viewDetailsBtn"))==null||e.addEventListener("click",()=>{S("",""),r("pinInput").value="",y(r("pinError")),w(r("pinModal"))}),(a=r("closePinModalBtn"))==null||a.addEventListener("click",()=>y(r("pinModal"))),(i=r("pinConfirmBtn"))==null||i.addEventListener("click",async()=>{try{y(r("pinError"));const o=(r("pinInput").value||"").trim();if(!/^\d{5}$/.test(o)){r("pinError").textContent="Enter your 5-digit PIN.",w(r("pinError"));return}const p=M.currentUser;if(!p)throw new Error("Not signed in");const g=await E(f(m,"users",p.uid)),b=((g.exists()?g.data():{}).pin||"").toString().trim();if(!b||b!==o){r("pinError").textContent="Incorrect PIN.",w(r("pinError"));return}const v=await E(f(m,"debit_card_secrets",p.uid));if(!v.exists()){r("pinError").textContent="Card details not available yet.",w(r("pinError"));return}const c=v.data();r("detailPan").textContent=c.pan||"—",r("detailCvv").textContent=c.cvv||"—",r("detailExp").textContent=z(c.expMonth,c.expYear),y(r("pinModal")),w(r("detailsModal"))}catch(o){console.error("View details error",o),r("pinError").textContent="Unable to verify PIN. Please try again.",w(r("pinError"))}}),(d=r("closeDetailsModalBtn"))==null||d.addEventListener("click",()=>y(r("detailsModal")))});A(M,async t=>{if(!t){window.location.href="login.html";return}await J(t),await j(t)});window.signOut=function(){Y(M).then(()=>window.location.href="login.html").catch(t=>{console.error("Sign out error",t),S("error","Unable to sign out. Please try again.")})};
