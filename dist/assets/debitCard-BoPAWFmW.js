const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-client-BuhbagS3.js","assets/firebase-config-CwkpdvL9.js"])))=>i.map(i=>d[i]);
import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as q}from"./preload-helper-D7HrI6pR.js";import{b as C,g as k,d as w,a as L,o as I,s as _,c as F,e as B}from"./firebase-client-BuhbagS3.js";import"./firebase-config-CwkpdvL9.js";const e=t=>document.getElementById(t);let v=null,o=null,b=null;function m(t,a){const r=e("status");r&&(r.className="text-sm mt-3",t==="error"?r.classList.add("text-red-600"):t==="success"?r.classList.add("text-green-700"):r.classList.add("text-gray-600"),r.textContent=a||"")}function z(t){const a=e("submitBtn"),r=e("submitBtnText"),n=e("submitBtnSpinner");!a||!r||!n||(a.disabled=t,n.classList.toggle("hidden",!t),r.textContent=t?"Submitting...":"Submit for approval")}function l(t){t==null||t.classList.remove("hidden")}function p(t){t==null||t.classList.add("hidden")}function S(t){p(e("requestPanel")),p(e("pendingPanel")),p(e("approvedPanel")),l(e(t==="pending"?"pendingPanel":t==="approved"?"approvedPanel":"requestPanel"))}async function U(t){var a;try{const r=await k(w(L,"users",t.uid));v=r.exists()?r.data():{};const n=r.exists()?r.data():{},i=[n.firstName,n.lastName].filter(Boolean).join(" ").trim();(a=e("who"))==null||a.classList.remove("hidden"),e("whoName")&&(e("whoName").textContent=i||"Signed in"),e("whoEmail")&&(e("whoEmail").textContent=t.email||"")}catch(r){console.warn("Debit card: could not load user profile",r)}}function H(t){return`•••• •••• •••• ${(t||"").toString().slice(-4)||"••••"}`}function A(t,a){const r=String(t||"").padStart(2,"0"),n=String(a||"").slice(-2);return`${r}/${n}`}function P(t){const a=typeof t=="string"?parseFloat(t.replace(/[^0-9.-]/g,""))||0:t||0;return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(a)}function O(){const t=v||{},a=[t.firstName,t.lastName].filter(Boolean).join(" ").trim()||"Cardholder",r=(o==null?void 0:o.last4)||"",n=(o==null?void 0:o.expMonth)||"",i=(o==null?void 0:o.expYear)||"",c=(o==null?void 0:o.linkedAccount)||(b==null?void 0:b.linkedAccount)||"";e("cardHolderName")&&(e("cardHolderName").textContent=a.toUpperCase()),e("cardNumberMasked")&&(e("cardNumberMasked").textContent=H(r)),e("cardExp")&&(e("cardExp").textContent=A(n,i));let s=0;e("cardAccountBalance")&&(c==="checking"?s=typeof t.checking=="string"?parseFloat(t.checking.replace(/[^0-9.-]/g,""))||0:t.checking||0:c==="savings"&&(s=typeof t.savings=="string"?parseFloat(t.savings.replace(/[^0-9.-]/g,""))||0:t.savings||0),e("cardAccountBalance").textContent=P(s));const g=e("depositRequirementItem");g&&(s<2?l(g):p(g))}async function D(t){try{const n=await k(w(L,"debit_cards",t.uid));o=n.exists()?n.data():null}catch(n){console.warn("Debit card: could not load issued card",n),o=null}try{const n=await k(w(L,"debit_card_applications",t.uid));b=n.exists()?n.data():null}catch(n){console.warn("Debit card: could not load application",n),b=null}if(o){S("approved"),O();const n=(o.status||"active").toLowerCase(),i=e("cardStatusBadge"),c=e("viewDetailsBtn"),s=e("cardStatusNote"),g=e("infoSidebar"),u=e("freezeCardBtn"),y=e("freezeCardBtnText"),h=e("depositRequirementItem");if(g&&l(g),h){const d=v||{},N=(o==null?void 0:o.linkedAccount)||"";let E=0;N==="checking"?E=typeof d.deposit=="string"?parseFloat(d.deposit.replace(/[^0-9.-]/g,""))||0:d.deposit||0:N==="savings"&&(E=typeof d.fixed=="string"?parseFloat(d.fixed.replace(/[^0-9.-]/g,""))||0:d.fixed||0),E<2?l(h):p(h)}u&&y&&(n==="active"?(y.textContent="Freeze card",u.onclick=()=>M(!0)):(n==="hold"||n==="frozen")&&(y.textContent="Unfreeze card",u.onclick=()=>M(!1))),i&&(i.className="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full border font-medium",n==="active"?(i.classList.add("bg-green-50","text-green-700","border-green-200"),i.innerHTML='<i class="fas fa-check-circle"></i> Active'):n==="frozen"?(i.classList.add("bg-green-50","text-green-700","border-green-200"),i.innerHTML='<i class="fas fa-snowflake"></i> Frozen'):n==="hold"?(i.classList.add("bg-amber-50","text-amber-700","border-amber-200"),i.innerHTML='<i class="fas fa-pause-circle"></i> On hold'):(i.classList.add("bg-gray-100","text-gray-700","border-gray-200"),i.innerHTML='<i class="fas fa-ban"></i> Suspended'));const x=n==="active"||n==="frozen",f=document.querySelector("#approvedPanel .rounded-2xl.p-5.text-white.shadow-lg")||document.querySelector('#approvedPanel [style*="radial-gradient"]');if(f)if(n==="frozen"){if(f.style.opacity="0.6",f.style.filter="grayscale(40%)",f.classList.add("relative"),!f.querySelector(".frozen-overlay")){const d=document.createElement("div");d.className="frozen-overlay absolute inset-0 rounded-2xl flex items-center justify-center",d.style.background="rgba(0, 0, 0, 0.1)",d.innerHTML='<div class="bg-white/90 px-4 py-2 rounded-lg border-2 border-green-500"><span class="text-green-900 font-bold text-sm">FROZEN</span></div>',f.appendChild(d)}}else{f.style.opacity="1",f.style.filter="none";const d=f.querySelector(".frozen-overlay");d&&d.remove()}c&&(c.disabled=!x,c.classList.toggle("opacity-50",!x),c.classList.toggle("cursor-not-allowed",!x)),u&&(n==="frozen"?(u.classList.remove("border-gray-300","text-gray-800","hover:bg-gray-50"),u.classList.add("bg-green-600","text-white","hover:bg-green-700","border-green-600")):(u.classList.remove("bg-green-600","text-white","hover:bg-green-700","border-green-600"),u.classList.add("border-gray-300","text-gray-800","hover:bg-gray-50"))),s&&(n==="frozen"?(s.className="text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-lg px-4 py-3",s.innerHTML='<div class="flex items-start gap-3"><i class="fas fa-snowflake text-gray-600 mt-0.5"></i><div><div class="font-semibold mb-1 text-gray-900">Card Frozen</div><div class="text-gray-700">Your card is currently frozen and cannot be used for transactions. Click "Unfreeze card" to activate it again.</div></div></div>',l(s)):n==="hold"?(s.className="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-4 py-3",s.innerHTML='<div class="flex items-start gap-3"><i class="fas fa-pause-circle text-amber-600 mt-0.5"></i><div><div class="font-semibold mb-1">Card On Hold</div><div>Your debit card is currently on hold. Contact support if you need help.</div></div></div>',l(s)):n==="suspended"?(s.className="text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg px-4 py-3",s.innerHTML='<div class="flex items-start gap-3"><i class="fas fa-ban text-red-600 mt-0.5"></i><div><div class="font-semibold mb-1">Card Suspended</div><div>Your debit card is suspended. Contact support to resolve this.</div></div></div>',l(s)):p(s));return}const a=e("infoSidebar");if(a&&l(a),((b==null?void 0:b.status)||"").toLowerCase()==="pending"){S("pending");return}S("request")}function Y(){var g,u,y,h,x,f;const t=((g=e("cardType"))==null?void 0:g.value)||"",a=((u=e("linkedAccount"))==null?void 0:u.value)||"",r=(((y=e("deliveryAddress"))==null?void 0:y.value)||"").trim(),n=(((h=e("phoneNumber"))==null?void 0:h.value)||"").trim(),i=(x=e("authorize"))==null?void 0:x.checked,c=(f=e("confirm"))==null?void 0:f.checked,s=[];return t||s.push("Select a card type."),a||s.push("Select a linked account."),r||s.push("Enter a delivery address."),n||s.push("Enter a phone number."),(!i||!c)&&s.push("Authorization and confirmation are required."),s}async function R(){var r;m("","");const t=C.currentUser;if(!t){m("error","You must be signed in.");return}if(await D(t),o){m("error","You already have an active debit card."),S("approved");return}if(((b==null?void 0:b.status)||"").toLowerCase()==="pending"){m("error","Your request is already pending approval."),S("pending");return}const a=Y();if(a.length){m("error",a[0]);return}z(!0);try{await F(w(L,"debit_card_applications",t.uid),{userId:t.uid,cardType:e("cardType").value,linkedAccount:e("linkedAccount").value,deliveryAddress:e("deliveryAddress").value.trim(),phoneNumber:e("phoneNumber").value.trim(),status:"pending",createdAt:B(),createdAtIso:new Date().toISOString()}),(r=e("form"))==null||r.reset(),p(e("successModal")),l(e("successModal")),S("pending")}catch(n){console.error("Debit card submit error",n),m("error","We couldn’t submit your request. Please try again.")}finally{z(!1)}}async function M(t){const a=C.currentUser;if(!a){m("error","You must be signed in.");return}try{const{updateDoc:r}=await q(async()=>{const{updateDoc:i}=await import("./firebase-client-BuhbagS3.js").then(c=>c.x);return{updateDoc:i}},__vite__mapDeps([0,1])),n=w(L,"debit_cards",a.uid);await r(n,{status:t?"frozen":"active",updatedAt:B()}),await D(a),m("success",t?"Card frozen successfully.":"Card unfrozen successfully.")}catch(r){console.error("Freeze card error",r),m("error","Unable to update card status. Please try again.")}}function T(){var s;const t=((s=e("linkedAccount"))==null?void 0:s.value)||"",a=e("accountBalanceDisplay"),r=e("accountTypeLabel"),n=e("accountBalanceAmount");if(!a||!r||!n)return;if(!t||!v){p(a);return}let i=0,c="";t==="checking"?(i=typeof v.deposit=="string"?parseFloat(v.deposit.replace(/[^0-9.-]/g,""))||0:v.deposit||0,c="Checking Offshore"):t==="savings"&&(i=typeof v.fixed=="string"?parseFloat(v.fixed.replace(/[^0-9.-]/g,""))||0:v.fixed||0,c="Savings Offshore"),c?(r.textContent=c,n.textContent=P(i),l(a)):p(a)}window.addEventListener("DOMContentLoaded",()=>{var t,a,r,n,i,c,s;(t=e("submitBtn"))==null||t.addEventListener("click",R),(a=e("closeSuccessModalBtn"))==null||a.addEventListener("click",()=>p(e("successModal"))),(r=e("linkedAccount"))==null||r.addEventListener("change",T),(n=e("viewDetailsBtn"))==null||n.addEventListener("click",()=>{m("",""),e("pinInput").value="",p(e("pinError")),l(e("pinModal"))}),(i=e("closePinModalBtn"))==null||i.addEventListener("click",()=>p(e("pinModal"))),(c=e("pinConfirmBtn"))==null||c.addEventListener("click",async()=>{try{p(e("pinError"));const g=(e("pinInput").value||"").trim();if(!/^\d{5}$/.test(g)){e("pinError").textContent="Enter your 5-digit PIN.",l(e("pinError"));return}const u=C.currentUser;if(!u)throw new Error("Not signed in");const y=await k(w(L,"users",u.uid)),x=((y.exists()?y.data():{}).pin||"").toString().trim();if(!x||x!==g){e("pinError").textContent="Incorrect PIN.",l(e("pinError"));return}const f=await k(w(L,"debit_card_secrets",u.uid));if(!f.exists()){e("pinError").textContent="Card details not available yet.",l(e("pinError"));return}const d=f.data();e("detailPan").textContent=d.pan||"—",e("detailCvv").textContent=d.cvv||"—",e("detailExp").textContent=A(d.expMonth,d.expYear),p(e("pinModal")),l(e("detailsModal"))}catch(g){console.error("View details error",g),e("pinError").textContent="Unable to verify PIN. Please try again.",l(e("pinError"))}}),(s=e("closeDetailsModalBtn"))==null||s.addEventListener("click",()=>p(e("detailsModal")))});I(C,async t=>{if(!t){window.location.href="login.html";return}await U(t),await D(t),e("requestPanel")&&!e("requestPanel").classList.contains("hidden")&&T()});window.signOut=function(){_(C).then(()=>window.location.href="login.html").catch(t=>{console.error("Sign out error",t),m("error","Unable to sign out. Please try again.")})};
