import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as b}from"./preload-helper-D7HrI6pR.js";import{a as u,d as h}from"./firebase-client-DudADU2j.js";import{onAuthStateChanged as P,signOut as N,updateProfile as x}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";import{doc as g,updateDoc as v,getDoc as S}from"https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";import"./firebase-config-CJaibweW.js";import"https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";window.auth=u;window.db=h;const w=document.getElementById("profileInfoCard");w&&w.classList.remove("hidden");async function U(e){const o=document.getElementById("email"),a=document.getElementById("firstName"),n=document.getElementById("accountType"),t=document.getElementById("phone-number-text"),d=document.getElementById("phone-number-action"),i=document.getElementById("profileImage");o&&(o.value=e.email||"",o.placeholder=e.email||"Email"),i&&(i.src=e.photoURL||"https://via.placeholder.com/150"),a&&(a.value=e.displayName||"",a.placeholder=e.displayName||"Full Name");try{const c=S(g(h,"users",e.uid)),p=new Promise((s,r)=>setTimeout(()=>r(new Error("Firestore query timeout")),5e3)),l=await Promise.race([c,p]);if(l.exists()){const s=l.data();if(a){const r=s.firstName&&s.lastName?`${s.firstName} ${s.lastName}`:s.firstName||e.displayName||"No name set";a.value=r,a.placeholder=r}if(n){const r=s.accountType||s.account_type||"Standard";n.value=r,n.placeholder=r}if(t){const r=s.phoneNumber||s.phone||"";r&&r.trim()!==""?(t.textContent=r,t.classList.remove("text-gray-500","italic"),t.classList.add("text-gray-700"),d&&d.classList.add("hidden")):(t.textContent="No phone number attached",t.classList.add("text-gray-500","italic"),t.classList.remove("text-gray-700"),d&&d.classList.remove("hidden"))}s.photoURL&&i&&(i.src=s.photoURL)}else n&&(n.value="Standard",n.placeholder="Standard"),t&&(t.textContent="No phone number attached",t.classList.add("text-gray-500","italic"),d&&d.classList.remove("hidden"))}catch(c){console.warn("Firestore query failed or timed out, using auth data:",c),n&&(n.value="Standard",n.placeholder="Standard"),t&&(t.textContent="No phone number attached",t.classList.add("text-gray-500","italic"),d&&d.classList.remove("hidden"))}finally{}}window.openAttachPhoneModal=function(e){e&&(e.preventDefault(),e.stopPropagation());const o=document.getElementById("attachPhoneModal");return o&&(o.classList.remove("hidden"),document.getElementById("new-phone-number").value="",document.getElementById("verify-password").value="",document.getElementById("phone-input-step").classList.remove("hidden"),document.getElementById("password-verification-step").classList.add("hidden"),document.getElementById("phone-modal-error").classList.add("hidden")),!1};window.closeAttachPhoneModal=function(){const e=document.getElementById("attachPhoneModal");e&&e.classList.add("hidden")};window.closePhoneSuccessModal=function(){const e=document.getElementById("phoneSuccessModal");e&&e.classList.add("hidden")};window.proceedToPasswordStep=function(){if(!document.getElementById("new-phone-number").value.trim()){m("Please enter a phone number");return}document.getElementById("phone-input-step").classList.add("hidden"),document.getElementById("password-verification-step").classList.remove("hidden"),document.getElementById("phone-modal-error").classList.add("hidden")};window.backToPhoneStep=function(){document.getElementById("phone-input-step").classList.remove("hidden"),document.getElementById("password-verification-step").classList.add("hidden"),document.getElementById("phone-modal-error").classList.add("hidden")};function m(e){const o=document.getElementById("phone-modal-error"),a=document.getElementById("phone-modal-error-text");o&&a&&(a.textContent=e,o.classList.remove("hidden"))}window.attachPhoneNumber=async function(){const e=document.getElementById("new-phone-number").value.trim(),o=document.getElementById("verify-password").value,a=document.getElementById("attach-phone-btn-text"),n=document.getElementById("attach-phone-spinner");if(!e){m("Please enter a phone number");return}if(!o){m("Please enter your password");return}try{a.classList.add("hidden"),n.classList.remove("hidden"),document.getElementById("phone-modal-error").classList.add("hidden");const t=u.currentUser;if(!t){m("User not authenticated");return}const{reauthenticateWithCredential:d,EmailAuthProvider:i}=await b(async()=>{const{reauthenticateWithCredential:L,EmailAuthProvider:B}=await import("https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js");return{reauthenticateWithCredential:L,EmailAuthProvider:B}},[]),c=i.credential(t.email,o);await d(t,c);const p=g(h,"users",t.uid);await v(p,{phoneNumber:e,phone:e,phoneUpdatedAt:new Date().toISOString()}),console.log("âœ… Phone number saved to Firestore:",e);const l=document.getElementById("phone-number-text"),s=document.getElementById("phone-number-action");l&&(l.textContent=e,l.classList.remove("text-gray-500","italic"),l.classList.add("text-gray-700")),s&&s.classList.add("hidden"),closeAttachPhoneModal();const r=document.getElementById("success-phone-number");r&&(r.textContent=e);const y=document.getElementById("phoneSuccessModal");y&&y.classList.remove("hidden")}catch(t){console.error("Error attaching phone number:",t),t.code==="auth/wrong-password"?m("Incorrect password. Please try again."):t.code==="auth/invalid-email"?m("Invalid email address."):m("Failed to attach phone number. Please try again.")}finally{a.classList.remove("hidden"),n.classList.add("hidden")}};let f=!1,E=!1;P(u,async e=>{e?(E=!0,f=!0,await U(e)):(f||(await new Promise(o=>setTimeout(o,500)),f=!0),E||u.currentUser||(window.location.href="login.html"))});function I(){const e=document.getElementById("imageUpload");e&&e.addEventListener("change",async function(o){const a=o.target.files[0];if(!a)return;const n=new FormData;n.append("file",a),n.append("upload_preset","ASHB_profile");try{const d=await(await fetch("https://api.cloudinary.com/v1_1/dmgcagkqa/image/upload",{method:"POST",body:n})).json();if(d.secure_url){const i=document.getElementById("profileImage");i&&(i.src=d.secure_url);const c=u.currentUser;c&&(await Promise.all([v(g(h,"users",c.uid),{photoURL:d.secure_url}),x(c,{photoURL:d.secure_url})]),alert("Profile image updated successfully!"))}}catch(t){console.error("Error uploading image:",t),alert("Failed to upload image. Please try again.")}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I):I();window.signOut=function(){N(u).then(()=>{window.location.href="login.html"}).catch(e=>{console.error("Sign out error:",e),window.location.href="login.html"})};
