import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as E}from"./preload-helper-D7HrI6pR.js";import{b as p,a as L,c as v,g as B,d as C,o as x}from"./firebase-client-DvgkFHPb.js";import"./firebase-config-C56FTJjz.js";class S{constructor(){this.initializeFirebase().catch(t=>{console.log("Firebase initialization deferred, will use fallback"),this.handleFirebaseError()})}async initializeFirebase(){console.log("Using localStorage fallback for banking details"),this.handleFirebaseError()}setupFirebase(){try{const t={apiKey:"AIzaSyBb9sVH4fMb-a5mQgcDjAfYT9RZHTb3sKE",authDomain:"twenty-third-forth.firebaseapp.com",projectId:"twenty-third-forth",storageBucket:"twenty-third-forth.firebasestorage.app",messagingSenderId:"835548579831",appId:"1:835548579831:web:5259f071b50341af28d0f2",measurementId:"G-KEMCE9679Y"};firebase.apps.length?this.app=firebase.app():this.app=firebase.initializeApp(t),this.auth=firebase.auth(),this.db=firebase.firestore(),console.log("Firebase initialized successfully for banking details"),this.auth.onAuthStateChanged(e=>{e?console.log("User authenticated:",e.uid):console.log("No user authenticated")})}catch(t){console.error("Error setting up Firebase:",t),this.handleFirebaseError()}}handleFirebaseError(){console.log("Firebase not available, using fallback mode"),this.app=null,this.auth=null,this.db=null}generateAccountNumber(){let t="";for(let e=0;e<10;e++)t+=Math.floor(Math.random()*10);return t}generateSwiftCode(){const t=["FTBC","CHAS","WELL","CITI","JPMO","BANK","AMEX"],e=["US","UK","CA","AU","SG"],n=["NYC","LON","TOR","SYD","SIN"],a=t[Math.floor(Math.random()*t.length)],s=n[Math.floor(Math.random()*n.length)],i=e[Math.floor(Math.random()*e.length)];return a+s+i}generateRoutingNumber(){let t="";for(let e=0;e<9;e++)t+=Math.floor(Math.random()*10);return t}generateBankingDetails(){return{accountNumber:this.generateAccountNumber(),swiftCode:this.generateSwiftCode(),routingNumber:this.generateRoutingNumber(),bankName:"Twenty Third & Forth",accountType:"Personal Account",generatedAt:new Date().toISOString()}}async saveBankingDetails(t,e,n=!1){try{let a=null;try{typeof window<"u"&&window.db?a=window.db:this.db&&(a=this.db)}catch(l){console.error("Could not access global db:",l)}if(!a)return console.warn("Firebase not available, using localStorage fallback"),this.saveToLocalStorage(t,e);const{doc:s,getDoc:i,setDoc:m}=await E(async()=>{const{doc:l,getDoc:b,setDoc:N}=await import("https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js");return{doc:l,getDoc:b,setDoc:N}},[]),c=s(a,"users",t);let r=null,u=null;try{u=await i(c),u.exists()&&(r=u.data())}catch(l){console.error("Error reading existing document:",l)}if(!n&&r&&r.bank&&r.bank.accountNumber)return console.log('‚ö†Ô∏è Banking details already exist for this user in "bank" field, not overwriting'),console.log("üìã Existing details:",{accountNumber:r.bank.accountNumber?"***"+r.bank.accountNumber.slice(-4):"none",hasSwiftCode:!!r.bank.swiftCode,hasRoutingNumber:!!r.bank.routingNumber}),this.saveToLocalStorage(t,r.bank),!0;console.log("üíæ Saving new banking details to Firebase...");const g={accountNumber:e.accountNumber,routingNumber:e.routingNumber,bankName:e.bankName,accountType:e.accountType,accountHolderName:e.accountHolderName||e.accountName||"Account Holder",swiftCode:e.swiftCode||"",iban:e.iban||"",createdAt:r&&r.bank&&r.bank.createdAt?r.bank.createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0,generatedAt:new Date().toISOString()};try{console.log("üíæ Attempting to save to Firebase:",{userId:t,accountNumber:g.accountNumber,swiftCode:g.swiftCode,routingNumber:g.routingNumber}),await m(c,{bank:g,hasBankingDetails:!0,lastUpdated:new Date().toISOString()},{merge:!0}),console.log('‚úÖ Banking details saved successfully to Firebase in user document "bank" field'),console.log("üîç Verifying save by reading back from Firebase...");const l=await i(c);if(l.exists()){const b=l.data();b.bank&&b.bank.accountNumber===g.accountNumber?(console.log("‚úÖ Verified: Banking details confirmed in Firebase"),console.log("üìã Verified details:",{accountNumber:b.bank.accountNumber,swiftCode:b.bank.swiftCode,routingNumber:b.bank.routingNumber})):(console.warn("‚ö†Ô∏è Verification failed: Account numbers do not match"),console.log("Expected:",g.accountNumber),console.log("Found:",b.bank?b.bank.accountNumber:"no bank field"))}else console.warn("‚ö†Ô∏è Verification failed: User document does not exist after save")}catch(l){throw console.error("‚ùå Error saving to Firebase:",l),console.error("Save error details:",{message:l.message,code:l.code,stack:l.stack}),l}return this.saveToLocalStorage(t,g),!0}catch(a){return console.error("‚ùå Error saving banking details to Firebase:",a),console.log("Falling back to localStorage"),this.saveToLocalStorage(t,e),!1}}saveToLocalStorage(t,e){try{const n=`beal_banking_details_${t}`;return localStorage.setItem(n,JSON.stringify({...e,userId:t,savedAt:new Date().toISOString()})),console.log("Banking details saved to localStorage as fallback"),!0}catch(n){return console.error("Error saving to localStorage:",n),!1}}async getBankingDetails(t,e=!1){try{let n=null;try{typeof window<"u"&&window.db?n=window.db:this.db&&(n=this.db)}catch{console.log("Could not access global db, will use localStorage")}if(n)try{console.log("üîç Checking Firebase for banking details for user:",t);const{doc:s,getDoc:i}=await E(async()=>{const{doc:r,getDoc:u}=await import("https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js");return{doc:r,getDoc:u}},[]),m=s(n,"users",t),c=await i(m);if(c.exists()){const r=c.data();if(console.log("üìÑ User document exists, checking for bank field:",{hasBankField:!!r.bank,bankData:r.bank?{hasAccountNumber:!!r.bank.accountNumber,accountNumber:r.bank.accountNumber?"***"+r.bank.accountNumber.slice(-4):"none"}:"no bank field"}),r.bank&&r.bank.accountNumber)return console.log('‚úÖ Found existing banking details in Firebase user document "bank" field'),console.log("üìã Banking details:",{accountNumber:r.bank.accountNumber,swiftCode:r.bank.swiftCode,routingNumber:r.bank.routingNumber}),this.saveToLocalStorage(t,r.bank),r.bank;console.log('‚ö†Ô∏è User document exists but no banking details found in "bank" field')}else console.log("‚ö†Ô∏è User document does not exist in Firebase")}catch(s){console.error("‚ùå Error reading from Firebase:",s),console.error("Error details:",{message:s.message,code:s.code,stack:s.stack})}else console.log("‚ö†Ô∏è Firebase db not available, will check localStorage");console.log("No banking details found in Firebase, checking localStorage");const a=this.getFromLocalStorage(t);if(a&&a.accountNumber){if(console.log("Found existing banking details in localStorage, syncing to Firebase"),n)try{await this.saveBankingDetails(t,a,!1)}catch{console.log("Could not save to Firebase, but using localStorage details")}return a}if(e){console.log("No existing banking details found, generating new ones");const s=this.generateBankingDetails();return await this.saveBankingDetails(t,s,!1),s}else return console.log("No existing banking details found"),null}catch(n){console.error("Error getting banking details:",n),console.log("Falling back to localStorage");const a=this.getFromLocalStorage(t);if(a&&a.accountNumber)return a;if(!e)return null;console.log("No existing details found, generating new ones");const s=this.generateBankingDetails();return await this.saveBankingDetails(t,s,!1),s}}getFromLocalStorage(t){try{const e=`beal_banking_details_${t}`,n=localStorage.getItem(e);if(n){const a=JSON.parse(n);if(a&&a.accountNumber)return console.log("Found existing banking details in localStorage"),a}return console.log("No existing banking details found in localStorage for user:",t),null}catch(e){return console.error("Error getting from localStorage:",e),null}}getCurrentUserId(){let t=null;try{typeof window<"u"&&window.auth?t=window.auth:this.auth&&(t=this.auth)}catch{console.log("Could not access global auth")}if(t){const n=t.currentUser;if(n&&n.uid)return n.uid}console.warn("No authenticated user found, using temporary ID");let e=localStorage.getItem("beal_temp_user_id");return e||(e="temp_user_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem("beal_temp_user_id",e)),e}async initializeUserBankingDetails(t=!1){const e=this.getCurrentUserId();if(console.log("üöÄ Initializing banking details for user:",e),!e)return console.warn("‚ö†Ô∏è No user ID available"),null;try{const n=await this.getBankingDetails(e,t);return console.log(n?"‚úÖ Successfully initialized banking details":"‚ÑπÔ∏è No banking details found (this is expected for new users)"),n}catch(n){return console.error("‚ùå Error initializing banking details:",n),console.error("Error stack:",n.stack),null}}}window.auth=p;window.db=L;window.firestoreHelpers={doc:C,getDoc:B,setDoc:v};x(p,o=>{o?console.log("‚úÖ User authenticated:",o.uid):console.log("No user authenticated, but continuing to allow viewing")});const h=new S;function D(o){const t=document.getElementById(o);if(!t){console.error("Element not found:",o);return}const e=t.innerText||t.textContent;if(!e||e.trim()===""||e.includes("Click")||e.includes("Loading")){d("Nothing to copy. Please generate wallet address first.","error");return}navigator.clipboard.writeText(e.trim()).then(()=>{d("Copied to clipboard!","success")}).catch(n=>{console.error("Failed to copy: ",n),d("Failed to copy. Please try again.","error")})}function I(o,t){const e=document.getElementById(o),n=document.getElementById(t);e.type==="password"?(e.type="text",n.setAttribute("stroke","green")):(e.type="password",n.setAttribute("stroke","black"))}function k(o){document.getElementById("account-number-loading").classList.add("hidden"),document.getElementById("swift-code-loading").classList.add("hidden"),document.getElementById("routing-number-loading").classList.add("hidden");const t=document.getElementById("account-number"),e=document.getElementById("swift-code"),n=document.getElementById("routing-number");t.textContent=o.accountNumber,e.textContent=o.swiftCode,n.textContent=o.routingNumber,[t,e,n].forEach(s=>{s.classList.remove("text-blue-600","italic"),s.classList.add("font-semibold","text-gray-800")}),t.classList.remove("hidden"),e.classList.remove("hidden"),n.classList.remove("hidden"),document.querySelectorAll(".copy-btn").forEach(s=>{s.disabled=!1,s.classList.remove("opacity-50")});const a=document.getElementById("refresh-banking-details");a&&a.classList.add("hidden")}function f(){document.getElementById("account-number-loading").classList.add("hidden"),document.getElementById("swift-code-loading").classList.add("hidden"),document.getElementById("routing-number-loading").classList.add("hidden");const o=document.getElementById("account-number"),t=document.getElementById("swift-code"),e=document.getElementById("routing-number");o.textContent="Click Generate to create banking details",t.textContent="Click Generate to create banking details",e.textContent="Click Generate to create banking details",o.classList.remove("hidden"),t.classList.remove("hidden"),e.classList.remove("hidden"),[o,t,e].forEach(a=>{a.classList.add("text-blue-600","italic"),a.classList.remove("font-semibold")}),document.querySelectorAll(".copy-btn").forEach(a=>{a.disabled=!0,a.classList.add("opacity-50")});const n=document.getElementById("refresh-banking-details");n&&(n.classList.remove("hidden"),n.classList.add("bg-blue-500","hover:bg-blue-600","text-white","shadow-lg"),n.title="Generate Banking Details - Click to create your banking details")}document.addEventListener("DOMContentLoaded",async()=>{try{await new Promise(e=>setTimeout(e,500));const t=window.auth&&window.auth.currentUser;if(!t)console.log("No user authenticated, showing generate button"),f();else{console.log("‚úÖ User authenticated, loading banking details for:",t.uid);let e=0;for(;!window.db&&e<3;)console.warn(`‚ö†Ô∏è Firebase db not available yet, waiting... (attempt ${e+1}/3)`),await new Promise(a=>setTimeout(a,1e3)),e++;if(!window.db){console.error("‚ùå Firebase db still not available after retries"),f();return}console.log("‚úÖ Firebase db is available, loading banking details...");const n=await h.initializeUserBankingDetails(!1);console.log("üìã Banking details retrieval result:",n?{found:!0,hasAccountNumber:!!n.accountNumber,hasSwiftCode:!!n.swiftCode,hasRoutingNumber:!!n.routingNumber}:"No details found"),n&&n.accountNumber&&n.accountNumber.trim()!==""?(k(n),console.log("‚úÖ Banking details loaded successfully from Firebase:",{accountNumber:n.accountNumber,swiftCode:n.swiftCode||"N/A",routingNumber:n.routingNumber||"N/A",bankName:n.bankName||"N/A",source:"Firebase"})):(console.log("No existing banking details found. Showing generate button."),n&&console.warn("‚ö†Ô∏è Details object exists but accountNumber is missing or empty:",n),f())}}catch(t){console.error("‚ùå Error initializing banking details:",t),f()}const o=document.getElementById("refresh-banking-details");o&&o.addEventListener("click",async()=>{try{F();const t=window.auth&&window.auth.currentUser,e=t?t.uid:h.getCurrentUserId();if(!e){d("Please log in to generate banking details","error"),f();return}console.log("üîç Checking for existing banking details for user:",e);const n=await h.getBankingDetails(e,!1);if(n&&n.accountNumber&&n.accountNumber.trim()!==""){console.log("‚úÖ Found existing banking details, displaying them"),k(n),d("Your banking details are displayed below.","success");return}console.log("No existing banking details found, generating new ones..."),console.log("Generating new banking details for user:",e);const a=h.generateBankingDetails();console.log("Generated new banking details:",a),await h.saveBankingDetails(e,a,!1)?(k(a),d("Banking details generated and saved! They will be available on all your devices.","success"),console.log("‚úÖ Banking details saved and displayed successfully")):(k(a),d("Banking details generated. Please check your connection to sync across devices.","error"))}catch(t){console.error("‚ùå Error generating new banking details:",t),d("Failed to generate new banking details: "+(t.message||"Unknown error"),"error"),f()}})});function F(){document.getElementById("account-number-loading").classList.remove("hidden"),document.getElementById("swift-code-loading").classList.remove("hidden"),document.getElementById("routing-number-loading").classList.remove("hidden"),document.getElementById("account-number").classList.add("hidden"),document.getElementById("swift-code").classList.add("hidden"),document.getElementById("routing-number").classList.add("hidden"),document.querySelectorAll(".copy-btn").forEach(o=>{o.disabled=!0,o.classList.add("opacity-50")})}function d(o,t="info"){const e=document.createElement("div");e.className=`fixed top-20 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${t==="success"?"bg-blue-500 text-white":t==="error"?"bg-red-500 text-white":"bg-blue-500 text-white"}`,e.textContent=o,document.body.appendChild(e),setTimeout(()=>{e.remove()},3e3)}window.copyToClipboard=D;window.toggleVisibility=I;window.selectDepositMethod=function(o){const t=document.getElementById("bank-deposit-btn"),e=document.getElementById("crypto-deposit-btn"),n=document.getElementById("bank-deposit-section"),a=document.getElementById("crypto-deposit-section");o==="bank"?(t.classList.add("border-blue-500","bg-blue-50","text-blue-700"),t.classList.remove("border-gray-200","bg-white","text-gray-700"),e.classList.remove("border-orange-500","bg-orange-50","text-orange-700"),e.classList.add("border-gray-200","bg-white","text-gray-700"),n.classList.remove("hidden"),a.classList.add("hidden")):(e.classList.add("border-orange-500","bg-orange-50","text-orange-700"),e.classList.remove("border-gray-200","bg-white","text-gray-700"),t.classList.remove("border-blue-500","bg-blue-50","text-blue-700"),t.classList.add("border-gray-200","bg-white","text-gray-700"),n.classList.add("hidden"),a.classList.remove("hidden"))};window.selectCryptoType=function(o){const t=document.getElementById("btc-btn"),e=document.getElementById("usdt-btn"),n=document.getElementById("btc-wallet-section"),a=document.getElementById("usdt-wallet-section");if(o==="btc"){t.classList.add("border-orange-500","bg-orange-50","text-orange-700"),t.classList.remove("border-gray-200","bg-white","text-gray-700"),e.classList.remove("border-teal-500","bg-teal-50","text-teal-700"),e.classList.add("border-gray-200","bg-white","text-gray-700"),n.classList.remove("hidden"),a.classList.add("hidden");const s=document.getElementById("btc-wallet-address"),i=document.getElementById("btc-wallet-loading");i&&i.classList.add("hidden"),s&&((!s.textContent||s.textContent.includes("Click"))&&(s.textContent=w("btc")),s.classList.remove("hidden")),y("btc")}else{e.classList.add("border-teal-500","bg-teal-50","text-teal-700"),e.classList.remove("border-gray-200","bg-white","text-gray-700"),t.classList.remove("border-orange-500","bg-orange-50","text-orange-700"),t.classList.add("border-gray-200","bg-white","text-gray-700"),a.classList.remove("hidden"),n.classList.add("hidden");const s=document.getElementById("usdt-wallet-address"),i=document.getElementById("usdt-wallet-loading");i&&i.classList.add("hidden"),s&&((!s.textContent||s.textContent.includes("Click"))&&(s.textContent=w("usdt")),s.classList.remove("hidden")),y("usdt")}};function w(o){return o==="btc"?"bc1qkrgt8qkwmfw6t53qr673yd8rvqhfkwfarqcw9d":o==="usdt"?"0xad6b24eF59Cdc672AAD86ecECcE3788cB1b423d4":""}window.generateCryptoWallet=async function(o){try{const t=window.auth&&window.auth.currentUser;if(!t){d("Please log in to generate crypto wallet","error");return}const e=document.getElementById(`${o}-wallet-loading`),n=document.getElementById(`${o}-wallet-address`);e&&e.classList.remove("hidden"),n&&(n.classList.add("hidden"),n.textContent="");const a=w(o);console.log(`Generated ${o.toUpperCase()} wallet:`,a);const{doc:s,getDoc:i,setDoc:m}=window.firestoreHelpers||{};if(!s||!i||!m)throw new Error("Firestore helpers not available");const c=s(window.db,"users",t.uid),r=await i(c),u=r.exists()?r.data():{},g={[o]:{address:a,type:o.toUpperCase(),generatedAt:new Date().toISOString(),network:o==="btc"?"Bitcoin":"Ethereum (ERC20)"}};await m(c,{crypto:{...u.crypto||{},...g},[`lastCrypto${o.toUpperCase()}Generated`]:new Date().toISOString()},{merge:!0}),console.log(`‚úÖ ${o.toUpperCase()} wallet saved to Firebase`),e&&e.classList.add("hidden"),n&&(n.textContent=a,n.classList.remove("hidden")),d(`${o.toUpperCase()} wallet address generated and saved!`,"success")}catch(t){console.error(`Error generating ${o} wallet:`,t),d(`Failed to generate ${o.toUpperCase()} wallet: ${t.message}`,"error");const e=document.getElementById(`${o}-wallet-loading`);e&&e.classList.add("hidden")}};async function y(o){try{const t=window.auth&&window.auth.currentUser;if(!t||!window.db)return;const{doc:e,getDoc:n,setDoc:a}=window.firestoreHelpers||{};if(!e||!n||!a)return;const s=e(window.db,"users",t.uid),i=await n(s);if(i.exists()){const m=i.data(),c=document.getElementById(`${o}-wallet-address`),r=document.getElementById(`${o}-wallet-loading`),u=w(o);r&&r.classList.add("hidden"),c&&(c.textContent=u,c.classList.remove("hidden")),await a(s,{crypto:{...m.crypto||{},[o]:{address:u,type:o.toUpperCase(),generatedAt:new Date().toISOString(),network:o==="btc"?"Bitcoin":"Ethereum (ERC20)"}}},{merge:!0}),console.log(`‚úÖ ${o.toUpperCase()} wallet set to fixed address`)}}catch(t){console.error(`Error loading ${o} wallet:`,t)}}document.addEventListener("DOMContentLoaded",async()=>{const o=document.getElementById("btc-wallet-address"),t=document.getElementById("usdt-wallet-address"),e=document.getElementById("btc-wallet-loading"),n=document.getElementById("usdt-wallet-loading");o&&(o.textContent=w("btc")),e&&e.classList.add("hidden"),t&&(t.textContent=w("usdt")),n&&n.classList.add("hidden"),await new Promise(s=>setTimeout(s,1e3)),window.auth&&window.auth.currentUser&&window.db&&(y("btc"),y("usdt"))});
