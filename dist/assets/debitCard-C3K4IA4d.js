import{b as E,g as _,d as h,a as S,o as I,s as F,c as T,e as D,A as q,B as U,C as R,D as O,x as H,F as V,y as Y,z as Q,G as $,H as j,Q as W,I as K,J as G,K as Z,L as J,M as X,N as ee,S as te,T as ae,V as re,_ as ne,O as se,P as ie,R as oe,U as ce,W as de,X as le,Y as ue,Z as fe,f as pe,h as me,$ as ge,l as be,a0 as ye,a1 as ve,k as xe,a2 as he,j as we,r as Se,q as Ce,u as _e,w as Ee}from"./firebase-client-X0D09DJ_.js";import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as Le}from"./preload-helper-D7HrI6pR.js";import"./firebase-config-LdbrzKVt.js";const De=Object.freeze(Object.defineProperty({__proto__:null,AbstractUserDataWriter:q,Bytes:U,CollectionReference:R,DocumentReference:O,DocumentSnapshot:H,FieldPath:V,FieldValue:Y,Firestore:Q,FirestoreError:$,GeoPoint:j,Query:W,QueryCompositeFilterConstraint:K,QueryConstraint:G,QueryDocumentSnapshot:Z,QueryFieldFilterConstraint:J,QueryOrderByConstraint:X,QuerySnapshot:ee,SnapshotMetadata:te,Timestamp:ae,VectorValue:re,_AutoId:ne,_ByteString:se,_DatabaseId:ie,_DocumentKey:oe,_EmptyAuthCredentialsProvider:ce,_FieldPath:de,_cast:le,_logWarn:ue,_validateIsNotUsedTogether:fe,addDoc:pe,collection:me,connectFirestoreEmulator:ge,deleteDoc:be,doc:h,ensureFirestoreConfigured:ye,executeWrite:ve,getDoc:_,getDocs:xe,getFirestore:he,onSnapshot:we,orderBy:Se,query:Ce,serverTimestamp:D,setDoc:T,updateDoc:_e,where:Ee},Symbol.toStringTag,{value:"Module"})),e=t=>document.getElementById(t);let y=null,o=null,b=null;function g(t,n){const r=e("status");r&&(r.className="text-sm mt-3",t==="error"?r.classList.add("text-red-600"):t==="success"?r.classList.add("text-green-700"):r.classList.add("text-gray-600"),r.textContent=n||"")}function A(t){const n=e("submitBtn"),r=e("submitBtnText"),a=e("submitBtnSpinner");!n||!r||!a||(n.disabled=t,a.classList.toggle("hidden",!t),r.textContent=t?"Submitting...":"Submit for approval")}function d(t){t==null||t.classList.remove("hidden")}function p(t){t==null||t.classList.add("hidden")}function C(t){p(e("requestPanel")),p(e("pendingPanel")),p(e("approvedPanel")),d(e(t==="pending"?"pendingPanel":t==="approved"?"approvedPanel":"requestPanel"))}async function ke(t){var n;try{const r=await _(h(S,"users",t.uid));y=r.exists()?r.data():{};const a=r.exists()?r.data():{},i=[a.firstName,a.lastName].filter(Boolean).join(" ").trim();(n=e("who"))==null||n.classList.remove("hidden"),e("whoName")&&(e("whoName").textContent=i||"Signed in"),e("whoEmail")&&(e("whoEmail").textContent=t.email||"")}catch(r){console.warn("Debit card: could not load user profile",r)}}function Pe(t){return`•••• •••• •••• ${(t||"").toString().slice(-4)||"••••"}`}function N(t,n){const r=String(t||"").padStart(2,"0"),a=String(n||"").slice(-2);return`${r}/${a}`}function M(t){const n=typeof t=="string"?parseFloat(t.replace(/[^0-9.-]/g,""))||0:t||0;return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(n)}function Ae(){const t=y||{},n=[t.firstName,t.lastName].filter(Boolean).join(" ").trim()||"Cardholder",r=(o==null?void 0:o.last4)||"",a=(o==null?void 0:o.expMonth)||"",i=(o==null?void 0:o.expYear)||"",l=(o==null?void 0:o.linkedAccount)||(b==null?void 0:b.linkedAccount)||"";e("cardHolderName")&&(e("cardHolderName").textContent=n.toUpperCase()),e("cardNumberMasked")&&(e("cardNumberMasked").textContent=Pe(r)),e("cardExp")&&(e("cardExp").textContent=N(a,i));let s=0;e("cardAccountBalance")&&(l==="checking"?s=typeof t.checking=="string"?parseFloat(t.checking.replace(/[^0-9.-]/g,""))||0:t.checking||0:l==="savings"&&(s=typeof t.savings=="string"?parseFloat(t.savings.replace(/[^0-9.-]/g,""))||0:t.savings||0),e("cardAccountBalance").textContent=M(s));const m=e("depositRequirementItem");m&&(s<2?d(m):p(m))}async function k(t){try{const a=await _(h(S,"debit_cards",t.uid));o=a.exists()?a.data():null}catch(a){console.warn("Debit card: could not load issued card",a),o=null}try{const a=await _(h(S,"debit_card_applications",t.uid));b=a.exists()?a.data():null}catch(a){console.warn("Debit card: could not load application",a),b=null}if(o){C("approved"),Ae();const a=(o.status||"active").toLowerCase(),i=e("cardStatusBadge"),l=e("viewDetailsBtn"),s=e("cardStatusNote"),m=e("infoSidebar"),u=e("freezeCardBtn"),v=e("freezeCardBtnText"),w=e("depositRequirementItem");if(m&&d(m),w){const c=y||{},P=(o==null?void 0:o.linkedAccount)||"";let L=0;P==="checking"?L=typeof c.deposit=="string"?parseFloat(c.deposit.replace(/[^0-9.-]/g,""))||0:c.deposit||0:P==="savings"&&(L=typeof c.fixed=="string"?parseFloat(c.fixed.replace(/[^0-9.-]/g,""))||0:c.fixed||0),L<2?d(w):p(w)}u&&v&&(a==="active"?(v.textContent="Freeze card",u.onclick=()=>B(!0)):(a==="hold"||a==="frozen")&&(v.textContent="Unfreeze card",u.onclick=()=>B(!1))),i&&(i.className="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full border font-medium",a==="active"?(i.classList.add("bg-green-50","text-green-700","border-green-200"),i.innerHTML='<i class="fas fa-check-circle"></i> Active'):a==="frozen"?(i.classList.add("bg-blue-50","text-blue-700","border-blue-200"),i.innerHTML='<i class="fas fa-snowflake"></i> Frozen'):a==="hold"?(i.classList.add("bg-amber-50","text-amber-700","border-amber-200"),i.innerHTML='<i class="fas fa-pause-circle"></i> On hold'):(i.classList.add("bg-gray-100","text-gray-700","border-gray-200"),i.innerHTML='<i class="fas fa-ban"></i> Suspended'));const x=a==="active"||a==="frozen",f=document.querySelector("#approvedPanel .rounded-2xl.p-5.text-white.shadow-lg")||document.querySelector('#approvedPanel [style*="radial-gradient"]');if(f)if(a==="frozen"){if(f.style.opacity="0.6",f.style.filter="grayscale(40%)",f.classList.add("relative"),!f.querySelector(".frozen-overlay")){const c=document.createElement("div");c.className="frozen-overlay absolute inset-0 rounded-2xl flex items-center justify-center",c.style.background="rgba(0, 0, 0, 0.1)",c.innerHTML='<div class="bg-white/90 px-4 py-2 rounded-lg border-2 border-blue-500"><span class="text-blue-900 font-bold text-sm">FROZEN</span></div>',f.appendChild(c)}}else{f.style.opacity="1",f.style.filter="none";const c=f.querySelector(".frozen-overlay");c&&c.remove()}l&&(l.disabled=!x,l.classList.toggle("opacity-50",!x),l.classList.toggle("cursor-not-allowed",!x)),u&&(a==="frozen"?(u.classList.remove("border-gray-300","text-gray-800","hover:bg-gray-50"),u.classList.add("bg-blue-600","text-white","hover:bg-blue-700","border-blue-600")):(u.classList.remove("bg-blue-600","text-white","hover:bg-blue-700","border-blue-600"),u.classList.add("border-gray-300","text-gray-800","hover:bg-gray-50"))),s&&(a==="frozen"?(s.className="text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-lg px-4 py-3",s.innerHTML='<div class="flex items-start gap-3"><i class="fas fa-snowflake text-gray-600 mt-0.5"></i><div><div class="font-semibold mb-1 text-gray-900">Card Frozen</div><div class="text-gray-700">Your card is currently frozen and cannot be used for transactions. Click "Unfreeze card" to activate it again.</div></div></div>',d(s)):a==="hold"?(s.className="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-4 py-3",s.innerHTML='<div class="flex items-start gap-3"><i class="fas fa-pause-circle text-amber-600 mt-0.5"></i><div><div class="font-semibold mb-1">Card On Hold</div><div>Your debit card is currently on hold. Contact support if you need help.</div></div></div>',d(s)):a==="suspended"?(s.className="text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg px-4 py-3",s.innerHTML='<div class="flex items-start gap-3"><i class="fas fa-ban text-red-600 mt-0.5"></i><div><div class="font-semibold mb-1">Card Suspended</div><div>Your debit card is suspended. Contact support to resolve this.</div></div></div>',d(s)):p(s));return}const n=e("infoSidebar");if(n&&d(n),((b==null?void 0:b.status)||"").toLowerCase()==="pending"){C("pending");return}C("request")}function Be(){var m,u,v,w,x,f;const t=((m=e("cardType"))==null?void 0:m.value)||"",n=((u=e("linkedAccount"))==null?void 0:u.value)||"",r=(((v=e("deliveryAddress"))==null?void 0:v.value)||"").trim(),a=(((w=e("phoneNumber"))==null?void 0:w.value)||"").trim(),i=(x=e("authorize"))==null?void 0:x.checked,l=(f=e("confirm"))==null?void 0:f.checked,s=[];return t||s.push("Select a card type."),n||s.push("Select a linked account."),r||s.push("Enter a delivery address."),a||s.push("Enter a phone number."),(!i||!l)&&s.push("Authorization and confirmation are required."),s}async function Te(){var r;g("","");const t=E.currentUser;if(!t){g("error","You must be signed in.");return}if(await k(t),o){g("error","You already have an active debit card."),C("approved");return}if(((b==null?void 0:b.status)||"").toLowerCase()==="pending"){g("error","Your request is already pending approval."),C("pending");return}const n=Be();if(n.length){g("error",n[0]);return}A(!0);try{await T(h(S,"debit_card_applications",t.uid),{userId:t.uid,cardType:e("cardType").value,linkedAccount:e("linkedAccount").value,deliveryAddress:e("deliveryAddress").value.trim(),phoneNumber:e("phoneNumber").value.trim(),status:"pending",createdAt:D(),createdAtIso:new Date().toISOString()}),(r=e("form"))==null||r.reset(),p(e("successModal")),d(e("successModal")),C("pending")}catch(a){console.error("Debit card submit error",a),g("error","We couldn’t submit your request. Please try again.")}finally{A(!1)}}async function B(t){const n=E.currentUser;if(!n){g("error","You must be signed in.");return}try{const{updateDoc:r}=await Le(async()=>{const{updateDoc:i}=await Promise.resolve().then(()=>De);return{updateDoc:i}},void 0),a=h(S,"debit_cards",n.uid);await r(a,{status:t?"frozen":"active",updatedAt:D()}),await k(n),g("success",t?"Card frozen successfully.":"Card unfrozen successfully.")}catch(r){console.error("Freeze card error",r),g("error","Unable to update card status. Please try again.")}}function z(){var s;const t=((s=e("linkedAccount"))==null?void 0:s.value)||"",n=e("accountBalanceDisplay"),r=e("accountTypeLabel"),a=e("accountBalanceAmount");if(!n||!r||!a)return;if(!t||!y){p(n);return}let i=0,l="";t==="checking"?(i=typeof y.deposit=="string"?parseFloat(y.deposit.replace(/[^0-9.-]/g,""))||0:y.deposit||0,l="Checking Offshore"):t==="savings"&&(i=typeof y.fixed=="string"?parseFloat(y.fixed.replace(/[^0-9.-]/g,""))||0:y.fixed||0,l="Savings Offshore"),l?(r.textContent=l,a.textContent=M(i),d(n)):p(n)}window.addEventListener("DOMContentLoaded",()=>{var t,n,r,a,i,l,s;(t=e("submitBtn"))==null||t.addEventListener("click",Te),(n=e("closeSuccessModalBtn"))==null||n.addEventListener("click",()=>p(e("successModal"))),(r=e("linkedAccount"))==null||r.addEventListener("change",z),(a=e("viewDetailsBtn"))==null||a.addEventListener("click",()=>{g("",""),e("pinInput").value="",p(e("pinError")),d(e("pinModal"))}),(i=e("closePinModalBtn"))==null||i.addEventListener("click",()=>p(e("pinModal"))),(l=e("pinConfirmBtn"))==null||l.addEventListener("click",async()=>{try{p(e("pinError"));const m=(e("pinInput").value||"").trim();if(!/^\d{5}$/.test(m)){e("pinError").textContent="Enter your 5-digit PIN.",d(e("pinError"));return}const u=E.currentUser;if(!u)throw new Error("Not signed in");const v=await _(h(S,"users",u.uid)),x=((v.exists()?v.data():{}).pin||"").toString().trim();if(!x||x!==m){e("pinError").textContent="Incorrect PIN.",d(e("pinError"));return}const f=await _(h(S,"debit_card_secrets",u.uid));if(!f.exists()){e("pinError").textContent="Card details not available yet.",d(e("pinError"));return}const c=f.data();e("detailPan").textContent=c.pan||"—",e("detailCvv").textContent=c.cvv||"—",e("detailExp").textContent=N(c.expMonth,c.expYear),p(e("pinModal")),d(e("detailsModal"))}catch(m){console.error("View details error",m),e("pinError").textContent="Unable to verify PIN. Please try again.",d(e("pinError"))}}),(s=e("closeDetailsModalBtn"))==null||s.addEventListener("click",()=>p(e("detailsModal")))});I(E,async t=>{if(!t){window.location.href="login.html";return}await ke(t),await k(t),e("requestPanel")&&!e("requestPanel").classList.contains("hidden")&&z()});window.signOut=function(){F(E).then(()=>window.location.href="login.html").catch(t=>{console.error("Sign out error",t),g("error","Unable to sign out. Please try again.")})};
