import"./modulepreload-polyfill-B5Qt9EMX.js";import{b as W,a as Y,u as S,g as x,d as v,o as q,s as H}from"./firebase-client-CmfDEE6w.js";import"./firebase-config-C56FTJjz.js";window.auth=W;window.db=Y;window.firestoreHelpers={doc:v,getDoc:x,updateDoc:S};window.executeTransfer=async function(){try{const o=window.auth.currentUser;if(!o)throw new Error("No user is signed in");const t=v(window.db,"users",o.uid),a=await x(t);if(!a.exists())throw new Error("User account not found");const e=a.data();switch((e.status||"inactive").toLowerCase()){case"suspended":throw new Error("Your account is currently suspended. Please contact support for assistance.");case"inactive":throw new Error("Your account is inactive. Please activate your account to make transfers.");case"banned":throw new Error("This account has been banned. Please contact support for more information.");case"processing":throw new Error("Your account is currently under review. Please try again later.");case"active":break;default:throw new Error("Unable to verify account status. Please contact support.")}let r=document.getElementById("bankName").value,g=document.getElementById("accountNumber").value,c=document.getElementById("accountName").value,s=parseFloat(document.getElementById("withdrawCash").value.replace(/[^0-9.]/g,""))||0,d=document.getElementById("swiftCode").value,w=document.getElementById("paymentDescription").value,C="TRX"+Math.floor(Math.random()*1e6);const T=document.getElementById("fundingSource"),u=T?T.value:"";if(!u)throw new Error("Funding source is required");let f=0,h="";if(u==="fixed_banking"){const i=e.checking??0;f=typeof i=="string"?parseFloat(i.replace(/[^0-9.-]/g,""))||0:parseFloat(i)||0,h="Checking Offshore"}else if(u==="savings_banking"){const i=e.savings??0;f=typeof i=="string"?parseFloat(i.replace(/[^0-9.-]/g,""))||0:parseFloat(i)||0,h="Savings Offshore"}if((isNaN(f)||f<0)&&(f=0),console.log("Final balance check in executeTransfer:",{fundingSource:u,accountType:h,transferAmount:s,accountBalance:f,rawUserData:{deposit:e.deposit,fixed:e.fixed,savings:e.savings,checking:e.checking,wallet:e.wallet,profit:e.profit,fixed_banking:e.fixed_banking,savings_banking:e.savings_banking}}),s>f)throw new Error(`Insufficient funds available in ${h}`);const D=s*1e-4,k=new Date,F=k.toLocaleTimeString("en-US",{hour12:!0,hour:"2-digit",minute:"2-digit"}),P=k.toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}),B=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(s),N=u==="fixed_banking"?"Checking":"Savings",U=selectedTransferType==="International"?"Transfer-Intl":"Transfer-Domestic",p=`${r} - Twenty Forth & Fifth  |  ${U}  |  ${B} |  ${F}  |  ${P}  |  ${N}  |  Pending`,$=e.pending1||"",A=e.pending2||"",R=e.pending3||"",_=e.pending4||"",M=e.pending5||"";let l="",m={};if(!$)l="pending1",m={pending1:p};else if(!A)l="pending2",m={pending2:p};else if(!R)l="pending3",m={pending3:p};else if(!_)l="pending4",m={pending4:p};else if(!M)l="pending5",m={pending5:p};else throw document.getElementById("pendingLimitReached").classList.remove("hidden"),new Error("Maximum pending transactions reached. This transaction has been queued as you have 5 pending transactions already. Cheers!");const L=i=>new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(i);if(u==="fixed_banking"){const i=e.checking??0,I=(typeof i=="string"?parseFloat(i.replace(/[^0-9.-]/g,""))||0:parseFloat(i)||0)-s;m.checking=L(I)}else if(u==="savings_banking"){const i=e.savings??0,I=(typeof i=="string"?parseFloat(i.replace(/[^0-9.-]/g,""))||0:parseFloat(i)||0)-s;m.savings=L(I)}l&&(await S(t,m),console.log(`Transfer string saved in Firebase as ${l}:`,p),console.log(`Amount deducted from ${u==="fixed_banking"?"deposit":"fixed"} account`));const V={bankName:r,accountNumber:g,accountName:c,transferAmount:B,swiftCode:d,transferType:selectedTransferType||"Domestic",paymentDescription:w,transactionRef:C,fee:D.toFixed(2),pendingSlot:l};await sendTransferDetails(V),document.getElementById("beneficiaryName").innerText=c,document.getElementById("beneficiaryAccount").innerText=g,document.getElementById("beneficiaryBank").innerText=r,document.getElementById("transferAmount").innerText=B,document.getElementById("transferFee").innerText=`$${D.toFixed(2)}`,document.getElementById("transactionRef").innerText=C,document.getElementById("receiptPaymentDescription").innerText=w||"-",selectedTransferType==="International"&&d?(document.getElementById("swiftCodeReceiptSection").classList.remove("hidden"),document.getElementById("receiptSwiftCode").innerText=d):document.getElementById("swiftCodeReceiptSection").classList.add("hidden"),document.getElementById("spinner").classList.add("hidden"),document.getElementById("successModal").classList.remove("hidden")}catch(o){console.error("Error executing transfer:",o),document.getElementById("spinner").classList.add("hidden"),showErrorModal(o.message)}};let b=!1,y=!1,E=null;q(window.auth,async o=>{if(E&&(clearTimeout(E),E=null),o){y=!0,b=!0;const t=document.getElementById("Deposit-account"),a=document.getElementById("Profit-wallet"),e=document.getElementById("wallet"),n=document.getElementById("welcome-message");t&&(t.textContent="Loading..."),a&&(a.textContent="Loading..."),e&&(e.textContent="Loading..."),n&&(n.textContent="Loading...");try{const r=v(window.db,"users",o.uid),g=await Promise.race([x(r),new Promise((c,s)=>setTimeout(()=>s(new Error("Timeout")),2e3))]);if(g.exists()){const c=g.data(),s=d=>{if(!d)return"0.00";const w=typeof d=="string"?parseFloat(d.replace(/[^0-9.-]/g,""))||0:Number(d)||0;return new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(w)};t&&(t.textContent=s(c.checking)),a&&(a.textContent=s(c.profit)),e&&(e.textContent=s(c.wallet)),n&&(n.textContent=`Welcome ${c.name||c.firstName||"User"}`)}else console.log("No user document found in Firestore."),t&&(t.textContent="0.00"),a&&(a.textContent="0.00"),e&&(e.textContent="0.00"),n&&(n.textContent="Welcome User")}catch(r){console.error("Error loading user data:",r),t&&(t.textContent="0.00"),a&&(a.textContent="0.00"),e&&(e.textContent="0.00"),n&&(n.textContent="Welcome User")}}else b||(await new Promise(t=>setTimeout(t,500)),b=!0),y?console.log("User state changed to null, but user was previously authenticated. Waiting..."):E=setTimeout(()=>{const t=window.auth.currentUser;!t&&!y?(console.log("No user signed in after verification. Redirecting to sign-in page."),window.location.href="login.html"):t&&(console.log("Auth state changed - user is now authenticated, canceling redirect"),y=!0)},1e3)});window.signOut=function(){H(window.auth).then(()=>{alert("Signed out successfully!"),window.location.href="login.html"}).catch(o=>{alert("Error signing out: "+o.message)})};window.validatePin=async function(){const o=document.getElementById("securityPin").value.trim(),t=document.getElementById("confirmButton"),a=document.getElementById("confirmButtonText"),e=document.getElementById("confirmButtonLoader"),n=document.getElementById("securityPinError");n.classList.add("hidden"),t.disabled=!0,a.textContent="Processing...",e.classList.remove("hidden"),document.getElementById("spinner").classList.remove("hidden");try{const r=window.auth.currentUser;if(r){const g=v(window.db,"users",r.uid),c=await x(g);if(c.exists()){const d=c.data().pin;d?o===d?(document.getElementById("securityPinModal").classList.add("hidden"),executeTransfer()):(n.textContent="Incorrect Pin. Please try again.",n.classList.remove("hidden")):(n.textContent="Please update your PIN in settings.",n.classList.remove("hidden"),window.location.href="pin.html")}}}catch(r){console.error("Error validating PIN:",r),n.textContent="Error validating PIN. Please try again.",n.classList.remove("hidden")}finally{t.disabled=!1,a.textContent="Confirm",e.classList.add("hidden"),document.getElementById("spinner").classList.add("hidden")}};document.addEventListener("DOMContentLoaded",function(){const o=document.getElementById("confirmButton");o&&o.addEventListener("click",window.validatePin)});
